# S3バケットバージョニング設定とは

## What's this file?
> [!NOTE]
> **What**
> 
> S3バケットバージョニング設定とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : S3バケットバージョニングとは何か
> 
> **Answer** : S3バケット内のオブジェクトの複数バージョンを保持する機能で、誤削除や上書きからデータを保護し、特定時点のデータを復元可能にする仕組み

## 目次

<details>
<summary>目次を開く</summary>

- [バージョニングの概要](#バージョニングの概要)
- [バージョニングの仕組み](#バージョニングの仕組み)
- [3つの設定状態](#3つの設定状態)
- [バージョニングのメリット](#バージョニングのメリット)
- [デメリットと注意点](#デメリットと注意点)
- [プロジェクトでの実装例](#プロジェクトでの実装例)
- [データ種別による使い分け](#データ種別による使い分け)
- [ベストプラクティス](#ベストプラクティス)

</details>

## バージョニングの概要

S3バケットバージョニングは、同じキー（オブジェクト名）で複数のバージョンのオブジェクトを保持する機能です。

### 基本的な動作

```
# バージョニング有効時の動作例
1. file.txt をアップロード → バージョンID: 111111
2. file.txt を更新       → バージョンID: 222222（新規）
3. file.txt を削除       → 削除マーカー追加（データは保持）
```

### Terraformでの設定

```hcl
resource "aws_s3_bucket_versioning" "example" {
  bucket = aws_s3_bucket.example.id

  versioning_configuration {
    status = "Enabled"  # または "Disabled", "Suspended"
  }
}
```

## バージョニングの仕組み

### バージョンIDの管理

```
オブジェクト: data.csv
├── バージョンID: null（バージョニング有効前）
├── バージョンID: 3HL4kqtJlcpXroDTDmJ+rmSpXd3dIbrHY（最新）
├── バージョンID: 2HL4kqtJlcpXroDTDmJ+rmSpXd3dIbrHX
└── バージョンID: 1HL4kqtJlcpXroDTDmJ+rmSpXd3dIbrHW（最古）
```

### 削除時の動作

1. **通常の削除**
   - 削除マーカーが追加される
   - 実際のデータは保持される
   - 復元可能

2. **永久削除**
   - バージョンIDを指定して削除
   - データが完全に削除される
   - 復元不可能

## 3つの設定状態

### 1. Enabled（有効）

```hcl
versioning_configuration {
  status = "Enabled"
}
```

- 新しいオブジェクトにバージョンIDが付与
- 既存オブジェクトの更新時に新バージョン作成
- 削除時は削除マーカーを追加

### 2. Disabled（無効）

```hcl
versioning_configuration {
  status = "Disabled"
}
```

- バージョニングを使用しない
- バージョンIDは"null"
- 上書き時は既存データが失われる

### 3. Suspended（一時停止）

```hcl
versioning_configuration {
  status = "Suspended"
}
```

- 新規オブジェクトのバージョンIDは"null"
- 既存バージョンは保持される
- 一時的にバージョニングを停止

## バージョニングのメリット

### 1. データ保護

```bash
# 誤って削除してしまった場合
aws s3 rm s3://my-bucket/important-file.pdf

# バージョニング有効なら復元可能
aws s3api list-object-versions --bucket my-bucket --prefix important-file.pdf
aws s3api delete-object --bucket my-bucket --key important-file.pdf --version-id DeleteMarkerVersionId
```

### 2. 監査証跡

- いつ、誰が、何を変更したかの履歴
- コンプライアンス要件への対応
- 変更履歴の追跡

### 3. ロールバック機能

```python
# 特定バージョンの復元
s3_client.copy_object(
    Bucket='my-bucket',
    CopySource={'Bucket': 'my-bucket', 'Key': 'file.txt', 'VersionId': 'previous_version_id'},
    Key='file.txt'
)
```

## デメリットと注意点

### 1. ストレージコストの増加

```
# バージョン数による容量増加例
original.jpg (5MB)
├── v1: 5MB
├── v2: 5MB（微修正）
├── v3: 5MB（再修正）
└── 合計: 15MB（3倍のストレージ使用）
```

### 2. 管理の複雑化

- 古いバージョンの定期削除が必要
- ライフサイクルルールの設定推奨
- バージョン数の監視

### 3. パフォーマンスへの影響

- 大量のバージョンがある場合のリスト操作
- APIコールの増加

## プロジェクトでの実装例

### 実際の設定パターン

```hcl
# 静的アセット用バケット - バージョニング有効（変更履歴を保持）
resource "aws_s3_bucket_versioning" "example_project_static" {
  bucket = aws_s3_bucket.example_project_static.id

  versioning_configuration {
    status = "Enabled"
  }
}

# 基準面データ用バケット - バージョニング有効（重要データの保護）
resource "aws_s3_bucket_versioning" "example_reference_surfaces" {
  bucket = aws_s3_bucket.example_reference_surfaces.id

  versioning_configuration {
    status = "Enabled"
  }
}

# 点群データ用バケット - バージョニング無効（一時データのため）
resource "aws_s3_bucket_versioning" "example_point_clouds" {
  bucket = aws_s3_bucket.example_point_clouds.id

  versioning_configuration {
    status = "Disabled"
  }
}

# 差分解析結果用バケット - バージョニング有効（長期保存データ）
resource "aws_s3_bucket_versioning" "example_difference_analysis" {
  bucket = aws_s3_bucket.example_difference_analysis.id

  versioning_configuration {
    status = "Enabled"
  }
}
```

## データ種別による使い分け

### バージョニングを有効にすべきケース

1. **重要な設定ファイル**
   - 変更履歴が必要
   - ロールバックの可能性

2. **コンプライアンス対象データ**
   - 監査証跡の保持
   - データの完全性証明

3. **長期保存データ**
   - 差分解析結果
   - 基準面データ

### バージョニングが不要なケース

1. **一時的なデータ**
   - キャッシュファイル
   - 処理中の中間ファイル

2. **大容量の更新頻度が高いデータ**
   - 点群データ（プロジェクトの例）
   - ストリーミングデータ

3. **ログファイル**
   - 追記のみでバージョン管理不要
   - 別の方法でアーカイブ

## ベストプラクティス

### 1. ライフサイクルルールとの併用

```hcl
resource "aws_s3_bucket_lifecycle_configuration" "versioned" {
  bucket = aws_s3_bucket.example.id

  rule {
    id     = "delete-old-versions"
    status = "Enabled"

    noncurrent_version_expiration {
      noncurrent_days = 30  # 30日後に古いバージョンを削除
    }
  }
}
```

### 2. MFAデリート保護

```hcl
resource "aws_s3_bucket_versioning" "secure" {
  bucket = aws_s3_bucket.critical.id

  versioning_configuration {
    status = "Enabled"
    mfa_delete = "Enabled"  # MFA認証なしでは削除不可
  }
}
```

### 3. コスト最適化

```hcl
# 古いバージョンを安価なストレージクラスへ移行
resource "aws_s3_bucket_lifecycle_configuration" "cost_optimized" {
  bucket = aws_s3_bucket.example.id

  rule {
    id     = "transition-old-versions"
    status = "Enabled"

    noncurrent_version_transition {
      noncurrent_days = 30
      storage_class   = "STANDARD_IA"  # 低頻度アクセス
    }

    noncurrent_version_transition {
      noncurrent_days = 90
      storage_class   = "GLACIER"  # アーカイブ
    }
  }
}
```

### 4. モニタリング

```bash
# バージョン数の監視
aws s3api list-object-versions \
  --bucket my-bucket \
  --query 'length(Versions[?IsLatest==`false`])'

# CloudWatchメトリクスでの監視
aws cloudwatch put-metric-alarm \
  --alarm-name high-version-count \
  --metric-name NumberOfObjects \
  --dimensions Name=BucketName,Value=my-bucket \
              Name=StorageType,Value=AllStorageTypes
```

## 関連

- [AWS S3 Versioning](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html)
- [S3 Lifecycle Configuration](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html)
- S3コスト最適化ガイド
- データ保護のベストプラクティス