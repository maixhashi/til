# S3バケットポリシー設定とは

## What's this file?
> [!NOTE]
> **What**
> 
> S3バケットポリシー設定とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : S3バケットポリシーとは何か
> 
> **Answer** : S3バケットへのアクセス権限をJSON形式で定義するリソースベースポリシーで、特定のプリンシパル（ユーザー、ロール、サービス）に対してバケットとオブジェクトへのアクセスを制御する仕組み

## 目次

<details>
<summary>目次を開く</summary>

- [バケットポリシーの概要](#バケットポリシーの概要)
- [ポリシーの構成要素](#ポリシーの構成要素)
- [IAMポリシーとの違い](#iamポリシーとの違い)
- [プロジェクトでの実装パターン](#プロジェクトでの実装パターン)
- [ポリシーの評価順序](#ポリシーの評価順序)
- [よく使用されるポリシーパターン](#よく使用されるポリシーパターン)
- [セキュリティベストプラクティス](#セキュリティベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)

</details>

## バケットポリシーの概要

S3バケットポリシーは、S3バケットとその中のオブジェクトへのアクセス権限を制御するJSON形式のポリシードキュメントです。

### 基本的な特徴

1. **リソースベースポリシー**
   - バケットに直接アタッチされる
   - クロスアカウントアクセスが可能
   - 最大20KBまでのサイズ制限

2. **JSON形式での定義**
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "ポリシーの識別子",
         "Effect": "Allow または Deny",
         "Principal": "誰に対して",
         "Action": "何の操作を",
         "Resource": "どのリソースに対して"
       }
     ]
   }
   ```

## ポリシーの構成要素

### 1. Version（バージョン）

```json
"Version": "2012-10-17"  // 現在はこのバージョンのみ使用
```

ポリシー言語のバージョンを指定します。

### 2. Statement（ステートメント）

ポリシーの実際のルールを定義する配列です。

### 3. Sid（ステートメントID）

```json
"Sid": "AllowECSTaskAccess"
```

- ポリシー内で一意の識別子
- 人間が読みやすい説明的な名前を推奨
- オプションだが設定推奨

### 4. Effect（効果）

```json
"Effect": "Allow"  // または "Deny"
```

- **Allow**: アクセスを許可
- **Deny**: アクセスを拒否（Allowより優先）

### 5. Principal（プリンシパル）

```json
"Principal": {
  "AWS": "arn:aws:iam::123456789012:role/my-role"
}
```

誰に対してアクセスを許可/拒否するか：
- AWS IAMユーザー
- IAMロール
- AWSアカウント
- フェデレーションユーザー
- AWSサービス

### 6. Action（アクション）

```json
"Action": [
  "s3:GetObject",
  "s3:PutObject",
  "s3:DeleteObject",
  "s3:ListBucket"
]
```

許可/拒否する操作を指定します。

### 7. Resource（リソース）

```json
"Resource": [
  "arn:aws:s3:::my-bucket",      // バケット自体
  "arn:aws:s3:::my-bucket/*"     // バケット内のオブジェクト
]
```

### 8. Condition（条件）

```json
"Condition": {
  "StringEquals": {
    "s3:x-amz-server-side-encryption": "AES256"
  }
}
```

特定の条件下でのみポリシーを適用します。

## IAMポリシーとの違い

### バケットポリシー

```hcl
# バケットにアタッチ
resource "aws_s3_bucket_policy" "example" {
  bucket = aws_s3_bucket.example.id
  policy = jsonencode({...})
}
```

- **リソースベース**: バケットに直接アタッチ
- **クロスアカウント**: 他のAWSアカウントからのアクセス可能
- **匿名アクセス**: パブリックアクセスの設定可能
- **管理場所**: S3サービス側

### IAMポリシー

```hcl
# ユーザー/ロールにアタッチ
resource "aws_iam_role_policy" "example" {
  role   = aws_iam_role.example.id
  policy = jsonencode({...})
}
```

- **アイデンティティベース**: ユーザー/ロールにアタッチ
- **同一アカウント内**: 基本的に同じアカウント内のみ
- **認証必須**: AWSの認証が必要
- **管理場所**: IAMサービス側

## プロジェクトでの実装パターン

### ECSタスクからのアクセス許可

```hcl
resource "aws_s3_bucket_policy" "example_project_static" {
  bucket = aws_s3_bucket.example_project_static.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "AllowECSTaskAccess"
        Effect = "Allow"
        Principal = {
          AWS = aws_iam_role.ecs_task.arn  # ECSタスクロール
        }
        Action = [
          "s3:GetObject",      # オブジェクトの読み取り
          "s3:PutObject",      # オブジェクトの書き込み
          "s3:DeleteObject",   # オブジェクトの削除
          "s3:ListBucket"      # バケット内容の一覧表示
        ]
        Resource = [
          aws_s3_bucket.example_project_static.arn,      # バケット操作用
          "${aws_s3_bucket.example_project_static.arn}/*" # オブジェクト操作用
        ]
      }
    ]
  })
}
```

### リソースの使い分け

```hcl
# ListBucket操作にはバケットARNが必要
Resource = "arn:aws:s3:::my-bucket"

# GetObject/PutObject/DeleteObject操作にはオブジェクトARNが必要
Resource = "arn:aws:s3:::my-bucket/*"

# 両方必要な場合は配列で指定
Resource = [
  "arn:aws:s3:::my-bucket",
  "arn:aws:s3:::my-bucket/*"
]
```

## ポリシーの評価順序

### 1. 明示的な拒否（Explicit Deny）

最優先。一つでもDenyがあればアクセス拒否。

### 2. 組織SCPによる制限

AWS Organizationsのサービスコントロールポリシー。

### 3. 明示的な許可（Explicit Allow）

バケットポリシーまたはIAMポリシーでのAllow。

### 4. デフォルト拒否（Default Deny）

明示的な許可がない場合は自動的に拒否。

```
評価フロー:
Explicit Deny? → Yes → アクセス拒否
     ↓ No
SCP Deny? → Yes → アクセス拒否
     ↓ No
Explicit Allow? → No → アクセス拒否（デフォルト）
     ↓ Yes
アクセス許可
```

## よく使用されるポリシーパターン

### 1. CloudFrontからのみアクセス許可

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity XXXXX"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-bucket/*"
    }
  ]
}
```

### 2. 特定IPアドレスからのアクセス制限

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowFromSpecificIP",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-bucket/*",
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": ["192.168.1.0/24", "10.0.0.0/16"]
        }
      }
    }
  ]
}
```

### 3. 暗号化の強制

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyUnencryptedObjectUploads",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-bucket/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        }
      }
    }
  ]
}
```

### 4. MFAの要求

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "RequireMFAForDelete",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:DeleteObject",
      "Resource": "arn:aws:s3:::my-bucket/*",
      "Condition": {
        "Bool": {
          "aws:MultiFactorAuthPresent": "false"
        }
      }
    }
  ]
}
```

## セキュリティベストプラクティス

### 1. 最小権限の原則

```hcl
# 良い例：必要最小限の権限
Action = ["s3:GetObject"]  # 読み取りのみ必要な場合

# 悪い例：過剰な権限
Action = ["s3:*"]  # 全ての操作を許可
```

### 2. 明示的な拒否の活用

```json
{
  "Statement": [
    {
      "Sid": "AllowSpecificActions",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:role/app-role"},
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Resource": "arn:aws:s3:::my-bucket/*"
    },
    {
      "Sid": "DenyDeleteActions",
      "Effect": "Deny",
      "Principal": "*",
      "Action": ["s3:DeleteBucket", "s3:DeleteBucketPolicy"],
      "Resource": "arn:aws:s3:::my-bucket"
    }
  ]
}
```

### 3. 条件の活用

```json
{
  "Condition": {
    "StringEquals": {
      "s3:x-amz-acl": "private"  # プライベートACLのみ許可
    },
    "DateGreaterThan": {
      "aws:CurrentTime": "2024-01-01T00:00:00Z"  # 特定日時以降のみ
    }
  }
}
```

### 4. ワイルドカードの慎重な使用

```json
// 良い例：特定のプレフィックス
"Resource": "arn:aws:s3:::my-bucket/uploads/*"

// 注意が必要：全てのオブジェクト
"Resource": "arn:aws:s3:::my-bucket/*"
```

## トラブルシューティング

### 1. アクセス拒否の診断

```bash
# CloudTrailでアクセス拒否の詳細を確認
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=GetObject \
  --query 'Events[?ErrorCode==`AccessDenied`]'
```

### 2. ポリシーシミュレーター

```bash
# IAMポリシーシミュレーターでテスト
aws iam simulate-principal-policy \
  --policy-source-arn arn:aws:iam::123456789012:role/my-role \
  --action-names s3:GetObject \
  --resource-arns arn:aws:s3:::my-bucket/test.txt
```

### 3. 一般的なエラーと対処

#### AccessDenied
- バケットポリシーとIAMポリシーの両方を確認
- パブリックアクセスブロック設定を確認
- リソースARNの記述ミスがないか確認

#### MalformedPolicy
- JSON構文エラーをチェック
- 必須フィールドの欠落を確認
- ポリシーサイズが20KB以下か確認

#### PolicyConflict
- 既存のポリシーとの競合を確認
- 明示的なDenyがないか確認

### 4. デバッグのヒント

```hcl
# Terraformでのポリシー検証
resource "aws_s3_bucket_policy" "example" {
  bucket = aws_s3_bucket.example.id
  
  # jsonencodeを使用してJSON構文エラーを防ぐ
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [...]
  })
}

# 出力で確認
output "bucket_policy" {
  value = aws_s3_bucket_policy.example.policy
}
```

## 関連

- [AWS S3 Bucket Policies](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html)
- [IAM Policy Language](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html)
- [S3 Access Control Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-best-practices.html)
- S3セキュリティチェックリスト