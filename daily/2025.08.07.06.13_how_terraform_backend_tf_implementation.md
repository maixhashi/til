# Terraformのbackend.tf実装パターン

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformプロジェクトでbackend.tfを実装するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにbackend.tfを実装するか
> 
> **Answer** : S3バックエンドとDynamoDBロックを使用し、Workspaceで環境を分離、CI/CDパイプラインで自動化する構成パターン

## 目次

<details>
<summary>目次を開く</summary>

- [Backend設定の詳細](#backend設定の詳細)
- [Workspace戦略](#workspace戦略)
- [状態ファイルの管理構造](#状態ファイルの管理構造)
- [GitHub Actionsとの統合](#github-actionsとの統合)
- [実際の運用フロー](#実際の運用フロー)

</details>

## Backend設定の詳細

### 設定ファイルの内容
```hcl
# backend.tf
terraform {
  backend "s3" {
    bucket               = "example-project-terraform-state"
    key                 = "terraform.tfstate"
    region              = "ap-northeast-1"
    encrypt             = true
    dynamodb_table      = "terraform-state-lock"
    workspace_key_prefix = "env:"
  }
}
```

### 各設定の役割と実装理由

| 設定項目 | 値 | 理由 |
|---------|-----|------|
| bucket | example-project-terraform-state | プロジェクト名を含む明確な命名 |
| key | terraform.tfstate | 標準的なファイル名を使用 |
| region | ap-northeast-1 | 東京リージョンで低レイテンシ |
| encrypt | true | セキュリティ要件を満たす |
| dynamodb_table | terraform-state-lock | 同時実行の防止 |
| workspace_key_prefix | env: | 環境別の明確な分離 |

## Workspace戦略

### 環境の定義
```hcl
# variables.tf
locals {
  environment = terraform.workspace == "default" ? "staging" : terraform.workspace
}
```

### Workspaceの使い分け

| Workspace | 環境 | 用途 | 自動実行タイミング |
|-----------|------|------|--------------------|
| default | staging | ステージング環境（開発用） | PRのplan |
| staging | staging | 明示的なステージング環境 | PRのplan |
| production | production | 本番環境 | デフォルトブランチへのマージ |

### 環境別設定の管理
```hcl
variable "environment_config" {
  default = {
    stg = {
      rds_instance_class  = "db.t3.small"
      ecs_task_cpu        = "256"
      ecs_task_memory     = "512"
      desired_count       = 1
      deletion_protection = false
    }
    prod = {
      rds_instance_class  = "db.t3.medium"
      ecs_task_cpu        = "512"
      ecs_task_memory     = "1024"
      desired_count       = 2
      deletion_protection = true
    }
  }
}
```

## 状態ファイルの管理構造

### S3での保存パス構造
```
s3://example-project-terraform-state/
├── terraform.tfstate           # defaultワークスペース
├── env:stg/
│   └── terraform.tfstate      # stgワークスペース
└── env:prod/
    └── terraform.tfstate      # prodワークスペース
```

### DynamoDBロックテーブル
```
Table: terraform-state-lock
├── LockID (Primary Key)
├── Info
└── TTL
```

**ロックの仕組み:**
1. `terraform plan/apply`実行時にロック取得
2. 他のプロセスは待機またはエラー
3. 処理完了後に自動的にロック解放

## GitHub Actionsとの統合

### ワークフロー設定
```yaml
# .github/workflows/terraform.yml
- name: Terraform Init
  working-directory: ${{ env.WORKING_DIR }}
  run: |
    terraform init
    terraform workspace select ${{ matrix.workspace }} || 
    terraform workspace new ${{ matrix.workspace }}
```

### 実行パターン

1. **Pull Request時**
   ```yaml
   strategy:
     matrix:
       workspace: [stg, prod]
   ```
   - 両環境でplanを実行
   - 変更内容をPRコメントに投稿

2. **mainブランチへのマージ時**
   ```yaml
   workspace: prod
   ```
   - prodワークスペースでapply実行
   - 本番環境への自動デプロイ

3. **手動実行時**
   ```yaml
   inputs:
     workspace:
       type: choice
       options: [stg, prod]
   ```
   - 選択した環境でplan/apply実行

## 実際の運用フロー

### 開発者のワークフロー

1. **ローカル開発**
   ```bash
   # 初期設定
   cd infra/terraform
   terraform init
   
   # ステージング環境で作業
   terraform workspace select stg
   terraform plan
   ```

2. **PR作成**
   - GitHubにPushすると自動でplan実行
   - stgとprod両方の変更内容を確認

3. **本番デプロイ**
   - PRをmainにマージ
   - 自動的にprod環境にapply

### 環境別のアクセス方法

```bash
# ステージング環境の確認
terraform workspace select stg
terraform state list

# 本番環境の確認
terraform workspace select prod
terraform state list
```

### トラブルシューティング

**ロックエラーの対処:**
```bash
# ロックの強制解除（慎重に使用）
terraform force-unlock <LOCK_ID>
```

**状態ファイルの確認:**
```bash
# S3から直接ダウンロード
aws s3 cp s3://example-project-terraform-state/env:prod/terraform.tfstate ./
```

## 関連
- [Terraform S3 Backend Documentation](https://www.terraform.io/docs/language/settings/backends/s3.html)
- [Terraform Workspaces Guide](https://www.terraform.io/docs/language/state/workspaces.html)
- [GitHub Actions with Terraform](https://learn.hashicorp.com/tutorials/terraform/github-actions)