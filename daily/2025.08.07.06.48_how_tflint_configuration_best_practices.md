# TFLintの設定方法とベストプラクティス

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformプロジェクトでTFLintを設定するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTFLintを設定するか
> 
> **Answer** : `.tflint.hcl`ファイルでAWSプラグインと各種Terraformコーディング規約ルールを有効化し、プロジェクトの要件に合わせたカスタマイズを行う

## 目次

<details>
<summary>目次を開く</summary>

- [設定ファイルの配置](#設定ファイルの配置)
- [AWSプラグインの設定方法](#awsプラグインの設定方法)
- [基本ルールの設定方法](#基本ルールの設定方法)
- [プロジェクト固有の設定](#プロジェクト固有の設定)
- [ルールの有効化・無効化の判断基準](#ルールの有効化無効化の判断基準)
- [設定の適用方法](#設定の適用方法)

</details>

## 設定ファイルの配置

TFLintの設定ファイルは一般的に以下のような場所に配置します：

```
# プロジェクトルートに配置
.tflint.hcl

# またはTerraformコードのディレクトリに配置
terraform/.tflint.hcl
```

Terraformコードと同じディレクトリに配置することで、簡単にTFLintを実行できます。

## AWSプラグインの設定方法

### 1. プラグインブロックの定義

```hcl
plugin "aws" {
  enabled = true
  version = "0.24.0"
  source  = "github.com/terraform-linters/tflint-ruleset-aws"
}
```

### 2. 設定のポイント

- **バージョン固定**: 再現性のためバージョンを明示的に指定
- **ソース指定**: 公式のAWSルールセットを使用
- **有効化**: `enabled = true`で明示的に有効化

## 基本ルールの設定方法

### 1. ドキュメント化ルール

```hcl
rule "terraform_documented_outputs" {
  enabled = true
}

rule "terraform_documented_variables" {
  enabled = true
}
```

すべての変数と出力にdescriptionを必須化します。

### 2. 命名規則ルール

```hcl
rule "terraform_naming_convention" {
  enabled = true
}
```

Terraformの標準命名規則（snake_case）を強制します。

### 3. コメント構文ルール

```hcl
rule "terraform_comment_syntax" {
  enabled = true
}
```

`#`ではなく`//`を使用するよう統一します。

## プロジェクト固有の設定

### 1. モジュール構造ルールのカスタマイズ

```hcl
rule "terraform_standard_module_structure" {
  enabled = false  # カスタムモジュール構造を使用する場合
}
```

標準的なモジュール構造を使用しない場合は、このルールを無効化できます。

### 2. モジュールソースの固定

```hcl
rule "terraform_module_pinned_source" {
  enabled = true
  style = "flexible"
}
```

- モジュールソースのバージョン固定を要求
- `style = "flexible"`で柔軟な記述方法を許可

### 3. 設定の注意点

ルールの重複定義に注意してください。同じルールを複数回定義すると、最後の定義が優先されます。

## ルールの有効化・無効化の判断基準

### 有効化すべきルール

1. **品質向上に寄与**
   - ドキュメント化ルール
   - 型付き変数ルール
   - 未使用宣言の検出

2. **セキュリティ強化**
   - AWS固有のセキュリティルール
   - 無効なリソース設定の検出

3. **保守性向上**
   - 命名規則の統一
   - バージョン管理の強制

### 無効化の判断基準

以下のような場合にルールを無効化することを検討します：

- プロジェクトのコーディング規約と競合する場合
- チームで合意した例外ルールがある場合
- 既存コードとの互換性を保つ必要がある場合

## 設定の適用方法

### 1. TFLintの実行

```bash
# 設定ファイルのあるディレクトリで実行
cd <terraform-directory>
tflint
```

### 2. 特定のディレクトリで実行

```bash
tflint --config=.tflint.hcl path/to/terraform/code
```

### 3. CI/CDでの活用

CI/CDパイプラインで自動実行することで、コード品質を継続的にチェックできます。

```yaml
# GitHub Actionsの例
- name: TFLint
  uses: terraform-linters/setup-tflint@v1
- run: tflint
```

## 関連

- [TFLint公式ドキュメント](https://github.com/terraform-linters/tflint)
- [AWS Provider Plugin](https://github.com/terraform-linters/tflint-ruleset-aws)
- [TFLint Rules](https://github.com/terraform-linters/tflint/tree/master/docs/rules)
- [Best Practices for Terraform Code Quality](https://www.terraform.io/docs/cloud/guides/recommended-practices/)