# Terraform AWS Subnetリソース完全リファレンス

## What's this file?

> [!NOTE]
> **What**
> 
> Terraform AWS Provider の aws_subnet リソースとは何かについて記載しています。

## Conclusion (忙しいとき向け)

> [!IMPORTANT]
> **What** : aws_subnet リソースとは何か
> 
> **Answer** : VPC内にサブネットを作成・管理するためのTerraformリソース。IPアドレス範囲、アベイラビリティゾーン、パブリック/プライベートの設定など、ネットワークセグメントの詳細な制御が可能

## 目次

<details>
<summary>目次を開く</summary>

- [1. aws_subnet リソースの基本](#1-aws_subnet-リソースの基本)
- [2. 引数（Arguments）詳細](#2-引数arguments詳細)
- [3. 属性（Attributes）詳細](#3-属性attributes詳細)
- [4. 実装パターンと使用例](#4-実装パターンと使用例)
- [5. ベストプラクティスと注意点](#5-ベストプラクティスと注意点)

</details>

## 1. aws_subnet リソースの基本

### 基本的な使用例

```hcl
# 単一のサブネット作成
resource "aws_subnet" "example" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"
  
  tags = {
    Name = "Main subnet"
  }
}
```

### パブリック/プライベートサブネットの作成

```hcl
# パブリックサブネット
resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "ap-northeast-1a"
  map_public_ip_on_launch = true  # パブリックIPの自動割り当て
  
  tags = {
    Name = "Public Subnet"
    Type = "public"
  }
}

# プライベートサブネット
resource "aws_subnet" "private" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.2.0/24"
  availability_zone       = "ap-northeast-1a"
  map_public_ip_on_launch = false  # デフォルトでfalse
  
  tags = {
    Name = "Private Subnet"
    Type = "private"
  }
}
```

## 2. 引数（Arguments）詳細

### 必須引数

| 引数名 | 型 | 説明 |
|--------|-----|------|
| `vpc_id` | string | サブネットを作成するVPCのID |
| `cidr_block` または `ipv6_cidr_block` | string | サブネットのCIDRブロック（どちらか一つは必須） |

### オプション引数

| 引数名 | 型 | デフォルト値 | 説明 |
|--------|-----|-------------|------|
| `availability_zone` | string | - | サブネットを作成するアベイラビリティゾーン |
| `availability_zone_id` | string | - | アベイラビリティゾーンのID |
| `cidr_block` | string | - | IPv4 CIDRブロック |
| `ipv6_cidr_block` | string | - | IPv6 CIDRブロック |
| `ipv6_native` | bool | false | IPv6専用サブネットとして作成 |
| `map_public_ip_on_launch` | bool | false | 起動時にパブリックIPを自動割り当て |
| `map_customer_owned_ip_on_launch` | bool | false | カスタマー所有IPを起動時に割り当て |
| `customer_owned_ipv4_pool` | string | - | カスタマー所有IPv4アドレスプール |
| `enable_dns64` | bool | false | DNS64を有効化（IPv6専用サブネット用） |
| `enable_resource_name_dns_aaaa_record_on_launch` | bool | false | AAAAレコードの自動作成を有効化 |
| `enable_resource_name_dns_a_record_on_launch` | bool | false | Aレコードの自動作成を有効化 |
| `private_dns_hostname_type_on_launch` | string | - | プライベートDNSホスト名のタイプ |
| `assign_ipv6_address_on_creation` | bool | false | 作成時にIPv6アドレスを割り当て |
| `outpost_arn` | string | - | AWS OutpostのARN |
| `tags` | map(string) | - | リソースに付与するタグ |

### 引数の詳細説明

#### availability_zone と availability_zone_id の違い

```hcl
# availability_zone を使用（推奨）
resource "aws_subnet" "example1" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.1.0/24"
  availability_zone = "ap-northeast-1a"  # リージョン固有の名前
}

# availability_zone_id を使用（複数リージョンで同じIDを使う場合）
resource "aws_subnet" "example2" {
  vpc_id              = aws_vpc.main.id
  cidr_block          = "10.0.2.0/24"
  availability_zone_id = "apne1-az1"  # リージョンに依存しないID
}
```

#### IPv6サポート

```hcl
# IPv4とIPv6のデュアルスタック
resource "aws_subnet" "dual_stack" {
  vpc_id                          = aws_vpc.main.id
  cidr_block                      = "10.0.1.0/24"
  ipv6_cidr_block                 = cidrsubnet(aws_vpc.main.ipv6_cidr_block, 8, 1)
  assign_ipv6_address_on_creation = true
  
  tags = {
    Name = "Dual Stack Subnet"
  }
}

# IPv6専用サブネット
resource "aws_subnet" "ipv6_only" {
  vpc_id          = aws_vpc.main.id
  ipv6_cidr_block = cidrsubnet(aws_vpc.main.ipv6_cidr_block, 8, 2)
  ipv6_native     = true
  enable_dns64    = true  # IPv6からIPv4への変換を有効化
  
  tags = {
    Name = "IPv6 Only Subnet"
  }
}
```

#### DNS設定

```hcl
resource "aws_subnet" "with_dns_records" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"
  
  # EC2インスタンスのDNSレコード自動作成
  enable_resource_name_dns_a_record_on_launch    = true
  enable_resource_name_dns_aaaa_record_on_launch = true
  private_dns_hostname_type_on_launch            = "ip-name"
  
  tags = {
    Name = "Subnet with DNS Records"
  }
}
```

## 3. 属性（Attributes）詳細

### 読み取り専用属性

| 属性名 | 型 | 説明 |
|--------|-----|------|
| `id` | string | サブネットのID |
| `arn` | string | サブネットのARN |
| `ipv6_cidr_block_association_id` | string | IPv6 CIDRブロックの関連付けID |
| `owner_id` | string | サブネットを所有するAWSアカウントID |
| `available_ip_address_count` | number | 利用可能なIPアドレス数 |
| `ipv6_cidr_block` | string | 割り当てられたIPv6 CIDRブロック |
| `ipv6_native` | bool | IPv6専用サブネットかどうか |
| `map_public_ip_on_launch` | bool | パブリックIP自動割り当て設定 |
| `tags_all` | map(string) | デフォルトタグを含むすべてのタグ |

### 属性の使用例

```hcl
resource "aws_subnet" "example" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"
}

# 他のリソースでサブネット属性を参照
resource "aws_instance" "example" {
  subnet_id = aws_subnet.example.id  # サブネットIDを参照
}

output "subnet_info" {
  value = {
    subnet_id    = aws_subnet.example.id
    subnet_arn   = aws_subnet.example.arn
    available_ips = aws_subnet.example.available_ip_address_count
  }
}
```

## 4. 実装パターンと使用例

### マルチAZ構成

```hcl
# 利用可能なAZを取得
data "aws_availability_zones" "available" {
  state = "available"
}

# 各AZにサブネットを作成
resource "aws_subnet" "public" {
  count = length(data.aws_availability_zones.available.names)
  
  vpc_id                  = aws_vpc.main.id
  cidr_block              = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index)
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = true
  
  tags = {
    Name = "Public Subnet ${count.index + 1}"
    Type = "public"
    AZ   = data.aws_availability_zones.available.names[count.index]
  }
}

resource "aws_subnet" "private" {
  count = length(data.aws_availability_zones.available.names)
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index + 100)
  availability_zone = data.aws_availability_zones.available.names[count.index]
  
  tags = {
    Name = "Private Subnet ${count.index + 1}"
    Type = "private"
    AZ   = data.aws_availability_zones.available.names[count.index]
  }
}
```

### 環境別サブネット設定

```hcl
locals {
  environment = "production"
  
  subnet_configs = {
    development = {
      public_cidrs  = ["10.0.1.0/24", "10.0.2.0/24"]
      private_cidrs = ["10.0.11.0/24", "10.0.12.0/24"]
      enable_public_ip = true
    }
    production = {
      public_cidrs  = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
      private_cidrs = ["10.0.11.0/24", "10.0.12.0/24", "10.0.13.0/24"]
      enable_public_ip = false  # 本番環境では自動割り当てを無効化
    }
  }
  
  config = local.subnet_configs[local.environment]
}

# 動的にサブネットを作成
resource "aws_subnet" "public" {
  count = length(local.config.public_cidrs)
  
  vpc_id                  = aws_vpc.main.id
  cidr_block              = local.config.public_cidrs[count.index]
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = local.config.enable_public_ip
  
  tags = {
    Name        = "${local.environment}-public-subnet-${count.index + 1}"
    Environment = local.environment
    Type        = "public"
  }
}
```

### データベース専用サブネット

```hcl
# RDS用のサブネット（マルチAZ対応）
resource "aws_subnet" "database" {
  count = 2  # RDSサブネットグループには最低2つのAZが必要
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index + 200)
  availability_zone = data.aws_availability_zones.available.names[count.index]
  
  tags = {
    Name = "Database Subnet ${count.index + 1}"
    Type = "database"
    AZ   = data.aws_availability_zones.available.names[count.index]
  }
}

# RDSサブネットグループ
resource "aws_db_subnet_group" "main" {
  name       = "main-db-subnet-group"
  subnet_ids = aws_subnet.database[*].id
  
  tags = {
    Name = "Main DB subnet group"
  }
}
```

### AWS Outpost用サブネット

```hcl
# Outpost環境でのサブネット
resource "aws_subnet" "outpost" {
  vpc_id      = aws_vpc.main.id
  cidr_block  = "10.0.100.0/24"
  outpost_arn = var.outpost_arn
  
  tags = {
    Name = "Outpost Subnet"
    Type = "outpost"
  }
}
```

## 5. ベストプラクティスと注意点

### CIDRブロックの計画

```hcl
# 効率的なCIDRブロック割り当て
locals {
  vpc_cidr = "10.0.0.0/16"  # 65,536 IPアドレス
  
  # サブネットサイズの計画
  # /24 = 256 IPアドレス（実際に使用可能: 251）
  # /25 = 128 IPアドレス（実際に使用可能: 123）
  # /26 = 64 IPアドレス（実際に使用可能: 59）
  # /27 = 32 IPアドレス（実際に使用可能: 27）
  # /28 = 16 IPアドレス（実際に使用可能: 11）
  
  subnet_cidrs = {
    public = [
      cidrsubnet(local.vpc_cidr, 4, 0),  # 10.0.0.0/20 (4,096 IPs)
      cidrsubnet(local.vpc_cidr, 4, 1),  # 10.0.16.0/20
      cidrsubnet(local.vpc_cidr, 4, 2),  # 10.0.32.0/20
    ]
    private = [
      cidrsubnet(local.vpc_cidr, 4, 8),  # 10.0.128.0/20
      cidrsubnet(local.vpc_cidr, 4, 9),  # 10.0.144.0/20
      cidrsubnet(local.vpc_cidr, 4, 10), # 10.0.160.0/20
    ]
    database = [
      cidrsubnet(local.vpc_cidr, 6, 48), # 10.0.192.0/22 (1,024 IPs)
      cidrsubnet(local.vpc_cidr, 6, 52), # 10.0.208.0/22
    ]
  }
}
```

### タグ付けの標準化

```hcl
locals {
  common_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = "terraform"
    CreatedAt   = timestamp()
  }
  
  subnet_name_format = {
    public   = "${var.project_name}-public-subnet"
    private  = "${var.project_name}-private-subnet"
    database = "${var.project_name}-db-subnet"
  }
}

resource "aws_subnet" "subnets" {
  for_each = var.subnet_configs
  
  vpc_id                  = aws_vpc.main.id
  cidr_block              = each.value.cidr_block
  availability_zone       = each.value.availability_zone
  map_public_ip_on_launch = each.value.type == "public" ? true : false
  
  tags = merge(local.common_tags, {
    Name = "${local.subnet_name_format[each.value.type]}-${each.value.availability_zone}"
    Type = each.value.type
    Tier = each.value.tier
  })
}
```

### 変更時の注意点

```hcl
# サブネットの変更は再作成を伴う場合がある
resource "aws_subnet" "example" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"  # 変更すると再作成
  
  # availability_zone の変更も再作成を伴う
  availability_zone = "ap-northeast-1a"
  
  # これらの設定は変更可能（再作成なし）
  map_public_ip_on_launch = true
  tags = {
    Name = "Example Subnet"
  }
  
  lifecycle {
    # 重要なサブネットは削除保護
    prevent_destroy = true
  }
}
```

### エラー処理とバリデーション

```hcl
# 入力値の検証
variable "subnet_cidr" {
  type        = string
  description = "CIDR block for the subnet"
  
  validation {
    condition = can(cidrhost(var.subnet_cidr, 0))
    error_message = "有効なCIDRブロックを指定してください。"
  }
}

# 条件付きサブネット作成
resource "aws_subnet" "conditional" {
  count = var.create_subnet ? 1 : 0
  
  vpc_id     = aws_vpc.main.id
  cidr_block = var.subnet_cidr
  
  tags = {
    Name = "Conditional Subnet"
  }
}
```

## 関連

- [AWS VPC Subnet Documentation](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html)
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [なぜALBはパブリックサブネットに配置する必要があるのか](./2025.08.04.15.34_why_alb_must_assign_in_public_subnet.md)
- [プライベートサブネット間の接続方法](./2025.08.04.15.27_how_connect_between_private_subnets.md)