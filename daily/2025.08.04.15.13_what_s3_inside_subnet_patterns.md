# S3がサブネット内に配置されるパターン

## What's this file?
> [!NOTE]
> **What**
> 
> S3がサブネット内に配置されるパターンとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : S3がサブネット内に配置されるパターンとは何か
> 
> **Answer** : S3自体はサブネット内に配置されることはないが、S3と同等の機能を提供するサービスがVPC内に配置されるパターンが存在する

## 目次

<details>
<summary>目次を開く</summary>

- [S3の基本的な配置制約](#s3の基本的な配置制約)
- [VPC内でS3互換サービスを実現するパターン](#vpc内でs3互換サービスを実現するパターン)
- [AWS Outposts S3](#aws-outposts-s3)
- [S3 File Gatewayパターン](#s3-file-gatewayパターン)
- [使用シナリオと選択基準](#使用シナリオと選択基準)

</details>

## S3の基本的な配置制約

### S3がサブネット内に配置できない理由

```mermaid
graph TB
    subgraph "AWS マネージドインフラ"
        S3[S3<br/>グローバルサービス]
    end
    
    subgraph "お客様のVPC"
        subgraph "サブネット"
            EC2[EC2インスタンス]
            RDS[RDSインスタンス]
        end
    end
    
    S3 -.->|アクセスのみ| EC2
    
    style S3 fill:#ff9,stroke:#f00,stroke-width:4px,stroke-dasharray: 5 5
    style EC2 fill:#9f9,stroke:#333,stroke-width:2px
    style RDS fill:#99f,stroke:#333,stroke-width:2px
```

- **グローバルサービス**: S3はリージョナルサービスとして設計
- **マルチテナント**: 複数の顧客で共有されるインフラ
- **抽象化レベル**: VPCの概念より上位で動作

## VPC内でS3互換サービスを実現するパターン

### パターン1: AWS Outposts S3

```mermaid
graph LR
    subgraph "オンプレミス環境"
        subgraph "AWS Outposts"
            OS3[Outposts S3<br/>ローカルストレージ]
            OEC2[EC2インスタンス]
        end
    end
    
    subgraph "AWS リージョン"
        S3[S3<br/>リージョナルサービス]
    end
    
    OEC2 --> OS3
    OS3 <--> S3
    
    style OS3 fill:#9f9,stroke:#333,stroke-width:3px
    style S3 fill:#ff9,stroke:#333,stroke-width:2px
```

### パターン2: Storage Gateway - File Gateway

```mermaid
graph TD
    subgraph "VPC内"
        subgraph "プライベートサブネット"
            FG[File Gateway<br/>EC2インスタンス]
            APP[アプリケーション]
        end
    end
    
    subgraph "AWS グローバル"
        S3[S3バケット]
    end
    
    APP -->|NFS/SMB| FG
    FG <-->|HTTPS| S3
    FG -->|キャッシュ| CACHE[(ローカル<br/>キャッシュ)]
    
    style FG fill:#9f9,stroke:#333,stroke-width:3px
    style S3 fill:#ff9,stroke:#333,stroke-width:2px
```

### パターン3: MinIO等のS3互換ストレージ

```mermaid
graph LR
    subgraph "VPC内"
        subgraph "プライベートサブネット"
            MINIO[MinIO<br/>S3互換API]
            EBS[(EBSボリューム)]
            APP[アプリケーション]
        end
    end
    
    APP -->|S3 API| MINIO
    MINIO --> EBS
    
    style MINIO fill:#9f9,stroke:#333,stroke-width:3px
    style EBS fill:#ccf,stroke:#333,stroke-width:2px
```

## AWS Outposts S3

### 特徴と制約
- **物理的な配置**: オンプレミス環境にAWSインフラを設置
- **ローカルデータ処理**: データがオンプレミスに保持される
- **容量制限**: Outpostsのハードウェア容量に依存
- **管理**: AWSによるフルマネージド

### ユースケース
1. **データレジデンシー要件**: データを特定の場所に保持する必要がある
2. **低レイテンシー要求**: ローカルでの高速アクセスが必要
3. **オフライン動作**: インターネット接続が不安定な環境

## S3 File Gatewayパターン

### アーキテクチャ詳細

```mermaid
sequenceDiagram
    participant App as アプリケーション
    participant FG as File Gateway
    participant Cache as ローカルキャッシュ
    participant S3 as S3バケット
    
    App->>FG: ファイル読み込み要求
    FG->>Cache: キャッシュ確認
    alt キャッシュヒット
        Cache->>FG: データ返却
    else キャッシュミス
        FG->>S3: データ取得
        S3->>FG: データ返却
        FG->>Cache: キャッシュ保存
    end
    FG->>App: データ返却
```

### 主な特徴
- **プロトコル変換**: NFS/SMBをS3 APIに変換
- **キャッシュ機能**: 頻繁にアクセスされるデータをローカル保存
- **透過的アクセス**: アプリケーションからは通常のファイルシステムとして見える

## 使用シナリオと選択基準

### 選択フローチャート

```mermaid
graph TD
    Start[S3互換ストレージが必要]
    
    Start --> Q1{データレジデンシー<br/>要件あり？}
    Q1 -->|Yes| Outposts[AWS Outposts S3]
    Q1 -->|No| Q2{既存アプリの<br/>互換性必要？}
    
    Q2 -->|Yes| Q3{NFS/SMB<br/>プロトコル必要？}
    Q3 -->|Yes| FileGW[File Gateway]
    Q3 -->|No| Q4{完全な<br/>S3互換API必要？}
    
    Q2 -->|No| S3Direct[通常のS3 +<br/>VPCエンドポイント]
    
    Q4 -->|Yes| MinIO[MinIO等の<br/>S3互換ストレージ]
    Q4 -->|No| Custom[カスタム実装]
    
    style Outposts fill:#f9f,stroke:#333,stroke-width:2px
    style FileGW fill:#9f9,stroke:#333,stroke-width:2px
    style S3Direct fill:#ff9,stroke:#333,stroke-width:2px
    style MinIO fill:#9ff,stroke:#333,stroke-width:2px
```

### 比較表

| パターン | 配置場所 | S3互換性 | 管理負荷 | コスト |
|---------|---------|----------|---------|--------|
| AWS Outposts S3 | オンプレミス | 完全互換 | 低（AWSマネージド） | 高 |
| File Gateway | VPC内 | プロトコル変換 | 中 | 中 |
| MinIO | VPC内 | API互換 | 高（自己管理） | 低 |
| 通常のS3 | AWS管理 | ネイティブ | なし | 使用量課金 |

## 関連
- [AWS Outposts公式ドキュメント](https://docs.aws.amazon.com/outposts/)
- [AWS Storage Gateway ドキュメント](https://docs.aws.amazon.com/storagegateway/)
- [MinIO公式サイト](https://min.io/)
- [S3 VPCエンドポイント設定ガイド](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html)