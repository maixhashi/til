# RDSパスワードをSecrets Managerで安全に管理する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにRDSのマスターパスワードをSecrets Managerで安全に管理するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにRDSパスワードをセキュアに管理するか
> 
> **Answer** : Terraformのrandom_passwordリソースで生成し、Secrets Managerに保存。RDSクラスターは生成されたパスワードを参照する設定にする。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 問題点](#1-問題点)
- [2. 解決方法](#2-解決方法)
- [3. 実装手順](#3-実装手順)
  - [3.1 Secrets Managerの設定](#31-secrets-managerの設定)
  - [3.2 RDSクラスターの修正](#32-rdsクラスターの修正)
- [4. 実装コード](#4-実装コード)
- [5. パスワードの取得方法](#5-パスワードの取得方法)
- [6. ベストプラクティス](#6-ベストプラクティス)
- [7. 注意事項](#7-注意事項)

</details>

## 1. 問題点

ハードコーディングされたパスワードの問題：
- **セキュリティリスク**: ソースコードに平文パスワードが露出
- **Git履歴**: 一度コミットすると履歴に永続的に残る
- **アクセス制御**: リポジトリアクセス権を持つ全員が閲覧可能
- **ローテーション困難**: パスワード変更が困難

## 2. 解決方法

AWS Secrets Managerを使用した安全な管理：
1. ランダムパスワードの自動生成
2. Secrets Managerへの安全な保存
3. 必要に応じたアクセス制御
4. 監査ログの記録

## 3. 実装手順

### 3.1 Secrets Managerの設定

以下のリソースを追加：
- `aws_secretsmanager_secret`: シークレットの定義
- `random_password`: ランダムパスワード生成
- `aws_secretsmanager_secret_version`: パスワードの保存

### 3.2 RDSクラスターの修正

`master_password`をハードコーディングから参照に変更

## 4. 実装コード

**aws_secretsmanager_secrets.tf**:
```hcl
# Secrets Manager - RDS Master Password
resource "aws_secretsmanager_secret" "rds_master_password" {
  name = "${var.project_name}-rds-master-password-${var.environment}"
  description = "Master password for RDS cluster"

  tags = {
    Name = "${var.project_name}-rds-master-password-${var.environment}"
  }
}

# Generate random password for RDS
resource "random_password" "rds_master" {
  length  = 32
  special = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}

# Store the password in Secrets Manager
resource "aws_secretsmanager_secret_version" "rds_master_password" {
  secret_id     = aws_secretsmanager_secret.rds_master_password.id
  secret_string = random_password.rds_master.result
}
```

**aws_rds_cluster.tf**:
```hcl
resource "aws_rds_cluster" "example" {
  cluster_identifier     = "${var.project_name}-${var.environment}"
  engine                 = "aurora-postgresql"
  engine_mode            = "provisioned"
  engine_version         = "15.4"
  database_name          = "example_project"
  master_username        = "postgres"
  master_password        = random_password.rds_master.result  # Secrets Manager参照
  # ... 他の設定
}
```

## 5. パスワードの取得方法

### AWS CLIでの取得
```bash
aws secretsmanager get-secret-value \
  --secret-id example-project-rds-master-password-production \
  --query SecretString \
  --output text
```

### アプリケーションからの取得
```javascript
// Node.js SDK例
const AWS = require('aws-sdk');
const client = new AWS.SecretsManager();

const getSecret = async () => {
  const data = await client.getSecretValue({
    SecretId: 'example-project-rds-master-password-production'
  }).promise();
  
  return data.SecretString;
};
```

## 6. ベストプラクティス

1. **最小権限の原則**
   - Secrets Managerへのアクセスは必要最小限に
   - IAMロールベースのアクセス制御

2. **ローテーション**
   - 定期的なパスワードローテーションの設定
   - 自動ローテーション機能の活用

3. **監査**
   - CloudTrailでアクセスログを記録
   - 異常なアクセスパターンの監視

4. **暗号化**
   - Secrets Manager自体がKMSで暗号化
   - 転送時もTLSで保護

## 7. 注意事項

1. **初回適用時の注意**
   - 既存のRDSクラスターがある場合、パスワード変更が発生
   - メンテナンスウィンドウでの実施推奨

2. **Terraformステート**
   - random_passwordの値がステートファイルに保存される
   - ステートファイルも安全に管理（S3 + KMS暗号化）

3. **削除保護**
   - Secrets Managerのシークレットは即座に削除されない
   - デフォルト7日間の削除待機期間

4. **コスト**
   - Secrets Managerは月額$0.40/シークレット
   - APIコール数に応じた追加料金

5. **依存関係**
   - RDSクラスターより先にSecrets Managerが作成される
   - 削除時は逆順で処理

## 関連
- [AWS RDS Cluster設定](/Users/username/example-project-app/infra/terraform/server/aws_rds_cluster.tf)
- [Secrets Manager設定](/Users/username/example-project-app/infra/terraform/server/aws_secretsmanager_secrets.tf)
- [IAMロール設定](/Users/username/example-project-app/infra/terraform/server/aws_iam_role.tf)