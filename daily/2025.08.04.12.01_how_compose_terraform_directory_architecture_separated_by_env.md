# Terraform環境別ディレクトリ構成の最適化

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformの環境別ディレクトリ構成を最適化するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTerraformの環境別ディレクトリ構成を最適化するか
> 
> **Answer** : ワークスペース機能と環境別tfvarsファイルを組み合わせ、モジュール化とDRY原則に従った階層構造を採用する

## 目次

<details>
<summary>目次を開く</summary>

- [1. 推奨ディレクトリ構造](#1-推奨ディレクトリ構造)
- [2. 環境分離の手法](#2-環境分離の手法)
- [3. モジュール設計](#3-モジュール設計)
- [4. 変数管理のベストプラクティス](#4-変数管理のベストプラクティス)
- [5. 状態ファイル管理](#5-状態ファイル管理)
- [6. CI/CD統合](#6-cicd統合)

</details>

## 1. 推奨ディレクトリ構造

### 基本構造
```
terraform/
├── environments/          # 環境別設定
│   ├── prod/
│   │   ├── backend.tf
│   │   ├── main.tf
│   │   └── terraform.tfvars
│   └── stg/
│       ├── backend.tf
│       ├── main.tf
│       └── terraform.tfvars
├── modules/              # 再利用可能なモジュール
│   ├── network/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── compute/
│   └── database/
├── global/               # 環境共通リソース
│   └── iam/
└── scripts/              # ヘルパースクリプト
```

### ワークスペース利用時の構造
```
terraform/
├── main.tf
├── variables.tf
├── outputs.tf
├── backend.tf
├── environments/
│   ├── prod.tfvars
│   └── stg.tfvars
└── modules/
```

## 2. 環境分離の手法

### 方法1: ディレクトリ分離
```hcl
# environments/prod/main.tf
module "network" {
  source = "../../modules/network"
  
  environment = "prod"
  vpc_cidr    = "10.0.0.0/16"
}
```

### 方法2: Workspaceとtfvars
```bash
# ワークスペース作成
terraform workspace new prod
terraform workspace new stg

# 環境別適用
terraform workspace select prod
terraform apply -var-file=environments/prod.tfvars
```

### 方法3: Terragrunt利用
```hcl
# terragrunt.hcl
inputs = {
  environment = local.environment
  region      = local.region
}

terraform {
  source = "../../../modules//app"
}
```

## 3. モジュール設計

### モジュール構造
```hcl
# modules/network/main.tf
resource "aws_vpc" "main" {
  cidr_block = var.vpc_cidr
  
  tags = {
    Name        = "${var.project}-${var.environment}-vpc"
    Environment = var.environment
  }
}

# modules/network/variables.tf
variable "environment" {
  description = "環境名"
  type        = string
}

variable "vpc_cidr" {
  description = "VPC CIDR"
  type        = string
}

# modules/network/outputs.tf
output "vpc_id" {
  value = aws_vpc.main.id
}
```

## 4. 変数管理のベストプラクティス

### 環境共通変数
```hcl
# variables.tf
variable "project" {
  default = "myapp"
}

variable "environment" {
  description = "環境名"
}

# 環境別マッピング
locals {
  env_config = {
    prod = {
      instance_type = "t3.large"
      min_size      = 2
      max_size      = 10
    }
    stg = {
      instance_type = "t3.small"
      min_size      = 1
      max_size      = 3
    }
  }
  
  config = local.env_config[var.environment]
}
```

### 環境別変数ファイル
```hcl
# environments/prod.tfvars
environment     = "prod"
vpc_cidr       = "10.0.0.0/16"
instance_count = 3
enable_backup  = true

# environments/stg.tfvars
environment     = "stg"
vpc_cidr       = "10.1.0.0/16"
instance_count = 1
enable_backup  = false
```

## 5. 状態ファイル管理

### S3バックエンド設定
```hcl
# backend.tf
terraform {
  backend "s3" {
    bucket         = "terraform-state-bucket"
    key            = "${var.project}/${terraform.workspace}/terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
  }
}
```

### 環境別バックエンド
```hcl
# environments/prod/backend.tf
terraform {
  backend "s3" {
    bucket = "prod-terraform-state"
    key    = "app/terraform.tfstate"
    region = "ap-northeast-1"
  }
}
```

## 6. CI/CD統合

### GitHub Actions例
```yaml
name: Terraform Apply

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [stg, prod]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        
      - name: Terraform Init
        run: terraform init
        
      - name: Select Workspace
        run: terraform workspace select ${{ matrix.environment }}
        
      - name: Terraform Apply
        run: terraform apply -auto-approve -var-file=environments/${{ matrix.environment }}.tfvars
```

### Makefile利用
```makefile
.PHONY: init plan apply

ENV ?= stg

init:
	terraform init
	terraform workspace select $(ENV) || terraform workspace new $(ENV)

plan:
	terraform plan -var-file=environments/$(ENV).tfvars

apply:
	terraform apply -var-file=environments/$(ENV).tfvars
```

## 関連
- [HashiCorp Learn - Terraform Workspaces](https://learn.hashicorp.com/tutorials/terraform/organize-configuration)
- [Terraform Best Practices](https://www.terraform-best-practices.com/)
- [Terragrunt](https://terragrunt.gruntwork.io/)
- [ベストな Terraform ディレクトリ構成を考察してみた - Speaker Deck](https://speakerdeck.com/harukasakihara/besutona-terraform-deirekutorigou-cheng-wokao-cha-sitemita)