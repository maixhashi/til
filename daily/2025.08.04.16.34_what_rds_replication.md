# RDSレプリケーションとは

## What's this file?
> [!NOTE]
> **What**
> 
> RDSレプリケーションとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : RDSレプリケーションとは何か
> 
> **Answer** : プライマリDBインスタンスのデータを1つ以上のレプリカに複製する仕組み。Multi-AZによる高可用性とリードレプリカによる読み取り性能向上の2種類があり、それぞれ同期・非同期でデータを複製する

## 目次

<details>
<summary>目次を開く</summary>

- [RDSレプリケーションの種類](#rdsレプリケーションの種類)
- [Multi-AZレプリケーション](#multi-azレプリケーション)
- [リードレプリカ](#リードレプリカ)
- [レプリケーション方式の比較と選択](#レプリケーション方式の比較と選択)

</details>

## RDSレプリケーションの種類

### 2つの主要なレプリケーション方式

```mermaid
graph TB
    subgraph "RDSレプリケーション"
        subgraph "Multi-AZ配置"
            MAZ[同期レプリケーション<br/>自動フェイルオーバー<br/>高可用性目的]
        end
        
        subgraph "リードレプリカ"
            RR[非同期レプリケーション<br/>読み取り負荷分散<br/>スケーラビリティ目的]
        end
    end
    
    subgraph "用途"
        HA[高可用性<br/>災害復旧]
        PERF[パフォーマンス<br/>読み取りスケール]
    end
    
    MAZ --> HA
    RR --> PERF
    
    style MAZ fill:#ff9,stroke:#333,stroke-width:3px
    style RR fill:#9ff,stroke:#333,stroke-width:3px
```

### レプリケーションの基本概念

| 特性 | Multi-AZ | リードレプリカ |
|------|----------|---------------|
| レプリケーション方式 | 同期 | 非同期 |
| 目的 | 高可用性・耐障害性 | 読み取り性能向上 |
| フェイルオーバー | 自動（1-2分） | 手動昇格可能 |
| 読み取り可能 | スタンバイは不可 | 可能 |
| 書き込み可能 | プライマリのみ | プライマリのみ |
| 追加コスト | 2倍のインスタンス料金 | レプリカ分の料金 |

## Multi-AZレプリケーション

### アーキテクチャ

```mermaid
graph LR
    subgraph "AZ-1a"
        Primary[プライマリ<br/>DBインスタンス<br/>読み書き可能]
        EBS1[EBSボリューム]
    end
    
    subgraph "AZ-1c"
        Standby[スタンバイ<br/>DBインスタンス<br/>アクセス不可]
        EBS2[EBSボリューム]
    end
    
    subgraph "アプリケーション"
        APP[アプリケーション]
    end
    
    APP -->|DNS名でアクセス| Primary
    Primary <-->|同期レプリケーション| Standby
    Primary --> EBS1
    Standby --> EBS2
    
    Primary -.->|障害時自動切替| Standby
    
    style Primary fill:#9f9,stroke:#333,stroke-width:3px
    style Standby fill:#ff9,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
```

### Multi-AZの動作原理

```mermaid
sequenceDiagram
    participant App as アプリケーション
    participant Primary as プライマリDB
    participant Standby as スタンバイDB
    participant DNS as RDS DNS
    
    App->>Primary: 書き込みリクエスト
    Primary->>Primary: データ更新
    Primary->>Standby: 同期レプリケーション
    Standby->>Primary: 更新確認
    Primary->>App: コミット完了
    
    Note over Primary: 障害発生！
    DNS->>DNS: DNSレコード更新
    App->>DNS: DNS解決
    DNS->>App: スタンバイのIP返却
    App->>Standby: 新プライマリとして接続
```

### Multi-AZの特徴

1. **自動フェイルオーバー**
   - ハードウェア障害検知
   - ネットワーク障害対応
   - AZ全体の障害に対応

2. **データ保護**
   - 同期レプリケーション
   - データロスなし
   - RPO（目標復旧時点）= 0

3. **透過的な切り替え**
   - DNSベースの切り替え
   - アプリケーション変更不要
   - 1-2分での自動復旧

## リードレプリカ

### リードレプリカのアーキテクチャ

```mermaid
graph TB
    subgraph "書き込み"
        Master[マスター<br/>DBインスタンス<br/>読み書き可能]
    end
    
    subgraph "読み取り負荷分散"
        RR1[リードレプリカ1<br/>同一リージョン]
        RR2[リードレプリカ2<br/>同一AZ]
        RR3[リードレプリカ3<br/>別リージョン]
    end
    
    subgraph "アプリケーション"
        Write[書き込み処理]
        Read1[読み取り処理1]
        Read2[読み取り処理2]
    end
    
    Write --> Master
    Master -->|非同期レプリケーション| RR1
    Master -->|非同期レプリケーション| RR2
    Master -->|非同期レプリケーション| RR3
    
    Read1 --> RR1
    Read2 --> RR2
    
    style Master fill:#ff9,stroke:#333,stroke-width:3px
    style RR1 fill:#9f9,stroke:#333,stroke-width:2px
    style RR2 fill:#9f9,stroke:#333,stroke-width:2px
    style RR3 fill:#9ff,stroke:#333,stroke-width:2px
```

### リードレプリカの用途

```mermaid
graph LR
    subgraph "主な用途"
        U1[読み取り負荷分散]
        U2[レポート・分析用DB]
        U3[災害復旧用バックアップ]
        U4[クロスリージョンレプリカ]
    end
    
    subgraph "メリット"
        M1[マスターの負荷軽減]
        M2[読み取り性能向上]
        M3[地理的分散]
        M4[手動昇格で復旧可能]
    end
    
    U1 --> M1
    U2 --> M2
    U3 --> M4
    U4 --> M3
```

### リードレプリカの制限事項

| 項目 | 制限内容 | 備考 |
|------|----------|------|
| 最大数 | 5個まで（DB エンジンによる） | Aurora は15個まで |
| レプリカのレプリカ | MySQL/MariaDBのみ可能 | カスケード構成 |
| 遅延 | 非同期のため遅延あり | 通常は秒単位 |
| スキーマ変更 | マスターで実行 | 自動伝播 |
| バックアップ | レプリカからも可能 | マスター負荷軽減 |

## レプリケーション方式の比較と選択

### 選択フローチャート

```mermaid
graph TD
    Start[要件分析] --> Q1{高可用性が<br/>最優先？}
    Q1 -->|Yes| Q2{自動フェイルオーバー<br/>必要？}
    Q1 -->|No| Q3{読み取り負荷が<br/>高い？}
    
    Q2 -->|Yes| MAZ[Multi-AZ推奨]
    Q2 -->|No| Q4{地理的分散<br/>必要？}
    
    Q3 -->|Yes| RR[リードレプリカ推奨]
    Q3 -->|No| Single[シングルインスタンス]
    
    Q4 -->|Yes| CrossRR[クロスリージョン<br/>リードレプリカ]
    Q4 -->|No| LocalRR[同一リージョン<br/>リードレプリカ]
    
    MAZ --> Q5{読み取り負荷も<br/>高い？}
    Q5 -->|Yes| Both[Multi-AZ +<br/>リードレプリカ]
    Q5 -->|No| MAZOnly[Multi-AZのみ]
    
    style MAZ fill:#ff9,stroke:#333,stroke-width:3px
    style RR fill:#9ff,stroke:#333,stroke-width:3px
    style Both fill:#f9f,stroke:#333,stroke-width:3px
```

### 実装パターン

#### パターン1: 高可用性重視

```mermaid
graph LR
    HA_App["ミッションクリティカル<br/>金融系・決済系"] --> HA_Primary[プライマリDB]
    HA_Primary <-.->|同期レプリケーション| HA_Standby["スタンバイDB<br/>(Multi-AZ)"]
    
    style HA_Primary fill:#ff9,stroke:#333,stroke-width:3px
    style HA_Standby fill:#fcc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style HA_App fill:#e6f3ff,stroke:#333,stroke-width:2px
```

**特徴**: Multi-AZ構成により自動フェイルオーバーを実現。金融系など高可用性が求められるシステムに最適。

#### パターン2: 読み取り性能重視

```mermaid
graph TD
    RP_App["レポーティング<br/>分析系"]
    RP_Primary[プライマリDB]
    
    RP_App --> RP_Primary
    
    RP_Primary -->|非同期| RP_RR1[リードレプリカ1]
    RP_Primary -->|非同期| RP_RR2[リードレプリカ2]
    RP_Primary -->|非同期| RP_RR3[リードレプリカ3]
    
    RP_App --> RP_RR1
    RP_App --> RP_RR2
    RP_App --> RP_RR3
    
    style RP_Primary fill:#ff9,stroke:#333,stroke-width:3px
    style RP_App fill:#e6f3ff,stroke:#333,stroke-width:2px
    style RP_RR1 fill:#9f9,stroke:#333,stroke-width:2px
    style RP_RR2 fill:#9f9,stroke:#333,stroke-width:2px
    style RP_RR3 fill:#9f9,stroke:#333,stroke-width:2px
```

**特徴**: 複数のリードレプリカで読み取り負荷を分散。レポーティングや分析系のワークロードに最適。

#### パターン3: 完全冗長構成

```mermaid
graph TD
    FR_App["グローバル<br/>24/7サービス"]
    FR_Primary["プライマリDB<br/>(Multi-AZ)"]
    FR_Standby["スタンバイDB"]
    
    FR_App --> FR_Primary
    FR_Primary <-.->|同期| FR_Standby
    
    FR_Primary -->|非同期| FR_RR1[リードレプリカ1]
    FR_Primary -->|非同期| FR_RR2[リードレプリカ2]
    FR_Primary -->|非同期| FR_Cross["クロスリージョン<br/>レプリカ"]
    
    FR_App --> FR_RR1
    FR_App --> FR_RR2
    
    style FR_Primary fill:#ff9,stroke:#333,stroke-width:3px
    style FR_Standby fill:#fcc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style FR_App fill:#e6f3ff,stroke:#333,stroke-width:2px
    style FR_Cross fill:#9ff,stroke:#333,stroke-width:2px
    style FR_RR1 fill:#9f9,stroke:#333,stroke-width:2px
    style FR_RR2 fill:#9f9,stroke:#333,stroke-width:2px
```

**特徴**: Multi-AZ + リードレプリカ + クロスリージョンレプリカの組み合わせ。グローバルサービスの完全な冗長性を実現。

### Terraformでの実装例

```hcl
# Multi-AZ配置のRDS
resource "aws_db_instance" "main" {
  identifier     = "main-database"
  engine         = "mysql"
  engine_version = "8.0"
  instance_class = "db.r5.large"
  
  # Multi-AZ有効化
  multi_az               = true
  
  # その他の設定
  allocated_storage      = 100
  storage_encrypted      = true
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]
}

# リードレプリカの作成
resource "aws_db_instance" "read_replica" {
  count                    = 2  # 2つのリードレプリカ
  identifier               = "read-replica-${count.index + 1}"
  replicate_source_db      = aws_db_instance.main.identifier
  
  # レプリカ固有の設定
  instance_class           = "db.r5.large"
  publicly_accessible      = false
  auto_minor_version_upgrade = false
  
  # 別AZに配置
  availability_zone        = data.aws_availability_zones.available.names[count.index]
}

# クロスリージョンレプリカ
resource "aws_db_instance" "cross_region_replica" {
  provider                 = aws.us_west_2  # 別リージョンのプロバイダー
  identifier               = "cross-region-replica"
  replicate_source_db      = aws_db_instance.main.arn
  
  instance_class           = "db.r5.large"
  storage_encrypted        = true
}
```

### 監視とメトリクス

```mermaid
graph LR
    subgraph "Multi-AZ監視"
        M1[フェイルオーバー回数]
        M2[レプリケーション状態]
        M3[スタンバイ遅延]
    end
    
    subgraph "リードレプリカ監視"
        R1[レプリカラグ]
        R2[レプリカCPU使用率]
        R3[レプリカ接続数]
    end
    
    subgraph "アラート"
        A1[CloudWatch Alarms]
        A2[SNS通知]
    end
    
    M1 --> A1
    R1 --> A1
    A1 --> A2
```

## 関連

- [AWS RDS Multi-AZ デプロイ](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html)
- [RDS リードレプリカ](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html)
- [RDS 高可用性ベストプラクティス](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_BestPractices.html)
- [Aurora レプリケーション](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Replication.html)