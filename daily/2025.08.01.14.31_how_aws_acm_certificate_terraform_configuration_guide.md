# AWS ACM証明書のTerraform設定ガイド

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformを使用してACM証明書を作成・管理するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : **どのように**Terraformを使用してACM証明書を作成・管理するか
> 
> **Answer** : `aws_acm_certificate`リソースを使用し、`validation_method`に`DNS`を指定してDNS検証を行い、`aws_acm_certificate_validation`リソースで検証を完了させる

## 目次

<details>
<summary>目次を開く</summary>

- [基本的な使用方法](#基本的な使用方法)
- [主要な引数](#主要な引数)
- [検証方法](#検証方法)
- [エクスポートされる属性](#エクスポートされる属性)
- [重要な注意事項](#重要な注意事項)
- [実践的な例](#実践的な例)
- [トラブルシューティング](#トラブルシューティング)
- [ベストプラクティス](#ベストプラクティス)

</details>

## 基本的な使用方法

### リソースの定義
```hcl
resource "aws_acm_certificate" "cert" {
  domain_name       = "example.com"
  validation_method = "DNS"

  tags = {
    Environment = "test"
  }

  lifecycle {
    create_before_destroy = true
  }
}
```

## 主要な引数

### 必須引数
- `domain_name` - (必須) 証明書でカバーするドメイン名

### オプション引数
- `validation_method` - (オプション) 証明書の検証方法。`DNS` または `EMAIL`。デフォルトは `EMAIL`
- `subject_alternative_names` - (オプション) 証明書に含める追加のドメイン名のリスト
- `tags` - (オプション) リソースに付与するタグのマップ
- `certificate_authority_arn` - (オプション) プライベート証明書の場合のCA ARN

## 検証方法

### DNS検証
DNS検証は推奨される方法で、自動更新が可能です。

```hcl
resource "aws_acm_certificate" "cert" {
  domain_name       = "example.com"
  validation_method = "DNS"

  subject_alternative_names = [
    "www.example.com",
    "api.example.com"
  ]

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_route53_record" "cert_validation" {
  for_each = {
    for dvo in aws_acm_certificate.cert.domain_validation_options : dvo.domain_name => {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  allow_overwrite = true
  name            = each.value.name
  records         = [each.value.record]
  ttl             = 60
  type            = each.value.type
  zone_id         = data.aws_route53_zone.main.zone_id
}

resource "aws_acm_certificate_validation" "cert" {
  certificate_arn         = aws_acm_certificate.cert.arn
  validation_record_fqdns = [for record in aws_route53_record.cert_validation : record.fqdn]
}
```

### Email検証
Email検証は手動での承認が必要です。

```hcl
resource "aws_acm_certificate" "cert" {
  domain_name       = "example.com"
  validation_method = "EMAIL"

  validation_options {
    domain_name       = "example.com"
    validation_domain = "example.com"
  }
}
```

## エクスポートされる属性

- `id` - 証明書のARN
- `arn` - 証明書のARN
- `domain_name` - 証明書のドメイン名
- `domain_validation_options` - DNS検証に必要な情報を含むセット
- `status` - 証明書のステータス
- `type` - 証明書のタイプ

## 重要な注意事項

### 1. リージョンの考慮事項
CloudFrontで使用する証明書は、`us-east-1`リージョンで作成する必要があります。

```hcl
provider "aws" {
  alias  = "virginia"
  region = "us-east-1"
}

resource "aws_acm_certificate" "cloudfront_cert" {
  provider          = aws.virginia
  domain_name       = "example.com"
  validation_method = "DNS"
}
```

### 2. ライフサイクル管理
証明書を置き換える際のダウンタイムを避けるため、`create_before_destroy`を使用することを推奨します。

```hcl
lifecycle {
  create_before_destroy = true
}
```

### 3. ワイルドカード証明書
ワイルドカード証明書もサポートされています。

```hcl
resource "aws_acm_certificate" "wildcard" {
  domain_name       = "*.example.com"
  validation_method = "DNS"
  
  subject_alternative_names = [
    "example.com"
  ]
}
```

## 実践的な例

### 1. 本番環境向けの設定
```hcl
resource "aws_acm_certificate" "production" {
  domain_name = "example.com"
  
  subject_alternative_names = [
    "*.example.com",
    "api.example.com",
    "admin.example.com"
  ]
  
  validation_method = "DNS"
  
  tags = {
    Name        = "example-production-cert"
    Environment = "production"
    ManagedBy   = "terraform"
  }
  
  lifecycle {
    create_before_destroy = true
  }
}
```

### 2. 複数環境での利用
```hcl
resource "aws_acm_certificate" "main" {
  domain_name = terraform.workspace == "production" ? 
    "example.com" : 
    "${terraform.workspace}.example.com"
  
  validation_method = "DNS"
  
  tags = {
    Name        = "example-${terraform.workspace}-cert"
    Environment = terraform.workspace
  }
  
  lifecycle {
    create_before_destroy = true
  }
}
```

### 3. 既存証明書の参照
新規作成ではなく、既存の証明書を参照する場合：

```hcl
data "aws_acm_certificate" "existing" {
  domain   = "example.com"
  statuses = ["ISSUED"]
  
  # 最新の証明書を取得
  most_recent = true
}
```

## トラブルシューティング

### 1. 検証タイムアウト
DNS検証は通常数分で完了しますが、最大30分かかる場合があります。

### 2. 証明書の削除エラー
使用中の証明書は削除できません。先に関連リソース（CloudFront、ALBなど）から証明書の参照を削除してください。

### 3. リージョンエラー
CloudFrontで「証明書が見つからない」エラーが発生する場合は、証明書が`us-east-1`リージョンに作成されているか確認してください。

## ベストプラクティス

1. **自動検証の活用**: 可能な限りDNS検証を使用し、自動更新を有効にする
2. **タグの活用**: 環境、プロジェクト、管理者などの情報をタグで管理
3. **ライフサイクルの設定**: `create_before_destroy`で無停止更新を実現
4. **監視の設定**: 証明書の有効期限をCloudWatchで監視
5. **ドキュメント化**: 証明書の用途、関連サービスをコメントで記載

## 関連
- [AWS ACM Certificate Provider設定](./2025.08.01.14.38_how_aws_acm_certificate_provider_configuration_details.md)
- [AWS ACM Certificate Count設定](./2025.08.01.14.43_how_aws_acm_certificate_count_configuration_details.md)
- [ACM証明書管理パターン比較](./2025.08.01.13.47_why_acm_certificate_management_patterns_comparison.md)
- [AWS ACM公式ドキュメント](https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html)
- [Terraform AWS Provider ACM Certificate](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/acm_certificate)