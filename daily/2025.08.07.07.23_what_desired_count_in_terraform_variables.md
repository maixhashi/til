# Terraform変数設定のdesired_countとは

## What's this file?
> [!NOTE]
> **What**
> 
> Terraform変数設定におけるdesired_countとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : desired_countとは何か
> 
> **Answer** : ECS（Elastic Container Service）で実行したいタスクの希望数を指定する設定値で、アプリケーションのコンテナインスタンス数を制御する

## 目次

<details>
<summary>目次を開く</summary>

- [desired_countの概要](#desired_countの概要)
- [ECSにおける役割](#ecsにおける役割)
- [環境別設定の意味](#環境別設定の意味)
- [Auto Scalingとの関係](#auto-scalingとの関係)
- [設定値の決定基準](#設定値の決定基準)
- [プロジェクトでの実装例](#プロジェクトでの実装例)

</details>

## desired_countの概要

`desired_count`は、AWS ECSサービスにおいて、常時実行しておきたいタスク（コンテナ）の数を指定する設定値です。

主な特徴：
- ECSサービスの基本的なスケーリング設定
- サービスの可用性とパフォーマンスに直接影響
- 環境ごとに異なる値を設定可能

## ECSにおける役割

### 1. タスク数の管理

ECSは`desired_count`の値に基づいて：
- 指定された数のタスクを起動
- タスクが停止した場合、自動的に新しいタスクを起動
- 常に指定数のタスクが実行状態を維持

### 2. 負荷分散

複数のタスクが実行される場合：
- ALB（Application Load Balancer）が自動的にトラフィックを分散
- 各タスクが均等にリクエストを処理
- 単一障害点の回避

## 環境別設定の意味

### ステージング環境（stg）
```hcl
desired_count = 1
```

- **最小構成**：開発・テスト用途のため1台で十分
- **コスト最適化**：不要なリソース消費を避ける
- **シンプルな動作確認**：単一インスタンスで問題を特定しやすい

### 本番環境（prod）
```hcl
desired_count = 2
```

- **高可用性**：1台が停止しても、もう1台でサービス継続
- **負荷分散**：2台でトラフィックを分散処理
- **メンテナンス性**：ローリングアップデート時のダウンタイム回避

## Auto Scalingとの関係

`desired_count`は以下の役割を持ちます：

1. **初期値**
   - Auto Scalingが有効な場合の起動時タスク数
   - スケーリングポリシーの基準値

2. **最小値との関係**
   - 通常、`min_capacity`以上の値を設定
   - Auto Scalingで縮小されても、この値を下回らない場合が多い

3. **手動調整**
   - Auto Scalingを使用しない場合の固定タスク数
   - 必要に応じて手動で変更可能

## 設定値の決定基準

### 考慮すべき要素

1. **トラフィック量**
   - 予想される同時接続数
   - ピーク時のリクエスト数

2. **可用性要件**
   - SLA（Service Level Agreement）
   - ダウンタイムの許容度

3. **コスト**
   - 各タスクのリソース使用量
   - 環境の重要度

4. **パフォーマンス**
   - レスポンスタイム要件
   - 処理能力の余裕

### 一般的な設定パターン

- **開発環境**：`1`（最小構成）
- **ステージング環境**：`1-2`（本番に近い構成でテスト）
- **本番環境**：`2以上`（高可用性確保）

## プロジェクトでの実装例

サンプルプロジェクトでは、`variables.tf`で以下のように定義：

```hcl
variable "environment_config" {
  type = map(object({
    desired_count = number
    // 他の設定...
  }))
  default = {
    stg = {
      desired_count = 1  # ステージング：最小構成
    }
    prod = {
      desired_count = 2  # 本番：高可用性
    }
  }
}
```

実際のECSサービスで使用：
```hcl
resource "aws_ecs_service" "app" {
  desired_count = local.config.desired_count
  // 他の設定...
}
```

## 関連

- [AWS ECS Service](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html)
- [ECS Auto Scaling](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-auto-scaling.html)
- Terraformでの高可用性設計
- コンテナオーケストレーションのベストプラクティス