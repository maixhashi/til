# なぜTerraformで環境別にリソース名を区別する必要があるのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**Terraformで`"${var.project_name}-ecs-tasks-${var.environment}"`のような環境変数を使用したリソース命名が必要なのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**環境別のリソース名区別が必要なのか
> 
> **Answer** : 複数環境（dev/staging/production）で同一AWSアカウント内にリソースを作成する際の名前衝突を防ぎ、リソースの識別・管理・トラブルシューティングを容易にするため

## 目次
<details>
<summary>目次を開く</summary>

- [1. 環境別リソース命名の必要性](#1-環境別リソース命名の必要性)
- [2. 命名規則の具体例](#2-命名規則の具体例)
- [3. 環境別命名のメリット](#3-環境別命名のメリット)
- [4. 命名規則のベストプラクティス](#4-命名規則のベストプラクティス)
- [5. 注意点とアンチパターン](#5-注意点とアンチパターン)

</details>

## 1. 環境別リソース命名の必要性

### リソース名の一意性要件
AWSの多くのリソースは、同一リージョン内で一意の名前を持つ必要があります：
- Security Groups
- ECS Task Definitions
- ECS Services
- RDS Instance Identifiers
- S3 Bucket Names（グローバルで一意）

### 環境分離の実現
```hcl
# 環境別の命名例
resource "aws_security_group" "ecs_tasks" {
  name = "${var.project_name}-ecs-tasks-${var.environment}"
  # example-project-ecs-tasks-dev
  # example-project-ecs-tasks-staging
  # example-project-ecs-tasks-production
}
```

## 2. 命名規則の具体例

### 基本的な命名パターン
```hcl
# パターン1: プロジェクト-リソース-環境
"${var.project_name}-${resource_type}-${var.environment}"

# パターン2: 環境-プロジェクト-リソース
"${var.environment}-${var.project_name}-${resource_type}"

# パターン3: プロジェクト-環境-リソース-サフィックス
"${var.project_name}-${var.environment}-${resource_type}-${random_suffix}"
```

### リソース別の命名例
```hcl
# ECSタスク定義
name = "${var.project_name}-task-${var.environment}"

# RDSインスタンス
identifier = "${var.project_name}-db-${var.environment}"

# ALB
name = "${var.project_name}-alb-${var.environment}"

# S3バケット
bucket = "${var.project_name}-assets-${var.environment}-${data.aws_caller_identity.current.account_id}"
```

## 3. 環境別命名のメリット

### 運用面でのメリット
1. **即座の環境識別**
   - AWSコンソールでリソース一覧を見たときに環境が一目瞭然
   - 誤った環境での操作リスクを軽減

2. **効率的なフィルタリング**
   - タグと組み合わせて環境別のリソース管理が容易
   - CloudWatchやCost Explorerでの環境別分析が可能

3. **トラブルシューティングの迅速化**
   - ログやエラーメッセージから環境を特定しやすい
   - インシデント対応時の混乱を防止

### 開発面でのメリット
1. **並行開発の実現**
   - 複数環境で同時に異なるバージョンをデプロイ可能
   - 環境間の干渉を防止

2. **Infrastructure as Codeの活用**
   - 同一のTerraformモジュールで複数環境を管理
   - 環境変数の切り替えだけで環境構築が可能

## 4. 命名規則のベストプラクティス

### 推奨される命名規則
```hcl
# 変数定義
variable "project_name" {
  description = "プロジェクト名"
  type        = string
  default     = "example-project"
}

variable "environment" {
  description = "環境名 (dev/staging/production)"
  type        = string
  validation {
    condition     = contains(["dev", "staging", "production"], var.environment)
    error_message = "環境名は dev, staging, production のいずれかである必要があります。"
  }
}

# リソース命名
locals {
  name_prefix = "${var.project_name}-${var.environment}"
  
  resource_names = {
    ecs_cluster     = "${local.name_prefix}-cluster"
    ecs_service     = "${local.name_prefix}-service"
    ecs_task        = "${local.name_prefix}-task"
    security_group  = "${local.name_prefix}-sg"
    alb             = "${local.name_prefix}-alb"
    rds             = "${local.name_prefix}-db"
  }
}
```

### タグ付けとの併用
```hcl
locals {
  common_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = "terraform"
    CreatedAt   = timestamp()
  }
}

resource "aws_security_group" "ecs_tasks" {
  name = local.resource_names.security_group
  tags = merge(local.common_tags, {
    Name = local.resource_names.security_group
    Type = "ecs-tasks"
  })
}
```

## 5. 注意点とアンチパターン

### 避けるべきパターン
```hcl
# ❌ 環境情報なし
name = "${var.project_name}-ecs-tasks"

# ❌ ハードコードされた環境名
name = "example-project-ecs-tasks-prod"

# ❌ 不明瞭な略語
name = "${var.project_name}-ecs-${substr(var.environment, 0, 1)}"
```

### 文字数制限への対応
一部のAWSリソースには名前の長さ制限があります：
```hcl
# RDSインスタンス識別子: 最大63文字
locals {
  rds_identifier = substr("${var.project_name}-${var.environment}-db", 0, 63)
}

# Security Group名: 最大255文字（通常は問題にならない）
```

### 環境移行時の考慮
```hcl
# データ移行やリソース複製時の一時的な命名
name = "${var.project_name}-${var.environment}-${var.migration_suffix}"
```

## 関連
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Resource Naming Limits](https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html)
- [Terraform Best Practices - Naming Conventions](https://www.terraform-best-practices.com/naming)