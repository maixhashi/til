# aws_s3_bucket_server_side_encryption_configurationリソースとは

## What's this file?
> [!NOTE]
> **What**
> 
> Terraformのaws_s3_bucket_server_side_encryption_configurationリソースとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : aws_s3_bucket_server_side_encryption_configurationとは何か
> 
> **Answer** : S3バケットに保存されるすべてのオブジェクトに対して自動的にサーバーサイド暗号化を適用するTerraformリソースで、データの保護とコンプライアンス要件を満たすために使用される

## 目次

<details>
<summary>目次を開く</summary>

- [リソースの概要](#リソースの概要)
- [サーバーサイド暗号化の仕組み](#サーバーサイド暗号化の仕組み)
- [暗号化アルゴリズムの種類](#暗号化アルゴリズムの種類)
- [設定構造と必須パラメータ](#設定構造と必須パラメータ)
- [プロジェクトでの実装例](#プロジェクトでの実装例)
- [セキュリティとコンプライアンス](#セキュリティとコンプライアンス)
- [ベストプラクティス](#ベストプラクティス)

</details>

## リソースの概要

`aws_s3_bucket_server_side_encryption_configuration`は、S3バケットレベルでデフォルトの暗号化設定を定義するTerraformリソースです。

主な特徴：
- バケット内のすべての新規オブジェクトに自動適用
- 既存オブジェクトには影響しない
- 暗号化はAWS側で透過的に処理
- 追加料金なし（AES256の場合）

### 重要：デフォルト設定について

**S3バケットはデフォルトでは暗号化されません。**

- 新規作成されたS3バケットは、明示的に設定しない限り暗号化が**無効**
- 2023年1月以降作成のバケットでも、自動的な暗号化設定はされない
- そのため、`aws_s3_bucket_server_side_encryption_configuration`リソースの明示的な記述が必要

```hcl
# これを書かないと暗号化されない
resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

## サーバーサイド暗号化の仕組み

### 暗号化プロセス

1. **アップロード時**
   ```
   クライアント → S3 → 自動暗号化 → ストレージ保存
   ```

2. **ダウンロード時**
   ```
   ストレージ → 自動復号化 → S3 → クライアント
   ```

### 透過的な処理

- クライアント側での暗号化処理不要
- APIやSDKの変更不要
- パフォーマンスへの影響最小限

## 暗号化アルゴリズムの種類

### 利用可能なオプション

| アルゴリズム | 説明 | コスト | 用途 |
|-------------|------|--------|------|
| AES256 | S3管理の暗号化キー | 無料 | 一般的な用途 |
| aws:kms | AWS KMS管理キー | 有料 | 高度な鍵管理 |
| aws:kms:dsse | KMS二重暗号化 | 有料 | 最高レベルのセキュリティ |

### AES256の特徴

```hcl
rule {
  apply_server_side_encryption_by_default {
    sse_algorithm = "AES256"
  }
}
```

- AWS管理の暗号化キー使用
- 256ビットAdvanced Encryption Standard
- 追加設定不要
- コスト効率的

### aws:kmsの特徴

```hcl
rule {
  apply_server_side_encryption_by_default {
    sse_algorithm     = "aws:kms"
    kms_master_key_id = aws_kms_key.s3.arn
  }
}
```

- カスタムKMSキー使用可能
- 詳細なアクセス制御
- 監査ログ記録
- キーローテーション機能

## 設定構造と必須パラメータ

### 基本構造

```hcl
resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
    bucket_key_enabled = true  # オプション
  }
}
```

### パラメータ詳細

1. **bucket**（必須）
   - 暗号化を適用するS3バケットのID
   - バケットリソースの参照推奨

2. **rule**（必須）
   - 暗号化ルールの定義
   - 複数ルールは不可

3. **apply_server_side_encryption_by_default**（必須）
   - デフォルト暗号化の設定
   - sse_algorithmは必須

4. **bucket_key_enabled**（オプション）
   - S3バケットキーの有効化
   - KMS使用時のコスト削減

## プロジェクトでの実装例

### 実際の設定パターン

```hcl
# 静的アセット用バケット
resource "aws_s3_bucket_server_side_encryption_configuration" "example_project_static" {
  bucket = aws_s3_bucket.example_project_static.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"  # 標準的な暗号化
    }
  }
}

# 基準面データ用バケット（重要データ）
resource "aws_s3_bucket_server_side_encryption_configuration" "example_reference_surfaces" {
  bucket = aws_s3_bucket.example_reference_surfaces.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

# 点群データ用バケット（一時データ）
resource "aws_s3_bucket_server_side_encryption_configuration" "example_point_clouds" {
  bucket = aws_s3_bucket.example_point_clouds.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

# 差分解析結果用バケット（長期保存）
resource "aws_s3_bucket_server_side_encryption_configuration" "example_difference_analysis" {
  bucket = aws_s3_bucket.example_difference_analysis.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

### 高度な設定例（KMS使用）

```hcl
# KMSキーの作成
resource "aws_kms_key" "s3" {
  description             = "S3 encryption key"
  deletion_window_in_days = 10
  enable_key_rotation     = true
}

# KMS暗号化設定
resource "aws_s3_bucket_server_side_encryption_configuration" "sensitive" {
  bucket = aws_s3_bucket.sensitive_data.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.s3.arn
    }
    bucket_key_enabled = true  # コスト最適化
  }
}
```

## セキュリティとコンプライアンス

### コンプライアンス要件への対応

1. **データ保護規制**
   - GDPR：暗号化によるデータ保護
   - HIPAA：医療データの暗号化要件
   - PCI DSS：カード情報の暗号化

2. **業界標準**
   - ISO 27001
   - SOC 2
   - NIST準拠

### セキュリティ強化策

```hcl
# 1. バケットポリシーで暗号化を強制
resource "aws_s3_bucket_policy" "enforce_encryption" {
  bucket = aws_s3_bucket.example.id

  policy = jsonencode({
    Statement = [{
      Effect = "Deny"
      Principal = "*"
      Action = "s3:PutObject"
      Resource = "${aws_s3_bucket.example.arn}/*"
      Condition = {
        StringNotEquals = {
          "s3:x-amz-server-side-encryption" = "AES256"
        }
      }
    }]
  })
}

# 2. バージョニングとの併用
resource "aws_s3_bucket_versioning" "example" {
  bucket = aws_s3_bucket.example.id
  versioning_configuration {
    status = "Enabled"
  }
}
```

## ベストプラクティス

### 1. 明示的な設定の重要性

```hcl
# ❌ 悪い例：暗号化設定を忘れている
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
  # 暗号化設定なし = 暗号化されない！
}

# ✅ 良い例：明示的に暗号化を設定
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  bucket = aws_s3_bucket.example.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

### 2. すべてのバケットで暗号化

```hcl
# デフォルトで暗号化を適用
locals {
  buckets = {
    static    = aws_s3_bucket.static
    data      = aws_s3_bucket.data
    backup    = aws_s3_bucket.backup
  }
}

resource "aws_s3_bucket_server_side_encryption_configuration" "all" {
  for_each = local.buckets
  bucket   = each.value.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

### 3. 環境別の暗号化戦略

```hcl
# 本番環境ではKMS、開発環境ではAES256
resource "aws_s3_bucket_server_side_encryption_configuration" "adaptive" {
  bucket = aws_s3_bucket.main.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = var.environment == "prod" ? "aws:kms" : "AES256"
      kms_master_key_id = var.environment == "prod" ? aws_kms_key.s3[0].arn : null
    }
  }
}
```

### 4. 監査とモニタリング

- CloudTrailでアクセスログ記録
- AWS Configで暗号化状態監視
- S3インベントリで暗号化状況確認

## 関連

- [AWS S3 Server-Side Encryption](https://docs.aws.amazon.com/AmazonS3/latest/userguide/serv-side-encryption.html)
- [Terraform aws_s3_bucket_server_side_encryption_configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_server_side_encryption_configuration)
- S3セキュリティのベストプラクティス
- KMS暗号化キー管理ガイド