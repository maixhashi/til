# Terraformコードのエラーチェック方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformコードでエラーが発生しないことを確認するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTerraformコードでエラーが発生しないことを確認するか
> 
> **Answer** : terraform plan, terraform validate, terraform fmt, tflint, checkov等のツールを段階的に使用して、構文エラー、設定ミス、セキュリティ問題を事前に検出する

## 目次

<details>
<summary>目次を開く</summary>

- [1. 基本的なエラーチェック手順](#1-基本的なエラーチェック手順)
- [2. terraform validateによる構文チェック](#2-terraform-validateによる構文チェック)
- [3. terraform planによる実行計画の確認](#3-terraform-planによる実行計画の確認)
- [4. terraform fmtによるフォーマットチェック](#4-terraform-fmtによるフォーマットチェック)
- [5. tflintによる詳細なルールチェック](#5-tflintによる詳細なルールチェック)
- [6. checkovによるセキュリティチェック](#6-checkovによるセキュリティチェック)
- [7. CI/CDパイプラインでの自動チェック](#7-cicdパイプラインでの自動チェック)

</details>

## 1. 基本的なエラーチェック手順

Terraformコードのエラーチェックは、以下の順序で実施することが推奨されます：

```bash
# 1. フォーマットを整える
terraform fmt -recursive

# 2. 構文エラーをチェック
terraform validate

# 3. 実行計画を確認
terraform plan

# 4. 追加のツールでチェック
tflint
checkov -d .
```

## 2. terraform validateによる構文チェック

`terraform validate`は、Terraformの構文エラーやリソース定義の基本的な問題を検出します。

```bash
# 初期化が必要
terraform init

# 構文チェックを実行
terraform validate
```

検出できるエラーの例：
- 必須引数の不足
- 存在しない引数の使用
- データ型の不一致
- 循環参照

## 3. terraform planによる実行計画の確認

`terraform plan`は、実際にインフラストラクチャに加えられる変更を事前に確認できます。

```bash
# 基本的な使用方法
terraform plan

# 計画をファイルに保存
terraform plan -out=tfplan

# 特定の変数を指定
terraform plan -var="environment=production"
```

確認すべきポイント：
- 予期しないリソースの削除がないか
- リソース名やタグが正しいか
- セキュリティグループやネットワーク設定が適切か

## 4. terraform fmtによるフォーマットチェック

コードの一貫性を保つために、`terraform fmt`を使用します。

```bash
# フォーマットチェック（変更なし）
terraform fmt -check

# フォーマットを自動修正
terraform fmt -recursive

# 差分を表示
terraform fmt -diff
```

## 5. tflintによる詳細なルールチェック

tflintは、Terraform固有のリンターで、より詳細なチェックが可能です。

```bash
# インストール
brew install tflint

# 設定ファイル作成（.tflint.hcl）
plugin "aws" {
  enabled = true
  version = "0.24.0"
  source  = "github.com/terraform-linters/tflint-ruleset-aws"
}

# 実行
tflint --init
tflint
```

検出できる問題：
- 非推奨のリソースタイプや引数
- AWS固有のベストプラクティス違反
- 無効なインスタンスタイプ
- リソース命名規則違反

## 6. checkovによるセキュリティチェック

checkovは、セキュリティとコンプライアンスのチェックツールです。

```bash
# インストール
pip install checkov

# 実行
checkov -d . --framework terraform

# 特定のチェックをスキップ
checkov -d . --skip-check CKV_AWS_23
```

チェック項目の例：
- 暗号化が有効になっているか
- パブリックアクセスが適切に制限されているか
- ロギングが有効になっているか
- セキュリティグループの設定が適切か

## 7. CI/CDパイプラインでの自動チェック

GitHub Actionsの例：

```yaml
name: Terraform CI

on:
  pull_request:
    paths:
      - 'infra/terraform/**'

jobs:
  terraform-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        
      - name: Terraform Init
        run: terraform init
        
      - name: Terraform Validate
        run: terraform validate
        
      - name: Terraform Plan
        run: terraform plan -no-color
        
      - name: tflint
        uses: terraform-linters/setup-tflint@v3
        run: |
          tflint --init
          tflint
          
      - name: Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
```

## 関連
- [Terraform公式ドキュメント - terraform validate](https://www.terraform.io/docs/commands/validate.html)
- [tflint公式リポジトリ](https://github.com/terraform-linters/tflint)
- [checkov公式ドキュメント](https://www.checkov.io/)
- [Terraform Best Practices](https://www.terraform.io/docs/language/best-practices.html)