# AWS ストレージ要件: Fargate と EC2

## 概要

AWSアーキテクチャにおいて、FargateとEC2は異なるストレージ要件を持ちます。本ドキュメントでは、それぞれのサービスで必要となるストレージの種類と使用方法について説明します。

## EC2インスタンスのストレージ要件

### EBS (Elastic Block Store) - 必須

EC2インスタンスを起動する際は、**必ず最低1つのEBSボリューム**が必要です。

- **ルートボリューム**: OS、システムファイル、アプリケーションを格納
- **追加データボリューム**: 必要に応じて複数のEBSボリュームをアタッチ可能
- **特徴**:
  - ブロックレベルストレージ
  - 高性能・低レイテンシー
  - スナップショットによるバックアップ機能
  - 暗号化対応

### EFS (Elastic File System) - オプション

EC2インスタンスでEFSは必須ではありませんが、以下の場合に有用です：

- 複数のEC2インスタンス間でファイル共有が必要
- NFSプロトコルが必要なアプリケーション
- 自動スケーリング環境での永続的な共有ストレージ
- ファイルベースのワークロード

#### EC2ストレージ構成例

```
# 単一EC2インスタンス
└── EBSボリューム（ルート + データ）

# 複数EC2インスタンス（共有不要）
├── EC2インスタンス1 - EBSボリューム
├── EC2インスタンス2 - EBSボリューム
└── EC2インスタンス3 - EBSボリューム

# 複数EC2インスタンス（共有必要）
├── EC2インスタンス1 - EBSボリューム + EFSマウント
├── EC2インスタンス2 - EBSボリューム + EFSマウント
└── EC2インスタンス3 - EBSボリューム + EFSマウント
```

## AWS Fargateのストレージ要件

### EBS - 使用不可

Fargateは**EBSボリュームを直接アタッチできません**。これは、Fargateが完全に管理されたコンテナ実行環境であり、基盤となるインフラストラクチャへの直接アクセスを提供しないためです。

### エフェメラルストレージ - デフォルト

Fargateタスクには以下のエフェメラルストレージが提供されます：

- **容量**: 20GB～200GBまで設定可能
- **特徴**:
  - タスク終了時に自動的に削除
  - 一時的なファイル処理に適している
  - 追加料金なし（基本料金に含まれる）

### EFS - オプション（推奨）

Fargateで永続的なストレージが必要な場合、EFSが推奨されます：

- **Fargate 1.4.0以降でサポート**
- **使用ケース**:
  - アプリケーションの設定ファイル
  - ログファイルの永続化
  - 複数タスク間でのファイル共有
  - コンテナ間でのデータ共有

#### Fargateでの EFS 設定例

```yaml
# タスク定義での EFS マウント設定
volumes:
  - name: efs-storage
    efs_volume_configuration:
      file_system_id: fs-xxxxxxxxx
      root_directory: /
      transit_encryption: ENABLED
      authorization_config:
        access_point_id: fsap-xxxxxxxxx
        iam: ENABLED

containerDefinitions:
  - name: app-container
    mountPoints:
      - sourceVolume: efs-storage
        containerPath: /mnt/efs
```

## ストレージ選択の決定フロー

### EC2を使用する場合

1. **EBSは必須** - ルートボリュームとして最低1つ必要
2. **EFSを検討すべきケース**:
   - 複数インスタンス間でのファイル共有が必要
   - NFSプロトコルのサポートが必要
   - 自動スケーリング環境での永続ストレージが必要

### Fargateを使用する場合

1. **EBSは使用不可** - アーキテクチャ上の制限
2. **エフェメラルストレージ** - 一時的なデータ処理には十分
3. **EFSを検討すべきケース**:
   - 永続的なデータ保存が必要
   - タスク間でのファイル共有が必要
   - アプリケーションの状態保持が必要

## ベストプラクティス

### EC2での推奨事項

1. **EBSの最適化**:
   - 適切なボリュームタイプの選択（gp3, io2等）
   - 定期的なスナップショット取得
   - 暗号化の有効化

2. **EFSの使用判断**:
   - 本当に共有ストレージが必要か検討
   - パフォーマンス要件の確認
   - コスト分析の実施

### Fargateでの推奨事項

1. **ストレージ戦略**:
   - 可能な限りエフェメラルストレージを活用
   - 永続化が必要な最小限のデータのみEFSに保存
   - S3やDynamoDBなど他のAWSサービスとの併用を検討

2. **EFS設定の最適化**:
   - 適切なパフォーマンスモードの選択
   - アクセスポイントによるセキュリティ強化
   - ライフサイクル管理の設定

## コスト考慮事項

### EC2のストレージコスト

- **EBS**: 容量とIOPS/スループットに基づく課金
- **EFS**: 使用容量に基づく従量課金

### Fargateのストレージコスト

- **エフェメラルストレージ**: Fargate基本料金に含まれる
- **EFS**: 別途使用容量に基づく課金

## まとめ

- **EC2**: EBSは必須、EFSはオプション
- **Fargate**: EBSは使用不可、永続ストレージにはEFSを使用
- ストレージ選択は、アプリケーションの要件とコストのバランスを考慮して決定

## 参考資料

- [AWS EBS Documentation](https://docs.aws.amazon.com/ebs/)
- [AWS EFS Documentation](https://docs.aws.amazon.com/efs/)
- [AWS Fargate Storage](https://docs.aws.amazon.com/fargate/latest/userguide/fargate-storage.html)
- [Amazon EKS with Fargate](https://docs.aws.amazon.com/eks/latest/userguide/fargate.html)