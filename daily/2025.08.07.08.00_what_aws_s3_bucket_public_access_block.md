# aws_s3_bucket_public_access_blockリソースとは

## What's this file?
> [!NOTE]
> **What**
> 
> Terraformのaws_s3_bucket_public_access_blockリソースとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : aws_s3_bucket_public_access_blockとは何か
> 
> **Answer** : S3バケットへのパブリックアクセスを包括的にブロックするTerraformリソースで、誤った設定によるデータ漏洩を防ぐために4つのセキュリティ設定を提供する

## 目次

<details>
<summary>目次を開く</summary>

- [リソースの概要](#リソースの概要)
- [4つのブロック設定](#4つのブロック設定)
- [各設定の詳細説明](#各設定の詳細説明)
- [設定の相互関係](#設定の相互関係)
- [プロジェクトでの実装例](#プロジェクトでの実装例)
- [よくある誤解と注意点](#よくある誤解と注意点)
- [ベストプラクティス](#ベストプラクティス)

</details>

## リソースの概要

`aws_s3_bucket_public_access_block`は、S3バケットのパブリックアクセスを防ぐための最も重要なセキュリティリソースです。

主な特徴：
- 2018年に導入されたセキュリティ機能
- バケットレベルでの包括的なアクセス制御
- 既存のバケットポリシーやACLを上書き
- アカウントレベルでも設定可能

### 重要：デフォルト設定について

**S3バケットはデフォルトではパブリックアクセスブロックが設定されません。**

- 新規作成されたS3バケットは、明示的に設定しない限りすべての設定が**false**（無効）
- 2023年4月以降、AWSコンソールで作成したバケットはデフォルトで有効になるが、Terraformでは明示的な設定が必要
- そのため、`aws_s3_bucket_public_access_block`リソースの明示的な記述が必須

```hcl
# これを書かないとパブリックアクセスが可能な状態
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
  # パブリックアクセスブロックなし = 潜在的なリスク！
}

# 必ず以下を追加すること
resource "aws_s3_bucket_public_access_block" "example" {
  bucket = aws_s3_bucket.example.id
  
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### なぜ必要か

- S3バケットの誤設定は重大なデータ漏洩の原因
- 複雑なバケットポリシーやACLの設定ミスを防ぐ
- コンプライアンス要件への対応

## 4つのブロック設定

```hcl
resource "aws_s3_bucket_public_access_block" "example" {
  bucket = aws_s3_bucket.example.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

| 設定名 | デフォルト | 推奨値 | 役割 |
|--------|-----------|--------|------|
| block_public_acls | false | true | パブリックACLの設定をブロック |
| block_public_policy | false | true | パブリックバケットポリシーの設定をブロック |
| ignore_public_acls | false | true | 既存のパブリックACLを無視 |
| restrict_public_buckets | false | true | パブリックバケットポリシーのアクセスを制限 |

## 各設定の詳細説明

### 1. block_public_acls

**機能**：新規パブリックACLの設定を阻止

```hcl
block_public_acls = true
```

- 新しいパブリックACLの追加を防ぐ
- 既存のパブリックACLは残る
- オブジェクトレベルのACLも対象

### 2. block_public_policy

**機能**：パブリックアクセスを許可するバケットポリシーの設定を阻止

```hcl
block_public_policy = true
```

- `Principal: "*"`を含むポリシーをブロック
- 条件付きパブリックアクセスもブロック
- 既存のポリシーは残る

### 3. ignore_public_acls

**機能**：既存のパブリックACLを無効化

```hcl
ignore_public_acls = true
```

- 既存のパブリックACLを無視
- ACL自体は削除されない
- 実質的にプライベートアクセスのみに

### 4. restrict_public_buckets

**機能**：パブリックポリシーによるアクセスを制限

```hcl
restrict_public_buckets = true
```

- AWS内からのアクセスのみ許可
- インターネットからの匿名アクセスをブロック
- VPCエンドポイント経由のアクセスは可能

## 設定の相互関係

### 推奨：すべてtrueに設定

```hcl
resource "aws_s3_bucket_public_access_block" "secure" {
  bucket = aws_s3_bucket.example.id

  block_public_acls       = true  # 新規パブリックACLをブロック
  block_public_policy     = true  # 新規パブリックポリシーをブロック
  ignore_public_acls      = true  # 既存パブリックACLを無視
  restrict_public_buckets = true  # パブリックアクセスを制限
}
```

### 段階的な適用例

```hcl
# ステップ1: 新規パブリック設定をブロック
resource "aws_s3_bucket_public_access_block" "step1" {
  bucket = aws_s3_bucket.example.id

  block_public_acls   = true
  block_public_policy = true
  # 既存の設定はまだ有効
}

# ステップ2: 既存の設定も無効化
resource "aws_s3_bucket_public_access_block" "step2" {
  bucket = aws_s3_bucket.example.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

## プロジェクトでの実装例

### 実際の設定（すべてプライベート）

```hcl
# 静的アセット用バケット
resource "aws_s3_bucket_public_access_block" "example_project_static" {
  bucket = aws_s3_bucket.example_project_static.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# 基準面データ用バケット
resource "aws_s3_bucket_public_access_block" "example_reference_surfaces" {
  bucket = aws_s3_bucket.example_reference_surfaces.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# 点群データ用バケット
resource "aws_s3_bucket_public_access_block" "example_point_clouds" {
  bucket = aws_s3_bucket.example_point_clouds.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# 差分解析結果用バケット
resource "aws_s3_bucket_public_access_block" "example_difference_analysis" {
  bucket = aws_s3_bucket.example_difference_analysis.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### CloudFront経由での公開が必要な場合

```hcl
# S3はプライベート、CloudFrontからのみアクセス可能
resource "aws_s3_bucket_public_access_block" "cdn_origin" {
  bucket = aws_s3_bucket.static_assets.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# OAI（Origin Access Identity）を使用
resource "aws_cloudfront_origin_access_identity" "oai" {
  comment = "OAI for static assets"
}

# バケットポリシーでCloudFrontのみ許可
resource "aws_s3_bucket_policy" "cdn_access" {
  bucket = aws_s3_bucket.static_assets.id

  policy = jsonencode({
    Statement = [{
      Principal = {
        AWS = aws_cloudfront_origin_access_identity.oai.iam_arn
      }
      Action   = "s3:GetObject"
      Resource = "${aws_s3_bucket.static_assets.arn}/*"
    }]
  })
}
```

## よくある誤解と注意点

### 1. 「静的ホスティングには不要」は誤り

```hcl
# ❌ 危険：パブリックアクセスブロックなし
resource "aws_s3_bucket" "website" {
  bucket = "my-public-website"
}

resource "aws_s3_bucket_website_configuration" "website" {
  bucket = aws_s3_bucket.website.id
  # ウェブサイトホスティング有効
}

# ✅ 安全：CloudFront経由でのみ公開
resource "aws_s3_bucket_public_access_block" "website" {
  bucket = aws_s3_bucket.website.id
  
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### 2. 既存バケットへの適用時の注意

- 既存のパブリックアクセスが即座にブロックされる
- アプリケーションの動作確認が必要
- 段階的な適用を検討

### 3. アカウントレベル設定との関係

```hcl
# アカウントレベルでも設定可能
resource "aws_s3_account_public_access_block" "account" {
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

## ベストプラクティス

### 1. デフォルトですべてのバケットに適用

```hcl
# モジュール化して再利用
module "s3_bucket_secure" {
  source = "./modules/s3"
  
  bucket_name = "my-secure-bucket"
  
  # パブリックアクセスブロックは必須
  enable_public_access_block = true
}
```

### 2. 例外的なパブリックアクセスの管理

```hcl
# 本当にパブリックアクセスが必要な場合
resource "aws_s3_bucket_public_access_block" "public_assets" {
  bucket = aws_s3_bucket.public_assets.id

  # 慎重に判断して一部を許可
  block_public_acls       = true   # ACLは使わない
  block_public_policy     = false  # ポリシーは許可
  ignore_public_acls      = true   # ACLは無視
  restrict_public_buckets = false  # パブリックアクセス許可
}

# 必ず理由をコメントで記載
# 例：公開APIドキュメント用バケット
```

### 3. 監査とコンプライアンス

```hcl
# タグで管理状態を明示
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
  
  tags = {
    PublicAccessBlocked = "true"
    SecurityLevel       = "high"
    DataClassification  = "confidential"
  }
}
```

### 4. テラフォームでの一括適用

```hcl
# すべてのバケットに一括適用
locals {
  buckets = {
    static    = aws_s3_bucket.static
    data      = aws_s3_bucket.data
    logs      = aws_s3_bucket.logs
  }
}

resource "aws_s3_bucket_public_access_block" "all" {
  for_each = local.buckets
  
  bucket = each.value.id
  
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

## 関連

- [AWS S3 Block Public Access](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html)
- [Terraform aws_s3_bucket_public_access_block](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_public_access_block)
- S3セキュリティのベストプラクティス
- データ漏洩防止ガイドライン