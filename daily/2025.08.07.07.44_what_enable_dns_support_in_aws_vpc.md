# AWS VPCのenable_dns_support設定とは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS VPCにおけるenable_dns_support設定とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : enable_dns_supportとは何か
> 
> **Answer** : VPC内でAmazon提供のDNSサーバー（Amazon Route 53 Resolver）を使用してDNS解決を行う機能を有効化する設定で、デフォルトでtrueに設定されている

## 目次

<details>
<summary>目次を開く</summary>

- [enable_dns_supportの概要](#enable_dns_supportの概要)
- [DNS解決の仕組み](#dns解決の仕組み)
- [デフォルト値と推奨設定](#デフォルト値と推奨設定)
- [enable_dns_hostnamesとの関係](#enable_dns_hostnamesとの関係)
- [無効化した場合の影響](#無効化した場合の影響)
- [設定の使用例](#設定の使用例)
- [トラブルシューティング](#トラブルシューティング)

</details>

## enable_dns_supportの概要

`enable_dns_support`は、VPC内でDNS解決機能を有効化するための基本的な設定です。

主な機能：
- Amazon提供のDNSサーバー（169.254.169.253）の使用
- VPC内外のドメイン名解決
- AWSサービスエンドポイントの名前解決

## DNS解決の仕組み

### Amazon DNSサーバー

VPCでDNS解決が有効な場合：

```
VPC CIDR: 10.0.0.0/16
DNSサーバー: 169.254.169.253 (AmazonProvidedDNS)
または
VPC CIDR + 2: 10.0.0.2
```

### 解決可能なドメイン

1. **パブリックドメイン**
   - example.com
   - google.com

2. **AWSサービスエンドポイント**
   - s3.amazonaws.com
   - rds.amazonaws.com

3. **VPC内部ドメイン**
   - ip-10-0-1-10.ec2.internal
   - プライベートホストゾーン（Route 53）

## デフォルト値と推奨設定

### デフォルト動作

```hcl
resource "aws_vpc" "example" {
  cidr_block = "10.0.0.0/16"
  # enable_dns_support = true  # デフォルトでtrue（省略可能）
}
```

### 明示的な設定

```hcl
resource "aws_vpc" "example_project" {
  cidr_block         = "10.0.0.0/16"
  enable_dns_support = true  # 明示的に有効化（推奨）
}
```

## enable_dns_hostnamesとの関係

### 設定の依存関係

| enable_dns_support | enable_dns_hostnames | 結果 |
|-------------------|---------------------|------|
| true（推奨） | true（推奨） | DNS解決 ✓ + パブリックDNS名割り当て ✓ |
| true | false | DNS解決 ✓ + パブリックDNS名割り当て ✗ |
| false | true | DNS解決 ✗（hostnamesも事実上無効） |
| false | false | すべてのDNS機能無効 |

### 正しい設定例

```hcl
resource "aws_vpc" "recommended" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true  # DNS解決を有効化
  enable_dns_hostnames = true  # DNS名割り当てを有効化
}
```

## 無効化した場合の影響

### DNS解決が無効の場合

```hcl
resource "aws_vpc" "no_dns" {
  cidr_block         = "10.0.0.0/16"
  enable_dns_support = false  # 非推奨
}
```

影響：
1. **名前解決不可**
   - RDSエンドポイント名が解決できない
   - S3エンドポイントにアクセスできない
   - 外部ドメインも解決不可

2. **代替手段が必要**
   - カスタムDNSサーバーの設置
   - /etc/hostsファイルの手動管理
   - IPアドレス直接指定

## 設定の使用例

### 標準的なWebアプリケーション

```hcl
# VPC設定
resource "aws_vpc" "web_app" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true
  
  tags = {
    Name = "web-app-vpc"
  }
}

# RDSインスタンス
resource "aws_db_instance" "main" {
  identifier = "main-db"
  # エンドポイント: main-db.xxx.rds.amazonaws.com
  # enable_dns_support = true により名前解決可能
}

# アプリケーション設定
resource "aws_ecs_task_definition" "app" {
  container_definitions = jsonencode([{
    environment = [{
      name  = "DATABASE_HOST"
      value = aws_db_instance.main.endpoint  # DNS名で接続
    }]
  }])
}
```

### カスタムDNS設定

```hcl
# カスタムDHCPオプション
resource "aws_vpc_dhcp_options" "custom" {
  domain_name_servers = [
    "AmazonProvidedDNS",  # Amazon DNSを最初に
    "8.8.8.8",            # Google DNS
    "8.8.4.4"
  ]
}

# VPCに関連付け
resource "aws_vpc_dhcp_options_association" "main" {
  vpc_id          = aws_vpc.main.id
  dhcp_options_id = aws_vpc_dhcp_options.custom.id
}
```

### VPCエンドポイント使用時

```hcl
# S3 VPCエンドポイント
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.${var.region}.s3"
  
  # enable_dns_support = true が必要
  # S3のDNS名（bucket.s3.amazonaws.com）を解決
}
```

## トラブルシューティング

### DNS解決の確認方法

```bash
# EC2インスタンス内で実行

# 1. DNSサーバーの確認
$ cat /etc/resolv.conf
nameserver 10.0.0.2  # VPC DNSサーバー

# 2. DNS解決テスト
$ nslookup google.com
# 成功すればDNS解決は有効

# 3. AWSサービスの解決
$ nslookup s3.amazonaws.com
# S3エンドポイントが解決できるか確認

# 4. VPC内部の解決
$ nslookup ip-10-0-1-10.ec2.internal
# 内部DNS名の解決確認
```

### よくある問題

1. **RDSに接続できない**
   ```hcl
   # 問題: DNS解決が無効
   enable_dns_support = false
   
   # 解決: 有効化する
   enable_dns_support = true
   ```

2. **VPCエンドポイントが機能しない**
   ```hcl
   # DNS解決が前提条件
   resource "aws_vpc" "main" {
     enable_dns_support = true  # 必須
   }
   ```

3. **コンテナからの外部接続失敗**
   ```hcl
   # ECS/Fargateタスクでの問題
   # DNS解決を確認
   enable_dns_support = true
   ```

## 関連

- [AWS VPC DNS Resolution](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html)
- [Amazon Route 53 Resolver](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver.html)
- enable_dns_hostnamesとの違い（2025.08.04.21.28_what_enable_dns_hostnames_in_terraform_aws_vpc.md）
- VPCエンドポイントの設定ガイド