# Terraformモジュールの作成チュートリアル

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformモジュールを作成するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTerraformモジュールを作成するか
> 
> **Answer** : `main.tf`、`variables.tf`、`outputs.tf`の基本構造を作成し、変数でパラメータ化。`create_before_destroy`ライフサイクルを設定し、セマンティックバージョニングでリリース管理。

## 目次

<details>
<summary>目次を開く</summary>

- [1. モジュールの基本構造](#1-モジュールの基本構造)
- [2. モジュールの作成手順](#2-モジュールの作成手順)
- [3. モジュールの使用方法](#3-モジュールの使用方法)
- [4. モジュール開発のベストプラクティス](#4-モジュール開発のベストプラクティス)
- [5. モジュールのテスト](#5-モジュールのテスト)
- [6. ドキュメント作成](#6-ドキュメント作成)
- [7. バージョニングとリリース管理](#7-バージョニングとリリース管理)
- [8. モジュールの公開（オプション）](#8-モジュールの公開オプション)

</details>

## 1. モジュールの基本構造

モジュールは以下の基本構造を持ちます：

```
module_name/
├── main.tf       # メインのリソース定義
├── variables.tf  # 入力変数の定義
├── outputs.tf    # 出力値の定義
└── README.md     # モジュールの説明
```

## 2. モジュールの作成手順

### 2.1 ディレクトリ構造の作成

```bash
mkdir module_name
cd module_name
touch main.tf variables.tf outputs.tf README.md
```

### 2.2 variables.tf の作成

変数の定義例：

```hcl
variable "aws_region" {
  description = "AWS region to deploy resources"
  type        = string
  default     = "ap-northeast-1"
}

variable "environment" {
  description = "Environment name (dev, staging, prod)"
  type        = string
  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be either dev, staging, or prod."
  }
}
```

### 2.3 main.tf の作成

リソース定義例：

```hcl
provider "aws" {
  region = var.aws_region
}

resource "aws_instance" "example" {
  ami           = var.ami_id
  instance_type = var.instance_type

  tags = {
    Name        = "${var.project_name}-instance"
    Environment = var.environment
  }
}
```

### 2.4 outputs.tf の作成

出力値の定義例：

```hcl
output "instance_id" {
  description = "ID of the created EC2 instance"
  value       = aws_instance.example.id
}

output "public_ip" {
  description = "Public IP of the created EC2 instance"
  value       = aws_instance.example.public_ip
}
```

## 3. モジュールの使用方法

### 3.1 モジュールの呼び出し

```hcl
module "example" {
  source = "./module_name"

  aws_region   = "ap-northeast-1"
  environment  = "dev"
  project_name = "my-project"
}
```

### 3.2 モジュールの出力値の参照

```hcl
output "instance_public_ip" {
  value = module.example.public_ip
}
```

## 4. モジュール開発のベストプラクティス

### 4.1 変数の命名規則

- 明確で説明的な名前を使用
- スネークケースを使用（例：`instance_type`）
- プレフィックスを使用して関連する変数をグループ化

```hcl
variable "db_username" {}
variable "db_password" {}
variable "db_name" {}
```

### 4.2 バリデーション

変数のバリデーションを追加して、誤った値の使用を防ぐ：

```hcl
variable "instance_type" {
  type = string
  validation {
    condition     = can(regex("^t[23].*|^m[4-6].*", var.instance_type))
    error_message = "Invalid instance type. Must be t2.*, t3.*, m4.*, m5.*, or m6.*"
  }
}
```

### 4.3 タグ付け

一貫したタグ付けを実装：

```hcl
locals {
  common_tags = {
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "Terraform"
  }
}

resource "aws_instance" "example" {
  # ... other configurations ...
  tags = merge(local.common_tags, var.additional_tags)
}
```

## 5. モジュールのテスト

### 5.1 基本的なテスト構造

```
module_name/
├── test/
│   ├── main.tf          # テスト用の設定
│   ├── variables.tf     # テスト用の変数
│   └── outputs.tf       # テスト用の出力
└── examples/
    └── basic/
        ├── main.tf      # 基本的な使用例
        └── README.md    # 使用例の説明
```

### 5.2 terratest の使用例

```go
package test

import (
    "testing"
    "github.com/gruntwork-io/terratest/modules/terraform"
    "github.com/stretchr/testify/assert"
)

func TestTerraformModule(t *testing.T) {
    terraformOptions := &terraform.Options{
        TerraformDir: "../examples/basic",
        Vars: map[string]interface{}{
            "environment": "test",
        },
    }

    defer terraform.Destroy(t, terraformOptions)
    terraform.InitAndApply(t, terraformOptions)

    instanceId := terraform.Output(t, terraformOptions, "instance_id")
    assert.NotEmpty(t, instanceId)
}
```

## 6. ドキュメント作成

### 6.1 README.md の基本構造

```markdown
# モジュール名

## 概要
このモジュールの目的と機能の説明

## 使用方法
```hcl
module "example" {
  source = "path/to/module"
  
  variable1 = "value1"
  variable2 = "value2"
}
```

## 入力変数
| 名前 | 説明 | タイプ | デフォルト値 | 必須 |
|------|------|--------|--------------|------|
| var1 | 説明1 | string | null | yes |
| var2 | 説明2 | number | 1 | no |

## 出力値
| 名前 | 説明 |
|------|------|
| output1 | 説明1 |
| output2 | 説明2 |
```

## 7. バージョニングとリリース管理

### 7.1 セマンティックバージョニング

- MAJOR.MINOR.PATCH形式を使用
- 下位互換性のない変更は MAJOR バージョンを上げる
- 機能追加は MINOR バージョンを上げる
- バグ修正は PATCH バージョンを上げる

### 7.2 タグ付け

```bash
git tag -a "v1.0.0" -m "Initial release"
git push origin v1.0.0
```

## 8. モジュールの公開（オプション）

### 8.1 Terraform Registry への公開

1. GitHubリポジトリの作成
2. セマンティックバージョニングのタグ付け
3. Terraform Registry へのリポジトリの登録
4. モジュールのドキュメント作成

### 8.2 プライベートレジストリの使用

```hcl
module "example" {
  source = "git::https://example.com/path/to/module.git?ref=v1.0.0"
}
```

## 関連
- [AWS ACM証明書のTerraform設定ガイド](/Users/shota-hashimoto/til/daily/2025.08.01.14.31_how_aws_acm_certificate_terraform_configuration_guide.md)
- [Terraformモジュールの公式ドキュメント](https://developer.hashicorp.com/terraform/language/modules)
- [Terraform Registry](https://registry.terraform.io/)
- [Terratest - Go言語を使ったTerraformテストフレームワーク](https://terratest.gruntwork.io/)
- [モジュールベストプラクティス](https://developer.hashicorp.com/terraform/tutorials/modules/module-create) 