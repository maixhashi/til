# AWS Subnetのmap_public_ip_on_launch設定とは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS Subnetにおけるmap_public_ip_on_launch設定とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : map_public_ip_on_launchとは何か
> 
> **Answer** : サブネット内で起動するEC2インスタンスに自動的にパブリックIPアドレスを割り当てるかどうかを制御する設定で、パブリックサブネットではtrue、プライベートサブネットではfalseまたは未設定にする

## 目次

<details>
<summary>目次を開く</summary>

- [map_public_ip_on_launchの概要](#map_public_ip_on_launchの概要)
- [設定値と動作](#設定値と動作)
- [パブリック/プライベートサブネットの区別](#パブリックプライベートサブネットの区別)
- [EC2インスタンスへの影響](#ec2インスタンスへの影響)
- [設定の優先順位](#設定の優先順位)
- [プロジェクトでの使用例](#プロジェクトでの使用例)
- [セキュリティとコストの考慮事項](#セキュリティとコストの考慮事項)

</details>

## map_public_ip_on_launchの概要

`map_public_ip_on_launch`は、サブネットレベルでEC2インスタンスのパブリックIP自動割り当てを制御する設定です。

主な特徴：
- サブネットのデフォルト動作を定義
- インスタンス起動時に自動適用
- 個別のインスタンス設定で上書き可能

## 設定値と動作

### 設定可能な値

| 設定値 | 動作 | 用途 |
|--------|------|------|
| true | パブリックIPを自動割り当て | パブリックサブネット |
| false（デフォルト） | パブリックIPを割り当てない | プライベートサブネット |

### 実際の設定例

```hcl
# パブリックサブネット
resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  map_public_ip_on_launch = true  # パブリックIP自動割り当て
}

# プライベートサブネット
resource "aws_subnet" "private" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.11.0/24"
  # map_public_ip_on_launch = false（デフォルト）
}
```

## パブリック/プライベートサブネットの区別

### パブリックサブネットの特徴

```hcl
resource "aws_subnet" "public_a" {
  vpc_id                  = aws_vpc.example_project.id
  availability_zone       = "ap-northeast-1a"
  cidr_block              = "10.0.1.0/24"
  map_public_ip_on_launch = true  # 必須設定

  tags = {
    Name = "${var.project_name}-subnet-Public-A-${var.environment}"
    Type = "public"
  }
}
```

要件：
1. `map_public_ip_on_launch = true`
2. インターネットゲートウェイへのルート
3. 適切なセキュリティグループ設定

### プライベートサブネットの特徴

```hcl
resource "aws_subnet" "private_app_a" {
  vpc_id            = aws_vpc.example_project.id
  availability_zone = "ap-northeast-1a"
  cidr_block        = "10.0.11.0/24"
  # map_public_ip_on_launch は設定しない（false）

  tags = {
    Name = "${var.project_name}-subnet-Private-App-A-${var.environment}"
    Type = "private-app"
  }
}
```

特徴：
- パブリックIPなし
- NATゲートウェイ経由で外部接続
- より高いセキュリティ

## EC2インスタンスへの影響

### パブリックIP割り当ての流れ

```hcl
# サブネット設定がtrueの場合
resource "aws_instance" "web" {
  subnet_id     = aws_subnet.public_a.id
  instance_type = "t3.micro"
  # 自動的にパブリックIPが割り当てられる
}

# 明示的な指定で上書き可能
resource "aws_instance" "no_public_ip" {
  subnet_id                   = aws_subnet.public_a.id
  instance_type               = "t3.micro"
  associate_public_ip_address = false  # サブネット設定を上書き
}
```

### ECS/Fargateでの動作

```hcl
resource "aws_ecs_service" "app" {
  network_configuration {
    subnets = [aws_subnet.public_a.id]
    # map_public_ip_on_launch = true の場合
    # FargateタスクにパブリックIPが割り当てられる
    assign_public_ip = "ENABLED"  # 明示的に指定も可能
  }
}
```

## 設定の優先順位

### 優先順位の階層

1. **インスタンスレベルの設定**（最優先）
   ```hcl
   associate_public_ip_address = true/false
   ```

2. **サブネットレベルの設定**
   ```hcl
   map_public_ip_on_launch = true/false
   ```

3. **デフォルト動作**
   - パブリックIPなし（false）

### 設定の組み合わせ例

| サブネット設定 | インスタンス設定 | 結果 |
|---------------|-----------------|------|
| true | 未指定 | パブリックIP割り当て |
| true | false | パブリックIPなし |
| false | true | パブリックIP割り当て |
| false | 未指定 | パブリックIPなし |

## プロジェクトでの使用例

### 実際の設定パターン

```hcl
# 1. パブリックサブネット（ALB用）
resource "aws_subnet" "public_a" {
  vpc_id                  = aws_vpc.example_project.id
  availability_zone       = "ap-northeast-1a"
  cidr_block              = "10.0.1.0/24"
  map_public_ip_on_launch = true  # ALBはパブリックIPが必要
}

# 2. プライベートアプリケーションサブネット
resource "aws_subnet" "private_app_a" {
  vpc_id            = aws_vpc.example_project.id
  availability_zone = "ap-northeast-1a"
  cidr_block        = "10.0.11.0/24"
  # map_public_ip_on_launch = false（デフォルト）
  # ECS/Fargateタスクはプライベート配置
}

# 3. プライベートDBサブネット
resource "aws_subnet" "private_db_a" {
  vpc_id            = aws_vpc.example_project.id
  availability_zone = "ap-northeast-1a"
  cidr_block        = "10.0.21.0/24"
  # map_public_ip_on_launch = false（デフォルト）
  # RDSは絶対にパブリックIPを持たない
}
```

### ルートテーブルとの連携

```hcl
# パブリックサブネット用ルートテーブル
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.example_project.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id  # IGW経由
  }
}

# プライベートサブネット用ルートテーブル
resource "aws_route_table" "private" {
  vpc_id = aws_vpc.example_project.id

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main.id  # NAT経由
  }
}
```

## セキュリティとコストの考慮事項

### セキュリティ上の注意点

1. **最小権限の原則**
   - 必要な場合のみパブリックIPを割り当て
   - データベースサーバーは必ずプライベート配置

2. **セキュリティグループの併用**
   ```hcl
   resource "aws_security_group" "public" {
     ingress {
       from_port   = 443
       to_port     = 443
       protocol    = "tcp"
       cidr_blocks = ["0.0.0.0/0"]  # 必要最小限のポート開放
     }
   }
   ```

3. **監査ログの活用**
   - VPC Flow Logsでトラフィック監視
   - CloudTrailでAPI呼び出し記録

### コストの考慮

1. **パブリックIPアドレスの課金**
   - 実行中のインスタンス：無料
   - 停止中のインスタンス：時間単位で課金
   - Elastic IP推奨（固定IP必要時）

2. **データ転送コスト**
   - パブリックIP経由：インターネット転送料金
   - プライベートIP経由：VPC内転送は無料

3. **最適化の方法**
   ```hcl
   # 開発環境では必要最小限に
   map_public_ip_on_launch = var.environment == "prod" ? true : false
   ```

## 関連

- [AWS Subnet Configuration](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)
- [Public and Private Subnets](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html)
- AWS VPCネットワーク設計のベストプラクティス
- セキュリティグループとNACLの設定ガイド