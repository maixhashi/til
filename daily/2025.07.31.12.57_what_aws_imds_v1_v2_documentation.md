# AWS Instance Metadata Service (IMDS) v1とv2の説明書

## 概要

Instance Metadata Service (IMDS) は、AWS EC2インスタンスが自身に関するメタデータを取得するためのサービスです。このドキュメントでは、IMDSv1とIMDSv2の違いと、それぞれの特徴について説明します。

## IMDSv1

### 特徴
- **アクセス方法**: シンプルなHTTP GETリクエスト
- **エンドポイント**: `http://169.254.169.254/latest/meta-data/`
- **認証**: 不要（トークンなし）
- **利用例**:
  ```bash
  curl http://169.254.169.254/latest/meta-data/instance-id
  ```

### セキュリティ上の課題
1. **SSRF攻撃への脆弱性**: 
   - 攻撃者がWebアプリケーションの脆弱性を悪用してIMDSエンドポイントにアクセス可能
   - IAMロールの認証情報を窃取される可能性

2. **認証メカニズムの欠如**:
   - リクエストの正当性を検証する仕組みがない
   - インスタンス内のすべてのプロセスがアクセス可能

## IMDSv2

### 特徴
- **アクセス方法**: セッショントークンベースの認証
- **エンドポイント**: 同じ `http://169.254.169.254/latest/meta-data/`
- **認証**: 必須（セッショントークン）
- **利用手順**:
  ```bash
  # 1. トークンの取得（TTL: 21600秒 = 6時間）
  TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
    -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
  
  # 2. トークンを使用してメタデータを取得
  curl -H "X-aws-ec2-metadata-token: $TOKEN" \
    http://169.254.169.254/latest/meta-data/instance-id
  ```

### セキュリティの強化
1. **SSRF攻撃への対策**:
   - PUTリクエストが必要なため、多くのSSRF攻撃を防御
   - トークンがないとメタデータにアクセス不可

2. **ホップ制限（TTL）**:
   - デフォルトで1ホップに制限
   - コンテナやリバースプロキシ経由のアクセスを制限

3. **セッションベースの認証**:
   - 各リクエストにトークンが必要
   - トークンの有効期限を設定可能

## 移行推奨事項

### なぜIMDSv2への移行が必要か
1. **セキュリティの向上**: SSRF攻撃やその他の脆弱性から保護
2. **AWS のベストプラクティス**: AWSが強く推奨
3. **コンプライアンス要件**: セキュリティ監査で指摘される可能性

### 移行方法
1. **段階的移行**:
   ```bash
   # IMDSv2をオプショナルに設定（両方使用可能）
   aws ec2 modify-instance-metadata-options \
     --instance-id i-1234567890abcdef0 \
     --http-tokens optional
   
   # アプリケーションをIMDSv2対応に更新後、必須に変更
   aws ec2 modify-instance-metadata-options \
     --instance-id i-1234567890abcdef0 \
     --http-tokens required
   ```

2. **新規インスタンスでの設定**:
   ```bash
   aws ec2 run-instances \
     --image-id ami-12345678 \
     --instance-type t3.micro \
     --metadata-options "HttpTokens=required,HttpPutResponseHopLimit=1"
   ```

### 互換性の確認事項
- AWS SDK: 最新バージョンはIMDSv2に対応
- アプリケーションコード: IMDSを直接呼び出している場合は更新が必要
- サードパーティツール: IMDSv2対応状況を確認

## まとめ

IMDSv2は、IMDSv1のセキュリティ上の課題を解決するために設計されました。すべての本番環境では、IMDSv2の使用を強く推奨します。段階的な移行アプローチを採用し、十分なテストを行った上で、IMDSv2を必須設定にすることが重要です。

## 参考資料
- [AWS公式ドキュメント - インスタンスメタデータサービスの使用](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)
- [AWS Security Blog - IMDSv2の導入](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/)