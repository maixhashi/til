# Terraform設定に実際の変数値を設定する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraform設定に実際の変数値を設定するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTerraform設定に実際の変数値を設定するか
> 
> **Answer** : terraform.tfvars、環境変数、コマンドライン引数、Terraformワークスペースの4つの方法を組み合わせて、機密性と環境に応じて適切に変数値を設定する

## 目次

<details>
<summary>目次を開く</summary>

- [変数設定の基本概念](#変数設定の基本概念)
- [変数の優先順位](#変数の優先順位)
- [設定方法1: terraform.tfvarsファイル](#設定方法1-terraformtfvarsファイル)
- [設定方法2: 環境変数](#設定方法2-環境変数)
- [設定方法3: コマンドライン引数](#設定方法3-コマンドライン引数)
- [設定方法4: Terraformワークスペース](#設定方法4-terraformワークスペース)
- [プロジェクトでの実装例](#プロジェクトでの実装例)
- [機密情報の管理](#機密情報の管理)
- [環境別設定のベストプラクティス](#環境別設定のベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)

</details>

## 変数設定の基本概念

Terraformでは変数を定義することで、コードの再利用性と柔軟性を高めることができます。

### 変数の定義と値の設定

```hcl
# variables.tf - 変数の定義
variable "project_name" {
  description = "プロジェクト名"
  type        = string
  default     = "example-project"  # デフォルト値
}

variable "db_master_password" {
  description = "RDSマスターパスワード"
  type        = string
  sensitive   = true  # 機密情報として扱う
  # デフォルト値なし = 必須変数
}
```

## 変数の優先順位

Terraformは以下の優先順位で変数値を決定します（上位が優先）：

```mermaid
graph TD
    A[コマンドライン -var/-var-file] --> B[*.auto.tfvars]
    B --> C[terraform.tfvars]
    C --> D[環境変数 TF_VAR_]
    D --> E[デフォルト値]
    
    style A fill:#ff9999
    style E fill:#99ccff
```

## 設定方法1: terraform.tfvarsファイル

### 基本的な使用方法

```hcl
# terraform.tfvars
project_name = "example-project"
domain_name  = "monitoring.example.co.jp"
region       = "ap-northeast-1"

# 環境ごとに異なる値
desired_count = 2
```

### 環境別ファイルの作成

```bash
# ファイル構成
terraform/
├── terraform.tfvars          # 共通設定
├── staging.tfvars           # ステージング環境
├── production.tfvars        # 本番環境
└── terraform.tfvars.example # サンプル（Git管理）
```

### terraform.tfvars.example

```hcl
# terraform.tfvars.example
# このファイルをコピーして terraform.tfvars を作成してください

# 基本設定
project_name = "example-project"
domain_name  = "your-domain.com"
region       = "ap-northeast-1"

# AWS認証情報（環境変数での設定を推奨）
# aws_access_key       = "YOUR_ACCESS_KEY"
# aws_secret_access_key = "YOUR_SECRET_KEY"

# データベース設定
# db_master_password = "CHANGE_ME"

# 証明書ARN
certificate_arn            = "arn:aws:acm:ap-northeast-1:xxx:certificate/xxx"
cloudfront_certificate_arn = "arn:aws:acm:us-east-1:xxx:certificate/xxx"

# アプリケーション秘密情報
# aes_key                        = "YOUR_AES_KEY"
# basic_auth                     = "username:password"
# example_server_aws_access_key    = "YOUR_KEY"
# example_server_aws_secret_access_key = "YOUR_SECRET"
# example_external_secret_key      = "YOUR_EXTERNAL_KEY"
```

## 設定方法2: 環境変数

### 環境変数の命名規則

```bash
# TF_VAR_ プレフィックスを付ける
export TF_VAR_db_master_password="SecurePassword123!"
export TF_VAR_aws_access_key="AKIAIOSFODNN7EXAMPLE"
export TF_VAR_aws_secret_access_key="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
```

### AWS認証の特別な環境変数

```bash
# Terraform AWS Providerが認識する標準的な環境変数
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_DEFAULT_REGION="ap-northeast-1"

# またはプロファイルを使用
export AWS_PROFILE="example-project"
```

### .envファイルの活用

```bash
# .env.example
TF_VAR_db_master_password=CHANGE_ME
TF_VAR_aes_key=CHANGE_ME
TF_VAR_basic_auth=username:password

# 使用方法
source .env
terraform plan
```

## 設定方法3: コマンドライン引数

### 個別の変数指定

```bash
# -var オプション
terraform plan -var="desired_count=3" -var="environment=prod"

# 複数の変数
terraform apply \
  -var="project_name=example-project" \
  -var="desired_count=2" \
  -var="enable_deletion_protection=true"
```

### 変数ファイルの指定

```bash
# -var-file オプション
terraform plan -var-file="production.tfvars"

# 複数のファイル（後のファイルが優先）
terraform apply \
  -var-file="common.tfvars" \
  -var-file="production.tfvars"
```

## 設定方法4: Terraformワークスペース

### ワークスペースの作成と切り替え

```bash
# ワークスペース一覧
terraform workspace list

# 新規作成
terraform workspace new prod

# 切り替え
terraform workspace select stg
```

### ワークスペースを活用した環境別設定

```hcl
# variables.tf
locals {
  environment = terraform.workspace == "default" ? "stg" : terraform.workspace
  
  environment_config = {
    stg = {
      instance_class       = "db.t3.small"
      cpu                  = "256"
      memory               = "512"
      desired_count        = 1
      deletion_protection  = false
    }
    prod = {
      instance_class       = "db.t3.medium"
      cpu                  = "512"
      memory               = "1024"
      desired_count        = 2
      deletion_protection  = true
    }
  }
  
  config = local.environment_config[local.environment]
}

# 使用例
resource "aws_db_instance" "main" {
  instance_class = local.config.instance_class
}
```

## プロジェクトでの実装例

### 1. 必須変数の確認

```bash
# 必須変数（デフォルト値なし）を確認
grep -B2 "variable" variables.tf | grep -B2 -v "default"

# 結果例：
# variable "aws_access_key"
# variable "aws_secret_access_key"
# variable "db_master_password"
# variable "certificate_arn"
# variable "aes_key"
```

### 2. 環境構築手順

```bash
# 1. terraform.tfvarsを作成
cp terraform.tfvars.example terraform.tfvars
vim terraform.tfvars  # 必要な値を設定

# 2. 機密情報を環境変数で設定
export TF_VAR_db_master_password="$(openssl rand -base64 32)"
export TF_VAR_aes_key="$(openssl rand -hex 32)"

# 3. ワークスペースを選択
terraform workspace select stg  # または prod

# 4. 初期化と適用
terraform init
terraform plan
terraform apply
```

### 3. CI/CD での設定例

```yaml
# GitHub Actions の例
name: Terraform Apply

env:
  TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
  TF_VAR_aes_key: ${{ secrets.AES_KEY }}
  TF_VAR_basic_auth: ${{ secrets.BASIC_AUTH }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        
      - name: Terraform Init
        run: terraform init
        
      - name: Select Workspace
        run: terraform workspace select ${{ github.event.inputs.environment }}
        
      - name: Terraform Apply
        run: terraform apply -auto-approve -var-file="${{ github.event.inputs.environment }}.tfvars"
```

## 機密情報の管理

### 1. Gitで管理すべきでないファイル

```gitignore
# .gitignore
*.tfvars
!*.tfvars.example
.env
.env.*
!.env.example
```

### 2. 機密情報の分類と管理方法

| 情報の種類 | 管理方法 | 例 |
|------------|----------|-----|
| 環境共通の設定 | terraform.tfvars | project_name, region |
| 環境固有の設定 | workspace + locals | instance_class, desired_count |
| 機密情報（開発） | 環境変数 or .env | db_password, api_keys |
| 機密情報（本番） | CI/CDシークレット | 全ての認証情報 |
| 証明書ARN | terraform.tfvars | 環境別に異なるが機密ではない |

### 3. AWS Systems Manager Parameter Store の活用

```hcl
# SSM Parameter Store から値を取得
data "aws_ssm_parameter" "db_password" {
  name = "/example-project/${local.environment}/db_password"
}

resource "aws_db_instance" "main" {
  password = data.aws_ssm_parameter.db_password.value
}
```

## 環境別設定のベストプラクティス

### 1. 変数の整理

```hcl
# 環境に依存しない変数（terraform.tfvars）
project_name = "example-project"
region       = "ap-northeast-1"

# 環境に依存する変数（workspace + locals）
locals {
  environment_config = {
    stg = { ... }
    prod = { ... }
  }
}

# 機密情報（環境変数）
# TF_VAR_db_master_password
# TF_VAR_aes_key
```

### 2. 検証環境の構築

```bash
# Makefile の例
.PHONY: plan-stg plan-prod apply-stg apply-prod

plan-stg:
	terraform workspace select stg
	terraform plan -var-file=common.tfvars -var-file=staging.tfvars

plan-prod:
	terraform workspace select prod
	terraform plan -var-file=common.tfvars -var-file=production.tfvars

apply-stg:
	terraform workspace select stg
	terraform apply -var-file=common.tfvars -var-file=staging.tfvars

apply-prod:
	@echo "本番環境への適用です。続行しますか？ [y/N]"
	@read confirm && [ "$$confirm" = "y" ]
	terraform workspace select prod
	terraform apply -var-file=common.tfvars -var-file=production.tfvars
```

## トラブルシューティング

### 1. 変数が見つからないエラー

```bash
Error: No value for required variable

  on variables.tf line 10:
  10: variable "db_master_password" {

The root module input variable "db_master_password" is not set, and has no
default value. Use a -var or -var-file command line argument to provide a
value for this variable.
```

**解決方法**:
```bash
# 環境変数を確認
echo $TF_VAR_db_master_password

# 設定されていない場合
export TF_VAR_db_master_password="your-password"
```

### 2. ワークスペースの確認

```bash
# 現在のワークスペースを確認
terraform workspace show

# 間違っている場合は切り替え
terraform workspace select stg
```

### 3. 変数値の確認

```bash
# 設定された変数値を確認（plan実行時）
terraform plan -var-file=terraform.tfvars | grep -A5 "Terraform will perform"

# デバッグ出力
TF_LOG=DEBUG terraform plan 2>&1 | grep "Variable"
```

### 4. 優先順位の問題

```bash
# 意図しない値が使われる場合、優先順位を確認

# 1. コマンドライン引数が最優先
terraform plan -var="desired_count=5"  # これが優先される

# 2. 環境変数より.tfvarsが優先
# terraform.tfvars: desired_count = 2
# TF_VAR_desired_count=3
# → 2が使用される
```

## 関連

- [Terraform Variables Documentation](https://www.terraform.io/docs/language/values/variables.html)
- [Terraform Workspaces](https://www.terraform.io/docs/language/state/workspaces.html)
- [AWS Systems Manager Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)
- プロジェクトのCI/CD設定ガイド