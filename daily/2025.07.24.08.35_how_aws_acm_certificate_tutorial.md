# AWS Certificate Manager (ACM) Terraform チュートリアル

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにAWS Certificate Manager (ACM) をTerraformで管理するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにAWS ACMをTerraformで管理するか
> 
> **Answer** : `aws_acm_certificate`リソースを使用し、DNS検証を推奨。`create_before_destroy`ライフサイクルを設定し、Route53と統合して自動検証を実現。CloudFront用は必ずus-east-1リージョンで作成。

## 目次

<details>
<summary>目次を開く</summary>

- [基本的な設定](#基本的な設定)
- [実践的な使用例](#実践的な使用例)
- [重要な考慮事項](#重要な考慮事項)
- [DNS検証の自動化](#dns検証の自動化)
- [ベストプラクティス](#ベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)
- [関連](#関連)

</details>

## 概要

このドキュメントでは、AWS Certificate Manager (ACM) をTerraformを使用して管理する方法について説明します。
ACMは、AWSのサービスで使用するSSL/TLS証明書を提供および管理するサービスです。

## 基本的な設定

### 1. シンプルな証明書リソース

```hcl
resource "aws_acm_certificate" "example" {
  domain_name       = "example.com"
  validation_method = "DNS"

  tags = {
    Environment = "production"
  }

  lifecycle {
    create_before_destroy = true
  }
}
```

### 2. マルチドメイン証明書

```hcl
resource "aws_acm_certificate" "wildcard" {
  domain_name               = "example.com"
  subject_alternative_names = ["*.example.com", "api.example.com"]
  validation_method         = "DNS"
}
```

## 実践的な使用例

### 1. 環境別の証明書管理

```hcl
resource "aws_acm_certificate" "main" {
  domain_name       = terraform.workspace != "prod" ? "app-${terraform.workspace}.example.com" : "app.example.com"
  validation_method = "DNS"
  
  subject_alternative_names = terraform.workspace != "prod" ? 
    ["*.app-${terraform.workspace}.example.com"] : 
    ["*.app.example.com"]

  tags = {
    Name        = "application-certificate"
    Environment = terraform.workspace
  }

  lifecycle {
    create_before_destroy = true
  }
}
```

### 2. リージョン別の証明書管理

```hcl
# CloudFront用（バージニアリージョン）
resource "aws_acm_certificate" "cloudfront" {
  provider          = aws.virginia
  domain_name       = "cdn.example.com"
  validation_method = "DNS"
}

# ALB用（東京リージョン）
resource "aws_acm_certificate" "alb" {
  domain_name       = "api.example.com"
  validation_method = "DNS"
}
```

## 重要な考慮事項

1. **検証方法**
   - DNS検証: 推奨される方法。自動更新が可能
   - Email検証: レガシーな方法。手動の介入が必要

2. **ライフサイクル管理**
   ```hcl
   lifecycle {
     create_before_destroy = true
   }
   ```
   - 証明書の更新時に新しい証明書を作成してから古い証明書を削除
   - ダウンタイムを防ぐために重要

3. **リージョンの考慮**
   - CloudFrontは必ずus-east-1（バージニア）の証明書を使用
   - 他のサービスは同じリージョンの証明書を使用

## DNS検証の自動化

```hcl
resource "aws_acm_certificate" "cert" {
  domain_name       = "example.com"
  validation_method = "DNS"
}

resource "aws_route53_record" "cert_validation" {
  for_each = {
    for dvo in aws_acm_certificate.cert.domain_validation_options : dvo.domain_name => {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  name    = each.value.name
  type    = each.value.type
  zone_id = aws_route53_zone.primary.zone_id
  records = [each.value.record]
  ttl     = 60
}

resource "aws_acm_certificate_validation" "cert" {
  certificate_arn         = aws_acm_certificate.cert.arn
  validation_record_fqdns = [for record in aws_route53_record.cert_validation : record.fqdn]
}
```

## ベストプラクティス

1. **命名規則**
   - 環境やリージョンを反映した明確な名前付け
   - タグによる適切な管理

2. **セキュリティ**
   - 必要最小限のドメインのみを含める
   - ワイルドカード証明書は慎重に使用

3. **コスト管理**
   - 未使用の証明書は削除
   - 証明書の統合を検討（可能な場合）

4. **更新管理**
   - `create_before_destroy = true` の使用
   - DNS検証の採用
   - 自動更新の確認

## トラブルシューティング

1. **よくある問題**
   - 検証タイムアウト
   - DNS レコードの伝播遅延
   - リージョンの不一致

2. **解決方法**
   - DNS伝播の待機時間の確保
   - 正しいリージョンでの証明書作成の確認
   - 検証レコードの正確な設定

## 関連
- [AWS ACM証明書リソースリファレンス](/Users/shota-hashimoto/til/daily/2025.07.24.08.47_what_aws_acm_certificate.md)
- [AWS Route53チュートリアル](/Users/shota-hashimoto/til/daily/2025.07.24.08.58_how_aws_route53_tutorial.md)
- [AWS ACM 公式ドキュメント](https://docs.aws.amazon.com/acm/)
- [Terraform AWS Provider - ACM](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/acm_certificate)
- [ACM ベストプラクティス](https://docs.aws.amazon.com/acm/latest/userguide/acm-bestpractices.html) 