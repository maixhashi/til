# なぜタグのNameも環境別に区別すべきなのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**TerraformでタグのNameも環境（prod/stg）別に区別する必要があるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**タグのNameも環境別に区別する必要があるのか
> 
> **Answer** : コンソールでの誤操作防止、コスト分析の精度向上、アラート・監視の環境別管理、複数環境の並行運用において必須。Nameタグは一意性の制約はないが、運用上は環境を含めるべき

## 目次
<details>
<summary>目次を開く</summary>

- [1. タグのNameに環境情報を含めるべき理由](#1-タグのnameに環境情報を含めるべき理由)
- [2. 環境情報を含めない場合のリスク](#2-環境情報を含めない場合のリスク)
- [3. 効果的な環境別Name設定パターン](#3-効果的な環境別name設定パターン)
- [4. 実際の運用シナリオ](#4-実際の運用シナリオ)
- [5. 例外的なケース](#5-例外的なケース)

</details>

## 1. タグのNameに環境情報を含めるべき理由

### AWSコンソールでの視認性

```hcl
# ❌ 悪い例：環境情報なし
resource "aws_instance" "web" {
  # ...
  tags = {
    Name = "Web Server"  # どの環境か不明
  }
}

# ✅ 良い例：環境情報あり
resource "aws_instance" "web" {
  # ...
  tags = {
    Name = "Web Server - Production"  # 一目で本番環境とわかる
    # または
    Name = "${var.project_name} Web Server (${var.environment})"
  }
}
```

### コンソールでのリソース一覧表示

AWSコンソールでは、多くのサービスでNameタグが優先的に表示されます：

```hcl
# EC2インスタンス一覧での表示例
# Nameタグなし → インスタンスIDのみ表示: i-0123456789abcdef0
# Nameタグあり → Nameタグの値を表示: Web Server - Production

# 複数環境が混在する場合の識別
tags = {
  Name = "${var.project_name}-${var.resource_type}-${var.environment}"
  # example-web-production
  # example-web-staging
  # example-web-development
}
```

## 2. 環境情報を含めない場合のリスク

### 誤操作のリスク

```hcl
# 危険な例：同じNameタグ
# staging/main.tf
resource "aws_instance" "app" {
  tags = {
    Name = "Application Server"  # 同じ名前
  }
}

# production/main.tf
resource "aws_instance" "app" {
  tags = {
    Name = "Application Server"  # 同じ名前 → 区別できない！
  }
}
```

### コスト分析の困難

```hcl
# Cost Explorerでのフィルタリングが困難
# ❌ 環境別コスト分析ができない
tags = {
  Name = "Database Server"
  Type = "RDS"
}

# ✅ 環境別コスト分析が可能
tags = {
  Name        = "Database Server - ${var.environment}"
  Environment = var.environment
  Type        = "RDS"
}
```

### 監視・アラートの混乱

```hcl
# CloudWatchアラーム名での識別
resource "aws_cloudwatch_metric_alarm" "cpu_high" {
  alarm_name = "High CPU - ${aws_instance.app.tags.Name}"
  # 環境情報がないと、どの環境のアラートか不明
  
  dimensions = {
    InstanceId = aws_instance.app.id
  }
}
```

## 3. 効果的な環境別Name設定パターン

### 基本パターン

```hcl
locals {
  # パターン1: 環境を後ろに付ける（推奨）
  name_suffix_pattern = "${var.project_name} ${var.resource_description} - ${title(var.environment)}"
  # 例: "Example App Web Server - Production"
  
  # パターン2: 環境を前に付ける
  name_prefix_pattern = "[${upper(var.environment)}] ${var.project_name} ${var.resource_description}"
  # 例: "[PROD] Example App Web Server"
  
  # パターン3: 短縮形式（スペース制約がある場合）
  name_compact_pattern = "${var.project_name}-${var.resource_type}-${var.environment}"
  # 例: "example-web-prod"
}
```

### リソース種別ごとの実装例

```hcl
# EC2インスタンス
resource "aws_instance" "app" {
  # ...
  tags = merge(local.common_tags, {
    Name = "${var.project_name} App Server - ${title(var.environment)}"
    # "Example App Server - Production"
  })
}

# RDS
resource "aws_db_instance" "main" {
  # ...
  tags = merge(local.common_tags, {
    Name = "${var.project_name} PostgreSQL - ${title(var.environment)}"
    # "Example App PostgreSQL - Staging"
  })
}

# ALB
resource "aws_lb" "main" {
  # ...
  tags = merge(local.common_tags, {
    Name = "${var.project_name} ALB - ${title(var.environment)}"
    # "Example App ALB - Production"
  })
}

# S3バケット（表示用）
resource "aws_s3_bucket" "static" {
  bucket = "${var.project_name}-static-${var.environment}-${data.aws_caller_identity.current.account_id}"
  
  tags = merge(local.common_tags, {
    Name = "${var.project_name} Static Assets - ${title(var.environment)}"
    # バケット名自体は一意性の制約があるが、Nameタグは表示用
  })
}
```

### 環境識別を強化する追加タグ

```hcl
locals {
  common_tags = {
    Name        = "${var.project_name} ${var.component} - ${title(var.environment)}"
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "terraform"
    CostCenter  = var.cost_center
    
    # 環境別の追加情報
    ProductionLevel = var.environment == "production" ? "critical" : "non-critical"
    BackupRequired  = var.environment == "production" ? "yes" : "no"
  }
}
```

## 4. 実際の運用シナリオ

### シナリオ1: 緊急時の対応

```hcl
# インシデント発生時の迅速な環境識別
resource "aws_instance" "app" {
  # ...
  tags = {
    Name         = "${var.project_name} App - ${upper(var.environment)}"
    AlertContact = var.environment == "production" ? "oncall@example.com" : "dev@example.com"
    SLA          = var.environment == "production" ? "99.9%" : "best-effort"
  }
}
```

### シナリオ2: 複数環境の同時作業

```hcl
# 開発者が複数環境で同時作業する場合
# ターミナルやブラウザのタブを多数開いている状況

# staging環境
tags = {
  Name = "[STG] ${var.project_name} - ${var.component}"
  # ターミナルのプロンプトやブラウザタブで即座に識別可能
}

# production環境
tags = {
  Name = "[PROD] ${var.project_name} - ${var.component} ⚠️"
  # 視覚的な警告も含めて本番環境を強調
}
```

### シナリオ3: 自動化スクリプトでの活用

```hcl
# Nameタグを使った環境別の一括操作
# 例: 特定環境のインスタンスのみ停止

# AWS CLIでの使用例:
# aws ec2 describe-instances --filters "Name=tag:Name,Values=*Staging*" 
# aws ec2 stop-instances --instance-ids $(上記で取得したID)

resource "aws_instance" "app" {
  tags = {
    Name            = "${var.project_name} - ${var.environment}"
    AutoStopEnabled = var.environment != "production" ? "true" : "false"
  }
}
```

## 5. 例外的なケース

### 環境情報を含めなくても良いケース

```hcl
# 1. グローバルリソース（全環境共通）
resource "aws_route53_zone" "main" {
  name = var.domain_name
  
  tags = {
    Name = "${var.project_name} DNS Zone"  # 環境情報不要
    Type = "global-resource"
  }
}

# 2. 共有リソース
resource "aws_ecr_repository" "app" {
  name = var.project_name  # 全環境で共有
  
  tags = {
    Name = "${var.project_name} Container Registry"  # 環境情報不要
    Type = "shared-resource"
  }
}

# 3. 開発専用リソース（環境が自明）
resource "aws_cloud9_environment_ec2" "dev" {
  name = "${var.project_name}-dev-environment"
  
  tags = {
    Name = "${var.project_name} Development IDE"  # 開発専用なので自明
  }
}
```

### ハイブリッドアプローチ

```hcl
# 環境に依存しない基本名 + 環境固有のサフィックス
locals {
  base_name = "${var.project_name} ${var.component}"
  
  # 本番環境のみ特別な表記
  name_tag = var.environment == "production" 
    ? "${local.base_name} - PRODUCTION ⚠️" 
    : "${local.base_name} - ${title(var.environment)}"
}

resource "aws_instance" "app" {
  tags = {
    Name = local.name_tag
  }
}
```

## 関連
- [Terraformにおけるnameパラメータとtagsのnameの違い](./2025.08.04.21.12_what_difference_between_name_and_tags_name_in_terraform.md)
- [なぜTerraformで環境別にリソース名を区別する必要があるのか](./2025.08.04.20.57_why_terraform_resource_naming_by_environment.md)
- [AWS Tagging Strategies](https://docs.aws.amazon.com/general/latest/gr/aws_tagging.html)