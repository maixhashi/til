# AWS ACM証明書のcount設定詳解

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformの`count`メタ引数を使用してAWS ACM証明書を管理するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにTerraformの`count`メタ引数を使用してAWS ACM証明書を管理するか
> 
> **Answer** : `count = var.condition ? 1 : 0`で条件付き作成を実現し、`count = length(var.list)`で複数証明書の一括作成を行い、`aws_acm_certificate.cert[0].arn`でリソースを参照する

## 目次

<details>
<summary>目次を開く</summary>

- [count設定の基本](#count設定の基本)
- [countの主な使用パターン](#countの主な使用パターン)
- [countとインデックスの活用](#countとインデックスの活用)
- [参照方法](#参照方法)
- [実践的な使用例](#実践的な使用例)
- [countとfor_eachの比較](#countとfor_eachの比較)
- [ベストプラクティス](#ベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)

</details>

## count設定の基本

### 設定項目の詳細

| 項目名 | 必須 | 型 | デフォルト値 | 説明 |
|--------|------|-----|-------------|------|
| `count` | × | number | 1 | 作成するリソースインスタンスの数。0を指定するとリソースは作成されない |

### 基本的な使用例

```hcl
# 条件付き作成（ドメイン名が設定されている場合のみ作成）
resource "aws_acm_certificate" "cert" {
  count = var.domain_name != "" ? 1 : 0
  
  domain_name       = var.domain_name
  validation_method = "DNS"
}

# 複数証明書の作成
resource "aws_acm_certificate" "multi_cert" {
  count = length(var.domain_list)
  
  domain_name       = var.domain_list[count.index]
  validation_method = "DNS"
}
```

## countの主な使用パターン

### 1. 条件付きリソース作成

最も一般的な使用方法は、特定の条件に基づいて証明書を作成するかどうかを制御することです。

```hcl
# 例1: 環境による条件分岐
resource "aws_acm_certificate" "production_cert" {
  count = terraform.workspace == "production" ? 1 : 0
  
  domain_name       = "example.com"
  validation_method = "DNS"
  
  tags = {
    Name = "production-certificate"
  }
}

# 例2: 機能フラグによる制御
variable "enable_ssl" {
  description = "SSL/TLS証明書を有効にするか"
  type        = bool
  default     = false
}

resource "aws_acm_certificate" "optional_cert" {
  count = var.enable_ssl ? 1 : 0
  
  domain_name       = var.domain_name
  validation_method = "DNS"
}

# 例3: 複数条件の組み合わせ
resource "aws_acm_certificate" "conditional_cert" {
  count = var.enable_ssl && var.domain_name != "" ? 1 : 0
  
  domain_name       = var.domain_name
  validation_method = "DNS"
}
```

### 2. 複数証明書の一括作成

複数のドメインに対して個別の証明書を作成する場合に使用します。

```hcl
variable "domains" {
  description = "証明書を作成するドメインのリスト"
  type        = list(string)
  default     = ["api.example.com", "app.example.com", "admin.example.com"]
}

resource "aws_acm_certificate" "multi_domain_certs" {
  count = length(var.domains)
  
  domain_name       = var.domains[count.index]
  validation_method = "DNS"
  
  tags = {
    Name   = "${var.domains[count.index]}-certificate"
    Index  = count.index
    Domain = var.domains[count.index]
  }
}
```

### 3. マップを使用した高度な管理

```hcl
variable "certificate_configs" {
  description = "証明書設定のマップ"
  type = map(object({
    domain_name = string
    san_domains = list(string)
    environment = string
  }))
  default = {
    main = {
      domain_name = "example.com"
      san_domains = ["*.example.com", "www.example.com"]
      environment = "production"
    }
    api = {
      domain_name = "api.example.com"
      san_domains = ["api-v1.example.com", "api-v2.example.com"]
      environment = "production"
    }
  }
}

resource "aws_acm_certificate" "mapped_certs" {
  for_each = var.certificate_configs  # countの代わりにfor_eachを使用
  
  domain_name               = each.value.domain_name
  subject_alternative_names = each.value.san_domains
  validation_method         = "DNS"
  
  tags = {
    Name        = "${each.key}-certificate"
    Environment = each.value.environment
  }
}
```

## countとインデックスの活用

### count.indexの使用方法

| 属性 | 説明 | 使用例 |
|------|------|--------|
| `count.index` | 現在のインスタンスのインデックス（0から開始） | `var.domains[count.index]` |

```hcl
# インデックスを使った命名
resource "aws_acm_certificate" "indexed_certs" {
  count = 3
  
  domain_name = "app${count.index + 1}.example.com"  # app1, app2, app3
  validation_method = "DNS"
  
  tags = {
    Name  = "certificate-${count.index + 1}"
    Index = count.index
  }
}
```

## 参照方法

### count使用時のリソース参照

```hcl
# 単一リソース（count = 0 or 1）の参照
resource "aws_cloudfront_distribution" "cdn" {
  # countが1の場合
  viewer_certificate {
    acm_certificate_arn = aws_acm_certificate.cert[0].arn
  }
}

# 条件付き参照
locals {
  certificate_arn = length(aws_acm_certificate.cert) > 0 ? aws_acm_certificate.cert[0].arn : null
}

# 複数リソースの参照
output "all_certificate_arns" {
  value = aws_acm_certificate.multi_cert[*].arn
}

# 特定インデックスの参照
output "first_certificate_domain" {
  value = length(aws_acm_certificate.multi_cert) > 0 ? aws_acm_certificate.multi_cert[0].domain_name : null
}
```

## 実践的な使用例

### 1. 環境別証明書管理

```hcl
locals {
  environments = ["dev", "stg", "prod"]
  base_domain  = "example.com"
}

resource "aws_acm_certificate" "env_certs" {
  count    = length(local.environments)
  provider = aws.virginia  # CloudFront用
  
  domain_name = local.environments[count.index] == "prod" ? 
    local.base_domain : 
    "${local.environments[count.index]}.${local.base_domain}"
  
  subject_alternative_names = local.environments[count.index] == "prod" ? 
    ["*.${local.base_domain}"] : 
    ["*.${local.environments[count.index]}.${local.base_domain}"]
  
  validation_method = "DNS"
  
  tags = {
    Name        = "${local.environments[count.index]}-certificate"
    Environment = local.environments[count.index]
  }
}
```

### 2. オプショナルなワイルドカード証明書

```hcl
variable "enable_wildcard" {
  description = "ワイルドカード証明書を作成するか"
  type        = bool
  default     = false
}

variable "primary_domain" {
  description = "プライマリドメイン"
  type        = string
}

# プライマリ証明書（常に作成）
resource "aws_acm_certificate" "primary" {
  domain_name       = var.primary_domain
  validation_method = "DNS"
  
  tags = {
    Name = "primary-certificate"
    Type = "primary"
  }
}

# ワイルドカード証明書（オプション）
resource "aws_acm_certificate" "wildcard" {
  count = var.enable_wildcard ? 1 : 0
  
  domain_name = "*.${var.primary_domain}"
  subject_alternative_names = [var.primary_domain]
  validation_method = "DNS"
  
  tags = {
    Name = "wildcard-certificate"
    Type = "wildcard"
  }
}
```

### 3. 動的なSAN証明書作成

```hcl
variable "main_domain" {
  type = string
}

variable "subdomains" {
  description = "作成するサブドメインのリスト"
  type        = list(string)
  default     = []
}

resource "aws_acm_certificate" "dynamic_san" {
  count = length(var.subdomains) > 0 ? 1 : 0
  
  domain_name = var.main_domain
  subject_alternative_names = concat(
    ["*.${var.main_domain}"],
    [for subdomain in var.subdomains : "${subdomain}.${var.main_domain}"]
  )
  validation_method = "DNS"
  
  tags = {
    Name         = "${var.main_domain}-certificate"
    SubdomainCount = length(var.subdomains)
  }
}
```

## countとfor_eachの比較

| 特徴 | count | for_each |
|------|-------|----------|
| 使用場面 | インデックスベースの作成、条件付き作成 | キーベースの作成、より複雑な構造 |
| 参照方法 | インデックス（`[0]`, `[1]`） | キー（`["main"]`, `["api"]`） |
| 削除時の影響 | インデックスがずれる可能性 | キーベースなので影響なし |
| 条件付き作成 | `count = condition ? 1 : 0` | 条件付きマップの作成が必要 |

## ベストプラクティス

### 1. 明示的な条件設定

```hcl
# 良い例：条件が明確
count = var.create_certificate ? 1 : 0

# 避けるべき例：暗黙的な型変換
count = var.create_certificate  # boolをnumberに暗黙変換
```

### 2. null値の適切な処理

```hcl
# 証明書が作成されない場合を考慮
output "certificate_arn" {
  value = try(aws_acm_certificate.cert[0].arn, null)
}
```

### 3. 検証の追加

```hcl
resource "aws_acm_certificate" "validated" {
  count = var.domain_name != "" ? 1 : 0
  
  domain_name       = var.domain_name
  validation_method = "DNS"
  
  lifecycle {
    precondition {
      condition     = can(regex("^[a-zA-Z0-9][a-zA-Z0-9-\\.]*[a-zA-Z0-9]$", var.domain_name))
      error_message = "ドメイン名の形式が不正です。"
    }
  }
}
```

## トラブルシューティング

### よくある問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| `index out of range` | countが0の時に`[0]`でアクセス | `try()`関数や条件チェックを使用 |
| リソースの予期しない再作成 | リスト内の順序変更 | `for_each`の使用を検討 |
| 依存関係エラー | count値が他のリソースに依存 | `depends_on`の明示的な指定 |

### デバッグ用の出力

```hcl
output "debug_certificate_count" {
  value = length(aws_acm_certificate.cert)
}

output "debug_certificate_indices" {
  value = range(length(aws_acm_certificate.cert))
}
```

## 関連
- [AWS ACM証明書のTerraform設定ガイド](./2025.08.01.14.31_how_aws_acm_certificate_terraform_configuration_guide.md)
- [AWS ACM証明書のProvider設定詳解](./2025.08.01.14.38_how_aws_acm_certificate_provider_configuration_details.md)
- [ACM証明書管理パターン比較](./2025.08.01.13.47_why_acm_certificate_management_patterns_comparison.md)
- [Terraform公式ドキュメント - countメタ引数](https://developer.hashicorp.com/terraform/language/meta-arguments/count)