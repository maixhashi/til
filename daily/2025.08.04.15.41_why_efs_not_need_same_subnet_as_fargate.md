# なぜEFSはFargateと同じサブネットに配置する必要がないのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**EFSはAWS Fargateと同じサブネットに配置する必要がないのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**EFSはAWS Fargateと同じサブネットに配置する必要がないのか
> 
> **Answer** : EFSはマウントターゲットを通じてアクセスされ、同一VPC内であれば異なるサブネットからでもNFSプロトコルで接続可能だから

## 目次
<details>
<summary>目次を開く</summary>

- [EFSのアーキテクチャ理解](#efsのアーキテクチャ理解)
- [FargateからEFSへの接続メカニズム](#fargateからefsへの接続メカニズム)
- [サブネット配置の考慮事項](#サブネット配置の考慮事項)
- [実装パターンとベストプラクティス](#実装パターンとベストプラクティス)

</details>

## EFSのアーキテクチャ理解

### EFSマウントターゲットの仕組み

```mermaid
graph TB
    subgraph "EFS ファイルシステム"
        EFS[EFS<br/>リージョナルサービス]
    end
    
    subgraph "VPC"
        subgraph "AZ-1a"
            subgraph "Subnet-1a"
                MT1[マウントターゲット 1<br/>10.0.1.10]
            end
            subgraph "Subnet-2a"
                Fargate1[Fargate Task 1]
            end
        end
        
        subgraph "AZ-1c"
            subgraph "Subnet-1c"
                MT2[マウントターゲット 2<br/>10.0.2.10]
            end
            subgraph "Subnet-2c"
                Fargate2[Fargate Task 2]
            end
        end
    end
    
    EFS --> MT1
    EFS --> MT2
    Fargate1 -->|NFS| MT1
    Fargate2 -->|NFS| MT2
    Fargate1 -.->|クロスAZ可能| MT2
    Fargate2 -.->|クロスAZ可能| MT1
    
    style EFS fill:#ff9,stroke:#333,stroke-width:4px
    style MT1 fill:#9ff,stroke:#333,stroke-width:2px
    style MT2 fill:#9ff,stroke:#333,stroke-width:2px
```

### 重要な特性
1. **マウントターゲット経由のアクセス**: EFS自体はリージョナルサービスで、マウントターゲットを介してアクセス
2. **NFSプロトコル**: 標準的なNFSv4.1プロトコルを使用
3. **VPC内通信**: 同一VPC内であればサブネットをまたいでアクセス可能
4. **ENI（Elastic Network Interface）**: マウントターゲットはENIとして実装

## FargateからEFSへの接続メカニズム

### 接続フロー詳細

```mermaid
sequenceDiagram
    participant FT as Fargate Task<br/>(Subnet A)
    participant SG as セキュリティグループ
    participant RT as ルートテーブル
    participant MT as EFSマウントターゲット<br/>(Subnet B)
    participant EFS as EFSファイルシステム
    
    FT->>SG: NFS接続要求 (2049/tcp)
    SG->>SG: セキュリティグループ確認
    Note over SG: Fargateタスクからの<br/>NFSトラフィック許可確認
    SG->>RT: ルーティング確認
    RT->>MT: パケット転送
    MT->>EFS: ファイルシステムアクセス
    EFS-->>MT: データ返却
    MT-->>FT: NFSレスポンス
```

### 必要な設定要素
1. **セキュリティグループ設定**
   - FargateタスクのSG: アウトバウンドでNFS (2049/tcp)を許可
   - EFSマウントターゲットのSG: インバウンドでNFS (2049/tcp)を許可

2. **ネットワーク到達性**
   - 同一VPC内でルーティング可能
   - NACLsでNFSトラフィックがブロックされていない

3. **DNS解決**
   - EFSのDNS名が正しく解決される

## サブネット配置の考慮事項

### 異なるサブネット配置のメリット

```mermaid
graph LR
    subgraph "コンピュートサブネット"
        F1[Fargate Task 1]
        F2[Fargate Task 2]
        F3[Fargate Task 3]
    end
    
    subgraph "ストレージサブネット"
        MT[EFS マウントターゲット]
        RDS[(RDS)]
        EC[(ElastiCache)]
    end
    
    F1 --> MT
    F2 --> MT
    F3 --> MT
    F1 --> RDS
    F2 --> EC
    
    style MT fill:#9ff,stroke:#333,stroke-width:3px
```

### 配置戦略の比較

| 配置パターン | メリット | デメリット | 推奨シナリオ |
|-------------|----------|------------|--------------|
| 同一サブネット | レイテンシー最小 | リソース分離が困難 | 小規模環境 |
| 異なるサブネット（同一AZ） | 論理的分離、管理性向上 | 追加設定必要 | 一般的な本番環境 |
| 異なるAZ | 高可用性、障害分離 | クロスAZデータ転送料 | 高可用性要求環境 |

### パフォーマンス考慮事項

```mermaid
graph TD
    subgraph "推奨: 同一AZ内の異なるサブネット"
        subgraph "AZ-1a"
            FS1[Fargate Subnet]
            ES1[EFS Subnet]
        end
        FS1 <-->|低レイテンシー<br/>転送料なし| ES1
    end
    
    subgraph "許容: クロスAZ"
        subgraph "AZ-1a "
            FS2[Fargate Subnet]
        end
        subgraph "AZ-1c"
            ES2[EFS Subnet]
        end
        FS2 <-->|高レイテンシー<br/>転送料発生| ES2
    end
```

## 実装パターンとベストプラクティス

### 推奨構成例

```mermaid
graph TB
    subgraph "Multi-AZ構成"
        subgraph "AZ-1a"
            subgraph "App Subnet 1a"
                FG1[Fargate Tasks]
            end
            subgraph "Storage Subnet 1a"
                MT1[EFS Mount Target 1a]
            end
        end
        
        subgraph "AZ-1c"
            subgraph "App Subnet 1c"
                FG2[Fargate Tasks]
            end
            subgraph "Storage Subnet 1c"
                MT2[EFS Mount Target 1c]
            end
        end
        
        EFS[EFS File System]
    end
    
    FG1 -->|Primary| MT1
    FG1 -.->|Failover| MT2
    FG2 -->|Primary| MT2
    FG2 -.->|Failover| MT1
    MT1 --> EFS
    MT2 --> EFS
    
    style EFS fill:#ff9,stroke:#333,stroke-width:4px
```

### Terraformによる実装例

```hcl
# EFSファイルシステム
resource "aws_efs_file_system" "main" {
  creation_token = "my-efs"
  encrypted      = true
  
  tags = {
    Name = "fargate-efs"
  }
}

# EFS用サブネット（ストレージ層）
resource "aws_subnet" "storage_1a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.10.0/24"
  availability_zone = "ap-northeast-1a"
  
  tags = {
    Name = "storage-subnet-1a"
    Type = "storage"
  }
}

# Fargate用サブネット（アプリケーション層）
resource "aws_subnet" "app_1a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.20.0/24"
  availability_zone = "ap-northeast-1a"
  
  tags = {
    Name = "app-subnet-1a"
    Type = "application"
  }
}

# EFSマウントターゲット
resource "aws_efs_mount_target" "main_1a" {
  file_system_id  = aws_efs_file_system.main.id
  subnet_id       = aws_subnet.storage_1a.id  # ストレージサブネット
  security_groups = [aws_security_group.efs.id]
}

# セキュリティグループ（EFS用）
resource "aws_security_group" "efs" {
  name_prefix = "efs-mt-"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port       = 2049
    to_port         = 2049
    protocol        = "tcp"
    security_groups = [aws_security_group.fargate.id]  # Fargateからのみ許可
  }
}

# セキュリティグループ（Fargate用）
resource "aws_security_group" "fargate" {
  name_prefix = "fargate-task-"
  vpc_id      = aws_vpc.main.id
  
  egress {
    from_port   = 2049
    to_port     = 2049
    protocol    = "tcp"
    cidr_blocks = [aws_vpc.main.cidr_block]  # VPC内のEFSへアクセス
  }
}

# Fargateタスク定義でのEFSマウント
resource "aws_ecs_task_definition" "app" {
  family                   = "app"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  
  volume {
    name = "efs-storage"
    
    efs_volume_configuration {
      file_system_id = aws_efs_file_system.main.id
      root_directory = "/"
    }
  }
}
```

### 設計上の推奨事項

1. **サブネット分離のメリット**
   - セキュリティグループの管理が明確
   - ネットワークACLによる追加制御が可能
   - 障害影響範囲の限定

2. **パフォーマンス最適化**
   - 同一AZ内のマウントターゲットを優先使用
   - 複数AZにマウントターゲットを配置して可用性確保
   - アクセスパターンに応じたプロビジョンドスループット設定

3. **コスト最適化**
   - クロスAZデータ転送を最小化
   - 不要なマウントターゲットの削除
   - EFSライフサイクル管理の活用

### トラブルシューティング

```mermaid
graph TD
    Start[EFSマウント失敗] --> Q1{セキュリティグループ<br/>設定は正しい？}
    Q1 -->|No| Fix1[NFSポート 2049を<br/>許可する]
    Q1 -->|Yes| Q2{同一VPC内？}
    Q2 -->|No| Fix2[VPCピアリングまたは<br/>Transit Gateway設定]
    Q2 -->|Yes| Q3{DNS解決可能？}
    Q3 -->|No| Fix3[VPC DNSサポート<br/>を有効化]
    Q3 -->|Yes| Q4{マウントターゲット<br/>存在する？}
    Q4 -->|No| Fix4[対象AZに<br/>マウントターゲット作成]
    Q4 -->|Yes| Fix5[CloudWatch Logsで<br/>詳細エラー確認]
```

## 関連
- [AWS EFS公式ドキュメント](https://docs.aws.amazon.com/efs/)
- [Fargate with EFSベストプラクティス](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/fargate-efs.html)
- [EFSパフォーマンスガイド](https://docs.aws.amazon.com/efs/latest/ug/performance.html)
- [VPCのセキュリティグループ設定](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)