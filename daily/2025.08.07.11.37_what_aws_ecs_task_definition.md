# AWS ECS タスク定義とは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS ECS タスク定義とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : AWS ECS タスク定義とは何か
> 
> **Answer** : ECSでコンテナを実行するための設計図（ブループリント）。コンテナの実行に必要なCPU/メモリ、ネットワーク設定、環境変数、ロールなどを定義する。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 主要な設定項目](#2-主要な設定項目)
  - [2.1 基本設定](#21-基本設定)
  - [2.2 リソース設定](#22-リソース設定)
  - [2.3 コンテナ定義](#23-コンテナ定義)
  - [2.4 ネットワーク設定](#24-ネットワーク設定)
  - [2.5 IAMロール](#25-iamロール)
- [3. 実装例](#3-実装例)
- [4. 重要なポイント](#4-重要なポイント)

</details>

## 1. 概要

ECS タスク定義は、Amazon ECS（Elastic Container Service）でコンテナを実行するための設計図です。Docker Composeファイルに似た役割を持ち、以下を定義します：

- どのDockerイメージを使用するか
- 必要なCPUとメモリの量
- 環境変数や秘密情報
- ネットワーキングモード
- ログ設定
- ヘルスチェック

## 2. 主要な設定項目

### 2.1 基本設定

**family**
- タスク定義のファミリー名（グループ名）
- 複数のリビジョンを管理するための識別子
- 例：`example-project-production`

**compatibility**
- 実行環境の指定（EC2、Fargate、両方）
- 一般的なプロジェクトでは`FARGATE`を使用

### 2.2 リソース設定

**cpu**
- タスクに割り当てるCPU量（単位：vCPU × 1024）
- 例：`1024` = 1 vCPU

**memory**
- タスクに割り当てるメモリ量（単位：MB）
- 例：`2048` = 2GB

### 2.3 コンテナ定義

**container_definitions**
- タスク内で実行するコンテナの詳細設定
- JSON形式で定義

主な設定項目：
- `name`: コンテナ名
- `image`: Dockerイメージ（ECRのURL）
- `portMappings`: ポートマッピング
- `environment`: 環境変数
- `secrets`: シークレット（Secrets Manager/SSMから取得）
- `healthCheck`: ヘルスチェック設定
- `logConfiguration`: ログ設定

### 2.4 ネットワーク設定

**network_mode**
- ネットワーキングモード
- Fargateでは`awsvpc`が必須

### 2.5 IAMロール

**execution_role_arn**
- タスク実行ロール（ECSエージェントが使用）
- ECRからのイメージ取得、CloudWatchへのログ送信などに必要

**task_role_arn**
- タスクロール（アプリケーションが使用）
- AWS APIへのアクセス権限を付与

## 3. 実装例

```hcl
resource "aws_ecs_task_definition" "main" {
  family                   = "${var.project_name}-${var.environment}"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  cpu                      = var.task_cpu    # 例: "1024" (1 vCPU)
  memory                   = var.task_memory  # 例: "2048" (2GB)
  execution_role_arn       = aws_iam_role.ecs_task_execution.arn
  task_role_arn            = aws_iam_role.ecs_task.arn

  container_definitions = jsonencode([
    {
      name  = "${var.project_name}-${var.environment}"
      image = "${aws_ecr_repository.main.repository_url}:latest"

      portMappings = [
        {
          containerPort = 3000
          protocol      = "tcp"
        }
      ]

      healthCheck = {
        command     = ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
        interval    = 30
        timeout     = 5
        retries     = 3
        startPeriod = 60
      }

      environment = [
        {
          name  = "NODE_ENV"
          value = var.node_env
        },
        {
          name  = "PORT"
          value = "3000"
        }
      ]

      secrets = [
        {
          name      = "DATABASE_URL"
          valueFrom = aws_secretsmanager_secret.db_connection_string.arn
        },
        {
          name      = "NEXTAUTH_SECRET"
          valueFrom = aws_secretsmanager_secret.nextauth_secret.arn
        },
        {
          name      = "NEXTAUTH_URL"
          valueFrom = aws_secretsmanager_secret.nextauth_url.arn
        }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.main.name
          "awslogs-region"        = var.aws_region
          "awslogs-stream-prefix" = "ecs"
        }
      }
    }
  ])

  tags = {
    Name = "${var.project_name}-task-${var.environment}"
  }
}
```

## 4. 重要なポイント

1. **Fargate互換性**
   - CPU/メモリの組み合わせは[Fargateの制限](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html)に従う必要がある

2. **セキュリティ**
   - 機密情報は環境変数ではなくSecretsを使用
   - 最小権限の原則に基づいたIAMロール設定

3. **ヘルスチェック**
   - コンテナの正常性を定期的に確認
   - 失敗時は自動的に再起動

4. **ログ管理**
   - CloudWatch Logsに自動的にログを送信
   - トラブルシューティングに活用

## 関連
- [AWS ECS サービス](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_ecs_service.tf)
- [AWS ECR リポジトリ](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_ecr_repository.tf)
- [AWS IAM ロール](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_iam_role.tf)