# AWS ACM証明書のProvider設定詳解

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにAWS ACM証明書のProvider設定を行うかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにAWS ACM証明書のProvider設定を行うか
> 
> **Answer** : CloudFront用の証明書は`provider = aws.virginia`を指定してus-east-1リージョンに作成し、リージョナルサービス用はサービスと同じリージョンのProviderを使用する

## 目次

<details>
<summary>目次を開く</summary>

- [Provider設定の基本](#provider設定の基本)
- [なぜProvider設定が重要なのか](#なぜprovider設定が重要なのか)
- [実践的なProvider設定パターン](#実践的なprovider設定パターン)
- [Provider設定のベストプラクティス](#provider設定のベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)
- [実装チェックリスト](#実装チェックリスト)

</details>

## Provider設定の基本

### 設定項目の詳細

| 項目名 | 必須 | 型 | 説明 |
|--------|------|-----|------|
| `provider` | × | string | 使用するAWSプロバイダーのエイリアス名。デフォルトプロバイダーを使用する場合は省略可能 |

### 基本的な使用例

```hcl
# デフォルトプロバイダーを使用する場合（provider指定なし）
resource "aws_acm_certificate" "cert" {
  domain_name       = "example.com"
  validation_method = "DNS"
}

# 特定のプロバイダーを明示的に指定する場合
resource "aws_acm_certificate" "cert" {
  provider          = aws.virginia
  domain_name       = "example.com"
  validation_method = "DNS"
}
```

## なぜProvider設定が重要なのか

### 1. CloudFrontでの使用

CloudFrontは**グローバルサービス**であり、ACM証明書は必ず**us-east-1（バージニア北部）リージョン**に作成する必要があります。

```hcl
# プロバイダーの定義
provider "aws" {
  region = "ap-northeast-1"  # デフォルトリージョン（東京）
}

provider "aws" {
  alias  = "virginia"
  region = "us-east-1"  # CloudFront用のリージョン
}

# CloudFront用の証明書（us-east-1で作成）
resource "aws_acm_certificate" "cloudfront_cert" {
  provider          = aws.virginia  # 重要：us-east-1プロバイダーを指定
  domain_name       = "example.com"
  validation_method = "DNS"
  
  tags = {
    Name = "cloudfront-certificate"
    Use  = "CloudFront"
  }
}
```

### 2. リージョナルサービスでの使用

ALB、API Gatewayなどのリージョナルサービスでは、**サービスと同じリージョン**に証明書を作成する必要があります。

```hcl
# ALB用の証明書（東京リージョン）
resource "aws_acm_certificate" "alb_cert" {
  # providerを指定しない場合、デフォルトプロバイダー（東京）が使用される
  domain_name       = "api.example.com"
  validation_method = "DNS"
  
  tags = {
    Name = "alb-certificate"
    Use  = "ALB"
  }
}
```

## 実践的なProvider設定パターン

### パターン1: マルチリージョン構成

```hcl
# プロバイダー定義
provider "aws" {
  region = "ap-northeast-1"
  alias  = "tokyo"
}

provider "aws" {
  region = "us-east-1"
  alias  = "virginia"
}

provider "aws" {
  region = "eu-west-1"
  alias  = "ireland"
}

# 各リージョンの証明書
resource "aws_acm_certificate" "tokyo_cert" {
  provider          = aws.tokyo
  domain_name       = "tokyo.example.com"
  validation_method = "DNS"
}

resource "aws_acm_certificate" "virginia_cert" {
  provider          = aws.virginia
  domain_name       = "global.example.com"
  validation_method = "DNS"
}

resource "aws_acm_certificate" "ireland_cert" {
  provider          = aws.ireland
  domain_name       = "eu.example.com"
  validation_method = "DNS"
}
```

### パターン2: 環境別Provider設定

```hcl
# 環境に応じたプロバイダー設定
provider "aws" {
  region = var.aws_region
  
  assume_role {
    role_arn = "arn:aws:iam::${var.account_id}:role/TerraformRole"
  }
}

provider "aws" {
  alias  = "virginia"
  region = "us-east-1"
  
  assume_role {
    role_arn = "arn:aws:iam::${var.account_id}:role/TerraformRole"
  }
}
```

### パターン3: モジュール内でのProvider継承

```hcl
# ルートモジュール
module "certificates" {
  source = "./modules/certificates"
  
  providers = {
    aws          = aws
    aws.virginia = aws.virginia
  }
}

# モジュール内（modules/certificates/main.tf）
terraform {
  required_providers {
    aws = {
      source                = "hashicorp/aws"
      version               = "~> 5.0"
      configuration_aliases = [aws.virginia]
    }
  }
}

resource "aws_acm_certificate" "regional" {
  # デフォルトプロバイダーを使用
  domain_name = var.regional_domain
  validation_method = "DNS"
}

resource "aws_acm_certificate" "global" {
  provider    = aws.virginia  # エイリアスプロバイダーを使用
  domain_name = var.global_domain
  validation_method = "DNS"
}
```

## Provider設定のベストプラクティス

### 1. 明示的な指定

```hcl
# 推奨：用途が明確な場合は常にproviderを明示的に指定
resource "aws_acm_certificate" "cloudfront_cert" {
  provider = aws.virginia  # CloudFront用であることが明確
  # ...
}
```

### 2. エイリアスの命名規則

| 用途 | 推奨エイリアス名 | 例 |
|------|-----------------|-----|
| リージョン指定 | リージョンの通称 | `aws.virginia`, `aws.tokyo` |
| 環境指定 | 環境名 | `aws.production`, `aws.staging` |
| アカウント指定 | アカウントの用途 | `aws.security`, `aws.logging` |

### 3. 設定の一元管理

```hcl
# providers.tf として別ファイルで管理
provider "aws" {
  region = local.default_region
}

provider "aws" {
  alias  = "virginia"
  region = "us-east-1"
}

provider "aws" {
  alias  = "oregon"
  region = "us-west-2"
}
```

## トラブルシューティング

### よくある問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| CloudFrontで証明書が見つからない | 証明書がus-east-1以外で作成されている | `provider = aws.virginia`を指定して再作成 |
| `Provider configuration not present` | エイリアスプロバイダーが定義されていない | 必要なプロバイダー定義を追加 |
| 異なるリージョンの証明書が作成される | デフォルトプロバイダーのリージョンが意図と異なる | 明示的にproviderを指定 |

### デバッグ方法

```hcl
# 証明書がどのリージョンに作成されたか確認
output "certificate_region" {
  value = regex("arn:aws:acm:([^:]+):", aws_acm_certificate.cert.arn)[0]
}
```

## 実装チェックリスト

- [ ] CloudFront用証明書には`provider = aws.virginia`を指定している
- [ ] リージョナルサービス用証明書は適切なリージョンで作成している
- [ ] プロバイダーエイリアスに一貫性のある命名規則を使用している
- [ ] モジュール使用時は`configuration_aliases`を定義している
- [ ] 不要なプロバイダー定義を削除している

## 関連
- [AWS ACM証明書のTerraform設定ガイド](./2025.08.01.14.31_how_aws_acm_certificate_terraform_configuration_guide.md)
- [AWS ACM Certificate Count設定](./2025.08.01.14.43_how_aws_acm_certificate_count_configuration_details.md)
- [ACM証明書管理パターン比較](./2025.08.01.13.47_why_acm_certificate_management_patterns_comparison.md)
- [Terraform AWS Providerドキュメント](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/guides/resource-tagging#providers)