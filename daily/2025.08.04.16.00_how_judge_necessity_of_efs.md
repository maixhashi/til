# EFSの必要性を判断する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにEFSの必要性を判断するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにEFSの必要性を判断するか
> 
> **Answer** : 複数のコンテナ/インスタンス間でのファイル共有、永続的なデータ保存、並行アクセスの要件を評価し、コストとパフォーマンスを考慮して判断する

## 目次

<details>
<summary>目次を開く</summary>

- [EFS導入の判断基準](#efs導入の判断基準)
- [ユースケース別の評価方法](#ユースケース別の評価方法)
- [代替ソリューションとの比較](#代替ソリューションとの比較)
- [コストとパフォーマンスの考慮](#コストとパフォーマンスの考慮)

</details>

## EFS導入の判断基準

### 判断フローチャート

```mermaid
graph TD
    Start[ファイルストレージが必要] --> Q1{複数のインスタンス/コンテナから<br/>同時アクセスが必要？}
    Q1 -->|Yes| Q2{POSIXファイルシステム<br/>互換性が必要？}
    Q1 -->|No| NoEFS1[EFS不要<br/>EBSやローカルストレージを検討]
    
    Q2 -->|Yes| Q3{データの永続化が必要？}
    Q2 -->|No| NoEFS2[EFS不要<br/>S3やDynamoDBを検討]
    
    Q3 -->|Yes| Q4{自動スケーリングが必要？}
    Q3 -->|No| NoEFS3[EFS不要<br/>一時ファイルシステムを検討]
    
    Q4 -->|Yes| Q5{高可用性が必要？}
    Q4 -->|No| Consider1[EFS検討可<br/>FSx for Lustreも評価]
    
    Q5 -->|Yes| UseEFS[EFS推奨]
    Q5 -->|No| Consider2[EFS検討可<br/>コスト評価必須]
    
    style UseEFS fill:#9f9,stroke:#333,stroke-width:3px
    style NoEFS1 fill:#f99,stroke:#333,stroke-width:2px
    style NoEFS2 fill:#f99,stroke:#333,stroke-width:2px
    style NoEFS3 fill:#f99,stroke:#333,stroke-width:2px
```

### 主要な判断要素

| 要素 | EFSが適している | EFSが不適切 |
|------|----------------|-------------|
| アクセスパターン | 複数インスタンスから同時読み書き | 単一インスタンスのみ |
| データの性質 | 共有設定ファイル、メディアファイル | 高頻度更新のデータベースファイル |
| パフォーマンス要件 | 中程度のレイテンシー許容 | 超低レイテンシー必須 |
| コスト感度 | ストレージ使用量に応じた課金OK | 固定費用を希望 |
| 管理負荷 | フルマネージドサービス希望 | 自己管理可能 |

## ユースケース別の評価方法

### ケース1: Webアプリケーションのコンテンツ管理

```mermaid
graph LR
    subgraph "EFS推奨シナリオ"
        UC1[WordPress<br/>メディアファイル]
        UC2[CMS<br/>アップロードファイル]
        UC3[共有設定<br/>ファイル]
    end
    
    subgraph "EFS非推奨シナリオ"
        NUC1[静的アセット<br/>→ S3 + CloudFront]
        NUC2[セッションデータ<br/>→ ElastiCache]
        NUC3[ログファイル<br/>→ CloudWatch Logs]
    end
    
    style UC1 fill:#9f9,stroke:#333,stroke-width:2px
    style UC2 fill:#9f9,stroke:#333,stroke-width:2px
    style UC3 fill:#9f9,stroke:#333,stroke-width:2px
    style NUC1 fill:#f99,stroke:#333,stroke-width:2px
    style NUC2 fill:#f99,stroke:#333,stroke-width:2px
    style NUC3 fill:#f99,stroke:#333,stroke-width:2px
```

### ケース2: コンテナ化されたアプリケーション

```mermaid
graph TB
    subgraph "Fargate + EFS評価"
        F1[要件分析]
        F2[データ永続化必要？]
        F3[コンテナ間共有必要？]
        F4[ボリューム要件]
        
        F1 --> F2
        F2 -->|Yes| F3
        F3 -->|Yes| F4
        F4 -->|大容量| EFS1[EFS推奨]
        F4 -->|小容量| ALT1[代替検討]
    end
    
    style EFS1 fill:#9f9,stroke:#333,stroke-width:3px
    style ALT1 fill:#ff9,stroke:#333,stroke-width:2px
```

### 評価チェックリスト

### EFS必要性評価チェックリスト

#### データ特性
- [ ] 複数のEC2/Fargateから同時アクセスが必要
- [ ] ファイルシステムのセマンティクスが必要
- [ ] データの永続化が必要
- [ ] 自動バックアップが必要

#### パフォーマンス要件
- [ ] 読み取り重視のワークロード
- [ ] レイテンシー要件は中程度で許容可能
- [ ] スループットの自動スケーリングが必要

#### 運用要件
- [ ] マネージドサービスが必須
- [ ] Multi-AZ対応が必要
- [ ] 容量の事前プロビジョニング不要

#### コスト要件
- [ ] 使用量ベースの課金モデルが適切
- [ ] アクセス頻度に応じた階層化が有効

## 代替ソリューションとの比較

### ストレージオプション比較マトリックス

```mermaid
graph LR
    subgraph "共有ストレージ要件"
        EFS[EFS<br/>フルマネージドNFS]
        FSx[FSx for Lustre<br/>高性能HPC]
        S3[S3 + S3 Sync<br/>オブジェクトストレージ]
    end
    
    subgraph "単一インスタンス要件"
        EBS[EBS<br/>ブロックストレージ]
        Instance[Instance Store<br/>一時ストレージ]
    end
    
    subgraph "特殊要件"
        Cache[ElastiCache<br/>インメモリキャッシュ]
        RDS[RDS<br/>データベース]
    end
```

### 詳細比較表

| 特性 | EFS | EBS | S3 | FSx |
|------|-----|-----|-----|-----|
| 共有アクセス | ✅ 複数同時 | ❌ 単一のみ | ✅ API経由 | ✅ 複数同時 |
| プロトコル | NFS v4.1 | ブロックレベル | REST/SDK | Lustre/Windows |
| レイテンシー | ミリ秒 | マイクロ秒 | 数十ミリ秒 | マイクロ秒 |
| スケーラビリティ | ペタバイト級 | 64TiB | 無制限 | ペタバイト級 |
| 料金体系 | 使用量課金 | 容量課金 | 使用量課金 | 容量課金 |
| ユースケース | 共有ファイル | OS/DB | 静的コンテンツ | HPC/ML |

## コストとパフォーマンスの考慮

### コスト計算例

```mermaid
graph TD
    subgraph "月額コスト試算（東京リージョン）"
        subgraph "100GB使用時"
            EFS_S[EFS Standard<br/>$30/月]
            EFS_IA[EFS IA<br/>$1.6/月<br/>+アクセス料]
            EBS_GP3[EBS gp3<br/>$8/月]
            S3_S[S3 Standard<br/>$2.3/月]
        end
        
        subgraph "1TB使用時"
            EFS_S_1T[EFS Standard<br/>$300/月]
            EFS_IA_1T[EFS IA<br/>$16/月<br/>+アクセス料]
            EBS_GP3_1T[EBS gp3<br/>$80/月]
            S3_S_1T[S3 Standard<br/>$23/月]
        end
    end
    
    style EFS_IA fill:#9f9,stroke:#333,stroke-width:2px
    style S3_S fill:#9f9,stroke:#333,stroke-width:2px
    style EFS_IA_1T fill:#9f9,stroke:#333,stroke-width:2px
    style S3_S_1T fill:#9f9,stroke:#333,stroke-width:2px
```

### パフォーマンス最適化の判断

### EFSパフォーマンスモード選択

| モード | レイテンシー | スループット | 用途 |
|------|-----------|----------|------|
| **General Purpose**（推奨） | 最小 | 制限あり | 一般的なファイル共有 |
| **Max I/O** | やや高い | 高い | 大規模並列処理 |

#### Provisioned Throughput検討項目
- [ ] ベースラインを超える一定のスループットが必要
- [ ] バースト残高の枯渇を回避したい
- [ ] 予測可能なパフォーマンスが必要

### 実装決定フロー

```mermaid
sequenceDiagram
    participant Dev as 開発チーム
    participant Arch as アーキテクト
    participant Cost as コスト管理
    participant Ops as 運用チーム
    
    Dev->>Arch: 要件提示
    Arch->>Arch: 技術評価
    Arch->>Cost: コスト試算依頼
    Cost->>Cost: TCO計算
    Cost->>Arch: コスト評価結果
    Arch->>Ops: 運用性確認
    Ops->>Arch: 運用要件フィードバック
    Arch->>Dev: 実装方針決定
    
    Note over Dev,Ops: EFS採用/非採用の最終決定
```

### 段階的導入アプローチ

1. **PoC実施**
   ```bash
   # 小規模環境でEFSをテスト
   aws efs create-file-system \
     --creation-token poc-test \
     --performance-mode generalPurpose \
     --throughput-mode bursting
   ```

2. **パフォーマンステスト**
   ```bash
   # fioを使用したベンチマーク
   fio --name=randwrite --ioengine=libaio \
     --iodepth=32 --rw=randwrite --bs=4k \
     --direct=1 --size=1G --numjobs=8
   ```

3. **コスト監視**
   - CloudWatchでの使用量追跡
   - Cost Explorerでの分析
   - 予算アラートの設定

4. **本番展開判断**
   - PoCの結果評価
   - スケーラビリティ確認
   - 災害復旧計画の策定

## 関連
- [AWS EFS料金計算ツール](https://calculator.aws/#/createCalculator/EFS)
- [EFSパフォーマンスガイド](https://docs.aws.amazon.com/efs/latest/ug/performance.html)
- [AWSストレージオプション比較](https://docs.aws.amazon.com/whitepapers/latest/aws-storage-services-overview/introduction.html)
- [Well-Architectedフレームワーク - ストレージ選択](https://docs.aws.amazon.com/wellarchitected/latest/framework/perf_data_storage.html)