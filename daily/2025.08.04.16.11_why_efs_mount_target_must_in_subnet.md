# なぜEFSマウントターゲットはサブネット内に配置する必要があるのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**EFSマウントターゲットはサブネット内に配置する必要があるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**EFSマウントターゲットはサブネット内に配置する必要があるのか
> 
> **Answer** : EFSマウントターゲットはENI（Elastic Network Interface）として実装され、VPC内のリソースからNFSプロトコルでアクセスするためのエンドポイントとして機能するため、必ずサブネット内に配置される必要がある

## 目次
<details>
<summary>目次を開く</summary>

- [EFSとマウントターゲットのアーキテクチャ](#efsとマウントターゲットのアーキテクチャ)
- [マウントターゲットの技術的要件](#マウントターゲットの技術的要件)
- [サブネット配置の必然性](#サブネット配置の必然性)
- [設計上の考慮事項](#設計上の考慮事項)

</details>

## EFSとマウントターゲットのアーキテクチャ

### EFSの二層構造

```mermaid
graph TB
    subgraph "AWS マネージド層"
        EFS[EFS ファイルシステム<br/>リージョナルサービス]
    end
    
    subgraph "VPC層"
        subgraph "AZ-1a"
            subgraph "Subnet-1a"
                MT1[マウントターゲット<br/>ENI: 10.0.1.10]
            end
        end
        subgraph "AZ-1c"
            subgraph "Subnet-1c"
                MT2[マウントターゲット<br/>ENI: 10.0.2.10]
            end
        end
    end
    
    subgraph "クライアント層"
        EC2A[EC2/Fargate A]
        EC2B[EC2/Fargate B]
    end
    
    EFS -.->|管理| MT1
    EFS -.->|管理| MT2
    EC2A -->|NFS v4.1| MT1
    EC2B -->|NFS v4.1| MT2
    
    style EFS fill:#ff9,stroke:#333,stroke-width:4px
    style MT1 fill:#9ff,stroke:#333,stroke-width:2px
    style MT2 fill:#9ff,stroke:#333,stroke-width:2px
```

### アーキテクチャの特徴
1. **EFS本体**: リージョナルサービスとしてAWSインフラ上に存在
2. **マウントターゲット**: VPC内のサブネットに配置されるアクセスポイント
3. **ENIベース**: 各マウントターゲットはENIとして実装
4. **NFSエンドポイント**: NFSプロトコルでのアクセスを提供

## マウントターゲットの技術的要件

### ENIとしての実装詳細

```mermaid
graph LR
    subgraph "マウントターゲットの構成要素"
        ENI[Elastic Network Interface]
        IP[プライベートIPアドレス]
        SG[セキュリティグループ]
        DNS[DNSエントリー]
    end
    
    subgraph "必須要件"
        Subnet[サブネット配置]
        CIDR[サブネットCIDR内IP]
        Route[ルーティング可能性]
    end
    
    ENI --> IP
    ENI --> SG
    IP --> DNS
    IP --> CIDR
    Subnet --> Route
    
    style ENI fill:#9ff,stroke:#333,stroke-width:3px
    style Subnet fill:#ff9,stroke:#333,stroke-width:3px
```

### 技術的制約
1. **IPアドレス割り当て**
   - サブネットのCIDRブロックからIPアドレスが必要
   - VPC外部からはプライベートIPアドレスを割り当て不可

2. **ネットワークインターフェース**
   - ENIはサブネットに紐づく必要がある
   - AWSのネットワーク仮想化はサブネットレベルで実装

3. **セキュリティ制御**
   - セキュリティグループはVPC内のリソースにのみ適用可能
   - NACLsはサブネットレベルで適用

## サブネット配置の必然性

### ネットワーク到達性の確保

```mermaid
sequenceDiagram
    participant Client as EC2/Fargate
    participant Route as ルートテーブル
    participant MT as マウントターゲット<br/>(サブネット内)
    participant EFS as EFSファイルシステム
    
    Client->>Route: NFSマウント要求<br/>(DNS名解決)
    Route->>Route: DNSをIPアドレスに解決
    Note over Route: availability-zone.file-system-id<br/>.efs.region.amazonaws.com
    Route->>MT: IPアドレスへルーティング
    Note over MT: サブネット内の<br/>プライベートIPアドレス
    MT->>EFS: ファイルシステム接続
    EFS-->>Client: マウント成功
```

### VPCネットワーキングの原則

```mermaid
graph TD
    subgraph "VPC (10.0.0.0/16)"
        subgraph "ルーティング可能な範囲"
            S1[Subnet 10.0.1.0/24]
            S2[Subnet 10.0.2.0/24]
            RT[ルートテーブル<br/>10.0.0.0/16 → local]
        end
        
        subgraph "外部サービス"
            EXT[S3, DynamoDB等<br/>VPCエンドポイント経由]
        end
    end
    
    subgraph "VPC外"
        INVALID[ルーティング不可能<br/>直接配置不可]
    end
    
    S1 <--> RT
    S2 <--> RT
    RT --> EXT
    RT -.->|不可| INVALID
    
    style S1 fill:#9f9,stroke:#333,stroke-width:2px
    style S2 fill:#9f9,stroke:#333,stroke-width:2px
    style INVALID fill:#f99,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
```

### 必須となる理由
1. **IPアドレッシング**: VPC内でルーティング可能なIPアドレスが必要
2. **ネットワーク分離**: VPCによるネットワーク分離の実現
3. **セキュリティ境界**: VPC/サブネットレベルでのアクセス制御
4. **AWSアーキテクチャ**: ENIはサブネットに属する設計

## 設計上の考慮事項

### マウントターゲット配置戦略

```mermaid
graph TB
    subgraph "推奨: Multi-AZ配置"
        subgraph "VPC"
            subgraph "AZ-1a"
                MTA[MT-1a<br/>Storage Subnet]
                AppA[App Subnet 1a]
            end
            subgraph "AZ-1c"
                MTC[MT-1c<br/>Storage Subnet]
                AppC[App Subnet 1c]
            end
        end
        EFSM[EFS]
    end
    
    EFSM --> MTA
    EFSM --> MTC
    AppA --> MTA
    AppC --> MTC
    AppA -.->|クロスAZ可| MTC
    AppC -.->|クロスAZ可| MTA
    
    style MTA fill:#9ff,stroke:#333,stroke-width:3px
    style MTC fill:#9ff,stroke:#333,stroke-width:3px
```

### サブネット選択の基準

| 考慮事項 | 推奨事項 | 理由 |
|---------|----------|------|
| AZ配置 | 各AZに1つのマウントターゲット | 高可用性とレイテンシー最適化 |
| サブネットタイプ | プライベートサブネット | インターネット露出不要 |
| 専用サブネット | ストレージ層として分離 | セキュリティとネットワーク管理 |
| IPアドレス | 各サブネットに予約IP確保 | 枯渇防止 |

### Terraformでの実装例

```hcl
# EFSファイルシステム
resource "aws_efs_file_system" "main" {
  creation_token = "my-efs"
  
  tags = {
    Name = "main-efs"
  }
}

# ストレージ用サブネット（マウントターゲット配置用）
resource "aws_subnet" "storage" {
  for_each = {
    "1a" = { az = "ap-northeast-1a", cidr = "10.0.10.0/24" }
    "1c" = { az = "ap-northeast-1c", cidr = "10.0.11.0/24" }
  }
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = each.value.cidr
  availability_zone = each.value.az
  
  tags = {
    Name = "storage-subnet-${each.key}"
    Type = "storage"
  }
}

# マウントターゲット（各サブネットに配置）
resource "aws_efs_mount_target" "main" {
  for_each = aws_subnet.storage
  
  file_system_id  = aws_efs_file_system.main.id
  subnet_id       = each.value.id  # サブネット内に配置（必須）
  security_groups = [aws_security_group.efs_mt.id]
}

# セキュリティグループ（マウントターゲット用）
resource "aws_security_group" "efs_mt" {
  name_prefix = "efs-mt-"
  vpc_id      = aws_vpc.main.id  # VPC内でのみ有効
  
  ingress {
    from_port   = 2049
    to_port     = 2049
    protocol    = "tcp"
    cidr_blocks = [aws_vpc.main.cidr_block]  # VPC内からのみ許可
  }
}
```

### アンチパターンと回避策

```mermaid
graph LR
    subgraph "アンチパターン"
        AP1[単一AZのみに配置]
        AP2[パブリックサブネット使用]
        AP3[アプリサブネットと混在]
    end
    
    subgraph "推奨パターン"
        RP1[Multi-AZ配置]
        RP2[プライベートサブネット使用]
        RP3[専用ストレージサブネット]
    end
    
    AP1 -->|改善| RP1
    AP2 -->|改善| RP2
    AP3 -->|改善| RP3
    
    style AP1 fill:#f99,stroke:#333,stroke-width:2px
    style AP2 fill:#f99,stroke:#333,stroke-width:2px
    style AP3 fill:#f99,stroke:#333,stroke-width:2px
    style RP1 fill:#9f9,stroke:#333,stroke-width:2px
    style RP2 fill:#9f9,stroke:#333,stroke-width:2px
    style RP3 fill:#9f9,stroke:#333,stroke-width:2px
```

### まとめ
EFSマウントターゲットがサブネット内に配置される必要があるのは、AWSのネットワーキングアーキテクチャの基本原則に基づいています。ENIとして実装されるマウントターゲットは、VPC内でルーティング可能なIPアドレスを持ち、セキュリティグループによる制御を受けるため、必然的にサブネット内に存在する必要があります。

## 関連
- [AWS EFS マウントターゲット作成ガイド](https://docs.aws.amazon.com/efs/latest/ug/accessing-fs.html)
- [VPCとサブネットの基礎](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)
- [ENI（Elastic Network Interface）詳細](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html)