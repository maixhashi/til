# AWS API Gatewayとは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS API Gatewayとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : AWS API Gatewayとは何か
> 
> **Answer** : APIの作成、公開、保守、監視、保護を行うフルマネージドサービス。REST API、HTTP API、WebSocket APIの3種類をサポートし、Lambda、EC2、その他AWSサービスやHTTPエンドポイントと統合してAPIを公開できる

## 目次

<details>
<summary>目次を開く</summary>

- [API Gatewayの基本概念](#api-gatewayの基本概念)
- [3つのAPIタイプの特徴](#3つのapiタイプの特徴)
- [主要機能とコンポーネント](#主要機能とコンポーネント)
- [統合パターンとユースケース](#統合パターンとユースケース)

</details>

## API Gatewayの基本概念

### API Gatewayの位置づけ

```mermaid
graph TB
    subgraph "クライアント"
        MOBILE[モバイルアプリ]
        WEB[Webアプリ]
        IOT[IoTデバイス]
        PARTNER[パートナーシステム]
    end
    
    subgraph "API Gateway層"
        APIGW[API Gateway<br/>統一エンドポイント]
        AUTH[認証・認可]
        THROTTLE[スロットリング]
        CACHE[キャッシング]
    end
    
    subgraph "バックエンド"
        LAMBDA[Lambda関数]
        EC2[EC2/ECS]
        DYNAMODB[DynamoDB]
        HTTP[HTTPエンドポイント]
    end
    
    MOBILE --> APIGW
    WEB --> APIGW
    IOT --> APIGW
    PARTNER --> APIGW
    
    APIGW --> AUTH
    APIGW --> THROTTLE
    APIGW --> CACHE
    
    APIGW --> LAMBDA
    APIGW --> EC2
    APIGW --> DYNAMODB
    APIGW --> HTTP
    
    style APIGW fill:#ff9,stroke:#333,stroke-width:3px
```

### API Gatewayの役割

| 役割 | 説明 | メリット |
|------|------|----------|
| APIプロキシ | クライアントとバックエンドの仲介 | 統一されたエンドポイント |
| 認証ゲートウェイ | API利用者の認証・認可 | セキュリティの一元管理 |
| トラフィック管理 | レート制限、スロットリング | バックエンド保護 |
| 変換レイヤー | リクエスト/レスポンス変換 | 柔軟な統合 |
| 監視ポイント | メトリクス、ログ収集 | 可視性向上 |

## 3つのAPIタイプの特徴

### REST API vs HTTP API vs WebSocket API

```mermaid
graph LR
    subgraph "REST API"
        REST[フル機能<br/>エンタープライズ向け]
        REST_F[・API Key<br/>・リクエスト検証<br/>・SDK生成<br/>・プライベート統合]
    end
    
    subgraph "HTTP API"
        HTTP[軽量・高速<br/>コスト最適化]
        HTTP_F[・JWT認証<br/>・CORS自動設定<br/>・低レイテンシー<br/>・70%安価]
    end
    
    subgraph "WebSocket API"
        WS[双方向通信<br/>リアルタイム]
        WS_F[・チャット<br/>・通知<br/>・ストリーミング<br/>・ゲーム]
    end
    
    style REST fill:#ff9,stroke:#333,stroke-width:2px
    style HTTP fill:#9ff,stroke:#333,stroke-width:2px
    style WS fill:#9f9,stroke:#333,stroke-width:2px
```

### 詳細比較

| 機能 | REST API | HTTP API | WebSocket API |
|------|----------|----------|---------------|
| プロトコル | HTTP/HTTPS | HTTP/HTTPS | WebSocket |
| 認証方法 | API Key, IAM, Cognito, Lambda | JWT, OAuth 2.0 | IAM, Lambda |
| 料金 | $3.5/100万リクエスト | $1.0/100万リクエスト | $1.0/100万メッセージ |
| レイテンシー | 〜29ms | 〜9ms | リアルタイム |
| VPC統合 | ✅ | ✅ | ✅ |
| WAF統合 | ✅ | ✅ | ❌ |
| キャッシング | ✅ | ❌ | ❌ |
| リクエスト変換 | ✅ | 限定的 | ✅ |

### APIタイプ選択フローチャート

```mermaid
graph TD
    Start[API要件] --> Q1{双方向通信が必要？}
    Q1 -->|Yes| WS[WebSocket API]
    Q1 -->|No| Q2{高度な機能が必要？}
    
    Q2 -->|Yes| Q3{必要な機能は？}
    Q2 -->|No| HTTP[HTTP API<br/>推奨]
    
    Q3 -->|API Key認証| REST[REST API]
    Q3 -->|リクエスト検証| REST
    Q3 -->|SDK生成| REST
    Q3 -->|キャッシング| REST
    
    style HTTP fill:#9ff,stroke:#333,stroke-width:3px
    style REST fill:#ff9,stroke:#333,stroke-width:2px
    style WS fill:#9f9,stroke:#333,stroke-width:2px
```

## 主要機能とコンポーネント

### API Gatewayのコンポーネント構造

```mermaid
graph TB
    subgraph "API定義"
        RESOURCE[リソース<br/>/users, /orders]
        METHOD[メソッド<br/>GET, POST, PUT]
        MODEL[モデル<br/>JSONスキーマ]
    end
    
    subgraph "リクエスト処理"
        AUTH_C[認証機能]
        VALID[検証機能]
        TRANS[変換機能]
    end
    
    subgraph "統合"
        INTEGRATION[統合タイプ]
        BACKEND[バックエンド接続]
        RESPONSE[レスポンス処理]
    end
    
    subgraph "デプロイ"
        STAGE[ステージ<br/>dev, test, prod]
        DEPLOY[デプロイメント]
        VERSION[バージョン管理]
    end
    
    RESOURCE --> METHOD
    METHOD --> AUTH_C
    AUTH_C --> VALID
    VALID --> TRANS
    TRANS --> INTEGRATION
    INTEGRATION --> BACKEND
    BACKEND --> RESPONSE
    RESPONSE --> STAGE
```

### 主要機能の詳細

#### 認証・認可機能

**APIキー認証**
- 使用量プランと連携
- クォータ制限
- スロットリング設定

**IAM認証**
- AWS署名バージョン4
- きめ細かいアクセス制御
- クロスアカウントアクセス

**Cognito認証**
- ユーザープール統合
- JWTトークン検証
- グループベース認可

**Lambdaオーソライザー**
- カスタム認証ロジック
- トークン/リクエストベース
- 認可結果キャッシュ

#### トラフィック管理

**スロットリング**
- バーストレート: 5000リクエスト/秒
- 定常レート: 10000リクエスト/秒
- メソッドレベル設定可能

**使用量プラン**
- APIキー別クォータ
- 日次/月次制限
- 段階的料金設定

**キャッシング**
- TTL設定可能
- 容量: 0.5GB〜237GB
- キャッシュキー設定

## 統合パターンとユースケース

### Lambda統合パターン

```mermaid
graph LR
    subgraph "Lambdaプロキシ統合"
        REQ1[リクエスト全体]
        LAMBDA1[Lambda関数]
        RES1[レスポンス全体]
    end
    
    subgraph "Lambda統合"
        REQ2[リクエスト]
        MAPPING1[リクエスト<br/>マッピング]
        LAMBDA2[Lambda関数]
        MAPPING2[レスポンス<br/>マッピング]
        RES2[レスポンス]
    end
    
    REQ1 --> LAMBDA1
    LAMBDA1 --> RES1
    
    REQ2 --> MAPPING1
    MAPPING1 --> LAMBDA2
    LAMBDA2 --> MAPPING2
    MAPPING2 --> RES2
    
    style LAMBDA1 fill:#ff9,stroke:#333,stroke-width:2px
    style MAPPING1 fill:#9ff,stroke:#333,stroke-width:2px
```

### 統合タイプ別の特徴

| 統合タイプ | 用途 | 変換 | ユースケース |
|-----------|------|------|--------------|
| Lambdaプロキシ | Lambda直接実行 | なし | サーバーレスAPI |
| HTTPプロキシ | HTTP転送 | なし | 既存API公開 |
| AWS統合 | AWSサービス呼び出し | あり | DynamoDB直接アクセス |
| Mock | テスト用 | あり | 開発・テスト |
| VPCリンク | プライベート統合 | あり | 内部サービス公開 |

### 実装パターン例

```hcl
# Terraform実装例

# REST API作成
resource "aws_api_gateway_rest_api" "main" {
  name        = "my-api"
  description = "My REST API"
  
  endpoint_configuration {
    types = ["REGIONAL"]  # EDGE, REGIONAL, PRIVATE
  }
}

# リソース定義
resource "aws_api_gateway_resource" "users" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  parent_id   = aws_api_gateway_rest_api.main.root_resource_id
  path_part   = "users"
}

# メソッド定義
resource "aws_api_gateway_method" "get_users" {
  rest_api_id   = aws_api_gateway_rest_api.main.id
  resource_id   = aws_api_gateway_resource.users.id
  http_method   = "GET"
  authorization = "AWS_IAM"
  
  request_parameters = {
    "method.request.querystring.limit" = false
  }
}

# Lambda統合
resource "aws_api_gateway_integration" "lambda" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  resource_id = aws_api_gateway_resource.users.id
  http_method = aws_api_gateway_method.get_users.http_method
  
  integration_http_method = "POST"
  type                    = "AWS_PROXY"
  uri                     = aws_lambda_function.get_users.invoke_arn
}

# デプロイメント
resource "aws_api_gateway_deployment" "prod" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  stage_name  = "prod"
  
  depends_on = [
    aws_api_gateway_integration.lambda
  ]
}
```

### 典型的なユースケース

```mermaid
graph TD
    subgraph "モバイルバックエンド"
        MB[モバイルアプリ]
        APIGW1[API Gateway]
        LAMBDA1[Lambda]
        DDB1[DynamoDB]
    end
    
    subgraph "マイクロサービス"
        CLIENT[クライアント]
        APIGW2[API Gateway]
        MS1[Service 1]
        MS2[Service 2]
        MS3[Service 3]
    end
    
    subgraph "レガシー統合"
        MODERN[モダンアプリ]
        APIGW3[API Gateway]
        LEGACY[レガシーシステム]
    end
    
    MB --> APIGW1
    APIGW1 --> LAMBDA1
    LAMBDA1 --> DDB1
    
    CLIENT --> APIGW2
    APIGW2 --> MS1
    APIGW2 --> MS2
    APIGW2 --> MS3
    
    MODERN --> APIGW3
    APIGW3 --> LEGACY
```

### ベストプラクティス

#### API設計のベストプラクティス

**セキュリティ**
- 認証方式の適切な選択
- HTTPSの必須化
- CORSの適切な設定
- WAF統合でのセキュリティ強化

**パフォーマンス**
- キャッシングの活用
- 適切なタイムアウト設定
- 非同期処理の検討
- VPCエンドポイント使用

**監視**
- CloudWatch統合
- X-Ray トレーシング
- アクセスログ有効化
- カスタムメトリクス設定

**コスト最適化**
- HTTP API優先検討
- キャッシュ活用
- 使用量プラン設定
- 不要なログの無効化

## 関連
- [API Gateway デベロッパーガイド](https://docs.aws.amazon.com/apigateway/)
- [REST API vs HTTP API 選択ガイド](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html)
- [API Gateway 料金](https://aws.amazon.com/api-gateway/pricing/)
- [サーバーレスアーキテクチャ](https://aws.amazon.com/serverless/)