# Terraform AWS VPCのenable_dns_hostnamesとは

## What's this file?

> [!NOTE]
> **What**
> 
> Terraform AWS VPCリソースのenable_dns_hostnames設定パラメータとは何かについて記載しています。

## Conclusion (忙しいとき向け)

> [!IMPORTANT]
> **What** : enable_dns_hostnamesとは何か
> 
> **Answer** : VPC内でEC2インスタンスにパブリックDNSホスト名を自動割り当てする機能を有効化する設定。trueにすることで、インスタンスがpublic IPを持つ場合にDNS名（ec2-x-x-x-x.region.compute.amazonaws.com）が付与される

## 目次

<details>
<summary>目次を開く</summary>

- [1. enable_dns_hostnamesの基本概念](#1-enable_dns_hostnamesの基本概念)
- [2. enable_dns_supportとの違い](#2-enable_dns_supportとの違い)
- [3. 実際の動作と影響](#3-実際の動作と影響)
- [4. 設定パターンと使用例](#4-設定パターンと使用例)
- [5. トラブルシューティング](#5-トラブルシューティング)

</details>

## 1. enable_dns_hostnamesの基本概念

### 設定の意味

```hcl
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true  # パブリックDNSホスト名の割り当てを有効化
  enable_dns_support   = true  # DNS解決を有効化（デフォルトでtrue）
  
  tags = {
    Name = "main-vpc"
  }
}
```

### enable_dns_hostnamesが有効な場合の動作

1. **パブリックIPを持つインスタンスへのDNS名割り当て**
   ```
   # パブリックIPアドレス: 54.123.45.67
   # 自動割り当てされるDNS名: ec2-54-123-45-67.ap-northeast-1.compute.amazonaws.com
   ```

2. **VPC内部からの名前解決**
   ```bash
   # VPC内の別インスタンスから
   $ nslookup ec2-54-123-45-67.ap-northeast-1.compute.amazonaws.com
   # → 54.123.45.67（パブリックIP）または 10.0.1.10（プライベートIP）
   ```

### デフォルト値と推奨設定

```hcl
# デフォルト値
enable_dns_hostnames = false  # デフォルトでは無効

# 推奨設定（ほとんどのケースで有効化を推奨）
enable_dns_hostnames = true
enable_dns_support   = true  # セットで有効化が必要
```

## 2. enable_dns_supportとの違い

### 両設定の役割比較

| 設定 | デフォルト値 | 役割 |
|------|-------------|------|
| enable_dns_support | true | VPC内でのDNS解決機能を有効化（Amazon提供のDNSサーバー使用） |
| enable_dns_hostnames | false | パブリックIPを持つインスタンスにDNSホスト名を割り当て |

### 設定の組み合わせと結果

```hcl
# ケース1: 両方true（推奨）
resource "aws_vpc" "recommended" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true
  # → DNS解決可能 + パブリックDNS名割り当て
}

# ケース2: dns_supportのみtrue（デフォルト）
resource "aws_vpc" "default" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = false
  # → DNS解決可能だが、パブリックDNS名は割り当てられない
}

# ケース3: dns_hostnamesのみtrue（非推奨）
resource "aws_vpc" "invalid" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = false
  enable_dns_hostnames = true
  # → enable_dns_hostnamesは事実上無効（dns_supportが前提）
}
```

## 3. 実際の動作と影響

### EC2インスタンスでの挙動

```hcl
# VPC設定
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
}

# パブリックサブネットのインスタンス
resource "aws_instance" "public" {
  ami                         = data.aws_ami.amazon_linux_2.id
  instance_type               = "t3.micro"
  subnet_id                   = aws_subnet.public.id
  associate_public_ip_address = true  # パブリックIP割り当て
  
  tags = {
    Name = "public-instance"
  }
}

# enable_dns_hostnames = true の場合:
# - パブリックDNS名: ec2-x-x-x-x.region.compute.amazonaws.com
# - プライベートDNS名: ip-10-0-1-10.region.compute.internal

# enable_dns_hostnames = false の場合:
# - パブリックDNS名: なし
# - プライベートDNS名: ip-10-0-1-10.region.compute.internal（これは常に存在）
```

### ECS/Fargateでの影響

```hcl
# ECSタスクでのDNS設定
resource "aws_ecs_task_definition" "app" {
  family                   = "app-task"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  
  container_definitions = jsonencode([
    {
      name  = "app"
      image = "nginx:latest"
      
      # VPCのDNS設定が有効な場合、コンテナ内からも
      # 他のAWSリソースのDNS名を解決可能
      environment = [
        {
          name  = "DATABASE_HOST"
          value = aws_db_instance.main.address  # RDSのDNS名を使用
        }
      ]
    }
  ])
}
```

### RDSやELBとの連携

```hcl
# RDSインスタンス（DNS名は常に提供される）
resource "aws_db_instance" "main" {
  identifier = "main-db"
  # エンドポイント: main-db.xxxx.region.rds.amazonaws.com
  # VPCのDNS設定に関係なく、RDSは独自のDNS名を持つ
}

# ALB（DNS名は常に提供される）
resource "aws_lb" "main" {
  name               = "main-alb"
  load_balancer_type = "application"
  # DNS名: main-alb-xxxx.region.elb.amazonaws.com
  # VPCのDNS設定に関係なく、ALBは独自のDNS名を持つ
}
```

## 4. 設定パターンと使用例

### 標準的な本番環境設定

```hcl
# 本番環境VPC
resource "aws_vpc" "production" {
  cidr_block           = var.vpc_cidr
  enable_dns_hostnames = true  # DNS名での通信を可能に
  enable_dns_support   = true  # DNS解決を有効化
  
  tags = {
    Name        = "${var.project_name}-vpc-${var.environment}"
    Environment = "production"
  }
}

# カスタムDHCPオプションセット（高度な設定）
resource "aws_vpc_dhcp_options" "custom" {
  domain_name         = "${var.environment}.${var.domain_name}"
  domain_name_servers = ["AmazonProvidedDNS"]
  
  tags = {
    Name = "${var.project_name}-dhcp-${var.environment}"
  }
}

resource "aws_vpc_dhcp_options_association" "custom" {
  vpc_id          = aws_vpc.production.id
  dhcp_options_id = aws_vpc_dhcp_options.custom.id
}
```

### マルチAZ構成での使用

```hcl
# 複数AZにまたがるVPC
resource "aws_vpc" "multi_az" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
}

# 各AZのサブネット
resource "aws_subnet" "public" {
  count                   = length(var.availability_zones)
  vpc_id                  = aws_vpc.multi_az.id
  cidr_block              = cidrsubnet(aws_vpc.multi_az.cidr_block, 8, count.index)
  availability_zone       = var.availability_zones[count.index]
  map_public_ip_on_launch = true  # パブリックIP自動割り当て
  
  # enable_dns_hostnamesが有効な場合、
  # このサブネットで起動したインスタンスにDNS名が付与される
}
```

### ハイブリッドクラウド環境

```hcl
# オンプレミスと接続するVPC
resource "aws_vpc" "hybrid" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
}

# Route 53 Resolver for hybrid DNS
resource "aws_route53_resolver_endpoint" "inbound" {
  name      = "inbound-resolver"
  direction = "INBOUND"
  
  security_group_ids = [aws_security_group.resolver.id]
  
  dynamic "ip_address" {
    for_each = aws_subnet.private[*].id
    content {
      subnet_id = ip_address.value
    }
  }
  
  # VPCのDNS設定が有効でないと、
  # Route 53 Resolverも正しく機能しない
}
```

## 5. トラブルシューティング

### よくある問題と解決方法

```hcl
# 問題1: インスタンスにDNS名が付かない
# 原因: enable_dns_hostnamesがfalse
resource "aws_vpc" "troubleshoot1" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = false  # これが原因
  enable_dns_support   = true
}

# 解決方法
resource "aws_vpc" "fixed1" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true  # trueに変更
  enable_dns_support   = true
}
```

### DNS解決の確認方法

```bash
# EC2インスタンス内での確認コマンド

# 1. 自身のDNS名を確認
$ curl http://169.254.169.254/latest/meta-data/public-hostname
ec2-54-123-45-67.ap-northeast-1.compute.amazonaws.com

# 2. DNS解決が機能しているか確認
$ nslookup google.com
# 成功すればDNS解決は有効

# 3. VPC内の他のリソースのDNS名を解決
$ nslookup my-rds-instance.xxx.rds.amazonaws.com
# RDSエンドポイントが解決できれば正常
```

### 設定変更時の注意点

```hcl
# 既存VPCの設定変更
# 注意: 変更は即座に反映されるが、
# 既存のインスタンスは再起動が必要な場合がある

resource "aws_vpc" "existing" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true  # falseからtrueに変更
  enable_dns_support   = true
  
  lifecycle {
    # VPCの設定変更時の影響を最小限に
    create_before_destroy = false
  }
}
```

## 関連

- [AWS VPC DNS Resolution Documentation](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html)
- [Terraform AWS Provider - aws_vpc Resource](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc)
- [Amazon EC2 Instance Hostname Types](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-naming.html)