# Amazon SWF (Simple Workflow Service)

## 概要

Amazon SWF（Simple Workflow Service）は、分散アプリケーションのワークフローを構築、実行、管理するためのフルマネージドサービスです。複雑なビジネスプロセスやアプリケーションワークフローを、スケーラブルで信頼性の高い方法で実装できます。

**注意**: 新規プロジェクトには、より新しいAWS Step Functionsの使用が推奨されています。

## 主な特徴

### 1. ワークフローの構成要素

#### ワークフロー（Workflow）
- ビジネスプロセス全体を表現
- 複数のアクティビティとデシジョンロジックで構成

#### アクティビティ（Activity）
- 実際の作業単位
- ワーカーによって実行される個別のタスク

#### ワーカー（Worker）
- アクティビティを実行するプログラム
- ポーリングによってタスクを取得

#### デサイダー（Decider）
- ワークフローの進行を制御
- 次に実行するアクティビティを決定

### 2. 実行保証
- **タスクの一意性**: 各タスクは一度だけ実行
- **実行履歴の永続化**: 全ての実行履歴を記録
- **障害からの自動回復**: 中断されたワークフローの再開

### 3. スケーラビリティ
- 自動的なスケーリング
- 分散実行のサポート
- 高可用性の保証

## アーキテクチャ

### ワークフローの実行フロー

```
1. ワークフロー開始
   ↓
2. デサイダーがタスクリストをポーリング
   ↓
3. デサイダーが次のアクティビティを決定
   ↓
4. アクティビティタスクがスケジュール
   ↓
5. ワーカーがタスクを取得・実行
   ↓
6. 結果がSWFに報告
   ↓
7. 2に戻る（完了まで繰り返し）
```

### コンポーネント間の通信

- **タスクリスト**: ワーカーとデサイダーがタスクを取得
- **ポーリング**: プル型のタスク取得メカニズム
- **ハートビート**: 長時間実行タスクの進捗報告

## 主要な機能

### 1. タスク管理
- **タスクの優先度設定**
- **タイムアウト管理**
- **リトライポリシー**
- **タスクのルーティング**

### 2. 実行制御
- **条件分岐**
- **並列実行**
- **ループ処理**
- **子ワークフロー**

### 3. エラーハンドリング
- **自動リトライ**
- **補償トランザクション**
- **タイムアウト処理**
- **手動介入のサポート**

### 4. モニタリング
- **実行履歴の追跡**
- **リアルタイムステータス**
- **CloudWatchメトリクス**
- **詳細なログ記録**

## 使用例

### 1. メディア処理
```
動画アップロード
  → トランスコーディング
  → サムネイル生成
  → メタデータ抽出
  → 配信準備
```

### 2. Eコマース注文処理
```
注文受付
  → 在庫確認
  → 決済処理
  → 配送手配
  → 通知送信
```

### 3. データ処理パイプライン
```
データ収集
  → 検証
  → 変換
  → 分析
  → レポート生成
```

## SWF vs Step Functions

### Amazon SWF
- **利点**:
  - より細かい制御が可能
  - 外部シグナルのサポート
  - 長期実行ワークフロー（最大1年）
  
- **欠点**:
  - 実装が複雑
  - ビジュアルツールなし
  - 管理の負担が大きい

### AWS Step Functions（推奨）
- **利点**:
  - ビジュアルワークフロー
  - より簡単な実装
  - サーバーレス統合
  - JSONベースの定義

- **欠点**:
  - SWFより制限が多い
  - 実行時間の制限（Standard: 1年、Express: 5分）

## 実装例（概念）

### ワークフロー定義
```python
# デサイダーの例
def decider_logic(events):
    if not has_activity_completed("ProcessPayment", events):
        return schedule_activity("ProcessPayment")
    elif not has_activity_completed("ShipOrder", events):
        return schedule_activity("ShipOrder")
    else:
        return complete_workflow()
```

### アクティビティワーカー
```python
# ワーカーの例
def process_payment_worker(task):
    # 決済処理のロジック
    result = process_payment(task.input)
    return result
```

## 料金体系

- **ワークフロー実行**: 実行数に基づく
- **アクティビティタスク**: タスク数に基づく
- **データ転送**: 通常のAWS料金

## 制限事項

- ワークフロー実行期間: 最大1年
- ワークフロー履歴: 最大25,000イベント
- オープンなアクティビティ: 最大1,000
- タスクリスト名: 最大256文字

## ベストプラクティス

### 1. ワークフロー設計
- 冪等性を持つアクティビティ
- 適切なタイムアウト設定
- エラーハンドリングの実装

### 2. パフォーマンス
- バッチ処理の活用
- 並列実行の最適化
- 効率的なポーリング

### 3. 運用
- 包括的なログ記録
- メトリクスの監視
- 定期的なクリーンアップ

## セキュリティ

- **IAMロール**: きめ細かいアクセス制御
- **暗号化**: 保管時・転送時の暗号化
- **VPC統合**: プライベートネットワーク内での実行
- **監査**: CloudTrailによる操作記録

## 移行ガイド

### SWFからStep Functionsへ
1. ワークフローの分析と簡素化
2. Step Functions形式への変換
3. 段階的な移行計画
4. テストと検証
5. 本番環境への展開

## まとめ

Amazon SWFは強力なワークフローサービスですが、現在は新規プロジェクトにはAWS Step Functionsの使用が推奨されています。既存のSWFワークフローを維持している場合は、Step Functionsへの移行を検討することをお勧めします。SWFは複雑なワークフローに対して細かい制御を提供しますが、その分実装と管理の負担も大きくなります。