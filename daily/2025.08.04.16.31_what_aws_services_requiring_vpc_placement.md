# VPCやサブネットへの配置が必要なAWSサービス

## What's this file?
> [!NOTE]
> **What**
> 
> VPCやサブネットへの配置が必要なAWSサービスとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : VPCやサブネットへの配置が必要なAWSサービスとは何か
> 
> **Answer** : EC2、RDS、ECS/Fargate、ALB/NLBなど、ネットワークレベルでの分離とIPアドレスベースの通信が必要なサービス群。これらは顧客のVPC内に配置され、ENI（Elastic Network Interface）を通じて動作する

## 目次

<details>
<summary>目次を開く</summary>

- [VPC配置が必要な理由](#vpc配置が必要な理由)
- [主要なVPC内配置サービス](#主要なvpc内配置サービス)
- [配置要件とネットワーク設計](#配置要件とネットワーク設計)
- [マネージドサービスとの違い](#マネージドサービスとの違い)

</details>

## VPC配置が必要な理由

### 技術的要件

```mermaid
graph TD
    subgraph "VPC配置が必要な理由"
        R1[プライベートIPアドレス必要]
        R2[ネットワーク分離要件]
        R3[直接的なネットワーク通信]
        R4[カスタムネットワーク設定]
        R5[セキュリティグループ制御]
    end
    
    subgraph "結果として"
        RES1[サブネット内にENI配置]
        RES2[顧客管理のネットワーク]
        RES3[OSレベルのアクセス]
        RES4[細かいネットワーク制御]
    end
    
    R1 --> RES1
    R2 --> RES2
    R3 --> RES3
    R4 --> RES4
    R5 --> RES4
    
    style R1 fill:#f99,stroke:#333,stroke-width:2px
    style R2 fill:#f99,stroke:#333,stroke-width:2px
    style RES1 fill:#9f9,stroke:#333,stroke-width:2px
```

### ENI（Elastic Network Interface）の役割

```mermaid
graph LR
    subgraph "EC2インスタンス"
        OS[OS]
        APP[アプリケーション]
    end
    
    subgraph "ネットワーク層"
        ENI[ENI<br/>MACアドレス<br/>プライベートIP<br/>パブリックIP（任意）]
        SG[セキュリティグループ]
    end
    
    subgraph "VPCインフラ"
        SUBNET[サブネット<br/>10.0.1.0/24]
        RT[ルートテーブル]
    end
    
    APP --> OS
    OS --> ENI
    ENI --> SG
    SG --> SUBNET
    SUBNET --> RT
    
    style ENI fill:#9ff,stroke:#333,stroke-width:3px
    style SUBNET fill:#ff9,stroke:#333,stroke-width:2px
```

## 主要なVPC内配置サービス

### コンピュートサービス

```mermaid
graph TB
    subgraph "EC2ベースサービス"
        EC2[EC2<br/>仮想サーバー]
        ASG[Auto Scaling Groups<br/>自動スケーリング]
        ECS_EC2[ECS on EC2<br/>コンテナ管理]
    end
    
    subgraph "サーバーレスコンピュート（VPC内）"
        Fargate[Fargate<br/>サーバーレスコンテナ]
        Lambda_VPC[Lambda in VPC<br/>VPC内実行]
        Batch[AWS Batch<br/>バッチ処理]
    end
    
    subgraph "配置要件"
        REQ[サブネット指定必須<br/>セキュリティグループ必須<br/>ENI自動作成]
    end
    
    EC2 --> REQ
    Fargate --> REQ
    Lambda_VPC --> REQ
```

### データベースサービス

```mermaid
graph LR
    subgraph "RDSファミリー"
        RDS[RDS<br/>MySQL/PostgreSQL等]
        Aurora[Aurora<br/>高性能DB]
        DocDB[DocumentDB<br/>MongoDB互換]
        Neptune[Neptune<br/>グラフDB]
    end
    
    subgraph "キャッシュサービス"
        EC[ElastiCache<br/>Redis/Memcached]
        DAX[DynamoDB Accelerator<br/>DynamoDBキャッシュ]
    end
    
    subgraph "共通要件"
        DB_REQ[DBサブネットグループ<br/>Multi-AZ配置<br/>プライベートアクセス]
    end
    
    RDS --> DB_REQ
    Aurora --> DB_REQ
    EC --> DB_REQ
    
    style RDS fill:#9f9,stroke:#333,stroke-width:2px
    style Aurora fill:#9f9,stroke:#333,stroke-width:2px
    style EC fill:#ff9,stroke:#333,stroke-width:2px
```

### ネットワーキングサービス

| サービス | 配置要件 | 用途 | 特徴 |
|---------|----------|------|------|
| ALB | パブリック/プライベートサブネット | L7ロードバランサー | HTTP/HTTPS振り分け |
| NLB | パブリック/プライベートサブネット | L4ロードバランサー | 高性能TCP/UDP |
| NAT Gateway | パブリックサブネット必須 | アウトバウンド通信 | プライベート→インターネット |
| VPN Gateway | VPCアタッチ | サイト間接続 | オンプレミス接続 |
| Transit Gateway | VPCアタッチメント | VPC間接続 | 複数VPC統合 |

## 配置要件とネットワーク設計

### 典型的なVPC内サービス配置

```mermaid
graph TB
    subgraph "VPC (10.0.0.0/16)"
        subgraph "パブリックサブネット層"
            subgraph "Public Subnet 1a"
                ALB1[ALB]
                NAT1[NAT Gateway]
            end
            subgraph "Public Subnet 1c"
                ALB2[ALB]
                NAT2[NAT Gateway]
            end
        end
        
        subgraph "プライベートサブネット層"
            subgraph "App Subnet 1a"
                EC2_1[EC2/Fargate]
            end
            subgraph "App Subnet 1c"
                EC2_2[EC2/Fargate]
            end
        end
        
        subgraph "データベースサブネット層"
            subgraph "DB Subnet 1a"
                RDS1[RDS Primary]
            end
            subgraph "DB Subnet 1c"
                RDS2[RDS Standby]
            end
        end
    end
    
    ALB1 --> EC2_1
    ALB2 --> EC2_2
    EC2_1 --> RDS1
    EC2_2 --> RDS2
    
    style ALB1 fill:#ff9,stroke:#333,stroke-width:2px
    style EC2_1 fill:#9f9,stroke:#333,stroke-width:2px
    style RDS1 fill:#99f,stroke:#333,stroke-width:2px
```

### サブネット設計のベストプラクティス

```mermaid
graph TB
    subgraph "VPC (10.0.0.0/16)"
        subgraph "パブリックサブネット"
            subgraph "public-1a (10.0.0.0/24)"
                ALB_1a[ALB]
                NAT_1a[NAT Gateway]
                Bastion_1a[Bastion]
            end
            subgraph "public-1c (10.0.1.0/24)"
                ALB_1c[ALB]
                NAT_1c[NAT Gateway]
            end
        end
        
        subgraph "プライベートサブネット - アプリケーション層"
            subgraph "app-1a (10.0.10.0/24)"
                EC2_1a[EC2]
                ECS_1a[ECS]
                Fargate_1a[Fargate]
            end
            subgraph "app-1c (10.0.11.0/24)"
                EC2_1c[EC2]
                ECS_1c[ECS]
                Fargate_1c[Fargate]
            end
        end
        
        subgraph "プライベートサブネット - データ層"
            subgraph "data-1a (10.0.20.0/24)"
                RDS_1a[RDS]
                ElastiCache_1a[ElastiCache]
                EFS_MT_1a[EFS MT]
            end
            subgraph "data-1c (10.0.21.0/24)"
                RDS_1c[RDS]
                ElastiCache_1c[ElastiCache]
                EFS_MT_1c[EFS MT]
            end
        end
    end
    
    %% 接続関係
    ALB_1a --> EC2_1a
    ALB_1a --> ECS_1a
    ALB_1a --> Fargate_1a
    ALB_1c --> EC2_1c
    ALB_1c --> ECS_1c
    ALB_1c --> Fargate_1c
    
    EC2_1a --> RDS_1a
    ECS_1a --> ElastiCache_1a
    Fargate_1a --> EFS_MT_1a
    EC2_1c --> RDS_1c
    ECS_1c --> ElastiCache_1c
    Fargate_1c --> EFS_MT_1c
    
    %% スタイリング
    style ALB_1a fill:#ff9,stroke:#333,stroke-width:2px
    style ALB_1c fill:#ff9,stroke:#333,stroke-width:2px
    style NAT_1a fill:#9ff,stroke:#333,stroke-width:2px
    style NAT_1c fill:#9ff,stroke:#333,stroke-width:2px
    style RDS_1a fill:#99f,stroke:#333,stroke-width:2px
    style RDS_1c fill:#99f,stroke:#333,stroke-width:2px
```

### Terraform実装例

```hcl
# VPC内配置が必要なサービスの例

# EC2インスタンス
resource "aws_instance" "app" {
  ami                    = "ami-0xxx"
  instance_type          = "t3.medium"
  subnet_id              = aws_subnet.private_app.id  # サブネット指定必須
  vpc_security_group_ids = [aws_security_group.app.id]
  
  tags = {
    Name = "app-server"
  }
}

# RDSインスタンス
resource "aws_db_instance" "main" {
  identifier     = "main-db"
  engine         = "mysql"
  instance_class = "db.t3.medium"
  
  # DBサブネットグループ（複数サブネット必須）
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]
}

resource "aws_db_subnet_group" "main" {
  name       = "main-db-subnet-group"
  subnet_ids = [
    aws_subnet.data_1a.id,
    aws_subnet.data_1c.id
  ]
}

# Fargateタスク
resource "aws_ecs_service" "app" {
  name            = "app-service"
  cluster         = aws_ecs_cluster.main.id
  task_definition = aws_ecs_task_definition.app.arn
  
  network_configuration {
    subnets         = aws_subnet.private_app[*].id  # サブネット指定必須
    security_groups = [aws_security_group.fargate.id]
  }
}

# ALB
resource "aws_lb" "main" {
  name               = "main-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  subnets            = aws_subnet.public[*].id  # 複数AZのサブネット必須
}
```

## マネージドサービスとの違い

### 配置パターンの比較

```mermaid
graph TD
    subgraph "判断基準"
        Q1{インフラ管理の<br/>責任は？}
        Q2{ネットワーク<br/>分離必要？}
        Q3{IPベース<br/>通信？}
    end
    
    subgraph "VPC内配置"
        VPC_SVC[EC2, RDS, ECS<br/>ALB, ElastiCache]
    end
    
    subgraph "VPC外配置"
        MANAGED[S3, DynamoDB<br/>Lambda, SNS]
    end
    
    Q1 -->|共同責任| Q2
    Q1 -->|AWS完全管理| MANAGED
    Q2 -->|Yes| Q3
    Q2 -->|No| MANAGED
    Q3 -->|Yes| VPC_SVC
    Q3 -->|No| MANAGED
    
    style VPC_SVC fill:#9f9,stroke:#333,stroke-width:3px
    style MANAGED fill:#ff9,stroke:#333,stroke-width:3px
```

### 管理責任の違い

| 項目 | VPC内配置サービス | VPC外マネージドサービス |
|------|------------------|----------------------|
| ネットワーク設定 | 顧客責任 | AWS管理 |
| セキュリティグループ | 顧客設定 | 不要（IAMのみ） |
| 可用性設計 | 顧客がMulti-AZ設定 | 自動的に高可用性 |
| スケーリング | 顧客が設定 | 自動スケール |
| パッチ適用 | 一部顧客責任 | AWS完全管理 |
| バックアップ | 顧客が設定 | 多くは自動 |

### まとめ：VPC配置の必要性

```mermaid
graph LR
    subgraph "VPC配置必須の特徴"
        F1[OSレベルアクセス]
        F2[カスタムソフトウェア]
        F3[レガシーアプリ対応]
        F4[細かいネットワーク制御]
        F5[既存システム連携]
    end
    
    subgraph "代表的サービス"
        S1[EC2<br/>完全制御可能]
        S2[RDS<br/>DB エンジン選択]
        S3[ECS/Fargate<br/>コンテナ実行]
    end
    
    F1 --> S1
    F2 --> S1
    F3 --> S2
    F4 --> S3
    
    style S1 fill:#9f9,stroke:#333,stroke-width:2px
    style S2 fill:#99f,stroke:#333,stroke-width:2px
    style S3 fill:#f9f,stroke:#333,stroke-width:2px
```

## 関連

- [Amazon VPC ユーザーガイド](https://docs.aws.amazon.com/vpc/latest/userguide/)
- [EC2 ネットワーキング](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-networking.html)
- [RDS VPC配置ガイド](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_VPC.html)
- [Well-Architected - ネットワーク設計](https://docs.aws.amazon.com/wellarchitected/latest/framework/a-foundations.html)