# AWS WAFが保護できるサービスとコンポーネント

## What's this file?
> [!NOTE]
> **What**
> 
> AWS WAFが保護できるサービスとコンポーネントとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : AWS WAFが保護できるサービスとコンポーネントとは何か
> 
> **Answer** : CloudFront、ALB、API Gateway、AppSync、Cognito User Poolの5つのサービスに対してWebアプリケーションレベルの保護を提供。EC2やRDSなどは直接保護できないが、ALB経由でアクセスすることで間接的に保護可能

## 目次

<details>
<summary>目次を開く</summary>

- [WAF適用可能なサービス一覧](#waf適用可能なサービス一覧)
- [各サービスでの保護範囲](#各サービスでの保護範囲)
- [WAFが保護できないサービス](#wafが保護できないサービス)
- [アーキテクチャパターンと保護戦略](#アーキテクチャパターンと保護戦略)

</details>

## WAF適用可能なサービス一覧

### 対応サービスとスコープ

```mermaid
graph TB
    subgraph "グローバルスコープ（us-east-1）"
        CF[CloudFront<br/>CDN]
    end
    
    subgraph "リージョナルスコープ"
        ALB[Application Load Balancer<br/>L7ロードバランサー]
        APIGW[API Gateway<br/>REST/HTTP API]
        APPSYNC[AWS AppSync<br/>GraphQL API]
        COGNITO[Cognito User Pool<br/>認証サービス]
    end
    
    subgraph "AWS WAF"
        GLOBAL[WAF Global<br/>CloudFront用]
        REGIONAL[WAF Regional<br/>その他サービス用]
    end
    
    GLOBAL --> CF
    REGIONAL --> ALB
    REGIONAL --> APIGW
    REGIONAL --> APPSYNC
    REGIONAL --> COGNITO
    
    style CF fill:#9ff,stroke:#333,stroke-width:3px
    style ALB fill:#ff9,stroke:#333,stroke-width:3px
    style APIGW fill:#9f9,stroke:#333,stroke-width:3px
```

### サービス別の特徴

| サービス | WAFスコープ | 保護レイヤー | 主な用途 |
|---------|------------|-------------|---------|
| CloudFront | CLOUDFRONT | エッジロケーション | 静的/動的コンテンツ配信 |
| ALB | REGIONAL | アプリケーション層 | Webアプリケーション |
| API Gateway | REGIONAL | API層 | REST/HTTP API |
| AppSync | REGIONAL | GraphQL層 | GraphQL API |
| Cognito | REGIONAL | 認証層 | ユーザー認証・認可 |

## 各サービスでの保護範囲

### CloudFrontでの保護

```mermaid
graph LR
    subgraph "インターネット"
        USER[ユーザー]
        ATTACKER[攻撃者]
    end
    
    subgraph "エッジロケーション"
        WAF_CF[WAF<br/>グローバル]
        CF[CloudFront]
    end
    
    subgraph "オリジン"
        S3[S3]
        ALB_ORIGIN[ALB]
        CUSTOM[カスタムオリジン]
    end
    
    USER --> WAF_CF
    ATTACKER -->|ブロック| WAF_CF
    WAF_CF --> CF
    CF --> S3
    CF --> ALB_ORIGIN
    CF --> CUSTOM
    
    style WAF_CF fill:#f99,stroke:#333,stroke-width:3px
    style CF fill:#9ff,stroke:#333,stroke-width:2px
```

### ALBでの保護

```mermaid
graph TB
    subgraph "インターネット/VPC"
        CLIENT[クライアント]
    end
    
    subgraph "パブリックサブネット"
        WAF_ALB[WAF<br/>リージョナル]
        ALB[ALB]
    end
    
    subgraph "プライベートサブネット"
        TG1[ターゲットグループ1<br/>EC2]
        TG2[ターゲットグループ2<br/>Fargate]
        TG3[ターゲットグループ3<br/>Lambda]
    end
    
    CLIENT --> WAF_ALB
    WAF_ALB --> ALB
    ALB --> TG1
    ALB --> TG2
    ALB --> TG3
    
    style WAF_ALB fill:#f99,stroke:#333,stroke-width:3px
    style ALB fill:#ff9,stroke:#333,stroke-width:2px
```

### API Gatewayでの保護

#### 保護可能なAPIタイプ

**REST API**
- エンドポイントタイプ: Edge/Regional/Private
- WAF統合: すべて可能
- 保護レベル: HTTPリクエスト全体

**HTTP API**
- エンドポイントタイプ: Regional
- WAF統合: 可能
- 保護レベル: HTTPリクエスト全体

**WebSocket API**
- WAF統合: 不可
- 代替策: CloudFront + WAF経由

### AppSyncでの保護

```mermaid
graph LR
    subgraph "GraphQLクライアント"
        MOBILE[モバイルアプリ]
        WEB[Webアプリ]
    end
    
    subgraph "AWS AppSync"
        WAF_AS[WAF保護]
        SCHEMA[GraphQLスキーマ]
        RESOLVER[リゾルバー]
    end
    
    subgraph "データソース"
        DDB[DynamoDB]
        LAMBDA[Lambda]
        RDS[RDS Proxy]
    end
    
    MOBILE --> WAF_AS
    WEB --> WAF_AS
    WAF_AS --> SCHEMA
    SCHEMA --> RESOLVER
    RESOLVER --> DDB
    RESOLVER --> LAMBDA
    RESOLVER --> RDS
    
    style WAF_AS fill:#f99,stroke:#333,stroke-width:3px
```

### Cognito User Poolでの保護

```mermaid
graph TD
    subgraph "認証フロー"
        USER[ユーザー]
        APP[アプリケーション]
    end
    
    subgraph "Cognito User Pool"
        WAF_COG[WAF保護]
        AUTH[認証エンドポイント<br/>SignUp/SignIn]
        TOKEN[トークンエンドポイント]
    end
    
    subgraph "保護対象"
        SIGNUP[サインアップ]
        SIGNIN[サインイン]
        FORGOT[パスワードリセット]
    end
    
    USER --> APP
    APP --> WAF_COG
    WAF_COG --> AUTH
    AUTH --> SIGNUP
    AUTH --> SIGNIN
    AUTH --> FORGOT
    
    style WAF_COG fill:#f99,stroke:#333,stroke-width:3px
```

## WAFが保護できないサービス

### 直接保護できないサービス

```mermaid
graph TD
    subgraph "直接保護不可"
        EC2[EC2<br/>仮想サーバー]
        RDS[RDS<br/>データベース]
        S3API[S3<br/>API直接アクセス]
        LAMBDA[Lambda<br/>直接呼び出し]
        ECS[ECS/Fargate<br/>コンテナ]
    end
    
    subgraph "間接的に保護可能"
        ALB_PROXY[ALB経由]
        CF_PROXY[CloudFront経由]
        APIGW_PROXY[API Gateway経由]
    end
    
    EC2 -->|保護方法| ALB_PROXY
    S3API -->|保護方法| CF_PROXY
    LAMBDA -->|保護方法| APIGW_PROXY
    
    style EC2 fill:#f99,stroke:#333,stroke-width:2px
    style ALB_PROXY fill:#9f9,stroke:#333,stroke-width:2px
```

### 保護できない理由と代替策

| サービス | 保護できない理由 | 推奨される代替策 |
|---------|----------------|----------------|
| EC2 | L7プロキシサービスではない | ALB + WAF経由でアクセス |
| RDS | データベースプロトコル | セキュリティグループ + VPC |
| S3（直接） | オブジェクトストレージAPI | CloudFront + WAF経由 |
| Lambda（直接） | 関数実行API | API Gateway + WAF経由 |
| ECS/Fargate | コンテナサービス | ALB + WAF経由でアクセス |

## アーキテクチャパターンと保護戦略

### パターン1: Webアプリケーション保護

```mermaid
graph TB
    subgraph "インターネット"
        USERS[ユーザー]
    end
    
    subgraph "エッジ保護"
        WAF1[WAF]
        CF[CloudFront]
    end
    
    subgraph "リージョン保護"
        WAF2[WAF]
        ALB[ALB]
    end
    
    subgraph "アプリケーション"
        EC2[EC2/Fargate]
        RDS[(RDS)]
    end
    
    USERS --> WAF1
    WAF1 --> CF
    CF --> WAF2
    WAF2 --> ALB
    ALB --> EC2
    EC2 --> RDS
    
    style WAF1 fill:#f99,stroke:#333,stroke-width:3px
    style WAF2 fill:#f99,stroke:#333,stroke-width:3px
```

### パターン2: API保護

```mermaid
graph LR
    subgraph "APIクライアント"
        MOBILE[モバイル]
        WEB[Web]
        IOT[IoT]
    end
    
    subgraph "API層"
        WAF_API[WAF]
        APIGW[API Gateway]
    end
    
    subgraph "バックエンド"
        LAMBDA[Lambda]
        ECS[ECS]
        STEP[Step Functions]
    end
    
    MOBILE --> WAF_API
    WEB --> WAF_API
    IOT --> WAF_API
    WAF_API --> APIGW
    APIGW --> LAMBDA
    APIGW --> ECS
    LAMBDA --> STEP
    
    style WAF_API fill:#f99,stroke:#333,stroke-width:3px
```

### パターン3: 多層防御

#### 多層防御アーキテクチャ

| レイヤー | サービス | WAFタイプ | 保護内容 |
|---------|---------|----------|----------|
| **エッジ層** | CloudFront | Global WAF | DDoS, 地理的制限 |
| **アプリケーション層** | ALB | Regional WAF | SQLi, XSS, カスタムルール |
| **API層** | API Gateway | Regional WAF | レート制限, APIアビューズ |
| **認証層** | Cognito | Regional WAF | ブルートフォース, アカウント作成攻撃 |

### Terraformでの実装例

```hcl
# CloudFront + WAF
resource "aws_wafv2_web_acl" "cloudfront" {
  provider = aws.us_east_1  # CloudFront WAFは us-east-1
  name     = "cloudfront-waf"
  scope    = "CLOUDFRONT"
  
  default_action {
    allow {}
  }
}

resource "aws_cloudfront_distribution" "main" {
  web_acl_id = aws_wafv2_web_acl.cloudfront.arn
  # その他の設定
}

# ALB + WAF
resource "aws_wafv2_web_acl" "alb" {
  name  = "alb-waf"
  scope = "REGIONAL"
  
  default_action {
    allow {}
  }
}

resource "aws_wafv2_web_acl_association" "alb" {
  resource_arn = aws_lb.main.arn
  web_acl_arn  = aws_wafv2_web_acl.alb.arn
}

# API Gateway + WAF
resource "aws_wafv2_web_acl_association" "api_gateway" {
  resource_arn = aws_api_gateway_stage.prod.arn
  web_acl_arn  = aws_wafv2_web_acl.api.arn
}
```

### 保護レベルのベストプラクティス

```mermaid
graph TD
    subgraph "推奨構成"
        REC1[CloudFront + WAF<br/>グローバル保護]
        REC2[ALB + WAF<br/>アプリケーション保護]
        REC3[API Gateway + WAF<br/>API保護]
        REC4[Cognito + WAF<br/>認証保護]
    end
    
    subgraph "保護効果"
        EFF1[DDoS緩和]
        EFF2[一般的な攻撃防御]
        EFF3[カスタムルール適用]
        EFF4[包括的セキュリティ]
    end
    
    REC1 --> EFF1
    REC2 --> EFF2
    REC3 --> EFF3
    REC1 & REC2 & REC3 & REC4 --> EFF4
    
    style EFF4 fill:#9f9,stroke:#333,stroke-width:3px
```

## 関連
- [AWS WAF デベロッパーガイド](https://docs.aws.amazon.com/waf/latest/developerguide/)
- [WAF と統合可能なサービス](https://docs.aws.amazon.com/waf/latest/developerguide/waf-chapter.html)
- [CloudFront での WAF 使用](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-awswaf.html)
- [ALB での WAF 使用](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/application-load-balancers.html#waf-integration)