# EFSのAWSアーキテクチャにおける配置場所

## What's this file?
> [!NOTE]
> **What**
> 
> EFSがAWSアーキテクチャのどこに配置されるかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : EFSがAWSアーキテクチャのどこに配置されるか
> 
> **Answer** : EFS本体はAWSマネージドインフラに存在し、マウントターゲットがVPC内の各サブネットに配置される二層構造となっている

## 目次

<details>
<summary>目次を開く</summary>

- [EFSの階層構造](#efsの階層構造)
- [各コンポーネントの配置場所](#各コンポーネントの配置場所)
- [他のAWSサービスとの配置比較](#他のawsサービスとの配置比較)
- [配置に関する制約と要件](#配置に関する制約と要件)

</details>

## EFSの階層構造

### EFSの全体アーキテクチャ

```mermaid
graph TB
    subgraph "AWS グローバルインフラストラクチャ"
        subgraph "リージョンレベル"
            EFS[EFS ファイルシステム<br/>マネージドサービス]
            subgraph "Multi-AZ冗長化"
                Storage1[ストレージ<br/>AZ-1]
                Storage2[ストレージ<br/>AZ-2]
                Storage3[ストレージ<br/>AZ-3]
            end
        end
    end
    
    subgraph "お客様のVPC"
        subgraph "AZ-1a"
            subgraph "Subnet-1"
                MT1[マウントターゲット 1<br/>ENI]
            end
        end
        subgraph "AZ-1c"
            subgraph "Subnet-2"
                MT2[マウントターゲット 2<br/>ENI]
            end
        end
    end
    
    subgraph "クライアント"
        EC2[EC2/Fargate/Lambda]
    end
    
    EFS --> Storage1
    EFS --> Storage2
    EFS --> Storage3
    Storage1 -.-> MT1
    Storage2 -.-> MT2
    EC2 -->|NFS v4.1| MT1
    EC2 -->|NFS v4.1| MT2
    
    style EFS fill:#ff9,stroke:#333,stroke-width:4px
    style MT1 fill:#9ff,stroke:#333,stroke-width:2px
    style MT2 fill:#9ff,stroke:#333,stroke-width:2px
```

### 配置レイヤーの詳細

| レイヤー | コンポーネント | 配置場所 | 管理主体 |
|---------|---------------|----------|----------|
| サービス層 | EFSファイルシステム | AWSリージョン | AWS完全管理 |
| データ層 | 実データストレージ | 複数AZに分散 | AWS完全管理 |
| アクセス層 | マウントターゲット | VPC内サブネット | 顧客が配置指定 |
| クライアント層 | EC2/Fargate等 | VPC内サブネット | 顧客管理 |

## 各コンポーネントの配置場所

### EFSファイルシステム本体

```mermaid
graph LR
    subgraph "リージョン: ap-northeast-1"
        subgraph "AWSマネージド環境"
            FS[EFS ファイルシステム<br/>fs-12345678]
            META[メタデータ<br/>管理システム]
            REP[レプリケーション<br/>エンジン]
        end
        
        subgraph "ストレージ分散"
            AZ1S[AZ-1a<br/>ストレージ]
            AZ2S[AZ-1c<br/>ストレージ]
            AZ3S[AZ-1d<br/>ストレージ]
        end
    end
    
    FS --> META
    FS --> REP
    REP --> AZ1S
    REP --> AZ2S
    REP --> AZ3S
    
    style FS fill:#ff9,stroke:#333,stroke-width:4px
```

### マウントターゲットの配置

```mermaid
graph TB
    subgraph "VPC (10.0.0.0/16)"
        subgraph "配置可能な場所"
            subgraph "プライベートサブネット"
                PMT1[マウントターゲット<br/>推奨配置]
            end
            subgraph "パブリックサブネット"
                PMT2[マウントターゲット<br/>配置可能]
            end
        end
        
        subgraph "配置要件"
            REQ1[サブネット内に配置必須]
            REQ2[ENIとして実装]
            REQ3[セキュリティグループ適用]
            REQ4[プライベートIPアドレス使用]
        end
    end
    
    PMT1 --> REQ1
    PMT1 --> REQ2
    PMT1 --> REQ3
    PMT1 --> REQ4
    
    style PMT1 fill:#9f9,stroke:#333,stroke-width:3px
    style PMT2 fill:#ff9,stroke:#333,stroke-width:2px
```

## 他のAWSサービスとの配置比較

### ストレージサービスの配置比較

```mermaid
graph LR
    subgraph "VPC外配置"
        S3[S3<br/>リージョナル]
        DDB[DynamoDB<br/>リージョナル]
        GLACIER[Glacier<br/>リージョナル]
    end
    
    subgraph "VPC内外ハイブリッド"
        EFS_FS[EFS本体<br/>リージョナル]
        EFS_MT[EFSマウントターゲット<br/>サブネット内]
        FSX[FSx<br/>同様の構造]
    end
    
    subgraph "VPC内配置"
        EBS[EBS<br/>AZ内]
        INST[Instance Store<br/>ホスト上]
    end
    
    EFS_FS -.->|アクセスポイント| EFS_MT
    
    style EFS_FS fill:#ff9,stroke:#333,stroke-width:3px
    style EFS_MT fill:#9ff,stroke:#333,stroke-width:3px
```

### サービス配置の特徴比較

| サービス | 本体の配置 | アクセスポイント | VPC要件 | 特徴 |
|----------|-----------|----------------|---------|------|
| EFS | AWSインフラ | VPC内マウントターゲット | 必須 | NFSプロトコル |
| S3 | AWSインフラ | インターネット/VPCエンドポイント | 不要 | RESTful API |
| EBS | AZ内 | 直接アタッチ | 必須 | ブロックデバイス |
| RDS | VPC内サブネット | ENI | 必須 | データベースエンジン |

## 配置に関する制約と要件

### マウントターゲット配置の制約

```mermaid
graph TD
    subgraph "配置制約"
        C1[1つのAZに1つのマウントターゲットのみ]
        C2[サブネット内にENIとして配置]
        C3[削除は全クライアントのアンマウント後]
        C4[IPアドレスはサブネットCIDRから自動割当]
    end
    
    subgraph "推奨構成"
        R1[各AZに1つずつ配置]
        R2[専用ストレージサブネット使用]
        R3[プライベートサブネット配置]
        R4[セキュリティグループで厳密な制御]
    end
    
    C1 --> R1
    C2 --> R2
    C4 --> R3
    
    style R1 fill:#9f9,stroke:#333,stroke-width:2px
    style R2 fill:#9f9,stroke:#333,stroke-width:2px
    style R3 fill:#9f9,stroke:#333,stroke-width:2px
    style R4 fill:#9f9,stroke:#333,stroke-width:2px
```

### 配置決定フローチャート

```mermaid
graph TD
    Start[EFS利用開始] --> Q1{VPCは作成済み？}
    Q1 -->|No| CreateVPC[VPC作成]
    Q1 -->|Yes| Q2{対象AZのサブネット<br/>は存在？}
    
    Q2 -->|No| CreateSubnet[サブネット作成]
    Q2 -->|Yes| Q3{ストレージ専用<br/>サブネット？}
    
    Q3 -->|No| Q4{新規作成可能？}
    Q4 -->|Yes| CreateStorageSubnet[ストレージサブネット作成]
    Q4 -->|No| UseExisting[既存サブネット使用]
    
    Q3 -->|Yes| CreateMT[マウントターゲット作成]
    CreateStorageSubnet --> CreateMT
    UseExisting --> CreateMT
    CreateSubnet --> CreateMT
    
    CreateMT --> ConfigSG[セキュリティグループ設定]
    ConfigSG --> Mount[クライアントからマウント]
    
    style CreateMT fill:#9ff,stroke:#333,stroke-width:3px
    style Mount fill:#9f9,stroke:#333,stroke-width:3px
```

### 実装時の配置例

```mermaid
graph TB
    subgraph "AWS Managed Infrastructure"
        EFS["EFS File System<br/>fs-12345678<br/>Region: ap-northeast-1<br/>Availability: 11 9's"]
    end
    
    subgraph "Customer VPC (10.0.0.0/16)"
        subgraph "AZ: ap-northeast-1a"
            subgraph "Storage Subnet (10.0.10.0/24)"
                MT1["Mount Target<br/>10.0.10.10<br/>sg-efs-mt"]
            end
            subgraph "App Subnet (10.0.1.0/24)"
                Client1["ECS Fargate<br/>Tasks"]
            end
        end
        
        subgraph "AZ: ap-northeast-1c"
            subgraph "Storage Subnet (10.0.11.0/24)"
                MT2["Mount Target<br/>10.0.11.10<br/>sg-efs-mt"]
            end
            subgraph "App Subnet (10.0.2.0/24)"
                Client2["EC2<br/>Instances"]
            end
        end
    end
    
    EFS -.->|NFS| MT1
    EFS -.->|NFS| MT2
    Client1 -->|Mount| MT1
    Client2 -->|Mount| MT2
    
    style EFS fill:#ff9,stroke:#333,stroke-width:4px
    style MT1 fill:#9ff,stroke:#333,stroke-width:3px
    style MT2 fill:#9ff,stroke:#333,stroke-width:3px
    style Client1 fill:#9f9,stroke:#333,stroke-width:2px
    style Client2 fill:#9f9,stroke:#333,stroke-width:2px
```

### DNS名前解決と配置の関係

```bash
# EFSのDNS名構造
# ファイルシステムDNS名（リージョンレベル）
fs-12345678.efs.ap-northeast-1.amazonaws.com

# AZ固有のマウントターゲットDNS名
ap-northeast-1a.fs-12345678.efs.ap-northeast-1.amazonaws.com
→ 10.0.10.10 (マウントターゲットのプライベートIP)

ap-northeast-1c.fs-12345678.efs.ap-northeast-1.amazonaws.com
→ 10.0.11.10 (マウントターゲットのプライベートIP)
```

## 関連

- [AWS EFS アーキテクチャ概要](https://docs.aws.amazon.com/efs/latest/ug/how-it-works.html)
- [VPCとサブネットの基礎](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)
- [EFSマウントターゲット作成ガイド](https://docs.aws.amazon.com/efs/latest/ug/accessing-fs.html)
- [AWSストレージサービスの選択](https://docs.aws.amazon.com/whitepapers/latest/aws-storage-services-overview/introduction.html)
