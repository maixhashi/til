# GitHub ActionsでTerraformの変更を反映する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにGitHub Actionsを使用してTerraformの構成変更を自動的に反映するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにGitHub ActionsでTerraformの変更を反映するか
> 
> **Answer** : `.github/workflows/terraform.yml`で定義されたワークフローにより、Pull Request時に`terraform plan`、mainブランチへのマージ時に`terraform apply`が自動実行される

## 目次

<details>
<summary>目次を開く</summary>

- [概要](#概要)
- [前提条件](#前提条件)
- [ワークフローの構成](#ワークフローの構成)
  - [トリガー設定](#トリガー設定)
  - [ジョブの流れ](#ジョブの流れ)
- [環境変数の設定方法](#環境変数の設定方法)
  - [GitHub Secretsの設定](#github-secretsの設定)
  - [Terraform変数の渡し方](#terraform変数の渡し方)
- [実行手順](#実行手順)
  - [自動実行](#自動実行)
  - [手動実行](#手動実行)
- [ローカルでの再現方法](#ローカルでの再現方法)

</details>

## 概要

一般的なプロジェクトでは、GitHub Actionsを使用してTerraformの構成変更を自動的にAWS環境に反映します。

## 前提条件

### 必要なGitHub Secrets
以下のSecretsをGitHubリポジトリに設定する必要があります：

| Secret名 | 説明 |
|---------|------|
| `AWS_ACCESS_KEY_ID` | AWS認証用アクセスキーID |
| `AWS_SECRET_ACCESS_KEY` | AWS認証用シークレットアクセスキー |
| `DB_MASTER_PASSWORD` | RDSマスターパスワード |
| `CERTIFICATE_ARN` | ALB用ACM証明書ARN |
| `CLOUDFRONT_CERTIFICATE_ARN` | CloudFront用ACM証明書ARN（us-east-1） |
| `AES_KEY` | AES暗号化キー（32文字） |
| `BASIC_AUTH` | Basic認証情報（形式: username:password） |
| `EXAMPLE_SERVER_AWS_ACCESS_KEY` | アプリケーション用AWSアクセスキー |
| `EXAMPLE_SERVER_AWS_SECRET_ACCESS_KEY` | アプリケーション用AWSシークレットキー |
| `EXAMPLE_EXTERNAL_SECRET_KEY` | 外部連携用シークレットキー |

### 設定方法
1. GitHubリポジトリの **Settings** → **Secrets and variables** → **Actions**
2. **New repository secret** をクリック
3. 各Secretを追加

## ワークフローの構成

### トリガー設定

```yaml
on:
  push:
    branches:
      - main      # 本番環境へのデプロイ
      - develop   # ステージング環境へのデプロイ
    paths:
      - 'infra/terraform/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # 手動実行
```

### ジョブの流れ

#### 1. **terraform-check** (検証)
- フォーマットチェック
- 構文検証
- すべてのPRとプッシュで実行

#### 2. **terraform-plan** (計画)
- 変更内容の確認
- PR作成時に自動実行
- 手動実行も可能

#### 3. **terraform-apply** (適用)
- 実際のリソース作成・更新
- mainブランチへのマージ時に自動実行
- 手動実行も可能

#### 4. **terraform-destroy** (破棄)
- リソースの削除
- 手動実行のみ

## 環境変数の設定方法

### GitHub Secretsの設定

#### AWS認証情報
```yaml
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: ap-northeast-1
```

### Terraform変数の渡し方

`TF_VAR_`プレフィックスを使用して環境変数として設定：

```yaml
env:
  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
  TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
  # その他の変数...
```

## 実行手順

### 自動実行

#### Pull Request作成時
1. `infra/terraform/`配下のファイルを変更
2. Pull Requestを作成
3. 自動的に`terraform plan`が実行される
4. 結果をPRのコメントで確認

#### mainブランチへのマージ時
1. PRがapproveされる
2. mainブランチにマージ
3. 自動的に`terraform apply`が実行される
4. AWS環境に変更が反映される

### 手動実行

1. **Actions** タブを開く
2. **Terraform CI/CD** ワークフローを選択
3. **Run workflow** をクリック
4. 以下を選択：
   - **workspace**: `stg` または `prod`
   - **action**: `plan`、`apply`、`destroy`
5. **Run workflow** を実行

## ローカルでの再現方法

GitHub Actionsと同じ環境をローカルで再現する方法：

### 1. 環境変数の設定

```bash
# AWS認証情報
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"

# Terraform変数
export TF_VAR_aws_access_key="your-access-key"
export TF_VAR_aws_secret_access_key="your-secret-key"
export TF_VAR_db_master_password="password"
export TF_VAR_certificate_arn="arn:aws:acm:..."
export TF_VAR_cloudfront_certificate_arn="arn:aws:acm:..."
export TF_VAR_aes_key="32-character-key"
export TF_VAR_basic_auth="username:password"
export TF_VAR_example_server_aws_access_key="app-access-key"
export TF_VAR_example_server_aws_secret_access_key="app-secret-key"
export TF_VAR_example_external_secret_key="external-key"
```

### 2. Terraformコマンドの実行

```bash
# ディレクトリ移動
cd infra/terraform

# 初期化
terraform init

# ワークスペース選択
terraform workspace select stg || terraform workspace new stg

# プラン確認
terraform plan

# 適用（注意！）
terraform apply
```

## 注意事項

1. **本番環境への適用**
   - mainブランチへのマージで自動実行される
   - 事前に必ずPRでplanを確認すること

2. **シークレット管理**
   - Secretsは絶対にコードにハードコードしない
   - ローカルの`.env`ファイルは`.gitignore`に追加

3. **ワークスペース**
   - `stg`: ステージング環境
   - `prod`: 本番環境
   - 環境ごとに異なるtfstateファイルが管理される

## 関連
- [Terraform公式ドキュメント](https://www.terraform.io/docs)
- [GitHub Actions公式ドキュメント](https://docs.github.com/ja/actions)
- [AWS Provider for Terraform](https://registry.terraform.io/providers/hashicorp/aws/latest)