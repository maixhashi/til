# なぜTerraformでACM証明書を管理する際にパターンを比較するのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**TerraformでACM証明書を管理する際に複数のパターンを比較して選択する必要があるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**TerraformでACM証明書を管理する際に複数のパターンを比較して選択する必要があるのか
> 
> **Answer** : 新規作成パターンはInfrastructure as Codeの完全性を保つが、DNS検証に時間がかかる。既存参照パターンは高速で安全だが、管理が分散する。プロジェクトの要件に応じた選択が必要。

## 目次
<details>
<summary>目次を開く</summary>

- [パターン1: Terraformで新規証明書を作成・管理](#パターン1-terraformで新規証明書を作成管理)
- [パターン2: 既存の証明書を参照](#パターン2-既存の証明書を参照)
- [使い分けの指針](#使い分けの指針)
- [ハイブリッドアプローチ](#ハイブリッドアプローチ)

</details>

## パターン1: Terraformで新規証明書を作成・管理

### 実装例
```hcl
resource "aws_acm_certificate" "cloudfront" {
  provider = aws.virginia
  count    = var.domain_name != "" ? 1 : 0
  
  domain_name       = var.domain_name
  validation_method = "DNS"
  
  lifecycle {
    create_before_destroy = true
  }
  
  tags = {
    Name        = "${var.project_name}-${var.environment}-cloudfront-cert"
    Environment = var.environment
  }
}
```

### 特徴
- **リソースタイプ**: `resource`を使用
- **証明書のライフサイクル**: Terraformが完全に管理
- **DNS検証**: Terraform実行時に行われる
- **条件付き作成**: `count`パラメータで制御可能

### メリット
1. Infrastructure as Code の原則に完全に準拠
2. 証明書の作成から削除まで一元管理
3. タグやその他の設定を柔軟に管理可能
4. terraform destroyで証明書も削除される

### デメリット
1. DNS検証に時間がかかる（最大30分程度）
2. terraform applyがDNS検証完了まで待機
3. 証明書の更新時にダウンタイムの可能性
4. 手動でのDNSレコード設定が必要な場合がある

## パターン2: 既存の証明書を参照

### 実装例
```hcl
data "aws_acm_certificate" "project_virginia" {
  domain   = terraform.workspace != "prod" ? "project-${terraform.workspace}.jp" : "project.jp"
  provider = aws.virginia
}
```

### 特徴
- **リソースタイプ**: `data`を使用
- **証明書のライフサイクル**: Terraform外で管理
- **DNS検証**: 事前に完了している必要がある
- **条件付き参照**: ワークスペースベースの動的参照

### メリット
1. terraform applyが高速（検証待ちなし）
2. 証明書の管理を分離できる
3. 既存の証明書管理プロセスと統合しやすい
4. 証明書の誤削除リスクが低い

### デメリット
1. 証明書が存在しない場合はエラー
2. 証明書の設定変更はTerraform外で行う必要
3. Infrastructure as Codeの完全性が損なわれる
4. 証明書の管理プロセスが分散する

## 使い分けの指針

### パターン1（新規作成）を選ぶべき場合
- 開発環境や検証環境
- 証明書のライフサイクルをTerraformで完全管理したい
- CI/CDパイプラインで自動化したい
- DNS検証の待機時間が許容できる

### パターン2（既存参照）を選ぶべき場合
- 本番環境
- 証明書の管理を専門チームが行う
- terraform applyの実行時間を短縮したい
- 既に証明書管理の仕組みが確立されている

## ハイブリッドアプローチ

環境によって使い分けることも可能です：

```hcl
# 開発環境では新規作成、本番環境では既存参照
resource "aws_acm_certificate" "cert" {
  count = terraform.workspace != "prod" ? 1 : 0
  # ...
}

data "aws_acm_certificate" "cert" {
  count = terraform.workspace == "prod" ? 1 : 0
  # ...
}

# 使用時は条件分岐
locals {
  certificate_arn = terraform.workspace != "prod" ? 
    aws_acm_certificate.cert[0].arn : 
    data.aws_acm_certificate.cert[0].arn
}
```

## 関連
- [AWS ACM証明書のTerraform設定ガイド](./2025.08.01.14.31_how_aws_acm_certificate_terraform_configuration_guide.md)
- [AWS ACM証明書のProvider設定詳解](./2025.08.01.14.38_how_aws_acm_certificate_provider_configuration_details.md)
- [AWS ACM証明書のcount設定詳解](./2025.08.01.14.43_how_aws_acm_certificate_count_configuration_details.md)
- [AWS Certificate Managerベストプラクティス](https://docs.aws.amazon.com/acm/latest/userguide/acm-best-practices.html)