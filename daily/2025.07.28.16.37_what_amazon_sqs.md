# Amazon SQS (Simple Queue Service)

## What's this file?
> [!NOTE]
> **What**
> 
> Amazon SQSとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : Amazon SQSとは何か
> 
> **Answer** : AWSが提供するフルマネージド型のメッセージキューイングサービス。分散システムやマイクロサービス間でメッセージを確実に送受信し、非同期処理や疎結合を実現。標準キューとFIFOキューの2種類がある。

## 目次

<details>
<summary>目次を開く</summary>

- [概要](#概要)
- [主な特徴](#主な特徴)
- [主要な機能](#主要な機能)
- [使用例とベストプラクティス](#使用例とベストプラクティス)
- [料金体系](#料金体系)
- [他のAWSサービスとの連携](#他のawsサービスとの連携)
- [制限事項](#制限事項)
- [セキュリティ](#セキュリティ)
- [関連](#関連)

</details>

## 概要

Amazon SQSは、AWSが提供するフルマネージド型のメッセージキューイングサービスです。分散システムやマイクロサービス間でメッセージを確実に送受信するための、スケーラブルで信頼性の高いインフラストラクチャを提供します。

## 主な特徴

### 1. フルマネージドサービス
- インフラストラクチャの管理不要
- 自動的なスケーリング
- 高可用性とデータ冗長性

### 2. キューの種類

#### 標準キュー（Standard Queue）
- **高スループット**: 無制限のトランザクション/秒
- **ベストエフォート順序**: メッセージの順序は保証されない
- **少なくとも1回配信**: メッセージが複数回配信される可能性あり
- **使用例**: 順序が重要でない大量のメッセージ処理

#### FIFOキュー（First-In-First-Out）
- **順序保証**: 送信順序通りにメッセージを配信
- **正確に1回配信**: 重複配信なし
- **スループット**: 最大3,000メッセージ/秒（バッチで30,000）
- **使用例**: 順序が重要な金融取引、在庫管理

### 3. メッセージ属性
- **メッセージサイズ**: 最大256KB
- **保持期間**: 1分〜14日（デフォルト4日）
- **可視性タイムアウト**: 0秒〜12時間
- **遅延配信**: 0秒〜15分

## 主要な機能

### 1. ポーリング方式
- **ショートポーリング**: 即座にレスポンスを返す（デフォルト）
- **ロングポーリング**: メッセージが利用可能になるまで最大20秒待機

### 2. デッドレターキュー（DLQ）
- 処理に失敗したメッセージを隔離
- 最大受信回数を設定可能
- エラー分析とデバッグに有用

### 3. メッセージ属性とメタデータ
- カスタム属性の追加（最大10個）
- システムメタデータ（送信時刻、受信回数など）

### 4. 暗号化
- **保管時の暗号化**: AWS KMSによる暗号化
- **転送時の暗号化**: HTTPS経由での通信

## 使用例とベストプラクティス

### 典型的な使用パターン

#### 1. 非同期処理
```
ウェブアプリ → SQS → ワーカー（バッチ処理）
```
- 画像処理、動画エンコーディング
- レポート生成
- メール送信

#### 2. アプリケーション間の疎結合
```
サービスA → SQS → サービスB
```
- マイクロサービス間の通信
- イベント駆動アーキテクチャ

#### 3. 負荷分散
```
プロデューサー → SQS → 複数のコンシューマー
```
- ワークロードの分散
- スケーラブルな処理

### ベストプラクティス

1. **冪等性の実装**
   - 同じメッセージが複数回処理されても問題ないように設計

2. **適切な可視性タイムアウト**
   - 処理時間より長く設定
   - 処理中に延長可能

3. **バッチ処理の活用**
   - 最大10メッセージの一括送受信
   - コストとパフォーマンスの最適化

4. **エラーハンドリング**
   - DLQの設定
   - リトライロジックの実装

## 料金体系

### 料金の要素
- **リクエスト数**: 100万リクエストあたりの料金
- **データ転送**: 送受信データ量
- **追加機能**: FIFO、暗号化など

### コスト最適化
- バッチ操作の使用
- ロングポーリングの活用
- 不要なメッセージ属性の削除

## 他のAWSサービスとの連携

### 1. Lambda
- SQSメッセージをトリガーとした関数実行
- サーバーレスメッセージ処理

### 2. SNS（Simple Notification Service）
- ファンアウトパターンの実装
- SNS → 複数のSQSキュー

### 3. EventBridge
- イベント駆動アーキテクチャの構築
- ルールベースのメッセージルーティング

### 4. Step Functions
- 複雑なワークフローの管理
- SQSを含む処理フローの可視化

## 制限事項

- メッセージサイズ: 256KB
- メッセージ保持期間: 最大14日
- インフライトメッセージ数: 標準キュー120,000、FIFOキュー20,000
- キュー名: 最大80文字

## セキュリティ

### アクセス制御
- IAMポリシー
- SQSアクセスポリシー
- VPCエンドポイント

### 監査とモニタリング
- CloudWatchメトリクス
- CloudTrailログ
- X-Rayトレーシング

## 関連
- [Amazon SWFとは](/Users/shota-hashimoto/til/daily/2025.07.28.16.38_what_amazon_swf.md)
- [AWS Lambdaのイベントソースの区別](/Users/shota-hashimoto/til/daily/2025.07.28.16.47_what_aws_lambda_eventsource_distinction.md)
- [Amazon SQS公式ドキュメント](https://docs.aws.amazon.com/sqs/latest/dg/welcome.html)
- [SQSベストプラクティス](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-best-practices.html)