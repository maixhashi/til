# AWS CloudFront パスベースルーティング説明書

## 概要

AWS CloudFrontは、パスベースルーティング機能を提供し、単一のディストリビューションから複数のオリジン（バックエンドサーバー）へリクエストを振り分けることができます。これにより、1つのドメインで静的コンテンツと動的コンテンツを効率的に配信できます。

## 基本概念

### パスベースルーティングとは
- URLのパス部分（例：`/api/users`、`/images/logo.png`）に基づいてリクエストを異なるオリジンに振り分ける機能
- CloudFrontがリバースプロキシとして機能し、パスパターンマッチングによってオリジンサーバーを選択

### 主要コンポーネント

#### 1. オリジン（Origins）
バックエンドサーバーの定義：
- S3バケット（静的コンテンツ用）
- Application Load Balancer（動的コンテンツ用）
- API Gateway（API用）
- EC2インスタンス
- カスタムオリジン

#### 2. キャッシュビヘイビア（Cache Behaviors）
リクエスト処理ルールの定義：
- パスパターンの設定
- オリジンの指定（Origin ID）
- キャッシュポリシー
- リクエスト/レスポンスの変換設定

#### 3. パスパターン（Path Patterns）
URLパスのマッチング条件：
- ワイルドカード対応（`*`：0文字以上、`?`：1文字）
- 例：`/api/*`、`/images/*.jpg`、`/blog/?/posts`

## ルーティングの仕組み

### 処理フロー
1. リクエストがCloudFrontディストリビューションに到達
2. 上から順にキャッシュビヘイビアのパスパターンをチェック
3. 最初にマッチしたビヘイビアが適用される
4. 該当ビヘイビアで指定されたオリジンにリクエストを転送

### 重要な特性
- **順序が重要**: デフォルトビヘイビア（`*`）は最後に配置
- **最初のマッチが優先**: 複数のパターンにマッチする場合、最初のものが使用される
- **パス転送**: CloudFrontはパスをオリジンURLに追加して転送

## 実装例

### 典型的な構成

```
CloudFront Distribution
├── Origin 1: S3バケット（静的コンテンツ）
├── Origin 2: ALB（動的コンテンツ）
└── Origin 3: API Gateway（API）

Cache Behaviors:
1. /api/* → Origin 3 (API Gateway)
2. /images/* → Origin 1 (S3)
3. /static/* → Origin 1 (S3)
4. * (default) → Origin 2 (ALB)
```

### 設定手順

#### 1. オリジンの追加
```
- S3オリジン:
  - ドメイン名: bucket-name.s3.amazonaws.com
  - S3バケットアクセス: Origin Access Identity (OAI)
  
- ALBオリジン:
  - ドメイン名: alb-name.region.elb.amazonaws.com
  - プロトコル: HTTPS only
  
- API Gatewayオリジン:
  - ドメイン名: api-id.execute-api.region.amazonaws.com
  - オリジンパス: /stage-name
```

#### 2. キャッシュビヘイビアの作成
```
ビヘイビア1:
- パスパターン: /api/*
- オリジン: API Gateway
- Viewer Protocol Policy: HTTPS Only
- Allowed HTTP Methods: GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE

ビヘイビア2:
- パスパターン: /images/*
- オリジン: S3バケット
- Viewer Protocol Policy: Redirect HTTP to HTTPS
- Cache Policy: Managed-CachingOptimized
```

#### 3. 順序の調整
- 特定のパスパターンを上位に配置
- デフォルトビヘイビア（`*`）は最下位

## ユースケース

### 1. マイクロサービスアーキテクチャ
```
/auth/* → 認証サービス
/users/* → ユーザーサービス
/products/* → 商品サービス
/orders/* → 注文サービス
```

### 2. 静的・動的コンテンツの分離
```
/static/* → S3（CSS、JS、画像）
/api/* → API Gateway
/* → アプリケーションサーバー
```

### 3. マルチアプリケーション配信
```
/blog/* → Amplifyアプリ1
/shop/* → Amplifyアプリ2
/admin/* → 管理画面アプリ
```

## 注意事項

### パス転送の挙動
- CloudFrontはパスをオリジンURLに追加
- 例：`/blog/posts` → `amplify-url.com/blog/posts`
- オリジン側でパスの調整が必要な場合がある

### 制限事項
- ホスト名やクエリパラメータによるルーティングは不可
- パスパターンのみでの振り分け
- 正規表現は使用不可（ワイルドカードのみ）

### パフォーマンス考慮事項
- キャッシュビヘイビアが多いと評価時間が増加
- 頻繁にアクセスされるパスを上位に配置
- 適切なキャッシュポリシーの設定が重要

## ベストプラクティス

### 1. パスパターンの設計
- 明確で一貫性のあるパス構造
- オーバーラップを避ける
- 将来の拡張を考慮

### 2. セキュリティ
- HTTPSの強制
- オリジンアクセスアイデンティティ（OAI）の使用
- 適切なCORSポリシーの設定

### 3. モニタリング
- CloudWatchメトリクスの活用
- アクセスログの分析
- エラー率の監視

### 4. コスト最適化
- 静的コンテンツの積極的なキャッシュ
- 圧縮の有効化
- 不要なオリジンリクエストの削減

## トラブルシューティング

### よくある問題

1. **404エラー**
   - パスパターンの設定ミス
   - オリジンでのパス不一致
   - 解決：CloudFrontとオリジンのパス設定を確認

2. **キャッシュの問題**
   - 古いコンテンツが表示される
   - 解決：キャッシュ無効化（Invalidation）の実行

3. **CORS エラー**
   - クロスオリジンリクエストの失敗
   - 解決：適切なCORSヘッダーの設定

## まとめ

AWS CloudFrontのパスベースルーティングは、複雑なWebアプリケーションアーキテクチャを単一のドメインで効率的に配信するための強力な機能です。適切に設計・実装することで、パフォーマンス、スケーラビリティ、メンテナンス性の向上を実現できます。オリジンの特性を理解し、キャッシュビヘイビアを最適化することが、成功の鍵となります。