# なぜblock_public_aclsで新規ACL設定を防ぐ必要があるのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**block_public_aclsで新規パブリックACL設定を防ぐ必要があるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**block_public_aclsで新規パブリックACL設定を防ぐ必要があるのか
> 
> **Answer** : ACLはオブジェクトレベルで個別に設定でき、管理が複雑で見落としやすいため、意図しないデータ漏洩を防ぐには根本的にパブリックACLの設定自体をブロックすることが最も確実だから

## 目次
<details>
<summary>目次を開く</summary>

- [S3 ACLの危険性](#s3-aclの危険性)
- [ACLとバケットポリシーの違い](#aclとバケットポリシーの違い)
- [なぜACLは管理が難しいのか](#なぜaclは管理が難しいのか)
- [実際のインシデント事例](#実際のインシデント事例)
- [block_public_aclsの効果](#block_public_aclsの効果)
- [代替手段との比較](#代替手段との比較)

</details>

## S3 ACLの危険性

### ACL（Access Control List）とは

S3 ACLは、バケットおよびオブジェクトレベルでアクセス権限を設定する古いメカニズムです。

```xml
<!-- パブリック読み取りACLの例 -->
<AccessControlPolicy>
  <Grant>
    <Grantee xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xsi:type="Group">
      <URI>http://acs.amazonaws.com/groups/global/AllUsers</URI>
    </Grantee>
    <Permission>READ</Permission>
  </Grant>
</AccessControlPolicy>
```

### パブリックACLの種類

| ACL設定 | 権限 | リスクレベル |
|---------|------|-------------|
| public-read | 誰でも読み取り可能 | 高 |
| public-read-write | 誰でも読み書き可能 | 極高 |
| authenticated-read | AWSアカウント保有者なら読み取り可能 | 中 |

## ACLとバケットポリシーの違い

### 管理方法の違い

```hcl
# バケットポリシー：JSON形式で一元管理
resource "aws_s3_bucket_policy" "example" {
  bucket = aws_s3_bucket.example.id
  policy = jsonencode({
    # 明確で監査しやすい
  })
}

# ACL：個別のオブジェクトごとに設定可能
# コンソールやAPIで簡単に変更できてしまう
```

### 可視性の違い

1. **バケットポリシー**
   - バケットレベルで一覧表示
   - Terraformで管理しやすい
   - 変更履歴が追跡しやすい

2. **ACL**
   - オブジェクトレベルで散在
   - 数百万のオブジェクトに個別設定可能
   - 見落としが発生しやすい

## なぜACLは管理が難しいのか

### 1. 粒度の細かさ

```bash
# 1つのバケットに100万個のオブジェクトがある場合
# それぞれに異なるACLを設定可能
aws s3api put-object-acl \
  --bucket my-bucket \
  --key sensitive-data.pdf \
  --acl public-read  # 危険！
```

### 2. デフォルト設定の罠

```python
# SDKでの一般的なアップロード
s3_client.put_object(
    Bucket='my-bucket',
    Key='file.txt',
    Body=data,
    ACL='public-read'  # 開発時のテストコードが本番に混入
)
```

### 3. 継承と上書きの複雑性

- バケットACLとオブジェクトACLが異なる場合
- 後から追加されたオブジェクトの扱い
- 一括変更の困難さ

## 実際のインシデント事例

### 有名な事例

1. **Capital One (2019年)**
   - S3の設定ミスで1億人以上の個人情報流出
   - 推定被害額：1億5000万ドル

2. **Verizon (2017年)**
   - 600万人の顧客データが公開状態
   - ACL設定ミスが原因

3. **Dow Jones (2017年)**
   - 220万人の顧客情報が露出
   - 開発環境の設定が本番に混入

### 共通する原因

- ACLの設定ミス
- 開発環境と本番環境の混同
- 定期的な監査の不足

## block_public_aclsの効果

### 設定前後の比較

```hcl
# block_public_acls = false の場合
# 以下のコマンドが成功してしまう
aws s3api put-bucket-acl --bucket my-bucket --acl public-read
aws s3api put-object-acl --bucket my-bucket --key file.txt --acl public-read

# block_public_acls = true の場合
# 上記コマンドはすべてエラーになる
# Error: Access Denied
```

### 4つの設定の連携効果

```hcl
resource "aws_s3_bucket_public_access_block" "example" {
  bucket = aws_s3_bucket.example.id

  # 新規パブリックACLをブロック（予防）
  block_public_acls = true
  
  # 既存パブリックACLを無視（治療）
  ignore_public_acls = true
  
  # パブリックポリシーもブロック（完全防御）
  block_public_policy = true
  restrict_public_buckets = true
}
```

## 代替手段との比較

### 1. バケットポリシーのみで制御

```json
{
  "Statement": [{
    "Effect": "Deny",
    "Principal": "*",
    "Action": "s3:PutObjectAcl",
    "Resource": "arn:aws:s3:::bucket/*",
    "Condition": {
      "StringEquals": {
        "s3:x-amz-acl": ["public-read", "public-read-write"]
      }
    }
  }]
}
```

**問題点**：
- 複雑な条件設定が必要
- 抜け穴が生じやすい
- メンテナンスが困難

### 2. IAMポリシーで制限

```json
{
  "Effect": "Deny",
  "Action": [
    "s3:PutBucketAcl",
    "s3:PutObjectAcl"
  ],
  "Resource": "*"
}
```

**問題点**：
- ユーザー/ロールごとの設定が必要
- 管理者権限では回避可能
- 外部からのアクセスは防げない

### 3. block_public_aclsの優位性

- **包括的**：すべてのアクセスパスをブロック
- **シンプル**：true/falseの設定のみ
- **確実**：AWSサービスレベルで動作
- **監査容易**：設定状態が明確

## ベストプラクティス

### 1. デフォルトで有効化

```hcl
# すべてのS3バケットに適用するモジュール
module "secure_s3_bucket" {
  source = "./modules/s3"
  
  # 必須設定
  enable_public_access_block = true
  block_public_acls = true
}
```

### 2. 例外は最小限に

```hcl
# どうしても必要な場合は理由を明記
resource "aws_s3_bucket_public_access_block" "static_website" {
  bucket = aws_s3_bucket.static_website.id
  
  # 静的ウェブサイトホスティングのため例外的に許可
  # CloudFront経由でのアクセスを推奨
  block_public_acls = false  # リスクを理解した上で設定
}
```

### 3. 定期的な監査

```bash
# AWS Configルールで監視
aws configservice put-config-rule --config-rule '{
  "ConfigRuleName": "s3-bucket-public-read-prohibited",
  "Source": {
    "Owner": "AWS",
    "SourceIdentifier": "S3_BUCKET_PUBLIC_READ_PROHIBITED"
  }
}'
```

## まとめ

`block_public_acls = true`が必要な理由：

1. **人的ミスの防止**：設定ミスを根本的に防ぐ
2. **セキュリティの簡素化**：複雑なACL管理が不要
3. **コンプライアンス対応**：規制要件を満たす
4. **インシデント予防**：データ漏洩リスクを最小化

現代のS3セキュリティにおいて、ACLは使用せず、バケットポリシーとIAMポリシーで制御することが推奨されています。`block_public_acls`は、その移行を確実にする重要な設定です。

## 関連

- [AWS S3 Block Public Access](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html)
- [S3 Security Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)
- S3データ漏洩インシデント事例集
- ACLからバケットポリシーへの移行ガイド