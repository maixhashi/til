# Terraform AWS RDS Clusterリソースとは

## What's this file?
> [!NOTE]
> **What**
> 
> Terraformにおけるaws_rds_clusterリソースとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : Terraformのaws_rds_clusterリソースとは何か
> 
> **Answer** : Amazon Aurora DBクラスターを定義・管理するためのTerraformリソース。高可用性と自動スケーリングを備えたマネージドデータベースクラスターを構築する。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. Amazon Auroraとは](#2-amazon-auroraとは)
- [3. 主要な設定項目](#3-主要な設定項目)
  - [3.1 基本設定](#31-基本設定)
  - [3.2 エンジン設定](#32-エンジン設定)
  - [3.3 セキュリティ設定](#33-セキュリティ設定)
  - [3.4 バックアップ設定](#34-バックアップ設定)
  - [3.5 可用性設定](#35-可用性設定)
- [4. プロジェクトでの設定](#4-プロジェクトでの設定)
- [5. RDS ClusterとRDS Instanceの関係](#5-rds-clusterとrds-instanceの関係)
- [6. Aurora特有の機能](#6-aurora特有の機能)
- [7. 重要なポイント](#7-重要なポイント)

</details>

## 1. 概要

`aws_rds_cluster`リソースは、Amazon Aurora DBクラスターを作成・管理するためのTerraformリソースです。これは複数のDBインスタンスを管理するクラスターレベルのリソースで、以下を定義します：

- データベースエンジンとバージョン
- マスターユーザー認証情報
- バックアップ設定
- 暗号化設定
- ネットワーク設定

## 2. Amazon Auroraとは

Amazon Auroraは、MySQLおよびPostgreSQLと互換性のあるフルマネージド型リレーショナルデータベースです：

- **高性能**: 標準的なMySQLの最大5倍、PostgreSQLの最大3倍のスループット
- **高可用性**: 3つのアベイラビリティーゾーンに6つのデータコピーを自動複製
- **自動スケーリング**: ストレージが10GBから128TBまで自動拡張
- **自動フェイルオーバー**: 30秒以内にフェイルオーバーを完了

## 3. 主要な設定項目

### 3.1 基本設定

**cluster_identifier**
- クラスターの一意の識別子
- 小文字、数字、ハイフンのみ使用可能
- 例：`example-project-production`

**database_name**
- 初期データベース名
- 作成時のみ指定可能

### 3.2 エンジン設定

**engine**
- データベースエンジンの種類
- 値：`aurora-mysql`、`aurora-postgresql`

**engine_mode**
- エンジンモード
- 値：`provisioned`（通常）、`serverless`（サーバーレス）

**engine_version**
- エンジンバージョン
- 例：PostgreSQL用 `15.4`、MySQL用 `8.0.mysql_aurora.3.04.0`

### 3.3 セキュリティ設定

**master_username / master_password**
- マスターユーザーの認証情報
- パスワードは後でSecrets Managerに移行推奨

**vpc_security_group_ids**
- 適用するセキュリティグループのリスト
- データベースへのアクセス制御

**db_subnet_group_name**
- DBサブネットグループ名
- クラスターを配置するサブネットを指定

**storage_encrypted**
- ストレージ暗号化の有効化
- 本番環境では`true`推奨

### 3.4 バックアップ設定

**backup_retention_period**
- 自動バックアップの保持期間（日数）
- 1〜35日、0で無効化

**preferred_backup_window**
- 優先バックアップウィンドウ
- UTC時刻で指定（例：`17:00-18:00`）

### 3.5 可用性設定

**availability_zones**
- クラスターを配置するAZのリスト
- 複数指定でMulti-AZ構成

## 4. プロジェクトでの設定

```hcl
resource "aws_rds_cluster" "example" {
  cluster_identifier     = "${var.project_name}-${var.environment}"
  engine                 = "aurora-postgresql"
  engine_mode            = "provisioned"
  engine_version         = "15.4"
  database_name          = "example_project"
  master_username        = "postgres"
  master_password        = "ExamplePassword2024!"  # 要Secrets Manager移行
  port                   = 5432
  vpc_security_group_ids = [aws_security_group.example_rds.id]
  db_subnet_group_name   = aws_db_subnet_group.example_project_server_private.name

  backup_retention_period = 7
  preferred_backup_window = "17:00-18:00" # 02:00-03:00 JST

  # Multi-AZ deployment
  availability_zones = ["ap-northeast-1a", "ap-northeast-1c"]

  # Storage encryption
  storage_encrypted = true

  # Performance Insights
  enabled_cloudwatch_logs_exports = ["postgresql"]

  tags = {
    Name = "${var.project_name}-postgresql-${var.environment}"
  }
}
```

## 5. RDS ClusterとRDS Instanceの関係

Aurora DBクラスターは以下の構成要素から成ります：

1. **クラスター（aws_rds_cluster）**
   - クラスター全体の設定を管理
   - データベース名、エンジン、バックアップ設定など

2. **インスタンス（aws_rds_cluster_instance）**
   - 実際のコンピューティングリソース
   - 読み書き可能なプライマリインスタンス
   - 読み取り専用のレプリカインスタンス

```hcl
# クラスターインスタンスの例
resource "aws_rds_cluster_instance" "primary" {
  identifier         = "${var.project_name}-primary"
  cluster_identifier = aws_rds_cluster.example.id
  instance_class     = "db.r6g.large"
  engine             = aws_rds_cluster.example.engine
  engine_version     = aws_rds_cluster.example.engine_version
}
```

## 6. Aurora特有の機能

1. **自動ストレージスケーリング**
   - 10GBから最大128TBまで自動拡張
   - 手動でのストレージ管理不要

2. **高速フェイルオーバー**
   - 通常30秒以内でフェイルオーバー完了
   - アプリケーション側の変更不要

3. **バックトラック（MySQL版のみ）**
   - データベースを過去の任意の時点に巻き戻し可能
   - 最大72時間前まで

4. **グローバルデータベース**
   - 複数リージョンへのレプリケーション
   - 災害復旧とグローバル読み取り

## 7. 重要なポイント

1. **セキュリティ**
   - マスターパスワードはSecrets Managerで管理
   - ストレージ暗号化は必須
   - 適切なセキュリティグループ設定

2. **パフォーマンス**
   - Performance Insightsの有効化
   - CloudWatchログエクスポート設定
   - 適切なインスタンスクラスの選択

3. **可用性**
   - Multi-AZ構成の使用
   - 適切なバックアップ保持期間
   - メンテナンスウィンドウの設定

4. **コスト最適化**
   - 不要なリードレプリカの削除
   - Aurora Serverlessの検討（変動負荷時）
   - Reserved Instancesの活用

5. **注意事項**
   - ストレージ暗号化は作成時のみ設定可能
   - エンジンバージョンアップグレードは計画的に
   - クラスター削除時は最終スナップショット取得

## 関連
- [AWS RDS Cluster Instance](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_rds_cluster_instance.tf)
- [AWS DB Subnet Group](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_db_subnet_group.tf)
- [AWS Security Group for RDS](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_security_group.tf)