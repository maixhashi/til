# Terraform AWS VPCリソース公式完全リファレンス

## What's this file?
> [!NOTE]
> **What**
> 
> Terraform Registry公式ドキュメント（hashicorp/aws provider）のaws_vpcリソースの完全な日本語リファレンスです。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : Terraform aws_vpcリソースとは何か
> 
> **Answer** : aws_vpcリソースは、AWS Virtual Private Cloud (VPC)を作成・管理するためのTerraformリソースです。VPCの作成から、IPv4/IPv6 CIDR割り当て、DNS設定、テナンシー、IPAM統合まで、VPCのライフサイクル全体を管理します。AWS Provider v5.0以降では、より柔軟なIPv6設定とIPAM統合が強化されています。

## 目次

<details>
<summary>目次を開く</summary>

- [リソース: aws_vpc](#リソース-aws_vpc)
- [使用例（Example Usage）](#使用例example-usage)
- [引数リファレンス（Argument Reference）](#引数リファレンスargument-reference)
- [属性リファレンス（Attribute Reference）](#属性リファレンスattribute-reference)
- [タイムアウト（Timeouts）](#タイムアウトtimeouts)
- [インポート（Import）](#インポートimport)
- [関連リソース](#関連リソース)
- [追加の技術詳細](#追加の技術詳細)

</details>

## リソース: aws_vpc

VPCを提供および管理します。

> **NOTE:** Terraform AWS Provider v5.0より前のバージョンでは、`enable_classiclink`、`enable_classiclink_dns_support`、および`enable_dns_support`引数がデフォルトで`true`に設定されていました。しかし、AWS EC2-Classicは2022年8月15日に廃止され、これらの引数は削除されました。詳細は[AWS News Blog](https://aws.amazon.com/blogs/aws/ec2-classic-is-retiring-heres-how-to-prepare/)を参照してください。

## 使用例（Example Usage）

### 基本的な使用例

```hcl
resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"
}
```

### 専用テナンシーVPCの基本的な使用例

```hcl
resource "aws_vpc" "main" {
  cidr_block       = "10.0.0.0/16"
  instance_tenancy = "dedicated"

  tags = {
    Name = "main"
  }
}
```

### セカンダリCIDRブロックの割り当て

```hcl
resource "aws_vpc_ipv4_cidr_block_association" "secondary_cidr" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "172.16.0.0/16"
}
```

### IPAM管理CIDR使用例

```hcl
data "aws_region" "current" {}

resource "aws_vpc_ipam" "test" {
  operating_regions {
    region_name = data.aws_region.current.name
  }
}

resource "aws_vpc_ipam_pool" "test" {
  address_family = "ipv4"
  ipam_scope_id  = aws_vpc_ipam.test.private_default_scope_id
  locale         = data.aws_region.current.name
}

resource "aws_vpc_ipam_pool_cidr" "test" {
  ipam_pool_id = aws_vpc_ipam_pool.test.id
  cidr         = "172.16.0.0/16"
}

resource "aws_vpc" "test" {
  ipv4_ipam_pool_id   = aws_vpc_ipam_pool.test.id
  ipv4_netmask_length = 28
  depends_on = [
    aws_vpc_ipam_pool_cidr.test
  ]
}
```

## 引数リファレンス（Argument Reference）

このリソースは以下の引数をサポートします：

### IPv4関連引数

#### cidr_block
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: VPCのIPv4 CIDRブロック。IPAMを使用しない場合はCIDRブロックが必要です。
- **競合**: `ipv4_ipam_pool_id`と競合
- **有効な値**: RFC 1918に準拠したプライベートIPアドレス範囲（例：10.0.0.0/8、172.16.0.0/12、192.168.0.0/16）またはパブリックIPアドレス範囲
- **サイズ制限**: /16（65,536 IPアドレス）から/28（16 IPアドレス）まで

#### ipv4_ipam_pool_id
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: VPCのCIDRを取得するIPAMプールのID
- **競合**: `cidr_block`と競合
- **使用条件**: AWS IPAMサービスが有効で、適切な権限が必要

#### ipv4_netmask_length
- **型**: `number`
- **必須/オプション**: オプション
- **説明**: IPAMプールから割り当てるIPv4アドレスのネットマスク長。`ipv4_ipam_pool_id`を指定する場合に使用
- **有効な値**: 16から28の整数

### IPv6関連引数

#### ipv6_cidr_block
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: VPCに割り当てるIPv6 CIDRブロック。Amazonが割り当てた`/56`プレフィックス長のGUA（Global Unicast Address）またはBYOIP（Bring Your Own IP）CIDRブロック
- **競合**: `ipv6_ipam_pool_id`、`assign_generated_ipv6_cidr_block`と競合
- **形式**: `2001:db8::/56`のような形式

#### ipv6_ipam_pool_id
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: VPCに割り当てるIPv6アドレスのIPAMプールID
- **競合**: `ipv6_cidr_block`と競合

#### ipv6_netmask_length
- **型**: `number`
- **必須/オプション**: オプション
- **説明**: IPAMプールから割り当てるIPv6アドレスのネットマスク長。`ipv6_ipam_pool_id`を指定する場合に使用
- **デフォルト**: 56（AWSの標準）

#### ipv6_cidr_block_network_border_group
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: BYOIP IPv6プールをアドバタイズするネットワーク境界グループの名前
- **使用場面**: Local ZonesやWavelength Zonesでの使用時
- **例**: `us-east-1-lax-1`（Los Angeles Local Zone）

#### assign_generated_ipv6_cidr_block
- **型**: `bool`
- **必須/オプション**: オプション
- **説明**: Amazon提供の`/56`プレフィックス長のIPv6 CIDRブロックをVPCに割り当てるかどうか
- **デフォルト**: `false`
- **競合**: `ipv6_ipam_pool_id`と競合
- **非推奨**: より柔軟な`ipv6_cidr_block`の使用を推奨

### DNS関連引数

#### enable_dns_support
- **型**: `bool`
- **必須/オプション**: オプション
- **説明**: VPCでDNS解決をサポートするかを示すブール値
- **デフォルト**: `true`
- **影響**: 
  - `true`: Amazon提供のDNSサーバー（169.254.169.253）が利用可能
  - `false`: VPC内でのDNS解決が無効

#### enable_dns_hostnames
- **型**: `bool`
- **必須/オプション**: オプション
- **説明**: VPCでDNSホスト名をサポートするかを示すブール値
- **デフォルト**: `false`
- **前提条件**: `enable_dns_support`が`true`である必要がある
- **影響**: 
  - `true`: VPC内のインスタンスがパブリックDNSホスト名を取得
  - `false`: パブリックDNSホスト名は割り当てられない

### その他の引数

#### instance_tenancy
- **型**: `string`
- **必須/オプション**: オプション
- **説明**: VPCで起動されるインスタンスのテナンシーオプション
- **デフォルト**: `"default"`
- **有効な値**: 
  - `"default"`: インスタンスは共有ハードウェアで実行
  - `"dedicated"`: インスタンスは単一顧客専用のハードウェアで実行
  - `"host"`: インスタンスは専用ホストで実行（ライセンス要件がある場合）
- **コスト影響**: `dedicated`と`host`は追加料金が発生

#### enable_network_address_usage_metrics
- **型**: `bool`
- **必須/オプション**: オプション
- **説明**: ネットワークアドレス使用状況メトリクスがVPCで有効かを示すブール値
- **デフォルト**: `false`
- **影響**: 
  - `true`: CloudWatchでVPCのIPアドレス使用状況メトリクスを表示
  - `false`: メトリクスは収集されない
- **用途**: IPアドレスの枯渇監視、容量計画

#### tags
- **型**: `map(string)`
- **必須/オプション**: オプション
- **説明**: リソースに割り当てるタグのマップ
- **例**: 
  ```hcl
  tags = {
    Name        = "my-vpc"
    Environment = "production"
    Project     = "web-app"
  }
  ```
- **制限**: 
  - 最大50個のタグ
  - キーの最大長: 128文字
  - 値の最大長: 256文字
  - `aws:`プレフィックスは予約済み

## 属性リファレンス（Attribute Reference）

このリソースは、すべての引数に加えて以下の属性をエクスポートします：

### 識別子

#### arn
- **型**: `string`
- **説明**: VPCのAmazon Resource Name (ARN)
- **形式**: `arn:aws:ec2:region:account-id:vpc/vpc-id`
- **用途**: IAMポリシー、リソース間参照

#### id
- **型**: `string`
- **説明**: VPCのID
- **形式**: `vpc-xxxxxxxxxxxxxxxxx`（17文字の英数字）
- **用途**: 他のリソースでの参照、APIコール

#### owner_id
- **型**: `string`
- **説明**: VPCのAWSアカウントID
- **形式**: 12桁の数字
- **用途**: クロスアカウントアクセスの設定

### デフォルトリソース

#### default_network_acl_id
- **型**: `string`
- **説明**: デフォルトネットワークACLのID
- **形式**: `acl-xxxxxxxxxxxxxxxxx`
- **特徴**: すべてのインバウンド/アウトバウンドトラフィックを許可

#### default_route_table_id
- **型**: `string`
- **説明**: デフォルトルートテーブルのID
- **形式**: `rtb-xxxxxxxxxxxxxxxxx`
- **特徴**: VPC CIDRへのローカルルートのみを含む

#### default_security_group_id
- **型**: `string`
- **説明**: デフォルトセキュリティグループのID
- **形式**: `sg-xxxxxxxxxxxxxxxxx`
- **特徴**: 
  - すべてのアウトバウンドトラフィックを許可
  - 同じセキュリティグループ内からのインバウンドトラフィックを許可

#### main_route_table_id
- **型**: `string`
- **説明**: メインルートテーブルのID
- **形式**: `rtb-xxxxxxxxxxxxxxxxx`
- **注**: 通常`default_route_table_id`と同じ

### DHCP設定

#### dhcp_options_id
- **型**: `string`
- **説明**: VPCに関連付けられたDHCPオプションセットのID
- **形式**: `dopt-xxxxxxxxxxxxxxxxx`
- **デフォルト**: リージョンのデフォルトDHCPオプションセット

### DNS設定（計算値）

#### enable_dns_hostnames
- **型**: `bool`
- **説明**: VPCでDNSホスト名が有効かどうか

#### enable_dns_support
- **型**: `bool`
- **説明**: VPCでDNS解決が有効かどうか

### IPv6設定

#### ipv6_association_id
- **型**: `string`
- **説明**: VPCとIPv6 CIDRブロックの関連付けID
- **形式**: `vpc-cidr-assoc-xxxxxxxxxxxxxxxxx`
- **用途**: IPv6 CIDR関連付けの管理

#### ipv6_cidr_block
- **型**: `string`
- **説明**: VPCのIPv6 CIDRブロック
- **形式**: `xxxx:xxxx:xxxx:xxxx::/56`

#### ipv6_cidr_block_network_border_group
- **型**: `string`
- **説明**: IPv6 CIDRブロックのネットワーク境界グループ
- **例**: `us-east-1`（リージョン）、`us-east-1-lax-1`（Local Zone）

### その他の設定

#### instance_tenancy
- **型**: `string`
- **説明**: VPCのインスタンステナンシー

#### enable_network_address_usage_metrics
- **型**: `bool`
- **説明**: ネットワークアドレス使用状況メトリクスが有効かどうか

### タグ

#### tags_all
- **型**: `map(string)`
- **説明**: VPCに割り当てられたすべてのタグのマップ（プロバイダーのデフォルトタグ設定を含む）
- **用途**: タグベースのアクセス制御、コスト配分

## タイムアウト（Timeouts）

[Configuration options](https://developer.hashicorp.com/terraform/language/resources/syntax#operation-timeouts):

- **create** - (デフォルト `10m`) VPC作成にかかる最大時間
- **update** - (デフォルト `10m`) VPC更新にかかる最大時間  
- **delete** - (デフォルト `10m`) VPC削除にかかる最大時間

カスタムタイムアウトの例：
```hcl
resource "aws_vpc" "example" {
  cidr_block = "10.0.0.0/16"

  timeouts {
    create = "15m"
    update = "20m"
    delete = "30m"
  }
}
```

## インポート（Import）

Terraformでは、`import`コマンドを使用してVPCをインポートできます。VPCは`id`を使用してインポートできます。例：

```console
$ terraform import aws_vpc.test_vpc vpc-a01106c2
```

### インポートの詳細手順

1. **リソース設定の準備**
   ```hcl
   resource "aws_vpc" "imported" {
     # 最小限の設定
   }
   ```

2. **インポートの実行**
   ```bash
   terraform import aws_vpc.imported vpc-xxxxxxxxxxxxxxxxx
   ```

3. **現在の状態の確認**
   ```bash
   terraform state show aws_vpc.imported
   ```

4. **設定の更新**
   インポート後、`terraform plan`を実行して差分を確認し、必要な設定を追加

### インポート時の注意事項

- デフォルトセキュリティグループ、ネットワークACL、ルートテーブルは自動的にインポートされない
- タグは正確にインポートされるが、`tags_all`には注意が必要
- DNS設定（`enable_dns_support`、`enable_dns_hostnames`）は正確にインポートされる

## 関連リソース

### VPC関連リソース
- [`aws_vpc_ipv4_cidr_block_association`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipv4_cidr_block_association) - 追加のIPv4 CIDRブロックをVPCに関連付け
- [`aws_vpc_ipv6_cidr_block_association`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipv6_cidr_block_association) - 追加のIPv6 CIDRブロックをVPCに関連付け
- [`aws_vpc_dhcp_options`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_dhcp_options) - VPC用のDHCPオプションを作成
- [`aws_vpc_dhcp_options_association`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_dhcp_options_association) - DHCPオプションをVPCに関連付け

### サブネット関連
- [`aws_subnet`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/subnet) - VPC内にサブネットを作成
- [`aws_db_subnet_group`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_subnet_group) - RDS用のサブネットグループを作成

### ルーティング関連
- [`aws_route_table`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route_table) - VPC用のルートテーブルを作成
- [`aws_route`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route) - ルートテーブルにルートを追加
- [`aws_route_table_association`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route_table_association) - ルートテーブルをサブネットに関連付け

### ゲートウェイ関連
- [`aws_internet_gateway`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/internet_gateway) - インターネットゲートウェイを作成
- [`aws_nat_gateway`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/nat_gateway) - NATゲートウェイを作成
- [`aws_egress_only_internet_gateway`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/egress_only_internet_gateway) - IPv6専用のアウトバウンドゲートウェイ

### セキュリティ関連
- [`aws_security_group`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) - セキュリティグループを作成
- [`aws_network_acl`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/network_acl) - ネットワークACLを作成
- [`aws_flow_log`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/flow_log) - VPCフローログを設定

### VPCピアリング・接続
- [`aws_vpc_peering_connection`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_peering_connection) - VPCピアリング接続を作成
- [`aws_vpc_endpoint`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_endpoint) - VPCエンドポイントを作成
- [`aws_vpn_gateway`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpn_gateway) - VPNゲートウェイを作成

### IPAM関連
- [`aws_vpc_ipam`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipam) - IPAMを作成
- [`aws_vpc_ipam_pool`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipam_pool) - IPAMプールを作成
- [`aws_vpc_ipam_pool_cidr`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipam_pool_cidr) - IPAMプールにCIDRを追加

### デフォルトリソース管理
- [`aws_default_vpc`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_vpc) - デフォルトVPCを管理
- [`aws_default_security_group`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_security_group) - デフォルトセキュリティグループを管理
- [`aws_default_network_acl`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_network_acl) - デフォルトネットワークACLを管理
- [`aws_default_route_table`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/default_route_table) - デフォルトルートテーブルを管理

## 追加の技術詳細

### VPCサイズの計画

#### CIDR範囲の選択
```
/16 = 65,536 IPアドレス（推奨：大規模環境）
/20 = 4,096 IPアドレス（推奨：中規模環境）
/24 = 256 IPアドレス（推奨：小規模環境）
/28 = 16 IPアドレス（最小サイズ）
```

#### 予約済みIPアドレス
各サブネットで、AWSは以下のIPアドレスを予約：
- ネットワークアドレス（.0）
- VPCルーター（.1）
- DNS（.2）
- 将来の使用（.3）
- ブロードキャストアドレス（最後）

### IPv6の詳細

#### IPv6 CIDRブロックのタイプ
1. **Amazon提供のIPv6 CIDRブロック**
   - 自動的に割り当てられるグローバルユニキャストアドレス
   - `/56`プレフィックス固定
   - インターネットルーティング可能

2. **BYOIP（Bring Your Own IP）**
   - 自社所有のIPv6アドレス範囲を使用
   - 事前にAWSに登録が必要
   - より柔軟な管理が可能

### IPAM統合のベストプラクティス

1. **階層的なプール設計**
   ```hcl
   # ルートプール
   resource "aws_vpc_ipam_pool" "root" {
     address_family = "ipv4"
     ipam_scope_id  = aws_vpc_ipam.main.private_default_scope_id
   }
   
   # リージョンプール
   resource "aws_vpc_ipam_pool" "region" {
     address_family          = "ipv4"
     ipam_scope_id           = aws_vpc_ipam.main.private_default_scope_id
     source_ipam_pool_id     = aws_vpc_ipam_pool.root.id
     locale                  = "us-east-1"
   }
   ```

2. **自動割り当てルール**
   ```hcl
   resource "aws_vpc_ipam_pool" "auto" {
     address_family        = "ipv4"
     ipam_scope_id         = aws_vpc_ipam.main.private_default_scope_id
     auto_import           = true
     allocation_min_netmask_length = 24
     allocation_max_netmask_length = 26
   }
   ```

### パフォーマンスとスケーリング

#### VPC制限
- リージョンあたりのVPC数: 5（デフォルト、増加可能）
- VPCあたりのサブネット数: 200
- VPCあたりのルートテーブル数: 200
- VPCあたりのセキュリティグループ数: 500

#### ネットワークパフォーマンス
- 同一AZ内: 最大25 Gbps
- 異なるAZ間: 最大5 Gbps（拡張ネットワーキング有効時）
- リージョン間: VPCピアリングまたはTransit Gateway経由

### コスト最適化

1. **不要なリソースの削除**
   - 未使用のNATゲートウェイ
   - アイドル状態のVPNコネクション
   - 未使用のElastic IP

2. **メトリクス監視**
   ```hcl
   # コスト監視のためのメトリクス有効化
   enable_network_address_usage_metrics = true
   ```

3. **適切なサイズ設定**
   - 必要以上に大きなCIDR範囲を避ける
   - サブネットサイズを適切に計画

### セキュリティベストプラクティス

1. **最小権限の原則**
   ```hcl
   # プライベートサブネット用のルートテーブル
   resource "aws_route_table" "private" {
     vpc_id = aws_vpc.main.id
     
     # インターネットへの直接ルートなし
     tags = {
       Name = "private-route-table"
     }
   }
   ```

2. **フローログの有効化**
   ```hcl
   resource "aws_flow_log" "main" {
     iam_role_arn    = aws_iam_role.flow_log.arn
     log_destination = aws_cloudwatch_log_group.flow_log.arn
     traffic_type    = "ALL"
     vpc_id          = aws_vpc.main.id
   }
   ```

3. **ネットワークセグメンテーション**
   - パブリック、プライベート、データベースサブネットの分離
   - セキュリティグループとNACLの適切な設定