# なぜAWS WAFは完全なマネージドサービスなのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**AWS WAFは完全なマネージドサービスと言えるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**AWS WAFは完全なマネージドサービスと言えるのか
> 
> **Answer** : WAFのインフラ、スケーリング、可用性はAWSが完全管理し、VPCやサブネットへの配置も不要。顧客はルールの定義と適用対象の選択のみを管理すればよいため、真のマネージドサービスである

## 目次
<details>
<summary>目次を開く</summary>

- [AWS WAFの管理モデル](#aws-wafの管理モデル)
- [完全マネージドサービスとしての特徴](#完全マネージドサービスとしての特徴)
- [顧客責任範囲の限定性](#顧客責任範囲の限定性)
- [他のセキュリティサービスとの比較](#他のセキュリティサービスとの比較)

</details>

## AWS WAFの管理モデル

### WAFのアーキテクチャと配置

```mermaid
graph TB
    subgraph "AWS マネージドインフラ（VPC外）"
        WAF[AWS WAF<br/>ルールエンジン]
        WI[WAF インフラ<br/>自動スケーリング]
        WM[監視・更新<br/>AWS管理]
    end
    
    subgraph "エッジロケーション"
        CF[CloudFront]
        APIGW[API Gateway]
    end
    
    subgraph "リージョナルサービス"
        ALB[ALB]
        APPSYNC[AppSync]
        COGNITO[Cognito]
    end
    
    subgraph "顧客管理"
        RULES[WAFルール定義]
        WEBACL[Web ACL設定]
    end
    
    WAF --> CF
    WAF --> ALB
    RULES --> WAF
    
    style WAF fill:#ff9,stroke:#333,stroke-width:4px
    style RULES fill:#9f9,stroke:#333,stroke-width:2px
```

### 責任分界点

| 管理項目 | AWS責任 | 顧客責任 |
|---------|---------|----------|
| インフラストラクチャ | ✅ 完全管理 | ❌ なし |
| ハードウェア管理 | ✅ 完全管理 | ❌ なし |
| スケーリング | ✅ 自動 | ❌ なし |
| 可用性保証 | ✅ SLA提供 | ❌ なし |
| パッチ適用 | ✅ 自動 | ❌ なし |
| ルール定義 | ❌ なし | ✅ 設定のみ |
| 適用対象選択 | ❌ なし | ✅ 設定のみ |

## 完全マネージドサービスとしての特徴

### VPC配置が不要な理由

```mermaid
graph LR
    subgraph "従来のファイアウォール"
        FW[ファイアウォール<br/>アプライアンス]
        SUBNET[サブネット配置必須]
        SCALING[手動スケーリング]
        HA[HA構成必要]
    end
    
    subgraph "AWS WAF"
        WAFM[WAFサービス<br/>VPC外で動作]
        AUTO[自動スケーリング]
        GLOBAL[グローバル展開]
        NOPLACE[配置不要]
    end
    
    FW --> SUBNET
    SUBNET --> SCALING
    SCALING --> HA
    
    WAFM --> AUTO
    AUTO --> GLOBAL
    GLOBAL --> NOPLACE
    
    style WAFM fill:#9ff,stroke:#333,stroke-width:3px
    style NOPLACE fill:#9f9,stroke:#333,stroke-width:2px
```

### マネージドサービスの証拠

1. **自動スケーリング**
   - リクエスト量に応じて自動調整
   - DDoS攻撃時も自動対応
   - 容量計画不要
   - パフォーマンス劣化なし

2. **高可用性**
   - Multi-AZ自動展開
   - リージョン内冗長性
   - SLA 99.95%保証
   - 自動フェイルオーバー

3. **グローバル展開**
   - CloudFront統合で全エッジロケーション
   - リージョナルサービスとの統合
   - レイテンシー最小化
   - 地理的分散

## 顧客責任範囲の限定性

### 顧客が管理する内容

```mermaid
graph TD
    subgraph "顧客設定（設定のみ）"
        R1[ルール定義<br/>Allow/Block条件]
        R2[レート制限<br/>閾値設定]
        R3[カスタムレスポンス<br/>ブロック時の応答]
        R4[ログ設定<br/>記録内容]
    end
    
    subgraph "AWS管理（すべて自動）"
        A1[ルール処理エンジン]
        A2[トラフィック分析]
        A3[攻撃検知・防御]
        A4[インフラ運用]
    end
    
    R1 -->|設定投入| A1
    A1 -->|自動実行| A2
    A2 --> A3
    A3 --> A4
    
    style R1 fill:#9f9,stroke:#333,stroke-width:2px
    style A1 fill:#ff9,stroke:#333,stroke-width:3px
```

### 設定例（Terraform）

```hcl
# WAF設定例 - 顧客が管理するのは設定のみ

resource "aws_wafv2_web_acl" "main" {
  name  = "main-web-acl"
  scope = "REGIONAL"  # またはCLOUDFRONT
  
  # デフォルトアクション（設定のみ）
  default_action {
    allow {}
  }
  
  # ルール定義（設定のみ）
  rule {
    name     = "RateLimitRule"
    priority = 1
    
    action {
      block {}
    }
    
    statement {
      rate_based_statement {
        limit              = 2000
        aggregate_key_type = "IP"
      }
    }
    
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "RateLimitRule"
      sampled_requests_enabled   = true
    }
  }
}

# ALBへの関連付け（設定のみ）
resource "aws_wafv2_web_acl_association" "alb" {
  resource_arn = aws_lb.main.arn
  web_acl_arn  = aws_wafv2_web_acl.main.arn
}

# インフラ管理、スケーリング、可用性はすべてAWS側で自動管理
```

## 他のセキュリティサービスとの比較

### セキュリティサービスの管理モデル比較

```mermaid
graph LR
    subgraph "完全マネージド"
        WAF[AWS WAF]
        SHIELD[AWS Shield]
        MACIE[Amazon Macie]
    end
    
    subgraph "ハイブリッド管理"
        SG[Security Groups<br/>ルール:顧客<br/>処理:AWS]
        NACL[Network ACLs<br/>ルール:顧客<br/>処理:AWS]
    end
    
    subgraph "顧客管理中心"
        IDS[EC2上のIDS/IPS]
        FW[仮想ファイアウォール]
    end
    
    style WAF fill:#9ff,stroke:#333,stroke-width:3px
    style SG fill:#ff9,stroke:#333,stroke-width:2px
    style IDS fill:#f99,stroke:#333,stroke-width:2px
```

### 詳細比較表

| サービス | インフラ管理 | スケーリング | ルール管理 | 配置場所 | 管理モデル |
|---------|-------------|-------------|-----------|----------|-----------|
| AWS WAF | AWS | 自動 | 顧客 | なし（AWS管理） | 完全マネージド |
| Security Groups | AWS | 自動 | 顧客 | ENIに適用 | ハイブリッド |
| NACLs | AWS | 自動 | 顧客 | サブネットに適用 | ハイブリッド |
| EC2上のIDS | 顧客 | 手動 | 顧客 | EC2インスタンス | 顧客管理 |
| AWS Shield | AWS | 自動 | AWS | なし（AWS管理） | 完全マネージド |

### WAFが完全マネージドである根拠

```mermaid
graph TD
    subgraph "完全マネージドの条件"
        C1[インフラ管理不要 ✅]
        C2[自動スケーリング ✅]
        C3[高可用性保証 ✅]
        C4[パッチ自動適用 ✅]
        C5[VPC配置不要 ✅]
    end
    
    subgraph "AWS WAFの実装"
        W1[AWS管理インフラで動作]
        W2[トラフィック量で自動拡張]
        W3[SLA 99.95%]
        W4[メンテナンス不要]
        W5[エッジ/リージョンで動作]
    end
    
    C1 --> W1
    C2 --> W2
    C3 --> W3
    C4 --> W4
    C5 --> W5
    
    Result[完全マネージドサービス確定]
    
    W1 --> Result
    W2 --> Result
    W3 --> Result
    W4 --> Result
    W5 --> Result
    
    style Result fill:#9f9,stroke:#333,stroke-width:4px
```

### 料金モデルから見る管理形態

#### WAF料金構造

**使用量ベースの課金（マネージドサービスの特徴）**
- Web ACL: $5.00/月
- リクエスト課金: $0.60/100万リクエスト
- ルール追加: $1.00/ルール/月

**インフラコストなし（AWS吸収）**
- サーバー費用: $0（AWS負担）
- ネットワーク費用: $0（AWS負担）
- 運用人件費: $0（AWS負担）

**顧客コスト予測可能**
- 使用量に応じた従量課金
- 隠れたコストなし
- スケーリングコスト込み

### まとめ：完全マネージドサービスとしてのWAF

```mermaid
graph LR
    subgraph "顧客作業"
        U1[ルール定義]
        U2[適用対象選択]
        U3[ログ確認]
    end
    
    subgraph "AWS自動管理"
        A1[インフラ運用]
        A2[容量管理]
        A3[可用性確保]
        A4[セキュリティ更新]
        A5[グローバル展開]
    end
    
    U1 -->|わずかな作業| Result[高度なセキュリティ実現]
    A1 --> Result
    A2 --> Result
    A3 --> Result
    A4 --> Result
    A5 --> Result
    
    style Result fill:#9f9,stroke:#333,stroke-width:4px
```

AWS WAFは：
- **インフラ**: 完全にAWS管理
- **運用**: 完全に自動化
- **顧客作業**: ルール設定のみ
- **結論**: 真の完全マネージドサービス

## 関連
- [AWS WAF 公式ドキュメント](https://docs.aws.amazon.com/waf/)
- [AWS責任共有モデル](https://aws.amazon.com/compliance/shared-responsibility-model/)
- [WAF料金](https://aws.amazon.com/waf/pricing/)
- [マネージドルールグループ](https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups.html)