# EBSとEC2インスタンスストアの違い

## 概要

AWS EC2でストレージを利用する際、主に2つの選択肢があります：EBS（Elastic Block Store）とEC2インスタンスストア。これらは根本的に異なる特性を持つストレージタイプであり、用途に応じて適切に選択する必要があります。本ドキュメントでは、両者の違いを詳細に解説します。

## 基本的な違い

### EBS（Elastic Block Store）

- **ネットワーク接続型ストレージ**
- **永続的**：EC2インスタンスから独立して存在
- **柔軟性が高い**：アタッチ/デタッチが可能
- **別途料金が発生**

### EC2インスタンスストア

- **物理的に接続されたストレージ**
- **一時的（エフェメラル）**：インスタンスと共に消滅
- **高性能**：物理的に接続されているため低レイテンシ
- **追加料金なし**：インスタンス料金に含まれる

## 詳細比較

### 1. データの永続性

#### EBS
```
✅ データは永続的に保存される
✅ インスタンス停止後もデータは保持
✅ インスタンス終了後も保持可能（DeleteOnTermination=false）
✅ 他のインスタンスに再アタッチ可能
```

#### インスタンスストア
```
❌ データは一時的（エフェメラル）
❌ インスタンス停止でデータ消失
❌ インスタンス終了でデータ消失
❌ インスタンスのリブートでは保持される
```

### 2. パフォーマンス特性

#### EBS

| ボリュームタイプ | 最大IOPS | 最大スループット | レイテンシ |
|-----------------|----------|-----------------|------------|
| gp3 | 16,000 | 1,000 MB/秒 | ミリ秒単位 |
| io2 Block Express | 256,000 | 4,000 MB/秒 | サブミリ秒 |
| st1 | 500 | 500 MB/秒 | ミリ秒単位 |

#### インスタンスストア

| インスタンスタイプ | ストレージタイプ | IOPS | スループット |
|-------------------|-----------------|------|--------------|
| i3.large | NVMe SSD | 100,000+ | 最大1.9 GB/秒 |
| d2.xlarge | HDD | 約3,000 | 最大250 MB/秒 |
| m5d.large | NVMe SSD | 30,000+ | 最大250 MB/秒 |

### 3. 可用性と信頼性

#### EBS

- **高可用性**
  - アベイラビリティゾーン内で自動レプリケーション
  - 年間故障率（AFR）: 0.1〜0.2%
  - スナップショットによるバックアップ

- **災害復旧**
  - スナップショットをS3に保存
  - リージョン間でのコピーが可能
  - ポイントインタイムリカバリ

#### インスタンスストア

- **単一障害点**
  - ハードウェア障害でデータ消失
  - バックアップ機能なし
  - レプリケーションなし

### 4. 管理機能

#### EBS

**柔軟な管理**
- 動的なサイズ変更（拡張のみ）
- ボリュームタイプの変更
- 暗号化の設定
- タグ付けによる管理

**スナップショット機能**
```bash
# スナップショット作成
aws ec2 create-snapshot --volume-id vol-xxxx

# スナップショットからボリューム作成
aws ec2 create-volume --snapshot-id snap-xxxx
```

#### インスタンスストア

**限定的な管理**
- サイズ変更不可
- タイプ変更不可
- スナップショット機能なし
- 手動でのバックアップが必要

### 5. コスト構造

#### EBS

**料金体系**
```
月額料金 = (ボリュームサイズ × GB単価) + (IOPS × IOPS単価) + スナップショット料金

例: gp3 100GB（東京リージョン）
- ボリューム: 100GB × $0.096 = $9.60/月
- スナップショット: 50GB × $0.05 = $2.50/月
- 合計: $12.10/月
```

#### インスタンスストア

**料金体系**
```
追加料金なし（インスタンス料金に含まれる）

例: m5d.large（東京リージョン）
- インスタンス料金: $0.134/時間
- 75GB NVMe SSD 込み
- ストレージの追加料金なし
```

## 使用シナリオ別の選択ガイド

### EBSを選ぶべきケース

#### 1. データベースサーバー
```yaml
理由:
  - データの永続性が必須
  - 定期的なバックアップが必要
  - 高い可用性が要求される
  
推奨構成:
  - RDS: io2またはgp3
  - 自己管理DB: io2（高IOPS要求時）
```

#### 2. ファイルサーバー
```yaml
理由:
  - 長期的なデータ保存
  - 複数インスタンス間での共有
  
推奨構成:
  - 一般用途: gp3
  - 大容量: st1またはsc1
```

#### 3. アプリケーションサーバー
```yaml
理由:
  - OSとアプリケーションの永続性
  - 簡単なスケーリング
  
推奨構成:
  - ブートボリューム: gp3
  - データボリューム: 用途に応じて選択
```

### インスタンスストアを選ぶべきケース

#### 1. キャッシュサーバー
```yaml
理由:
  - 高速I/Oが必要
  - データ消失が許容される
  
推奨インスタンス:
  - i3シリーズ（Redis、Memcached）
  - m5d/m5adシリーズ（一般的なキャッシュ）
```

#### 2. 一時的な処理
```yaml
理由:
  - バッチ処理の作業領域
  - ビルドサーバーの一時ファイル
  
推奨インスタンス:
  - c5dシリーズ（CPU集約的処理）
  - r5dシリーズ（メモリ集約的処理）
```

#### 3. 分散ストレージのノード
```yaml
理由:
  - レプリケーションで冗長性確保
  - 高いI/O性能が必要
  
推奨インスタンス:
  - i3enシリーズ（大容量NVMe）
  - d3シリーズ（大容量HDD）
```

## ハイブリッド構成のベストプラクティス

### 1. ブートボリューム + データストレージ

```yaml
構成:
  ブートボリューム: EBS gp3（永続性）
  一時データ: インスタンスストア（高速I/O）
  
利点:
  - OSの永続性を確保
  - 高速な一時ストレージを活用
```

### 2. データベースの最適化

```yaml
構成:
  データファイル: EBS io2（永続性・高IOPS）
  一時テーブル: インスタンスストア（高速）
  ログファイル: EBS gp3（永続性）
  
利点:
  - クリティカルデータの保護
  - パフォーマンスの最適化
```

## 移行シナリオ

### インスタンスストア → EBS

```bash
# 1. インスタンスストアのデータをtarでアーカイブ
sudo tar -czf /tmp/backup.tar.gz /data/

# 2. EBSボリュームを作成してアタッチ
aws ec2 create-volume --size 100 --volume-type gp3
aws ec2 attach-volume --volume-id vol-xxxx --instance-id i-xxxx

# 3. データを復元
sudo tar -xzf /tmp/backup.tar.gz -C /mnt/ebs/
```

### EBS → インスタンスストア

```bash
# 1. インスタンスストア付きインスタンスを起動
aws ec2 run-instances --instance-type m5d.large

# 2. EBSボリュームをアタッチ
aws ec2 attach-volume --volume-id vol-xxxx

# 3. データをコピー
sudo rsync -av /mnt/ebs/ /mnt/instance-store/
```

## トラブルシューティング

### EBSの一般的な問題

1. **アタッチメントエラー**
   - 異なるAZのボリューム
   - すでに他のインスタンスにアタッチ済み
   - デバイス名の競合

2. **パフォーマンス低下**
   - IOPS制限に到達
   - ネットワーク帯域幅の不足
   - EBS最適化の未使用

### インスタンスストアの一般的な問題

1. **データ消失**
   - 予期せぬインスタンス停止
   - ハードウェア障害
   - 誤ったリブート操作

2. **容量不足**
   - 固定サイズで拡張不可
   - 一時ファイルの蓄積
   - ログローテーションの失敗

## まとめ

### 選択の指針

| 要件 | EBS | インスタンスストア |
|------|-----|-------------------|
| データ永続性 | ✅ 最適 | ❌ 不適 |
| 高性能I/O | ⭕ 良好 | ✅ 最適 |
| 柔軟性 | ✅ 最適 | ❌ 不適 |
| コスト効率 | ⭕ 用途次第 | ✅ 最適 |
| バックアップ | ✅ 最適 | ❌ 不適 |

**最終的な選択は、アプリケーションの要件、データの重要性、パフォーマンス要求、予算などを総合的に考慮して決定する必要があります。多くの場合、両者を組み合わせたハイブリッド構成が最適なソリューションとなります。**

## 参考資料

- [Amazon EBS ドキュメント](https://docs.aws.amazon.com/ebs/)
- [EC2 インスタンスストア](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html)
- [EBS 最適化インスタンス](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html)
- [ストレージの最適化](https://aws.amazon.com/jp/ec2/instance-types/#storage-optimized)