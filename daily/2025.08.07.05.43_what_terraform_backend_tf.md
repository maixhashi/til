# Terraform Backend設定ファイル

## What's this file?
> [!NOTE]
> **What**
> 
> Terraform Backend設定ファイル（backend.tf）とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : Terraform Backend設定ファイルとは何か
> 
> **Answer** : Terraformの状態ファイル（tfstate）をS3に保存し、DynamoDBで排他制御を行うための設定ファイル

## 目次

<details>
<summary>目次を開く</summary>

- [Terraform Backendとは](#terraform-backendとは)
- [S3 Backendの構成要素](#s3-backendの構成要素)
- [Workspace対応](#workspace対応)
- [認証方法](#認証方法)
- [セキュリティ考慮事項](#セキュリティ考慮事項)

</details>

## Terraform Backendとは

### 基本概念
Terraform Backendは、Terraformの状態ファイル（terraform.tfstate）を保存・管理する仕組みです。デフォルトではローカルに保存されますが、チーム開発では共有ストレージが必要です。

### なぜRemote Backendが必要か
- **チーム共有**: 複数人が同じインフラを管理
- **状態の一元管理**: 最新の状態を常に参照
- **排他制御**: 同時実行による競合を防止
- **履歴管理**: 状態ファイルのバージョン管理

## S3 Backendの構成要素

### 設定内容の詳細
```hcl
terraform {
  backend "s3" {
    bucket         = "example-project-terraform-state"  # 状態ファイル保存用S3バケット
    key            = "terraform.tfstate"                 # 状態ファイルのキー名
    region         = "ap-northeast-1"                    # S3バケットのリージョン
    encrypt        = true                                # 保存時の暗号化
    dynamodb_table = "terraform-state-lock"              # ロック管理用DynamoDBテーブル
    workspace_key_prefix = "env:"                        # Workspace用のプレフィックス
  }
}
```

### 各設定項目の役割

| 項目 | 説明 | 例 |
|------|------|-----|
| bucket | 状態ファイルを保存するS3バケット名 | example-project-terraform-state |
| key | 状態ファイルのオブジェクトキー | terraform.tfstate |
| region | S3バケットが存在するリージョン | ap-northeast-1 |
| encrypt | S3での暗号化有効化 | true |
| dynamodb_table | ロック管理用のDynamoDBテーブル名 | terraform-state-lock |
| workspace_key_prefix | Workspace別の状態ファイル管理用プレフィックス | env: |

## Workspace対応

### 状態ファイルの保存パス
Workspaceごとに異なるパスに状態ファイルが保存されます：

- **defaultワークスペース**: `s3://example-project-terraform-state/terraform.tfstate`
- **stgワークスペース**: `s3://example-project-terraform-state/env:stg/terraform.tfstate`
- **prodワークスペース**: `s3://example-project-terraform-state/env:prod/terraform.tfstate`

### Workspaceのメリット
- 環境ごとの状態管理が分離
- 同一設定で複数環境を管理可能
- 環境間の誤操作を防止

## 認証方法

### 利用可能な認証方式
1. **環境変数**
   ```bash
   export AWS_ACCESS_KEY_ID=your-access-key
   export AWS_SECRET_ACCESS_KEY=your-secret-key
   ```

2. **AWS Profile**
   ```bash
   export AWS_PROFILE=your-profile
   ```

3. **IAMロール** (EC2/ECS/Lambda実行時)
   - インスタンスプロファイル経由で自動認証

4. **GitHub Actions**
   - Repository Secretsに設定
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`

## セキュリティ考慮事項

### 必要な権限
S3 Backendを使用するには以下のAWS権限が必要：

#### S3バケットへの権限
- `s3:GetObject`
- `s3:PutObject`
- `s3:DeleteObject`
- `s3:ListBucket`

#### DynamoDBテーブルへの権限
- `dynamodb:GetItem`
- `dynamodb:PutItem`
- `dynamodb:DeleteItem`

### ベストプラクティス
1. **暗号化の有効化**: `encrypt = true`で保存時暗号化
2. **バケットのバージョニング**: 状態ファイルの履歴管理
3. **アクセス制限**: IAMポリシーで最小権限の原則
4. **定期的なバックアップ**: 重要な変更前にはバックアップ

### 注意事項
- 状態ファイルには機密情報が含まれる可能性
- S3バケットは公開設定にしない
- DynamoDBテーブルは自動作成されない（事前作成が必要）

## 関連
- [Terraform Backend Documentation](https://www.terraform.io/docs/language/settings/backends/s3.html)
- [AWS S3 Backend Configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/backends/s3)
- [Terraform Workspaces](https://www.terraform.io/docs/language/state/workspaces.html)