# AWS Route 53 Terraform セットアップチュートリアル

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにAWS Route 53をTerraformでセットアップするかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにAWS Route 53をTerraformでセットアップするか
> 
> **Answer** : `aws_route53_zone`でホストゾーンを作成し、`aws_route53_record`で各種DNSレコードを定義。AWSサービスへのルーティングにはエイリアスレコードを使用。ACM証明書の検証やヘルスチェック、フェイルオーバーなどの高度な機能も利用可能。

## 目次

<details>
<summary>目次を開く</summary>

- [はじめに](#はじめに)
- [前提条件](#前提条件)
- [基本的なセットアップ手順](#基本的なセットアップ手順)
- [高度な設定例](#高度な設定例)
- [ベストプラクティス](#ベストプラクティス)
- [注意事項](#注意事項)
- [トラブルシューティング](#トラブルシューティング)
- [関連](#関連)

</details>

## はじめに
このチュートリアルでは、Terraformを使用してAWS Route 53の基本的なセットアップ方法について説明します。

## 前提条件
- AWSアカウント
- Terraformのインストール
- AWS CLIのセットアップと認証設定

## 基本的なセットアップ手順

### 1. プロバイダーの設定
```terraform
provider "aws" {
  region = "ap-northeast-1"  # 東京リージョン
}
```

### 2. ホストゾーンの作成
```terraform
resource "aws_route53_zone" "main" {
  name = "example.com"
  
  tags = {
    Environment = var.environment
  }
}
```

### 3. 基本的なDNSレコードの作成

#### Aレコード（IPv4）
```terraform
resource "aws_route53_record" "www" {
  zone_id = aws_route53_zone.main.zone_id
  name    = "www.example.com"
  type    = "A"
  ttl     = "300"
  records = ["203.0.113.1"]  # IPアドレスを指定
}
```

#### CNAMEレコード
```terraform
resource "aws_route53_record" "app" {
  zone_id = aws_route53_zone.main.zone_id
  name    = "app.example.com"
  type    = "CNAME"
  ttl     = "300"
  records = ["app.herokuapp.com"]
}
```

### 4. エイリアスレコードの作成（AWSサービス用）
```terraform
resource "aws_route53_record" "alias" {
  zone_id = aws_route53_zone.main.zone_id
  name    = "api.example.com"
  type    = "A"

  alias {
    name                   = aws_alb.main.dns_name
    zone_id                = aws_alb.main.zone_id
    evaluate_target_health = true
  }
}
```

### 5. SSL/TLS証明書の検証用レコード
```terraform
resource "aws_route53_record" "cert_validation" {
  for_each = {
    for dvo in aws_acm_certificate.main.domain_validation_options : dvo.domain_name => {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  allow_overwrite = true
  name            = each.value.name
  records         = [each.value.record]
  ttl             = 60
  type            = each.value.type
  zone_id         = aws_route53_zone.main.zone_id
}
```

## 高度な設定例

### 1. 重み付けルーティング
```terraform
resource "aws_route53_record" "weighted" {
  zone_id = aws_route53_zone.main.zone_id
  name    = "weight.example.com"
  type    = "A"
  
  weighted_routing_policy {
    weight = 50
  }
  
  set_identifier = "primary"
  records        = ["203.0.113.1"]
  ttl           = 300
}
```

### 2. ヘルスチェック
```terraform
resource "aws_route53_health_check" "web" {
  fqdn              = "example.com"
  port              = 80
  type              = "HTTP"
  resource_path     = "/"
  failure_threshold = "3"
  request_interval  = "30"

  tags = {
    Name = "web-health-check"
  }
}
```

### 3. フェイルオーバールーティング
```terraform
resource "aws_route53_record" "primary" {
  zone_id = aws_route53_zone.main.zone_id
  name    = "failover.example.com"
  type    = "A"
  ttl     = 300
  
  failover_routing_policy {
    type = "PRIMARY"
  }
  
  health_check_id = aws_route53_health_check.web.id
  set_identifier  = "primary"
  records         = ["203.0.113.1"]
}
```

## ベストプラクティス

1. **変数の活用**
```terraform
variable "domain_name" {
  type        = string
  description = "メインドメイン名"
}

variable "environment" {
  type        = string
  description = "環境名（dev/staging/prod）"
}
```

2. **条件付きリソース作成**
```terraform
resource "aws_route53_record" "www" {
  count = var.environment == "prod" ? 1 : 0
  
  zone_id = aws_route53_zone.main.zone_id
  name    = "www.${var.domain_name}"
  type    = "A"
  ttl     = "300"
  records = ["203.0.113.1"]
}
```

## 注意事項
1. DNSの伝播には時間がかかる場合があります（TTLの設定に注意）
2. ホストゾーンの削除前に、全てのレコードを削除する必要があります
3. ACM証明書の検証には、CNAMEレコードが必要です
4. エイリアスレコードは、AWSサービス向けに最適化されています

## トラブルシューティング

1. **レコードが反映されない場合**
   - TTLの値を確認
   - ネームサーバーの設定を確認
   - Route 53のキャッシュをチェック

2. **証明書の検証が失敗する場合**
   - CNAMEレコードの値を確認
   - レコードの伝播を待つ
   - ドメインの所有権を確認

3. **エイリアスレコードの問題**
   - ターゲットリソースが同じリージョンにあることを確認
   - zone_idが正しいことを確認

## 関連
- [AWS Route53について](/Users/shota-hashimoto/til/daily/2025.07.17.12.21_what_aws_route53.md)
- [AWS ACM証明書リソース](/Users/shota-hashimoto/til/daily/2025.07.24.08.47_what_aws_acm_certificate.md)
- [AWS Route 53 ドキュメント](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/Welcome.html)
- [Terraform AWS Provider - Route 53](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_zone)
- [Route 53 ベストプラクティス](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/best-practices-dns.html) 