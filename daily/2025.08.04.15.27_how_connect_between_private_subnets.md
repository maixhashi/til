# プライベートサブネット間の接続方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにプライベートサブネット間を接続するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにプライベートサブネット間を接続するか
> 
> **Answer** : 同一VPC内のプライベートサブネット間はデフォルトで接続可能。異なるVPC間の場合はVPCピアリング、Transit Gateway、PrivateLinkなどの設定が必要

## 目次

<details>
<summary>目次を開く</summary>

- [同一VPC内のプライベートサブネット間接続](#同一vpc内のプライベートサブネット間接続)
- [異なるVPC間のプライベートサブネット接続](#異なるvpc間のプライベートサブネット接続)
- [セキュリティ設定の考慮事項](#セキュリティ設定の考慮事項)
- [接続パターンの比較と選択](#接続パターンの比較と選択)

</details>

## 同一VPC内のプライベートサブネット間接続

### デフォルトの接続性

```mermaid
graph LR
    subgraph "VPC (10.0.0.0/16)"
        subgraph "Private Subnet A (10.0.1.0/24)"
            EC2A[EC2-A<br/>10.0.1.10]
        end
        subgraph "Private Subnet B (10.0.2.0/24)"
            EC2B[EC2-B<br/>10.0.2.10]
        end
        RT[ルートテーブル<br/>10.0.0.0/16 → local]
    end
    
    EC2A <-->|自動的に通信可能| EC2B
    
    style EC2A fill:#9f9,stroke:#333,stroke-width:2px
    style EC2B fill:#9f9,stroke:#333,stroke-width:2px
    style RT fill:#ff9,stroke:#333,stroke-width:2px
```

### 必要な設定
1. **ルートテーブル**: VPC CIDRブロックへのローカルルートが自動設定
2. **セキュリティグループ**: 適切なインバウンドルールの設定が必要
3. **NACLs**: デフォルトは全許可、必要に応じて制限

### セキュリティグループの設定例

```bash
# セキュリティグループの作成と設定
aws ec2 create-security-group \
    --group-name private-subnet-sg \
    --description "Security group for private subnet communication" \
    --vpc-id vpc-xxxxx

# プライベートサブネット間の通信を許可
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxx \
    --protocol tcp \
    --port 443 \
    --source-group sg-xxxxx
```

## 異なるVPC間のプライベートサブネット接続

### パターン1: VPCピアリング

```mermaid
graph TB
    subgraph "VPC A (10.0.0.0/16)"
        subgraph "Private Subnet A"
            EC2A[EC2-A<br/>10.0.1.10]
        end
        RTA[ルートテーブルA]
    end
    
    subgraph "VPC B (172.16.0.0/16)"
        subgraph "Private Subnet B"
            EC2B[EC2-B<br/>172.16.1.10]
        end
        RTB[ルートテーブルB]
    end
    
    PC[VPCピアリング接続]
    
    EC2A --> RTA
    RTA --> PC
    PC --> RTB
    RTB --> EC2B
    
    RTA -.->|172.16.0.0/16 → pcx-xxxxx| PC
    RTB -.->|10.0.0.0/16 → pcx-xxxxx| PC
    
    style PC fill:#f9f,stroke:#333,stroke-width:3px
```

### パターン2: AWS Transit Gateway

```mermaid
graph TB
    subgraph "Transit Gateway"
        TGW[Transit Gateway]
        TGWRT[TGWルートテーブル]
    end
    
    subgraph "VPC A"
        VPCA[Private Subnet A<br/>10.0.0.0/16]
    end
    
    subgraph "VPC B"
        VPCB[Private Subnet B<br/>172.16.0.0/16]
    end
    
    subgraph "VPC C"
        VPCC[Private Subnet C<br/>192.168.0.0/16]
    end
    
    VPCA <--> TGW
    VPCB <--> TGW
    VPCC <--> TGW
    TGW --> TGWRT
    
    style TGW fill:#ff9,stroke:#333,stroke-width:4px
    style TGWRT fill:#9ff,stroke:#333,stroke-width:2px
```

### パターン3: AWS PrivateLink

```mermaid
sequenceDiagram
    participant Consumer as コンシューマーVPC<br/>プライベートサブネット
    participant Interface as VPCエンドポイント<br/>(インターフェース型)
    participant NLB as Network Load Balancer
    participant Provider as プロバイダーVPC<br/>プライベートサブネット
    
    Consumer->>Interface: API呼び出し
    Interface->>NLB: プライベート接続
    NLB->>Provider: 負荷分散
    Provider-->>NLB: レスポンス
    NLB-->>Interface: レスポンス
    Interface-->>Consumer: レスポンス
```

## セキュリティ設定の考慮事項

### 多層防御の実装

```mermaid
graph TD
    subgraph "セキュリティレイヤー"
        SG[セキュリティグループ<br/>ステートフル]
        NACL[ネットワークACL<br/>ステートレス]
        RT[ルートテーブル<br/>経路制御]
        FW[AWS Network Firewall<br/>詳細な制御]
    end
    
    Traffic[トラフィック] --> SG
    SG --> NACL
    NACL --> RT
    RT --> FW
    FW --> Destination[宛先]
    
    style SG fill:#9f9,stroke:#333,stroke-width:2px
    style NACL fill:#99f,stroke:#333,stroke-width:2px
    style RT fill:#ff9,stroke:#333,stroke-width:2px
    style FW fill:#f99,stroke:#333,stroke-width:2px
```

### ベストプラクティス
1. **最小権限の原則**: 必要最小限のポートとプロトコルのみ許可
2. **送信元の制限**: 特定のIPアドレスまたはセキュリティグループからのみ許可
3. **暗号化**: VPN接続やTLS通信の利用
4. **監査ログ**: VPC Flow LogsとCloudTrailの有効化

## 接続パターンの比較と選択

### 接続方式の選択フローチャート

```mermaid
graph TD
    Start[プライベートサブネット間<br/>接続が必要]
    
    Start --> Q1{同一VPC内？}
    Q1 -->|Yes| SameVPC[デフォルトで接続可能<br/>セキュリティグループ設定のみ]
    Q1 -->|No| Q2{接続するVPC数は？}
    
    Q2 -->|2つのみ| Q3{トランジット<br/>接続が必要？}
    Q2 -->|3つ以上| TGW[Transit Gateway]
    
    Q3 -->|No| Peering[VPCピアリング]
    Q3 -->|Yes| TGW
    
    Q2 -->|サービス公開| PrivateLink[AWS PrivateLink]
    
    style SameVPC fill:#9f9,stroke:#333,stroke-width:2px
    style Peering fill:#99f,stroke:#333,stroke-width:2px
    style TGW fill:#ff9,stroke:#333,stroke-width:2px
    style PrivateLink fill:#f9f,stroke:#333,stroke-width:2px
```

### 比較表

| 接続方式 | 最大接続数 | 料金体系 | 帯域幅 | 複雑性 | ユースケース |
|---------|-----------|----------|--------|---------|--------------|
| 同一VPC内 | N/A | 無料 | 無制限 | 低 | 基本的な内部通信 |
| VPCピアリング | 1対1 | データ転送料のみ | 無制限 | 低 | シンプルなVPC間接続 |
| Transit Gateway | 多対多 | 接続料+データ転送料 | 50Gbps | 中 | 複雑なネットワーク構成 |
| PrivateLink | 多対1 | エンドポイント料+データ転送料 | 10Gbps | 高 | サービス公開 |

### 実装例: VPCピアリング設定

```bash
# VPCピアリング接続の作成
aws ec2 create-vpc-peering-connection \
    --vpc-id vpc-aaaaa \
    --peer-vpc-id vpc-bbbbb \
    --peer-region us-east-1

# ピアリング接続の承諾
aws ec2 accept-vpc-peering-connection \
    --vpc-peering-connection-id pcx-xxxxx

# ルートテーブルの更新（VPC A側）
aws ec2 create-route \
    --route-table-id rtb-aaaaa \
    --destination-cidr-block 172.16.0.0/16 \
    --vpc-peering-connection-id pcx-xxxxx

# ルートテーブルの更新（VPC B側）
aws ec2 create-route \
    --route-table-id rtb-bbbbb \
    --destination-cidr-block 10.0.0.0/16 \
    --vpc-peering-connection-id pcx-xxxxx
```

## 関連
- [AWS VPCピアリング公式ドキュメント](https://docs.aws.amazon.com/vpc/latest/peering/)
- [AWS Transit Gateway ドキュメント](https://docs.aws.amazon.com/vpc/latest/tgw/)
- [AWS PrivateLink ドキュメント](https://docs.aws.amazon.com/vpc/latest/privatelink/)
- [VPCのセキュリティベストプラクティス](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html)