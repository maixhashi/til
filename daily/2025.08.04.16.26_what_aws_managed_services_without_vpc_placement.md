# VPCやサブネットへの配置が不要なAWSマネージドサービス

## What's this file?
> [!NOTE]
> **What**
> 
> VPCやサブネットへの配置が不要なAWSマネージドサービスとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : VPCやサブネットへの配置が不要なAWSマネージドサービスとは何か
> 
> **Answer** : S3、DynamoDB、Lambda、Secrets Managerなど、AWSが完全に管理し、APIやSDK経由でアクセスするサービス群。これらはVPC外のAWSインフラ上で動作し、マウントや配置の概念がない

## 目次

<details>
<summary>目次を開く</summary>

- [AWSサービスの配置パターン分類](#awsサービスの配置パターン分類)
- [VPC外配置サービスの特徴](#vpc外配置サービスの特徴)
- [主要なVPC外配置サービス一覧](#主要なvpc外配置サービス一覧)
- [アクセス方法とセキュリティ](#アクセス方法とセキュリティ)

</details>

## AWSサービスの配置パターン分類

### サービス配置の3つのパターン

```mermaid
graph TB
    subgraph "パターン1: VPC外配置（マネージドサービス）"
        S3[S3]
        DDB[DynamoDB]
        Lambda[Lambda]
        SM[Secrets Manager]
        CW[CloudWatch]
    end
    
    subgraph "パターン2: VPC内配置必須"
        EC2[EC2]
        RDS[RDS]
        ECS[ECS/Fargate]
        ALB[ALB/NLB]
    end
    
    subgraph "パターン3: ハイブリッド型"
        EFSA[EFS本体<br/>VPC外]
        EFSM[EFSマウントターゲット<br/>VPC内]
        FSXA[FSx本体<br/>VPC外]
        FSXM[FSxエンドポイント<br/>VPC内]
    end
    
    EFSA -.-> EFSM
    FSXA -.-> FSXM
    
    style S3 fill:#ff9,stroke:#333,stroke-width:3px
    style DDB fill:#ff9,stroke:#333,stroke-width:3px
    style Lambda fill:#ff9,stroke:#333,stroke-width:3px
    style EC2 fill:#9f9,stroke:#333,stroke-width:2px
    style RDS fill:#9f9,stroke:#333,stroke-width:2px
```

### 配置パターンの特徴比較

| パターン | 配置場所 | アクセス方法 | 管理責任 | 例 |
|---------|----------|-------------|----------|-----|
| VPC外配置 | AWSインフラ | API/SDK | AWS完全管理 | S3, DynamoDB |
| VPC内配置 | 顧客VPC | 直接接続 | 共同責任 | EC2, RDS |
| ハイブリッド | 両方 | 専用エンドポイント | 混合 | EFS, FSx |

## VPC外配置サービスの特徴

### 共通特性

```mermaid
graph LR
    subgraph "VPC外配置サービスの特徴"
        F1[APIベースアクセス]
        F2[マウント不要]
        F3[グローバルまたはリージョナル]
        F4[自動スケーリング]
        F5[高可用性組み込み]
        F6[使用量課金]
    end
    
    subgraph "アクセス方法"
        A1[HTTPS/REST API]
        A2[AWS SDK]
        A3[AWS CLI]
        A4[マネジメントコンソール]
    end
    
    F1 --> A1
    F1 --> A2
    F1 --> A3
    F1 --> A4
    
    style F1 fill:#9ff,stroke:#333,stroke-width:2px
    style F2 fill:#9ff,stroke:#333,stroke-width:2px
```

### VPC配置が不要な理由

```mermaid
graph TD
    subgraph "理由"
        R1[マルチテナント設計]
        R2[リージョンレベルの冗長性]
        R3[APIゲートウェイ経由のアクセス]
        R4[自動的な負荷分散]
        R5[グローバルなスケーラビリティ]
    end
    
    subgraph "結果"
        RES1[VPC制約からの解放]
        RES2[簡単なアクセス設定]
        RES3[インフラ管理不要]
        RES4[高い可用性]
    end
    
    R1 --> RES1
    R2 --> RES4
    R3 --> RES2
    R4 --> RES4
    R5 --> RES3
```

## 主要なVPC外配置サービス一覧

### ストレージサービス

```mermaid
graph LR
    subgraph "オブジェクトストレージ"
        S3[S3<br/>無制限スケール]
        Glacier[Glacier<br/>アーカイブ]
    end
    
    subgraph "データベース"
        DDB[DynamoDB<br/>NoSQL]
        TS[Timestream<br/>時系列DB]
        QL[QLDB<br/>台帳DB]
    end
    
    subgraph "データ分析"
        Athena[Athena<br/>SQLクエリ]
        Kinesis[Kinesis<br/>ストリーミング]
        Glue[Glue<br/>ETL]
    end
```

### アプリケーションサービス

```mermaid
graph TD
    subgraph "コンピュート"
        Lambda[Lambda<br/>サーバーレス関数]
        SF[Step Functions<br/>ワークフロー]
        Batch[Batch<br/>バッチ処理]
    end
    
    subgraph "統合サービス"
        SQS[SQS<br/>キューサービス]
        SNS[SNS<br/>通知サービス]
        EB[EventBridge<br/>イベントバス]
    end
    
    subgraph "開発者ツール"
        SM[Secrets Manager<br/>シークレット管理]
        PM[Parameter Store<br/>設定管理]
        CC[CodeCommit<br/>Git リポジトリ]
    end
```

### 監視・管理サービス

| サービス | 用途 | アクセス方法 | 特徴 |
|---------|------|-------------|------|
| CloudWatch | ログ・メトリクス | API/SDK | 自動収集 |
| CloudTrail | 監査ログ | API/SDK | 全APIコール記録 |
| X-Ray | 分散トレース | API/SDK | アプリ性能分析 |
| Config | リソース構成管理 | API/SDK | 変更追跡 |
| Systems Manager | 運用管理 | API/SDK | 統合管理 |

## アクセス方法とセキュリティ

### アクセスパターン

```mermaid
graph LR
    subgraph "VPC内のリソース"
        EC2[EC2/Lambda<br/>in VPC]
    end
    
    subgraph "アクセス経路"
        subgraph "パブリックアクセス"
            IGW[インターネット<br/>ゲートウェイ]
            NAT[NAT<br/>ゲートウェイ]
        end
        
        subgraph "プライベートアクセス"
            VPE[VPC<br/>エンドポイント]
        end
    end
    
    subgraph "VPC外サービス"
        S3E[S3]
        DDBE[DynamoDB]
        SME[Secrets Manager]
    end
    
    EC2 -->|推奨| VPE
    EC2 -->|代替| NAT
    VPE --> S3E
    VPE --> DDBE
    VPE --> SME
    NAT --> IGW
    IGW --> S3E
    
    style VPE fill:#9f9,stroke:#333,stroke-width:3px
    style EC2 fill:#9ff,stroke:#333,stroke-width:2px
```

### VPCエンドポイントの種類

#### ゲートウェイエンドポイント（無料）

| サービス | ルートテーブル更新 | コスト |
|---------|-----------------|------|
| S3 | 必須 | 無料 |
| DynamoDB | 必須 | 無料 |

#### インターフェースエンドポイント（有料）

| サービス | DNS解決 | コスト |
|---------|----------|------|
| Secrets Manager | プライベート | 時間単位 + データ転送 |
| Lambda | プライベート | 時間単位 + データ転送 |
| SNS | プライベート | 時間単位 + データ転送 |

### セキュリティベストプラクティス

```mermaid
graph TD
    subgraph "アクセス制御"
        IAM[IAMポリシー<br/>最小権限]
        RES[リソースポリシー<br/>S3バケットポリシー等]
        VPE[VPCエンドポイント<br/>ポリシー]
    end
    
    subgraph "暗号化"
        TLS[転送時暗号化<br/>TLS/HTTPS]
        REST[保管時暗号化<br/>KMS]
    end
    
    subgraph "監査"
        CT[CloudTrail<br/>APIログ]
        CW[CloudWatch<br/>メトリクス]
    end
    
    IAM --> TLS
    RES --> REST
    VPE --> CT
    
    style IAM fill:#f99,stroke:#333,stroke-width:2px
    style TLS fill:#9f9,stroke:#333,stroke-width:2px
    style CT fill:#99f,stroke:#333,stroke-width:2px
```

### 実装例：VPC外サービスへのアクセス

```python
# VPC配置不要なサービスへのアクセス例
import boto3

# S3（VPC外）
s3 = boto3.client('s3')
response = s3.get_object(Bucket='my-bucket', Key='my-key')

# DynamoDB（VPC外）
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('my-table')
response = table.get_item(Key={'id': '123'})

# Secrets Manager（VPC外）
sm = boto3.client('secretsmanager')
secret = sm.get_secret_value(SecretId='my-secret')

# Lambda（VPC外で実行）
lambda_client = boto3.client('lambda')
response = lambda_client.invoke(
    FunctionName='my-function',
    Payload=json.dumps({'key': 'value'})
)

# いずれもマウント不要、API経由でアクセス
```

### まとめ：VPC配置の必要性判断

```mermaid
graph TD
    Start[AWSサービス選択] --> Q1{データプレーンは<br/>AWS管理？}
    Q1 -->|Yes| Q2{APIアクセス？}
    Q1 -->|No| VPCReq[VPC配置必須<br/>EC2, RDS等]
    
    Q2 -->|Yes| NoVPC[VPC配置不要<br/>S3, DynamoDB等]
    Q2 -->|No| Q3{マウントが必要？}
    
    Q3 -->|Yes| Hybrid[ハイブリッド型<br/>EFS, FSx]
    Q3 -->|No| Special[特殊ケース<br/>要確認]
    
    style NoVPC fill:#9f9,stroke:#333,stroke-width:3px
    style VPCReq fill:#ff9,stroke:#333,stroke-width:3px
    style Hybrid fill:#9ff,stroke:#333,stroke-width:3px
```

## 関連
- [AWS サービスエンドポイント](https://docs.aws.amazon.com/general/latest/gr/aws-service-information.html)
- [VPCエンドポイント](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)
- [AWSサービスのセキュリティ](https://docs.aws.amazon.com/security/)
- [Well-Architectedフレームワーク](https://docs.aws.amazon.com/wellarchitected/latest/framework/welcome.html)