# Terraformのlifecycle create_before_destroyとは

## What's this file?
> [!NOTE]
> **What**
> 
> Terraformのlifecycle設定における`create_before_destroy`プロパティとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : lifecycle create_before_destroyとは何か
> 
> **Answer** : リソースを更新する際、古いリソースを削除する前に新しいリソースを先に作成する設定。ダウンタイムを防ぐために使用される。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 通常のリソース更新フロー](#2-通常のリソース更新フロー)
- [3. create_before_destroyの動作](#3-create_before_destroyの動作)
- [4. 主な使用場面](#4-主な使用場面)
- [5. ACM証明書での使用例](#5-acm証明書での使用例)
- [6. 設定方法](#6-設定方法)
- [7. 注意事項](#7-注意事項)
- [8. その他のlifecycle設定](#8-その他のlifecycle設定)

</details>

## 1. 概要

`create_before_destroy`は、Terraformのlifecycleメタ引数の一つで、リソースの更新時の動作を制御します。このフラグをtrueに設定すると、既存のリソースを削除する前に新しいリソースを作成します。

主な目的：
- サービスの可用性維持
- ダウンタイムの防止
- 依存関係の適切な処理

## 2. 通常のリソース更新フロー

`create_before_destroy = false`（デフォルト）の場合：

```
1. 既存リソースの削除
2. 新規リソースの作成
3. 参照の更新
```

この間、リソースが存在しない期間が発生し、サービスが中断される可能性があります。

## 3. create_before_destroyの動作

`create_before_destroy = true`の場合：

```
1. 新規リソースの作成
2. 参照の更新
3. 既存リソースの削除
```

新旧のリソースが一時的に共存し、切り替えがスムーズに行われます。

## 4. 主な使用場面

### 推奨される場面

1. **証明書（ACM）**
   - SSL/TLS証明書の更新時
   - ドメイン変更時

2. **ロードバランサー**
   - ALB/NLBの設定変更時

3. **Auto Scalingグループ**
   - 起動設定の変更時

4. **セキュリティグループ**
   - ルールの大幅な変更時

### 必要ない場面

1. **RDSインスタンス**
   - 通常はインプレース更新が可能

2. **S3バケット**
   - バケット名は一意である必要があるため

3. **VPC**
   - 依存リソースが多く、複雑になるため

## 5. ACM証明書での使用例

```hcl
resource "aws_acm_certificate" "cloudfront" {
  provider = aws.virginia

  domain_name = var.domain_name
  subject_alternative_names = [
    "*.${var.domain_name}"
  ]
  validation_method = "DNS"

  lifecycle {
    create_before_destroy = true
  }

  tags = {
    Name = "${var.project_name}-cloudfront-certificate-${var.environment}"
  }
}
```

ACM証明書で`create_before_destroy`を使用する理由：
- CloudFrontやALBが証明書を使用中でも更新可能
- 証明書の切り替え時のダウンタイムを防止
- ドメイン名変更時の円滑な移行

## 6. 設定方法

### 基本的な設定

```hcl
resource "aws_instance" "example" {
  # ... リソース設定 ...

  lifecycle {
    create_before_destroy = true
  }
}
```

### 他のlifecycle設定との組み合わせ

```hcl
resource "aws_instance" "example" {
  # ... リソース設定 ...

  lifecycle {
    create_before_destroy = true
    prevent_destroy       = false
    ignore_changes       = [tags]
  }
}
```

## 7. 注意事項

### 1. リソースの制約

一部のリソースでは使用できない場合があります：
- 名前が一意である必要があるリソース
- 同時に複数存在できないリソース

### 2. コストへの影響

一時的に新旧両方のリソースが存在するため：
- 短時間ですが2倍のコストが発生
- 課金体系を確認して使用

### 3. 依存関係の複雑化

```hcl
# 注意が必要な例
resource "aws_security_group" "example" {
  # ... 設定 ...
  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_instance" "example" {
  vpc_security_group_ids = [aws_security_group.example.id]
  # セキュリティグループの更新時に影響を受ける
}
```

### 4. 状態ファイルの管理

- 中間状態でエラーが発生した場合、手動介入が必要な場合がある
- `terraform state`コマンドでの確認が重要

## 8. その他のlifecycle設定

### prevent_destroy

リソースの削除を防止：

```hcl
lifecycle {
  prevent_destroy = true
}
```

### ignore_changes

特定の属性の変更を無視：

```hcl
lifecycle {
  ignore_changes = [tags, user_data]
}
```

### replace_triggered_by

他のリソースの変更時に再作成：

```hcl
lifecycle {
  replace_triggered_by = [
    aws_instance.example.id
  ]
}
```

### postcondition

リソース作成後の条件チェック：

```hcl
lifecycle {
  postcondition {
    condition     = self.status == "available"
    error_message = "リソースが利用可能な状態ではありません"
  }
}
```

## 関連
- [AWS ACM Certificate設定](/Users/username/example-project-app/infra/terraform/client/aws_acm_certificate.tf)
- [Terraform公式ドキュメント - Lifecycle](https://www.terraform.io/language/meta-arguments/lifecycle)
- [AWS ACM証明書のTerraform設定ガイド](/Users/username/example-project-app/my-documents/knowledges/2025.08.01.14.31_AWS_ACM証明書のTerraform設定ガイド.md)