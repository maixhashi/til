# なぜALBはパブリックサブネットに配置する必要があるのか

## What's this file?
> [!NOTE]
> **Why**
> 
> **なぜ**インターネット向けALBはパブリックサブネットに配置する必要があるのか

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **Why** : **なぜ**インターネット向けALBはパブリックサブネットに配置する必要があるのか
> 
> **Answer** : ALBがインターネットからのトラフィックを受信するためには、パブリックIPアドレスとインターネットゲートウェイへの経路が必要だから。内部ALBの場合はプライベートサブネットでも可能

## 目次
<details>
<summary>目次を開く</summary>

- [ALBの種類と配置要件](#albの種類と配置要件)
- [インターネット向けALBの技術的要件](#インターネット向けalbの技術的要件)
- [内部ALBとの違い](#内部albとの違い)
- [設定パターンと実装例](#設定パターンと実装例)

</details>

## ALBの種類と配置要件

### ALBの2つのスキーム

```mermaid
graph TB
    subgraph "インターネット向けALB"
        subgraph "パブリックサブネット"
            IALB[Internet-facing ALB<br/>パブリックIP: 必須]
        end
        IGW[インターネット<br/>ゲートウェイ]
        Internet[インターネット]
    end
    
    subgraph "内部ALB"
        subgraph "プライベートサブネット"
            IILB[Internal ALB<br/>プライベートIPのみ]
        end
        VPC[VPC内部]
    end
    
    Internet --> IGW
    IGW --> IALB
    VPC --> IILB
    
    style IALB fill:#ff9,stroke:#333,stroke-width:3px
    style IILB fill:#9f9,stroke:#333,stroke-width:3px
```

### 配置要件の比較

| ALBタイプ | サブネット要件 | IPアドレス | アクセス元 | 用途 |
|-----------|---------------|------------|-----------|------|
| Internet-facing | パブリックサブネット必須 | パブリックIP | インターネット | 外部公開サービス |
| Internal | プライベートサブネット可 | プライベートIPのみ | VPC内部 | 内部サービス |

## インターネット向けALBの技術的要件

### パブリックサブネット配置が必須な理由

```mermaid
sequenceDiagram
    participant User as インターネット<br/>ユーザー
    participant IGW as インターネット<br/>ゲートウェイ
    participant ALB as ALB<br/>(パブリックサブネット)
    participant Target as ターゲット<br/>(プライベートサブネット)
    
    User->>IGW: HTTPリクエスト<br/>(パブリックIP宛)
    Note over IGW: パブリックIPから<br/>プライベートIPへ変換
    IGW->>ALB: リクエスト転送
    ALB->>Target: 負荷分散
    Target-->>ALB: レスポンス
    ALB-->>IGW: レスポンス返却
    Note over IGW: プライベートIPから<br/>パブリックIPへ変換
    IGW-->>User: HTTPレスポンス
```

### 必要な要件
1. **パブリックIPアドレス**
   - インターネットからアクセス可能なIPアドレス
   - ALBのENI（Elastic Network Interface）に自動割り当て

2. **インターネットゲートウェイへの経路**
   - ルートテーブルに0.0.0.0/0 → IGWの設定が必要
   - 双方向通信のための経路確保

3. **DNSレコード**
   - ALBのDNS名がパブリックIPに解決される必要
   - Route 53などでのドメイン設定

### ネットワーク要件の詳細

```mermaid
graph LR
    subgraph "VPC (10.0.0.0/16)"
        subgraph "パブリックサブネット"
            ALB[ALB<br/>ENI: 10.0.1.10<br/>Public IP: 54.x.x.x]
            RT1[ルートテーブル<br/>0.0.0.0/0 → IGW]
        end
        subgraph "プライベートサブネット"
            EC2[EC2ターゲット<br/>10.0.2.10]
            RT2[ルートテーブル<br/>0.0.0.0/0 → NAT]
        end
        IGW[インターネット<br/>ゲートウェイ]
        NAT[NATゲートウェイ]
    end
    
    ALB --> RT1
    RT1 --> IGW
    EC2 --> RT2
    RT2 --> NAT
    NAT --> IGW
    
    style ALB fill:#ff9,stroke:#333,stroke-width:3px
    style IGW fill:#9ff,stroke:#333,stroke-width:3px
```

## 内部ALBとの違い

### 内部ALBの配置パターン

```mermaid
graph TB
    subgraph "VPC"
        subgraph "プライベートサブネットA"
            ILBA[内部ALB<br/>10.0.1.10]
        end
        subgraph "プライベートサブネットB"
            Client[クライアント<br/>10.0.2.10]
        end
        subgraph "プライベートサブネットC"
            Target[ターゲット<br/>10.0.3.10]
        end
    end
    
    Client --> ILBA
    ILBA --> Target
    
    style ILBA fill:#9f9,stroke:#333,stroke-width:3px
```

### 内部ALBの特徴
- **プライベートIPのみ**: パブリックIPアドレスは不要
- **VPC内部通信**: インターネットゲートウェイ不要
- **柔軟な配置**: プライベートサブネットに配置可能
- **セキュリティ**: インターネットから直接アクセス不可

## 設定パターンと実装例

### パターン1: 典型的なWebアプリケーション構成

```mermaid
graph TB
    subgraph "インターネット"
        Users[ユーザー]
    end
    
    subgraph "VPC"
        subgraph "パブリックサブネット (Multi-AZ)"
            ALB[ALB<br/>Internet-facing]
        end
        subgraph "プライベートサブネット (Multi-AZ)"
            ASG[Auto Scaling Group<br/>EC2インスタンス]
        end
        subgraph "データベースサブネット"
            RDS[(RDS)]
        end
    end
    
    Users --> ALB
    ALB --> ASG
    ASG --> RDS
    
    style ALB fill:#ff9,stroke:#333,stroke-width:3px
    style ASG fill:#9f9,stroke:#333,stroke-width:2px
    style RDS fill:#99f,stroke:#333,stroke-width:2px
```

### パターン2: マイクロサービス構成

```mermaid
graph LR
    subgraph "外部アクセス"
        ExtALB["External ALB<br/>(パブリックサブネット)"]
    end
    
    subgraph "内部サービス"
        IntALB1["Internal ALB 1<br/>(プライベートサブネット)"]
        IntALB2["Internal ALB 2<br/>(プライベートサブネット)"]
        
        Service1[Service 1]
        Service2[Service 2]
    end
    
    ExtALB --> IntALB1
    ExtALB --> IntALB2
    IntALB1 --> Service1
    IntALB2 --> Service2
    
    style ExtALB fill:#ff9,stroke:#333,stroke-width:3px
    style IntALB1 fill:#9f9,stroke:#333,stroke-width:2px
    style IntALB2 fill:#9f9,stroke:#333,stroke-width:2px
```

### Terraformによる実装例

```hcl
# インターネット向けALB
resource "aws_lb" "internet_facing" {
  name               = "external-alb"
  internal           = false  # インターネット向け
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  
  # パブリックサブネットを指定（必須）
  subnets = [
    aws_subnet.public_1a.id,
    aws_subnet.public_1c.id
  ]
  
  enable_deletion_protection = false
  enable_http2              = true
}

# 内部ALB
resource "aws_lb" "internal" {
  name               = "internal-alb"
  internal           = true  # 内部向け
  load_balancer_type = "application"
  security_groups    = [aws_security_group.internal_alb.id]
  
  # プライベートサブネットでOK
  subnets = [
    aws_subnet.private_1a.id,
    aws_subnet.private_1c.id
  ]
}

# パブリックサブネットの定義
resource "aws_subnet" "public_1a" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "ap-northeast-1a"
  map_public_ip_on_launch = true  # パブリックIP自動割り当て
}

# ルートテーブル（パブリック）
resource "aws_route" "public_internet" {
  route_table_id         = aws_route_table.public.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.main.id  # IGWへのルート
}
```

### トラブルシューティングチェックリスト

1. **ALBがアクセスできない場合**
   - [ ] ALBはパブリックサブネットに配置されているか
   - [ ] サブネットのルートテーブルにIGWへの経路があるか
   - [ ] セキュリティグループで適切なポートが開いているか
   - [ ] NACLで通信がブロックされていないか

2. **ヘルスチェック失敗の場合**
   - [ ] ターゲットのセキュリティグループがALBからの通信を許可しているか
   - [ ] ヘルスチェックのパスとポートが正しいか
   - [ ] ターゲットインスタンスが正常に起動しているか

## 関連
- [AWS ALB公式ドキュメント](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/)
- [VPCのサブネット設計ベストプラクティス](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)
- [ALBのセキュリティベストプラクティス](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/security_groups.html)