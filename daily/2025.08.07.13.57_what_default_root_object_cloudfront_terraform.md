# CloudFront Distribution の default_root_object とは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS CloudFront Distributionの`default_root_object`プロパティとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : CloudFrontのdefault_root_objectとは何か
> 
> **Answer** : ルートURL（/）へのアクセス時に自動的に返されるデフォルトファイルを指定する設定。通常は"index.html"を指定する。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 基本的な動作](#2-基本的な動作)
- [3. 設定方法](#3-設定方法)
- [4. 一般的な設定値](#4-一般的な設定値)
- [5. サブディレクトリでの動作](#5-サブディレクトリでの動作)
- [6. 実装例](#6-実装例)
- [7. 注意事項](#7-注意事項)
- [8. トラブルシューティング](#8-トラブルシューティング)

</details>

## 1. 概要

`default_root_object`は、CloudFront Distributionでルートパス（/）へのリクエストがあった場合に、自動的に返すオブジェクト（ファイル）を指定する設定です。

主な特徴：
- ルートURLアクセス時のデフォルトファイル指定
- サブディレクトリには適用されない
- SPAやWebサイトのエントリーポイント設定に使用

## 2. 基本的な動作

### リクエストの変換

```
ユーザーのリクエスト: https://example.com/
↓ (default_root_object = "index.html")
実際のリクエスト: https://example.com/index.html
```

### 動作フロー

1. ユーザーがルートURL（/）にアクセス
2. CloudFrontが`default_root_object`を確認
3. 指定されたファイルをオリジンから取得
4. ユーザーにレスポンスを返す

## 3. 設定方法

### Terraformでの基本設定

```hcl
resource "aws_cloudfront_distribution" "main" {
  # ... その他の設定 ...
  
  default_root_object = "index.html"
  
  # ... その他の設定 ...
}
```

### 空文字列の設定

```hcl
# デフォルトオブジェクトを無効化
default_root_object = ""
```

## 4. 一般的な設定値

### Webサイト・SPA

```hcl
# HTMLファイル
default_root_object = "index.html"

# PHPアプリケーション
default_root_object = "index.php"

# 別名のインデックスファイル
default_root_object = "home.html"
default_root_object = "main.html"
```

### APIゲートウェイ

```hcl
# APIの場合は通常空文字列
default_root_object = ""
```

### 特殊なケース

```hcl
# メンテナンスページ
default_root_object = "maintenance.html"

# カスタムランディングページ
default_root_object = "welcome.html"
```

## 5. サブディレクトリでの動作

### 重要な制限

`default_root_object`はルートパス（/）のみに適用されます：

```
https://example.com/          → index.html が返される
https://example.com/about/    → index.html は返されない（404エラー）
https://example.com/blog/     → index.html は返されない（404エラー）
```

### サブディレクトリ対応

Lambda@EdgeやCloudFront Functionsを使用：

```javascript
// CloudFront Function例
function handler(event) {
    var request = event.request;
    var uri = request.uri;
    
    // ディレクトリパスの場合、index.htmlを追加
    if (uri.endsWith('/')) {
        request.uri = uri + 'index.html';
    }
    
    return request;
}
```

## 6. 実装例

### 静的Webサイト

```hcl
resource "aws_cloudfront_distribution" "static_site" {
  origin {
    domain_name = aws_s3_bucket.website.bucket_regional_domain_name
    origin_id   = "S3-${aws_s3_bucket.website.id}"
  }
  
  enabled             = true
  default_root_object = "index.html"
  
  # SPAのための404処理
  custom_error_response {
    error_code         = 404
    response_page_path = "/index.html"
    response_code      = 200
  }
}
```

### React/Vue.js SPA

```hcl
resource "aws_cloudfront_distribution" "spa" {
  # ... オリジン設定 ...
  
  enabled             = true
  default_root_object = "index.html"
  
  # SPAルーティング対応
  custom_error_response {
    error_code            = 403
    error_caching_min_ttl = 0
    response_page_path    = "/index.html"
    response_code         = 200
  }
  
  custom_error_response {
    error_code            = 404
    error_caching_min_ttl = 0
    response_page_path    = "/index.html"
    response_code         = 200
  }
}
```

### マルチページアプリケーション

```hcl
resource "aws_cloudfront_distribution" "multi_page" {
  # ... オリジン設定 ...
  
  enabled             = true
  default_root_object = "index.html"
  
  # 各ディレクトリに個別のキャッシュ動作を設定
  ordered_cache_behavior {
    path_pattern     = "/admin/*"
    target_origin_id = aws_s3_bucket.website.id
    # ... キャッシュ設定 ...
  }
}
```

## 7. 注意事項

### 1. 大文字小文字の区別

- ファイル名は大文字小文字を区別
- `index.html`と`Index.html`は別ファイル

### 2. ファイルの存在確認

- 指定したファイルがオリジンに存在しない場合は404エラー
- 事前にファイルの存在を確認

### 3. キャッシュの考慮

```hcl
default_cache_behavior {
  # index.htmlのキャッシュは短めに設定
  min_ttl     = 0
  default_ttl = 300  # 5分
  max_ttl     = 3600 # 1時間
}
```

### 4. セキュリティ

- デフォルトオブジェクトに機密情報を含めない
- 適切なアクセス制限を設定

## 8. Next.jsアプリケーションの場合

### 問題：Next.jsには静的なindex.htmlが存在しない

Next.jsアプリケーションは動的にページを生成するため、従来の静的なindex.htmlファイルは存在しません。そのため、CloudFrontの設定には特別な考慮が必要です。

### 解決方法1: ALB/ECSをオリジンとして使用（推奨）

```hcl
resource "aws_cloudfront_distribution" "nextjs" {
  origin {
    domain_name = aws_lb.main.dns_name
    origin_id   = "ALB-${aws_lb.main.id}"
    
    custom_origin_config {
      http_port              = 80
      https_port             = 443
      origin_protocol_policy = "https-only"
      origin_ssl_protocols   = ["TLSv1.2"]
    }
  }
  
  # default_root_objectは空文字列または省略
  default_root_object = ""
  
  default_cache_behavior {
    # 動的コンテンツのキャッシュ設定
    target_origin_id = "ALB-${aws_lb.main.id}"
    
    # Next.jsの動的ルーティングに対応
    forwarded_values {
      query_string = true
      headers      = ["*"]  # または必要なヘッダーのみ
      
      cookies {
        forward = "all"
      }
    }
  }
}
```

### 解決方法2: Next.js Static Export + S3

静的エクスポートを使用する場合：

```javascript
// next.config.js
module.exports = {
  output: 'export',
  trailingSlash: true,
}
```

```hcl
resource "aws_cloudfront_distribution" "nextjs_static" {
  origin {
    domain_name = aws_s3_bucket.nextjs.bucket_regional_domain_name
    origin_id   = "S3-${aws_s3_bucket.nextjs.id}"
  }
  
  # 静的エクスポートの場合
  default_root_object = "index.html"
  
  # _next/static のキャッシュ設定
  ordered_cache_behavior {
    path_pattern     = "_next/static/*"
    target_origin_id = "S3-${aws_s3_bucket.nextjs.id}"
    
    forwarded_values {
      query_string = false
      cookies {
        forward = "none"
      }
    }
    
    min_ttl     = 0
    default_ttl = 31536000  # 1年
    max_ttl     = 31536000
  }
}
```

### 解決方法3: CloudFront Functions でリダイレクト

```javascript
function handler(event) {
    var request = event.request;
    var uri = request.uri;
    
    // ルートパスを/にリダイレクト
    if (uri === '/index.html') {
        return {
            statusCode: 301,
            statusDescription: 'Moved Permanently',
            headers: {
                'location': { value: '/' }
            }
        };
    }
    
    return request;
}
```

### Next.js特有の考慮事項

1. **API Routes**: `/api/*`パスは必ずオリジンサーバーに転送
2. **Image Optimization**: `/_next/image`パスの適切な処理
3. **ISR/SSG**: 適切なキャッシュヘッダーの設定
4. **Preview Mode**: プレビューモードのCookie処理

## 9. トラブルシューティング

### 問題1: ルートアクセスで404エラー

**原因**: 指定したファイルがオリジンに存在しない

**解決方法**:
```bash
# S3バケットの確認
aws s3 ls s3://your-bucket/index.html

# ファイルをアップロード
aws s3 cp index.html s3://your-bucket/
```

### 問題2: サブディレクトリで動作しない

**原因**: `default_root_object`はルートパスのみ対応

**解決方法**:
- Lambda@EdgeまたはCloudFront Functionsを使用
- オリジンでディレクトリインデックスを設定

### 問題3: キャッシュが更新されない

**原因**: CloudFrontキャッシュ

**解決方法**:
```bash
# キャッシュの無効化
aws cloudfront create-invalidation \
  --distribution-id ABCDEFG1234567 \
  --paths "/"
```

### 問題4: 予期しないファイルが返される

**原因**: 設定ミスまたはキャッシュ

**解決方法**:
1. Terraform設定を確認
2. CloudFrontコンソールで設定を確認
3. キャッシュを無効化

## 関連
- [CloudFront Distribution設定](/Users/username/example-project-app/infra/terraform/client/aws_cloudfront_distribution.tf)
- [S3 静的アセット配信パターン](/Users/username/example-project-app/my-documents/knowledges/2025.08.02.11.50_s3_only_static_assets_broadcasting.md)
- [AWS公式ドキュメント - デフォルトルートオブジェクト](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/DefaultRootObject.html)