# CloudFront Distribution の geo_restriction とは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS CloudFront Distributionの`restrictions`ブロック内の`geo_restriction`プロパティとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : CloudFrontのgeo_restrictionとは何か
> 
> **Answer** : 地理的な位置（国）に基づいてコンテンツへのアクセスを制限する機能。特定の国からのアクセスを許可または拒否できる。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 基本構造](#2-基本構造)
- [3. restriction_typeの種類](#3-restriction_typeの種類)
  - [3.1 none（制限なし）](#31-none制限なし)
  - [3.2 whitelist（ホワイトリスト）](#32-whitelistホワイトリスト)
  - [3.3 blacklist（ブラックリスト）](#33-blacklistブラックリスト)
- [4. 設定例](#4-設定例)
- [5. 国コードについて](#5-国コードについて)
- [6. 使用場面](#6-使用場面)
- [7. 注意事項](#7-注意事項)
- [8. 動作の仕組み](#8-動作の仕組み)

</details>

## 1. 概要

`geo_restriction`は、CloudFront Distributionで地理的制限を設定するための機能です。これにより、特定の国や地域からのアクセスを制御できます。

主な用途：
- ライセンス契約に基づく地域制限
- 法規制への準拠
- セキュリティ対策
- ビジネス戦略に基づくアクセス制御

## 2. 基本構造

Terraform設定における基本構造：

```hcl
resource "aws_cloudfront_distribution" "main" {
  # ... その他の設定 ...

  restrictions {
    geo_restriction {
      restriction_type = "none"  # または "whitelist", "blacklist"
      locations        = []      # 国コードのリスト（必要な場合）
    }
  }
}
```

**重要**: `restrictions`ブロックは**必須フィールド**です。CloudFront Distributionを作成する際は、必ず`restrictions`ブロックと`geo_restriction`を指定する必要があります。地理的制限を使用しない場合でも、`restriction_type = "none"`として明示的に指定しなければなりません。

## 3. restriction_typeの種類

### 3.1 none（制限なし）

すべての国からのアクセスを許可：

```hcl
restrictions {
  geo_restriction {
    restriction_type = "none"
  }
}
```

- デフォルト設定
- `locations`の指定は不要
- グローバルにコンテンツを配信する場合に使用

### 3.2 whitelist（ホワイトリスト）

指定した国からのアクセスのみを許可：

```hcl
restrictions {
  geo_restriction {
    restriction_type = "whitelist"
    locations        = ["JP", "US", "GB"]
  }
}
```

- リストに含まれる国からのみアクセス可能
- それ以外の国からは403 Forbiddenが返される

### 3.3 blacklist（ブラックリスト）

指定した国からのアクセスを拒否：

```hcl
restrictions {
  geo_restriction {
    restriction_type = "blacklist"
    locations        = ["CN", "KP"]
  }
}
```

- リストに含まれる国からのアクセスを拒否
- それ以外の国からはアクセス可能

## 4. 設定例

### 日本国内限定配信

```hcl
resource "aws_cloudfront_distribution" "japan_only" {
  # ... その他の設定 ...

  restrictions {
    geo_restriction {
      restriction_type = "whitelist"
      locations        = ["JP"]
    }
  }
}
```

### 特定国を除外

```hcl
resource "aws_cloudfront_distribution" "exclude_countries" {
  # ... その他の設定 ...

  restrictions {
    geo_restriction {
      restriction_type = "blacklist"
      locations        = ["CN", "RU", "KP"]
    }
  }
}
```

### アジア太平洋地域限定

```hcl
resource "aws_cloudfront_distribution" "apac_only" {
  # ... その他の設定 ...

  restrictions {
    geo_restriction {
      restriction_type = "whitelist"
      locations        = ["JP", "KR", "SG", "AU", "NZ", "TH", "MY", "ID", "PH", "VN"]
    }
  }
}
```

## 5. 国コードについて

### ISO 3166-1 alpha-2形式

CloudFrontは2文字の国コードを使用：
- `JP` - 日本
- `US` - アメリカ合衆国
- `GB` - イギリス
- `CN` - 中国
- `KR` - 韓国
- `DE` - ドイツ
- `FR` - フランス

### 特殊なコード

- `EU` - 欧州連合（複数国を一括指定）
- `AP` - アジア太平洋地域（リージョングループ）

## 6. 使用場面

### 1. コンプライアンス要件

- 医療データの地域制限
- 金融サービスの規制対応
- 個人情報保護法への準拠

### 2. ライセンス管理

- コンテンツの配信権がある地域のみに限定
- ソフトウェアの輸出規制対応

### 3. セキュリティ対策

- 攻撃が多い地域からのアクセスを遮断
- 不正アクセスの防止

### 4. ビジネス戦略

- 段階的なサービス展開
- 地域限定のプロモーション

## 7. 注意事項

### 1. IPアドレスの精度

- CloudFrontはIPアドレスから国を判定
- VPNやプロキシ使用時は正確でない場合がある
- 約99%の精度

### 2. パフォーマンスへの影響

- geo_restriction自体による遅延はほとんどない
- エッジロケーションで処理される

### 3. エラーハンドリング

制限された場合のレスポンス：
```hcl
custom_error_response {
  error_code            = 403
  error_caching_min_ttl = 300
  response_page_path    = "/geo-restricted.html"
  response_code         = 403
}
```

### 4. 料金

- geo_restriction機能自体に追加料金はない
- 通常のCloudFront使用料金のみ

### 5. 更新の反映

- 設定変更は数分で全エッジロケーションに反映
- 即座には反映されない

## 8. 動作の仕組み

1. **リクエスト受信**
   - ユーザーがCloudFrontにアクセス

2. **IP判定**
   - CloudFrontがクライアントIPから国を特定

3. **制限チェック**
   - geo_restriction設定と照合

4. **アクセス制御**
   - 許可：オリジンサーバーへリクエスト転送
   - 拒否：403 Forbiddenを返す

5. **ログ記録**
   - アクセスログに国情報を記録

## 関連
- [CloudFront Distribution設定](/Users/username/example-project-app/infra/terraform/client/aws_cloudfront_distribution.tf)
- [AWS CloudFront パスベースルーティング説明書](/Users/username/example-project-app/my-documents/knowledges/2025.07.31.11.05_AWS_CloudFront_パスベースルーティング説明書.md)
- [AWS公式ドキュメント - 地理的制限](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/georestrictions.html)