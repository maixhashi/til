# TerraformでRDSパスワードをSecrets Managerで管理する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにTerraformでRDSパスワードをAWS Secrets Managerで管理するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにRDSパスワードをSecrets Managerで安全に管理するか
> 
> **Answer** : 変数から受け取ったパスワードをSecrets Managerに保存し、ECSタスクやLambdaからはSecrets Manager経由でアクセスする。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 実装方法](#2-実装方法)
  - [2.1 Secrets Managerリソースの定義](#21-secrets-managerリソースの定義)
  - [2.2 RDSクラスターの設定](#22-rdsクラスターの設定)
  - [2.3 変数の定義](#23-変数の定義)
  - [2.4 Outputの設定](#24-outputの設定)
- [3. アプリケーションからの利用](#3-アプリケーションからの利用)
  - [3.1 ECSタスクでの利用](#31-ecsタスクでの利用)
  - [3.2 Lambdaでの利用](#32-lambdaでの利用)
- [4. セキュリティ設計](#4-セキュリティ設計)
- [5. 運用上の注意点](#5-運用上の注意点)

</details>

## 1. 概要

設計書（SYS004_セキュリティ方式設計書）に基づき、RDSのマスターパスワードをAWS Secrets Managerで管理します。これにより：

- パスワードの一元管理
- アクセス制御（IAMロール）
- 監査ログの記録
- ローテーション機能

が実現されます。

## 2. 実装方法

### 2.1 Secrets Managerリソースの定義

**aws_secretsmanager_secrets.tf**:
```hcl
# Secrets Manager - RDS Master Password
resource "aws_secretsmanager_secret" "rds_master_password" {
  name = "${var.project_name}-rds-master-password-${var.environment}"
  description = "Master password for RDS cluster"

  tags = {
    Name = "${var.project_name}-rds-master-password-${var.environment}"
  }
}

# Store the RDS password in Secrets Manager
resource "aws_secretsmanager_secret_version" "rds_master_password" {
  secret_id     = aws_secretsmanager_secret.rds_master_password.id
  secret_string = var.db_master_password
}
```

### 2.2 RDSクラスターの設定

**aws_rds_cluster.tf**:
```hcl
resource "aws_rds_cluster" "example" {
  cluster_identifier     = "${var.project_name}-${var.environment}"
  engine                 = "aurora-postgresql"
  engine_mode            = "provisioned"
  engine_version         = "15.4"
  database_name          = "example_project"
  master_username        = var.db_master_username
  master_password        = var.db_master_password
  manage_master_user_password = false  # Secrets Managerで手動管理
  # ... その他の設定
}
```

### 2.3 変数の定義

**variables.tf**:
```hcl
variable "db_master_username" {
  type = string
}

variable "db_master_password" {
  type = string
  sensitive = true  # 機密情報としてマーク
}
```

### 2.4 Outputの設定

**outputs.tf**:
```hcl
output "rds_master_password_secret_arn" {
  description = "ARN of the RDS master password secret in Secrets Manager"
  value       = aws_secretsmanager_secret.rds_master_password.arn
  sensitive   = true
}
```

## 3. アプリケーションからの利用

### 3.1 ECSタスクでの利用

ECSタスク定義でSecrets Managerから環境変数として取得：

```hcl
secrets = [
  {
    name      = "DATABASE_URL"
    valueFrom = aws_secretsmanager_secret.db_connection_string.arn
  }
]
```

ECSタスク実行ロールには`AmazonECSTaskExecutionRolePolicy`がアタッチされており、Secrets Managerへのアクセス権限が含まれています。

### 3.2 Lambdaでの利用

Lambda関数のIAMロールにSecrets Managerへのアクセス権限を付与：

```hcl
{
  Effect = "Allow"
  Action = [
    "secretsmanager:GetSecretValue"
  ]
  Resource = [
    aws_secretsmanager_secret.rds_master_password.arn
  ]
}
```

## 4. セキュリティ設計

1. **最小権限の原則**
   - 必要なリソースのみにアクセス権限を付与
   - ECSタスクとLambdaで異なるロールを使用

2. **暗号化**
   - Secrets ManagerはKMSで自動暗号化
   - 転送時はTLSで保護

3. **監査**
   - CloudTrailでアクセスログを記録
   - 不正アクセスの検知が可能

4. **ローテーション**
   - 将来的に自動ローテーション機能を追加可能

## 5. 運用上の注意点

1. **初回デプロイ時**
   - terraform.tfvarsまたは環境変数でパスワードを提供
   - 例：`TF_VAR_db_master_password="secure-password"`

2. **パスワード変更時**
   - Secrets Managerの値を更新
   - RDSクラスターのパスワードも変更が必要

3. **削除保護**
   - Secrets Managerは7日間の削除待機期間がデフォルト
   - 誤削除を防ぐために有効

4. **コスト**
   - Secrets Manager：$0.40/月/シークレット
   - APIコール：$0.05/10,000リクエスト

5. **接続文字列の構築**
   - アプリケーション側で動的に構築
   ```javascript
   const password = await getSecretValue('rds-master-password');
   const connectionString = `postgresql://postgres:${password}@${endpoint}:5432/example_project`;
   ```

## 関連
- [セキュリティ方式設計書](/Users/username/example-project-app/docs/2. 基本設計書/2-2. システム方式設計書/SYS004_セキュリティ方式設計書.md)
- [Secrets Manager設定](/Users/username/example-project-app/infra/terraform/server/aws_secretsmanager_secrets.tf)
- [RDSクラスター設定](/Users/username/example-project-app/infra/terraform/server/aws_rds_cluster.tf)