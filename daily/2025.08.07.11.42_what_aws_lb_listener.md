# AWS LB Listenerとは

## What's this file?
> [!NOTE]
> **What**
> 
> AWS LB Listenerとは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : AWS LB Listenerとは何か
> 
> **Answer** : ロードバランサーの指定ポートで接続要求をチェックし、設定されたルールに基づいてトラフィックを適切なターゲットグループにルーティングするコンポーネント。

## 目次

<details>
<summary>目次を開く</summary>

- [1. 概要](#1-概要)
- [2. 主要な機能](#2-主要な機能)
  - [2.1 プロトコルとポート](#21-プロトコルとポート)
  - [2.2 ルールとアクション](#22-ルールとアクション)
  - [2.3 SSL/TLS終端](#23-ssltls終端)
- [3. リスナーの種類](#3-リスナーの種類)
  - [3.1 HTTPリスナー](#31-httpリスナー)
  - [3.2 HTTPSリスナー](#32-httpsリスナー)
  - [3.3 TCPリスナー（NLB）](#33-tcpリスナーnlb)
- [4. 主要な設定項目](#4-主要な設定項目)
- [5. デフォルトアクション](#5-デフォルトアクション)
- [6. リスナールール](#6-リスナールール)
- [7. 重要なポイント](#7-重要なポイント)

</details>

## 1. 概要

AWS LB Listener（ロードバランサーリスナー）は、ロードバランサーがクライアントからの接続要求を受け付ける入り口となるコンポーネントです。指定されたプロトコルとポートで接続をリッスンし、設定されたルールに基づいてトラフィックを処理します。

主な役割：
- 特定のポートでの接続待ち受け
- プロトコルの処理（HTTP/HTTPS/TCP）
- SSL/TLS証明書の管理（HTTPS時）
- トラフィックのルーティング

## 2. 主要な機能

### 2.1 プロトコルとポート

リスナーは以下の組み合わせで設定可能：
- **HTTP**: ポート80（標準）または任意のポート
- **HTTPS**: ポート443（標準）または任意のポート
- **TCP/UDP**: 任意のポート（NLBの場合）

### 2.2 ルールとアクション

リスナーは受信したリクエストを評価し、アクションを実行：
- **forward**: ターゲットグループへ転送
- **redirect**: 別のURLへリダイレクト
- **fixed-response**: 固定レスポンスを返す
- **authenticate-oidc**: OIDC認証
- **authenticate-cognito**: Cognito認証

### 2.3 SSL/TLS終端

HTTPSリスナーの場合：
- SSL/TLS証明書の管理
- 暗号化通信の終端処理
- セキュリティポリシーの適用

## 3. リスナーの種類

### 3.1 HTTPリスナー

```hcl
resource "aws_lb_listener" "http" {
  load_balancer_arn = aws_lb.main.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type = "redirect"
    redirect {
      port        = "443"
      protocol    = "HTTPS"
      status_code = "HTTP_301"
    }
  }
}
```

### 3.2 HTTPSリスナー

```hcl
resource "aws_lb_listener" "https" {
  load_balancer_arn = aws_lb.main.arn
  port              = "443"
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-TLS-1-2-2017-01"
  certificate_arn   = aws_acm_certificate.main.arn

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.main.arn
  }
}
```

### 3.3 TCPリスナー（NLB）

```hcl
resource "aws_lb_listener" "tcp" {
  load_balancer_arn = aws_lb.nlb.arn
  port              = "3306"
  protocol          = "TCP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tcp.arn
  }
}
```

## 4. 主要な設定項目

**load_balancer_arn**
- 関連付けるロードバランサーのARN
- 必須項目

**port**
- リスナーがリッスンするポート番号
- 1-65535の範囲

**protocol**
- 接続プロトコル（HTTP/HTTPS/TCP/TLS/UDP/TCP_UDP）
- ALBはHTTP/HTTPSのみサポート

**certificate_arn**
- SSL証明書のARN（HTTPSの場合必須）
- ACMまたはIAMの証明書を指定

**ssl_policy**
- SSL/TLSセキュリティポリシー
- HTTPSリスナーでのみ使用

**default_action**
- デフォルトのアクション設定
- 必須項目

## 5. デフォルトアクション

すべてのリスナーにはデフォルトアクションが必要：

```hcl
default_action {
  type = "forward"
  target_group_arn = aws_lb_target_group.main.arn
}

# または

default_action {
  type = "redirect"
  redirect {
    port        = "443"
    protocol    = "HTTPS"
    status_code = "HTTP_301"
  }
}
```

## 6. リスナールール

デフォルトアクション以外の条件付きルーティング：

```hcl
resource "aws_lb_listener_rule" "api" {
  listener_arn = aws_lb_listener.https.arn
  priority     = 100

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.api.arn
  }

  condition {
    path_pattern {
      values = ["/api/*"]
    }
  }
}
```

条件の種類：
- `path_pattern`: パスパターン
- `host_header`: ホストヘッダー
- `http_request_method`: HTTPメソッド
- `source_ip`: ソースIP
- `http_header`: HTTPヘッダー
- `query_string`: クエリ文字列

## 7. 重要なポイント

1. **セキュリティ**
   - HTTPSリスナーでは強力なSSLポリシーを使用
   - HTTPからHTTPSへの自動リダイレクト設定

2. **パフォーマンス**
   - 適切なアイドルタイムアウトの設定
   - HTTP/2の有効化（ALBのみ）

3. **可用性**
   - 複数の証明書（SNI）のサポート
   - 複数のターゲットグループへの振り分け

4. **監視**
   - CloudWatchメトリクスの活用
   - アクセスログの有効化

5. **コスト**
   - リスナーごとの料金は発生しない
   - ルール数に応じた料金体系（ALB）

## 関連
- [AWS Application Load Balancer (ALB)](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_lb.tf)
- [AWS Target Group](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_lb_target_group.tf)
- [AWS ACM Certificate](/Users/username/example-project-app/infra/terraform/modules/aws/server/aws_acm_certificate.tf)